{# apps/accounting/templates/accounting/journal/journal_entry_template_detail.html #}
{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{{ template.name }} - تفاصيل القالب{% endblock %}

{% block extra_css %}
<style>
.print-only {
    display: none;
}

@media print {
    .no-print {
        display: none !important;
    }
    .print-only {
        display: block;
    }
}

.template-header-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.stat-card {
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-5px);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                    </li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="h3 mb-1">{% trans "القالب" %}: {{ template.name }}</h1>
            {% if template.code %}
                <p class="text-muted mb-1">{% trans "الرمز" %}: <code>{{ template.code }}</code></p>
            {% endif %}
            <div class="d-flex align-items-center gap-3 mt-2">
                {% if template.is_active %}
                    <span class="badge bg-success fs-6">
                        <i class="fas fa-check-circle"></i> {% trans "نشط" %}
                    </span>
                {% else %}
                    <span class="badge bg-secondary fs-6">
                        <i class="fas fa-times-circle"></i> {% trans "معطل" %}
                    </span>
                {% endif %}

                <span class="badge bg-info fs-6">
                    <i class="fas fa-tag"></i> {{ template.get_entry_type_display }}
                </span>

                {% if template.category %}
                <span class="badge bg-primary fs-6">
                    <i class="fas fa-folder"></i> {{ template.category }}
                </span>
                {% endif %}

                {% if template.is_balanced %}
                    <span class="badge bg-success fs-6">
                        <i class="fas fa-balance-scale"></i> {% trans "متوازن" %}
                    </span>
                {% else %}
                    <span class="badge bg-warning fs-6">
                        <i class="fas fa-exclamation-triangle"></i> {% trans "غير متوازن" %}
                    </span>
                {% endif %}

                {% if template.auto_balance %}
                <span class="badge bg-secondary fs-6">
                    <i class="fas fa-magic"></i> {% trans "توازن تلقائي" %}
                </span>
                {% endif %}
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'accounting:use_template' %}?template={{ template.pk }}" class="btn btn-success">
                <i class="fas fa-magic"></i> {% trans "استخدام القالب" %}
            </a>
            {% if can_edit %}
            <a href="{% url 'accounting:template_update' template.pk %}" class="btn btn-warning">
                <i class="fas fa-edit"></i> {% trans "تعديل" %}
            </a>
            {% endif %}
            {% if can_delete %}
            <a href="{% url 'accounting:template_delete' template.pk %}" class="btn btn-danger">
                <i class="fas fa-trash"></i> {% trans "حذف" %}
            </a>
            {% endif %}
            <a href="{% url 'accounting:template_list' %}" class="btn btn-secondary">
                <i class="fas fa-list"></i> {% trans "العودة للقائمة" %}
            </a>
        </div>
    </div>

    <div class="row">
        <!-- المحتوى الرئيسي -->
        <div class="col-lg-8">
            <!-- وصف القالب -->
            {% if template.description %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-align-left"></i> {% trans "وصف القالب" %}
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ template.description }}</p>
                </div>
            </div>
            {% endif %}

            <!-- البيانات الافتراضية -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-file-alt"></i> {% trans "البيانات الافتراضية" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>{% trans "البيان الافتراضي" %}:</strong>
                        <p class="mb-0 mt-1">{{ template.default_description }}</p>
                    </div>
                    {% if template.default_reference %}
                    <div>
                        <strong>{% trans "المرجع الافتراضي" %}:</strong>
                        <p class="mb-0 mt-1">{{ template.default_reference }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- سطور القالب -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-list"></i> {% trans "سطور القالب" %} ({{ template.template_lines.count }})
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="12%" class="text-end">{% trans "مدين" %}</th>
                                    <th width="12%" class="text-end">{% trans "دائن" %}</th>
                                    <th width="25%">{% trans "الحساب" %}</th>
                                    <th width="25%">{% trans "البيان" %}</th>
                                    <th width="10%" class="text-center">{% trans "مركز التكلفة" %}</th>
                                    <th width="6%" class="text-center no-print">{% trans "إجباري" %}</th>
                                    <th width="5%" class="text-center no-print">{% trans "قابل للتعديل" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in template.template_lines.all %}
                                <tr>
                                    <td class="fw-bold text-muted">{{ line.line_number }}</td>
                                    <td class="text-end">
                                        {% if line.debit_amount %}
                                            <span class="fw-bold text-success">
                                                {{ line.debit_amount|floatformat:2 }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if line.credit_amount %}
                                            <span class="fw-bold text-primary">
                                                {{ line.credit_amount|floatformat:2 }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="fw-bold">{{ line.account.name }}</div>
                                        <small class="text-muted">{{ line.account.code }}</small>
                                    </td>
                                    <td>
                                        {{ line.description|default:"-" }}
                                        {% if line.reference %}
                                            <br><small class="text-muted">{{ line.reference }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if line.default_cost_center %}
                                            <span class="badge bg-info">{{ line.default_cost_center.code }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center no-print">
                                        {% if line.is_required %}
                                            <i class="fas fa-check-circle text-success" title="إجباري"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle text-muted" title="اختياري"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-center no-print">
                                        {% if line.amount_editable %}
                                            <i class="fas fa-edit text-primary" title="قابل للتعديل"></i>
                                        {% else %}
                                            <i class="fas fa-lock text-muted" title="ثابت"></i>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-3 d-block"></i>
                                        {% trans "لا توجد سطور في هذا القالب" %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ملخص الأرصدة -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-calculator"></i> {% trans "ملخص الأرصدة" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <h3 class="text-success mb-0">{{ template.get_total_debit|floatformat:2 }}</h3>
                                <small class="text-muted">{% trans "إجمالي المدين" %}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <h3 class="text-primary mb-0">{{ template.get_total_credit|floatformat:2 }}</h3>
                                <small class="text-muted">{% trans "إجمالي الدائن" %}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                {% if template.is_balanced %}
                                    <h3 class="text-success mb-0"><i class="fas fa-check-circle"></i></h3>
                                    <small class="text-success">{% trans "متوازن" %}</small>
                                {% else %}
                                    <h3 class="text-warning mb-0"><i class="fas fa-exclamation-triangle"></i></h3>
                                    <small class="text-warning">{% trans "غير متوازن" %}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- معلومات إضافية -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> {% trans "معلومات إضافية" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">{% trans "نوع القيد" %}</h6>
                            <p class="mb-0">{{ template.get_entry_type_display }}</p>
                        </div>
                        {% if template.category %}
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">{% trans "الفئة" %}</h6>
                            <p class="mb-0">{{ template.category }}</p>
                        </div>
                        {% endif %}
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">{% trans "ترتيب العرض" %}</h6>
                            <p class="mb-0">{{ template.display_order }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">{% trans "تاريخ الإنشاء" %}</h6>
                            <p class="mb-0">{{ template.created_at|date:"Y/m/d H:i" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">{% trans "أنشأ بواسطة" %}</h6>
                            <p class="mb-0">{{ template.created_by.get_full_name|default:template.created_by.username }}</p>
                        </div>
                        {% if template.updated_at != template.created_at %}
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">{% trans "آخر تحديث" %}</h6>
                            <p class="mb-0">{{ template.updated_at|date:"Y/m/d H:i" }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- الشريط الجانبي -->
        <div class="col-lg-4">
            <!-- إحصائيات سريعة -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> {% trans "إحصائيات سريعة" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-12">
                            <div class="border rounded p-3">
                                <h3 class="text-primary mb-0">{{ template.template_lines.count }}</h3>
                                <small class="text-muted">{% trans "عدد السطور" %}</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="border rounded p-3">
                                <h3 class="text-success mb-0">{{ template.get_total_debit|floatformat:2 }}</h3>
                                <small class="text-muted">{% trans "المبلغ الإجمالي" %}</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="border rounded p-3">
                                <h3 class="text-warning mb-0">{{ usage_count|default:0 }}</h3>
                                <small class="text-muted">{% trans "مرات الاستخدام" %}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- إجراءات سريعة -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt"></i> {% trans "إجراءات سريعة" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'accounting:use_template' %}?template={{ template.pk }}" class="btn btn-success">
                            <i class="fas fa-magic me-2"></i>{% trans "استخدام القالب" %}
                        </a>

                        {% if can_edit %}
                        <a href="{% url 'accounting:template_update' template.pk %}" class="btn btn-warning">
                            <i class="fas fa-edit me-2"></i>{% trans "تعديل القالب" %}
                        </a>
                        {% endif %}

                        <button type="button" class="btn btn-outline-info" onclick="printTemplate()">
                            <i class="fas fa-print me-2"></i>{% trans "طباعة القالب" %}
                        </button>

                        <button type="button" class="btn btn-outline-secondary" onclick="copyTemplate()">
                            <i class="fas fa-copy me-2"></i>{% trans "نسخ القالب" %}
                        </button>

                        {% if can_delete %}
                        <a href="{% url 'accounting:template_delete' template.pk %}" class="btn btn-outline-danger">
                            <i class="fas fa-trash me-2"></i>{% trans "حذف القالب" %}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- خصائص القالب -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-sliders-h text-warning"></i> {% trans "خصائص القالب" %}
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-1"></i>
                            <strong>{% trans "نوع القيد" %}:</strong> {{ template.get_entry_type_display }}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-1"></i>
                            <strong>{% trans "حالة التوازن" %}:</strong>
                            {% if template.is_balanced %}
                                <span class="text-success">متوازن</span>
                            {% else %}
                                <span class="text-warning">غير متوازن</span>
                            {% endif %}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-1"></i>
                            <strong>{% trans "التوازن التلقائي" %}:</strong>
                            {% if template.auto_balance %}
                                <span class="text-success">مفعل</span>
                            {% else %}
                                <span class="text-muted">معطل</span>
                            {% endif %}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-1"></i>
                            <strong>{% trans "حالة القالب" %}:</strong>
                            {% if template.is_active %}
                                <span class="text-success">نشط</span>
                            {% else %}
                                <span class="text-danger">معطل</span>
                            {% endif %}
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-info-circle text-primary me-1"></i>
                            {% if template.is_active %}
                                القالب نشط ومتاح للاستخدام
                            {% else %}
                                القالب معطل وغير متاح للاستخدام
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Header (Hidden, shown only when printing) -->
<div class="print-only">
    <div class="text-center mb-4">
        <h2>{{ request.current_company.name }}</h2>
        <h4>{% trans "قالب قيد رقم" %}: {{ template.name }}</h4>
        {% if template.code %}
        <p>{% trans "الرمز" %}: {{ template.code }}</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function printTemplate() {
    window.print();
}

function copyTemplate() {
    Swal.fire({
        title: 'نسخ القالب',
        text: 'سيتم إنشاء قالب جديد بنفس البيانات. هل تريد المتابعة؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم، انسخ القالب',
        cancelButtonText: 'إلغاء',
        confirmButtonColor: '#0d6efd',
        showLoaderOnConfirm: true,
        preConfirm: () => {
            return $.ajax({
                url: '{% url "accounting:template_copy" template.pk %}',
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                dataType: 'json'
            }).then(response => {
                if (!response.success) {
                    throw new Error(response.message || 'خطأ غير معروف');
                }
                return response;
            }).catch(error => {
                Swal.showValidationMessage(
                    `خطأ: ${error.message || error.responseJSON?.message || 'فشل في نسخ القالب'}`
                );
            });
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed && result.value) {
            Swal.fire({
                title: 'نجح!',
                text: result.value.message,
                icon: 'success',
                confirmButtonText: 'عرض القالب الجديد'
            }).then(() => {
                window.location.href = result.value.redirect_url;
            });
        }
    });
}
</script>
{% endblock %}