<!-- apps/accounting/templates/accounting/vouchers/payment_voucher_form.html -->
{% extends 'base/base.html' %}
{% load i18n static widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
.form-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid #dee2e6;
}

.form-section h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

.check-fields {
    display: none;
}

.amount-display {
    font-size: 1.5rem;
    font-weight: bold;
    color: #dc3545;
    text-align: center;
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                    </li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">{{ title }}</h1>
            <p class="text-muted mb-0">إدخال بيانات سند الصرف</p>
        </div>
        <div>
            <a href="{% url 'accounting:payment_voucher_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right"></i> العودة للقائمة
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Form Card -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-arrow-down me-2 text-danger"></i>
                        {% if object %}تعديل سند الصرف{% else %}سند صرف جديد{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" novalidate id="voucherForm">
                        {% csrf_token %}

                        <!-- المعلومات الأساسية -->
                        <div class="form-section">
                            <h6><i class="fas fa-info-circle me-2"></i>المعلومات الأساسية</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="{{ form.date.id_for_label }}" class="form-label">
                                        {{ form.date.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.date|add_class:"form-control" }}
                                    {% if form.date.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.date.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label for="{{ form.amount.id_for_label }}" class="form-label">
                                        {{ form.amount.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.amount|add_class:"form-control text-end" }}
                                    {% if form.amount.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.amount.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label for="{{ form.currency.id_for_label }}" class="form-label">
                                        {{ form.currency.label }}
                                    </label>
                                    {{ form.currency|add_class:"form-select" }}
                                </div>
                            </div>
                        </div>

                        <!-- بيانات المستفيد -->
                        <div class="form-section">
                            <h6><i class="fas fa-user me-2"></i>بيانات المستفيد</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.beneficiary_name.id_for_label }}" class="form-label">
                                        {{ form.beneficiary_name.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.beneficiary_name|add_class:"form-control" }}
                                    {% if form.beneficiary_name.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.beneficiary_name.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label for="{{ form.beneficiary_type.id_for_label }}" class="form-label">
                                        {{ form.beneficiary_type.label }}
                                    </label>
                                    {{ form.beneficiary_type|add_class:"form-select" }}
                                </div>
                            </div>
                        </div>

                        <!-- الحسابات المحاسبية -->
                        <div class="form-section">
                            <h6><i class="fas fa-sitemap me-2"></i>الحسابات المحاسبية</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.cash_account_search.id_for_label }}" class="form-label">
                                        {{ form.cash_account_search.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.cash_account_search|add_class:"form-control" }}
                                    {{ form.cash_account }}
                                    {% if form.cash_account.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.cash_account.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label for="{{ form.expense_account_search.id_for_label }}" class="form-label">
                                        {{ form.expense_account_search.label }}
                                    </label>
                                    {{ form.expense_account_search|add_class:"form-control" }}
                                    {{ form.expense_account }}
                                    <small class="text-muted">اختياري - سيستخدم حساب الصندوق إذا لم يحدد</small>
                                </div>
                            </div>
                        </div>

                        <!-- طريقة الدفع -->
                        <div class="form-section">
                            <h6><i class="fas fa-credit-card me-2"></i>طريقة الدفع</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.payment_method.id_for_label }}" class="form-label">
                                        {{ form.payment_method.label }}
                                    </label>
                                    {{ form.payment_method|add_class:"form-select" }}
                                </div>
                                <div class="col-md-6">
                                    <!-- سيظهر فقط عند الحاجة -->
                                </div>
                            </div>

                            <!-- حقول الشيك (مخفية افتراضياً) -->
                            <div class="row g-3 mt-2 check-fields" id="checkFields">
                                <div class="col-md-4">
                                    <label for="{{ form.check_number.id_for_label }}" class="form-label">
                                        {{ form.check_number.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.check_number|add_class:"form-control" }}
                                    {% if form.check_number.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.check_number.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label for="{{ form.check_date.id_for_label }}" class="form-label">
                                        {{ form.check_date.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.check_date|add_class:"form-control" }}
                                    {% if form.check_date.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.check_date.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label for="{{ form.bank_name.id_for_label }}" class="form-label">
                                        {{ form.bank_name.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.bank_name|add_class:"form-control" }}
                                    {% if form.bank_name.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.bank_name.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- البيان والملاحظات -->
                        <div class="form-section">
                            <h6><i class="fas fa-align-left me-2"></i>البيان والملاحظات</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">
                                        {{ form.description.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.description|add_class:"form-control" }}
                                    {% if form.description.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.description.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row g-3 mt-2">
                                <div class="col-12">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label">
                                        {{ form.notes.label }}
                                    </label>
                                    {{ form.notes|add_class:"form-control" }}
                                </div>
                            </div>
                        </div>

                        <!-- أزرار الإجراءات -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'accounting:payment_voucher_list' %}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-arrow-right me-2"></i>العودة
                            </a>

                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                {% if object %}تحديث{% else %}إنشاء{% endif %} السند
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // تهيئة البحث التلقائي للحسابات
    $('.account-autocomplete').select2({
        theme: 'bootstrap-5',
        placeholder: 'ابحث عن الحساب...',
        minimumInputLength: 2,
        ajax: {
            url: '{% url "accounting:account_autocomplete" %}',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    term: params.term,
                    page: params.page
                };
            },
            processResults: function (data, params) {
                return {
                    results: data.map(function(item) {
                        return {
                            id: item.id,
                            text: item.text,
                            code: item.code,
                            name: item.name
                        };
                    })
                };
            },
            cache: true
        }
    });

    // عند اختيار حساب الصندوق
    $('#id_cash_account_search').on('select2:select', function (e) {
        var data = e.params.data;
        $('#id_cash_account').val(data.id);
    });

    // عند اختيار حساب المصروف
    $('#id_expense_account_search').on('select2:select', function (e) {
        var data = e.params.data;
        $('#id_expense_account').val(data.id);
    });

    // إظهار/إخفاء حقول الشيك
    $('#id_payment_method').on('change', function() {
        if ($(this).val() === 'check') {
            $('#checkFields').show();
            $('#checkFields input').prop('required', true);
        } else {
            $('#checkFields').hide();
            $('#checkFields input').prop('required', false);
        }
    });

    // تطبيق القاعدة عند التحميل
    if ($('#id_payment_method').val() === 'check') {
        $('#checkFields').show();
        $('#checkFields input').prop('required', true);
    }

    // تحسين تجربة المستخدم
    $('#voucherForm').on('submit', function() {
        $('button[type="submit"]').prop('disabled', true)
               .html('<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...');
    });

    // تنبيه عند مغادرة الصفحة بدون حفظ
    var formChanged = false;
    $('#voucherForm input, #voucherForm select, #voucherForm textarea').on('change', function() {
        formChanged = true;
    });

    $(window).on('beforeunload', function() {
        if (formChanged) {
            return 'لديك تغييرات غير محفوظة. هل أنت متأكد من مغادرة الصفحة؟';
        }
    });

    $('#voucherForm').on('submit', function() {
        formChanged = false;
    });
});
</script>
{% endblock %}