{% extends 'base/base.html' %}
{% load i18n static widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
/* Windows Wizard Style */
:root {
    --primary-color: #0078d4;
    --success-color: #107c10;
    --border-color: #e1e1e1;
    --bg-light: #f3f3f3;
}

/* Select2 Styling - مثل فاتورة المشتريات */
.select2-container--bootstrap-5 .select2-selection--single {
    background-image: none !important;
    background-color: #fff !important;
    padding: 0.375rem 0.75rem !important;
    direction: rtl;
    text-align: right;
    min-height: 38px;
    display: flex;
    align-items: center;
}

select[data-select2-id] {
    background-image: none !important;
}

.select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
}

/* Autocomplete Dropdown - Oracle Desktop Style */
.autocomplete-wrapper {
    position: relative;
    display: flex;
    align-items: stretch;
    width: 100%;
}

.autocomplete-search-input {
    flex: 1;
    border-top-left-radius: 0.375rem !important;
    border-bottom-left-radius: 0.375rem !important;
    border-left: none !important;
    padding-left: 35px !important;
}

.autocomplete-clear-btn {
    position: absolute;
    left: 32px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: none;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    z-index: 5;
    padding: 0;
    line-height: 1;
}

.autocomplete-clear-btn:hover {
    background: #c82333;
}

.autocomplete-clear-btn.show {
    display: flex;
}

.autocomplete-dropdown-btn {
    width: 32px;
    padding: 0;
    border: 1px solid #dee2e6;
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
    background: linear-gradient(to bottom, #ffffff, #f8f9fa);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
}

.autocomplete-dropdown-btn:hover {
    background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
    border-color: #0078d4;
}

.autocomplete-dropdown-btn:active {
    background: #dee2e6;
}

.autocomplete-dropdown-btn i {
    font-size: 11px;
    color: #495057;
    transition: transform 0.2s;
}

.autocomplete-dropdown-btn:hover i {
    color: #0078d4;
}

.autocomplete-wrapper.open .autocomplete-dropdown-btn i {
    transform: rotate(180deg);
}

.autocomplete-list {
    position: absolute;
    top: 100%;
    right: 0;
    left: 0;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #dee2e6;
    border-top: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    z-index: 1000;
    display: none;
}

.autocomplete-list.show {
    display: block;
}

.autocomplete-list-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    text-align: right;
    direction: rtl;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.15s;
    display: flex;
    align-items: center;
}

.autocomplete-list-item:last-child {
    border-bottom: none;
}

.autocomplete-list-item.selected {
    background-color: #e3f2fd !important;
    border-right: 3px solid #0078d4;
    font-weight: 500;
}

.autocomplete-list-item:hover,
.autocomplete-list-item.active {
    background-color: #0078d4 !important;
    color: white !important;
}

.autocomplete-list-item:hover {
    font-weight: 500;
}

/* Level indicators for categories */
.autocomplete-list-item .level-indicator {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-left: 8px;
    flex-shrink: 0;
}

.autocomplete-list-item[data-level="1"] {
    font-weight: 600;
    background: #f8f9fa;
}

.autocomplete-list-item[data-level="1"]:hover {
    font-weight: 600;
}

.autocomplete-list-item[data-level="1"] .level-indicator {
    background: #0078d4;
    width: 8px;
    height: 8px;
}

.autocomplete-list-item[data-level="2"] {
    padding-right: 1.5rem;
}

.autocomplete-list-item[data-level="2"] .level-indicator {
    background: #28a745;
}

.autocomplete-list-item[data-level="3"] {
    padding-right: 2.25rem;
    font-size: 0.95em;
}

.autocomplete-list-item[data-level="3"] .level-indicator {
    background: #ffc107;
}

.autocomplete-list-item[data-level="4"] {
    padding-right: 3rem;
    font-size: 0.9em;
    color: #666;
}

.autocomplete-list-item[data-level="4"] .level-indicator {
    background: #dc3545;
}

.autocomplete-list-item:hover .level-indicator,
.autocomplete-list-item.active .level-indicator {
    background: white !important;
}

/* Review Tab Styles */
.review-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.review-header {
    margin-bottom: 40px;
}

.review-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
}

.review-icon i {
    font-size: 40px;
    color: white;
}

.review-main-title {
    font-size: 28px;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 10px;
}

.review-subtitle {
    font-size: 16px;
    color: #718096;
}

.review-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 24px;
    overflow: hidden;
    border: 1px solid #e2e8f0;
    transition: transform 0.2s, box-shadow 0.2s;
}

.review-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.review-card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 24px;
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.review-card-header i {
    font-size: 20px;
}

.review-card-header .badge {
    margin-right: auto;
    font-size: 13px;
    padding: 4px 12px;
}

.review-card-body {
    padding: 24px;
}

.review-field {
    margin-bottom: 20px;
}

.review-field:last-child {
    margin-bottom: 0;
}

.review-field label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.review-field label i {
    color: #667eea;
    margin-left: 6px;
}

.review-field-value {
    background: #f7fafc;
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    font-size: 15px;
    color: #2d3748;
    font-weight: 500;
    min-height: 45px;
    display: flex;
    align-items: center;
}

.variants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
}

.variant-preview-item {
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    padding: 16px;
    border-radius: 10px;
    border-right: 4px solid #667eea;
    transition: all 0.2s;
}

.variant-preview-item:hover {
    transform: translateX(-4px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
}

.variant-preview-item strong {
    display: block;
    color: #2d3748;
    font-size: 15px;
    margin-bottom: 6px;
}

.conversion-item {
    background: #f7fafc;
    padding: 14px 18px;
    border-radius: 8px;
    border-right: 3px solid #48bb78;
    margin-bottom: 12px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.conversion-item strong {
    color: #2d3748;
}

.price-list-section {
    margin-bottom: 20px;
}

.price-list-section h6 {
    color: #667eea;
    font-weight: 600;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e2e8f0;
}

.price-item {
    background: #f7fafc;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-right: 3px solid #ed8936;
}

.price-item strong {
    color: #2d3748;
}

.price-item .price-value {
    color: #ed8936;
    font-weight: 700;
    font-size: 16px;
}

.review-success {
    background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
    padding: 40px;
    border-radius: 12px;
    margin-top: 30px;
    border: 2px solid #9ae6b4;
}

.success-checkmark {
    width: 70px;
    height: 70px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
}

.success-checkmark i {
    font-size: 35px;
    color: white;
}

.review-success h4 {
    color: #2f855a;
    font-weight: 700;
    margin-bottom: 10px;
}

/* Tab Navigation */
.nav-tabs {
    border-bottom: 3px solid var(--border-color);
    padding: 10px 50px 0 50px;
    background: linear-gradient(to bottom, #ffffff, #f8f9fa);
}

.nav-tabs .nav-link {
    border: 2px solid #ddd;
    border-radius: 8px 8px 0 0;
    color: #000000 !important;
    padding: 18px 30px;
    font-weight: 600;
    font-size: 15px;
    margin-left: 5px;
    margin-right: 5px;
    background: #ffffff;
    transition: all 0.3s;
    position: relative;
    bottom: -3px;
}

.nav-tabs .nav-link i {
    font-size: 18px;
    margin-left: 8px;
    vertical-align: middle;
    color: #000000 !important;
}

.nav-tabs .nav-link:hover {
    color: var(--primary-color) !important;
    background: #e9ecef;
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.nav-tabs .nav-link:hover i {
    color: var(--primary-color) !important;
}

.nav-tabs .nav-link.active {
    color: #ffffff !important;
    background: var(--primary-color) !important;
    border-color: var(--primary-color);
    border-bottom: 3px solid var(--primary-color);
    box-shadow: 0 -3px 10px rgba(0, 120, 212, 0.3);
}

.nav-tabs .nav-link.active i {
    color: #ffffff !important;
}

/* Tab Content */
.tab-content {
    padding: 40px 50px;
    min-height: 450px;
}

.tab-pane {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}

.wizard-container {
    max-width: 900px;
    margin: 30px auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.1);
    overflow: hidden;
}


/* Content Area - kept for buttons section */
.wizard-content {
    padding: 40px 50px;
    min-height: 450px;
}

.page-title {
    font-size: 24px;
    font-weight: 600;
    color: #333;
    margin-bottom: 10px;
}

.page-description {
    color: #666;
    margin-bottom: 30px;
    font-size: 14px;
}

/* Form Fields */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #333;
    font-size: 14px;
}

.form-group label.required-field::after {
    content: ' *';
    color: #d13438;
}

.form-control, .form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-control:focus, .form-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
}

.form-text {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
    display: block;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 2px solid transparent;
    transition: all 0.2s;
    cursor: pointer;
}

.checkbox-wrapper:hover {
    border-color: var(--primary-color);
    background: #f0f6ff;
}

.checkbox-wrapper input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
}

.checkbox-label {
    flex: 1;
}

.checkbox-label strong {
    display: block;
    color: #333;
    margin-bottom: 4px;
}

.checkbox-label small {
    color: #666;
    font-size: 13px;
}

/* Review Section */
.review-section {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 20px;
}

.review-section h5 {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color);
}

.review-item {
    display: flex;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.review-item:last-child {
    border-bottom: none;
}

.review-label {
    font-weight: 500;
    color: #666;
    min-width: 140px;
}

.review-value {
    color: #333;
    font-weight: 500;
}

.variant-preview {
    background: white;
    border-radius: 4px;
    padding: 15px;
    margin-top: 10px;
}

.variant-item {
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.variant-item:last-child {
    margin-bottom: 0;
}

/* Buttons */
.wizard-buttons {
    display: flex;
    justify-content: space-between;
    padding: 20px 50px;
    background: #f8f9fa;
    border-top: 1px solid var(--border-color);
}

.btn-wizard {
    padding: 10px 30px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-wizard:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-back {
    background: white;
    color: #333;
    border: 1px solid var(--border-color);
}

.btn-back:hover:not(:disabled) {
    background: #f8f9fa;
    border-color: #999;
}

.btn-next {
    background: var(--primary-color);
    color: white;
}

.btn-next:hover:not(:disabled) {
    background: #106ebe;
}

.btn-save {
    background: var(--success-color);
    color: white;
}

.btn-save:hover:not(:disabled) {
    background: #0e6b0e;
}

.btn-cancel {
    background: transparent;
    color: #666;
    border: none;
}

.btn-cancel:hover {
    color: #333;
    text-decoration: underline;
}

/* Variants Selection */
.variants-container {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 20px;
    margin-top: 20px;
}

.attribute-group {
    margin-bottom: 25px;
}

.attribute-group h6 {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 12px;
}

.attribute-values {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
}

.attribute-value {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.attribute-value:hover {
    border-color: var(--primary-color);
    background: #f0f6ff;
}

.attribute-value input[type="checkbox"] {
    margin-right: 8px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.attribute-value label {
    margin: 0;
    cursor: pointer;
    flex: 1;
    font-weight: 500;
    color: #333;
}

.variants-summary {
    margin-top: 20px;
    padding: 15px;
    background: white;
    border-radius: 6px;
    border: 2px solid var(--primary-color);
}

.variants-summary strong {
    color: var(--primary-color);
    font-size: 16px;
}

/* Loading State */
.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    background: white;
    padding: 30px;
    border-radius: 8px;
    text-align: center;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .wizard-progress {
        padding: 20px;
    }

    .wizard-content {
        padding: 30px 20px;
    }

    .wizard-buttons {
        padding: 15px 20px;
        flex-direction: column;
        gap: 10px;
    }

    .btn-wizard {
        width: 100%;
        justify-content: center;
    }

    .step-label {
        font-size: 11px;
    }
}

/* Error Messages */
.error-message {
    color: #d13438;
    font-size: 13px;
    margin-top: 5px;
    display: none;
}

.error-message.active {
    display: block;
}

.form-control.error, .form-select.error {
    border-color: #d13438;
}

.success-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
    background: var(--success-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 30px;
}
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <form method="post" id="wizardForm" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Bootstrap Tabs -->
        <ul class="nav nav-tabs mb-4" id="itemTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab"
                        data-bs-target="#basic" type="button" role="tab">
                    <i class="fas fa-info-circle"></i> {% trans "معلومات أساسية" %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="variants-tab" data-bs-toggle="tab"
                        data-bs-target="#variants" type="button" role="tab">
                    <i class="fas fa-layer-group"></i> {% trans "المتغيرات" %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="details-tab" data-bs-toggle="tab"
                        data-bs-target="#details" type="button" role="tab">
                    <i class="fas fa-cogs"></i> {% trans "التفاصيل والتحويلات" %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pricing-tab" data-bs-toggle="tab"
                        data-bs-target="#pricing" type="button" role="tab">
                    <i class="fas fa-tags"></i> {% trans "الأسعار" %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="review-tab" data-bs-toggle="tab"
                        data-bs-target="#review" type="button" role="tab">
                    <i class="fas fa-check-circle"></i> {% trans "مراجعة" %}
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="itemTabsContent">

            <!-- Step 1: Basic Information -->
            <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                <h2 class="page-title">{% trans "المعلومات الأساسية" %}</h2>
                <p class="page-description">{% trans "الرجاء إدخال المعلومات الأساسية للمادة" %}</p>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required-field">{% trans "اسم المادة" %}</label>
                            {{ form.name|add_class:"form-control" }}
                            <div class="error-message" id="error-name"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "الاسم الإنجليزي" %}</label>
                            {{ form.name_en|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required-field">{% trans "التصنيف" %}</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-control category-search-input autocomplete-search-input" placeholder="اكتب للبحث..." autocomplete="off">
                                <button type="button" class="autocomplete-clear-btn" tabindex="-1" title="مسح الاختيار">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="button" class="autocomplete-dropdown-btn" tabindex="-1" title="إظهار جميع الخيارات">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="autocomplete-list"></div>
                                <div style="display: none;">
                                    {{ form.category|add_class:"category-select" }}
                                </div>
                            </div>
                            <div class="error-message" id="error-category"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required-field">{% trans "وحدة القياس" %}</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-control base-uom-search-input autocomplete-search-input" placeholder="اكتب للبحث..." autocomplete="off">
                                <button type="button" class="autocomplete-clear-btn" tabindex="-1" title="مسح الاختيار">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="button" class="autocomplete-dropdown-btn" tabindex="-1" title="إظهار جميع الخيارات">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="autocomplete-list"></div>
                                <div style="display: none;">
                                    {{ form.base_uom|add_class:"base-uom-select" }}
                                </div>
                            </div>
                            <div class="error-message" id="error-base_uom"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required-field">{% trans "العملة" %}</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-control currency-search-input autocomplete-search-input" placeholder="اكتب للبحث..." autocomplete="off">
                                <button type="button" class="autocomplete-clear-btn" tabindex="-1" title="مسح الاختيار">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="button" class="autocomplete-dropdown-btn" tabindex="-1" title="إظهار جميع الخيارات">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="autocomplete-list"></div>
                                <div style="display: none;">
                                    {{ form.currency|add_class:"currency-select" }}
                                </div>
                            </div>
                            <div class="error-message" id="error-currency"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "العلامة التجارية" %}</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-control brand-search-input autocomplete-search-input" placeholder="اكتب للبحث..." autocomplete="off">
                                <button type="button" class="autocomplete-clear-btn" tabindex="-1" title="مسح الاختيار">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="button" class="autocomplete-dropdown-btn" tabindex="-1" title="إظهار جميع الخيارات">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="autocomplete-list"></div>
                                <div style="display: none;">
                                    {{ form.brand|add_class:"brand-select" }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- الحقول المحاسبية -->
                    <div class="col-md-12 mt-4">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-calculator"></i> {% trans "الحسابات المحاسبية" %}
                            <small class="text-muted">({% trans "اختياري" %})</small>
                        </h6>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "حساب المبيعات" %}</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-control sales-account-search-input autocomplete-search-input" placeholder="اكتب للبحث..." autocomplete="off">
                                <button type="button" class="autocomplete-clear-btn" tabindex="-1" title="مسح الاختيار">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="button" class="autocomplete-dropdown-btn" tabindex="-1" title="إظهار جميع الخيارات">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="autocomplete-list"></div>
                                <div style="display: none;">
                                    {{ form.sales_account|add_class:"sales-account-select" }}
                                </div>
                            </div>
                            <small class="form-text text-muted">{% trans "حساب إيرادات المبيعات" %}</small>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "حساب المشتريات" %}</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-control purchase-account-search-input autocomplete-search-input" placeholder="اكتب للبحث..." autocomplete="off">
                                <button type="button" class="autocomplete-clear-btn" tabindex="-1" title="مسح الاختيار">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="button" class="autocomplete-dropdown-btn" tabindex="-1" title="إظهار جميع الخيارات">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="autocomplete-list"></div>
                                <div style="display: none;">
                                    {{ form.purchase_account|add_class:"purchase-account-select" }}
                                </div>
                            </div>
                            <small class="form-text text-muted">{% trans "حساب مصروفات المشتريات" %}</small>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "حساب المخزون" %}</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-control inventory-account-search-input autocomplete-search-input" placeholder="اكتب للبحث..." autocomplete="off">
                                <button type="button" class="autocomplete-clear-btn" tabindex="-1" title="مسح الاختيار">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="button" class="autocomplete-dropdown-btn" tabindex="-1" title="إظهار جميع الخيارات">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="autocomplete-list"></div>
                                <div style="display: none;">
                                    {{ form.inventory_account|add_class:"inventory-account-select" }}
                                </div>
                            </div>
                            <small class="form-text text-muted">{% trans "حساب أصول المخزون" %}</small>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "حساب تكلفة البضاعة المباعة" %}</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" class="form-control cogs-account-search-input autocomplete-search-input" placeholder="اكتب للبحث..." autocomplete="off">
                                <button type="button" class="autocomplete-clear-btn" tabindex="-1" title="مسح الاختيار">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="button" class="autocomplete-dropdown-btn" tabindex="-1" title="إظهار جميع الخيارات">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="autocomplete-list"></div>
                                <div style="display: none;">
                                    {{ form.cost_of_goods_account|add_class:"cogs-account-select" }}
                                </div>
                            </div>
                            <small class="form-text text-muted">{% trans "حساب تكلفة المبيعات" %}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Variants -->
            <div class="tab-pane fade" id="variants" role="tabpanel" aria-labelledby="variants-tab">
                <h2 class="page-title">{% trans "المتغيرات" %}</h2>
                <p class="page-description">{% trans "هل هذه المادة لها متغيرات؟ (مثل: ألوان، مقاسات، إلخ)" %}</p>

                <div class="checkbox-wrapper" onclick="toggleCheckbox('id_has_variants')">
                    {{ form.has_variants }}
                    <div class="checkbox-label">
                        <strong>{% trans "هذه المادة لها متغيرات" %}</strong>
                        <small>{% trans "مثال: قميص بألوان ومقاسات مختلفة" %}</small>
                    </div>
                </div>

                <div id="variantsSelection" class="variants-container" style="display: none;">

                    <!-- عرض المتغيرات الموجودة في وضع التعديل -->
                    {% if is_update and existing_variants %}
                    <div class="alert alert-info mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-layer-group"></i> {% trans "المتغيرات الموجودة" %}
                            <span class="badge bg-primary ms-2">{{ existing_variants|length }}</span>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered bg-white">
                                <thead>
                                    <tr>
                                        <th width="50">#</th>
                                        <th>{% trans "الكود" %}</th>
                                        <th>{% trans "المواصفات" %}</th>
                                        <th>{% trans "السعر الأساسي" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for variant in existing_variants %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td><code class="bg-light px-2 py-1">{{ variant.code }}</code></td>
                                        <td>
                                            {% for attr_val in variant.variant_attribute_values.all %}
                                                <span class="badge bg-light text-dark border me-1">
                                                    {{ attr_val.attribute.name }}: <strong>{{ attr_val.value.value }}</strong>
                                                </span>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% if variant.base_price %}
                                                <strong class="text-success">{{ variant.base_price }}</strong>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-success mt-3 mb-0" role="alert">
                            <i class="fas fa-check-circle"></i>
                            <strong>✅ المتغيرات الموجودة محمية:</strong> عند الحفظ، سيتم الحفاظ على جميع المتغيرات الموجودة.
                            <br>
                            <small class="text-muted">لحذف أو تعديل متغيرات موجودة، يرجى استخدام صفحة إدارة المتغيرات المنفصلة.</small>
                        </div>
                    </div>
                    {% endif %}

                    <h6>
                        {% trans "اختر الخصائص والقيم:" %}
                        {% if is_update and existing_variants %}
                        <small class="text-muted">(الخصائص المستخدمة في المتغيرات الموجودة محددة تلقائياً)</small>
                        {% endif %}
                    </h6>

                    {% for attribute in variant_attributes %}
                    <div class="attribute-group">
                        <h6>{{ attribute.name }}</h6>
                        <div class="attribute-values">
                            {% for value in attribute.values.all %}
                            <div class="attribute-value">
                                <input type="checkbox"
                                       id="attr_{{ attribute.id }}_val_{{ value.id }}"
                                       class="variant-checkbox"
                                       data-attribute-id="{{ attribute.id }}"
                                       data-attribute-name="{{ attribute.name }}"
                                       data-value-id="{{ value.id }}"
                                       data-value-name="{{ value.value }}">
                                <label for="attr_{{ attribute.id }}_val_{{ value.id }}">
                                    {{ value.value }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}

                    <div class="variants-summary">
                        <strong>{% trans "عدد المتغيرات المتوقعة:" %} <span id="variantCount">0</span></strong>
                    </div>
                </div>
            </div>

            <!-- Step 3: Details & Conversions -->
            <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
                <h2 class="page-title">{% trans "التفاصيل والتحويلات" %}</h2>
                <p class="page-description">{% trans "معلومات إضافية عن المادة وتحويلات وحدات القياس (اختياري)" %}</p>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "رمز الكود" %}</label>
                            {{ form.item_code|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "الباركود" %}</label>
                            {{ form.barcode|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "رقم الكتالوج" %}</label>
                            {{ form.catalog_number|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "نسبة الضريبة" %} (%)</label>
                            {{ form.tax_rate|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "الوزن" %} (كجم)</label>
                            {{ form.weight|add_class:"form-control" }}
                        </div>
                    </div>

                    <!-- الأبعاد الفيزيائية -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>{% trans "الطول" %} (سم)</label>
                            {{ form.length|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group">
                            <label>{% trans "العرض" %} (سم)</label>
                            {{ form.width|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group">
                            <label>{% trans "الارتفاع" %} (سم)</label>
                            {{ form.height|add_class:"form-control" }}
                        </div>
                    </div>

                    <!-- معلومات الشركة المصنعة -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "الشركة المصنعة" %}</label>
                            {{ form.manufacturer|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "رقم الموديل" %}</label>
                            {{ form.model_number|add_class:"form-control" }}
                        </div>
                    </div>

                    <!-- الوصف والمميزات -->
                    <div class="col-md-12">
                        <div class="form-group">
                            <label>{% trans "وصف مختصر" %}</label>
                            {{ form.short_description|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-group">
                            <label>{% trans "الوصف التفصيلي" %}</label>
                            {{ form.description|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-group">
                            <label>{% trans "المميزات" %}</label>
                            {{ form.features|add_class:"form-control" }}
                            <small class="text-muted">{% trans "كل ميزة في سطر منفصل" %}</small>
                        </div>
                    </div>

                    <!-- الملفات والمرفقات -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "صورة المادة" %}</label>
                            {{ form.image|add_class:"form-control" }}
                            <small class="text-muted">{% trans "صورة توضيحية للمادة" %}</small>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "ملف مرفق" %}</label>
                            {{ form.attachment|add_class:"form-control" }}
                            <small class="text-muted">{% trans "ملف PDF أو مستند" %}</small>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-group">
                            <label>{% trans "اسم المرفق" %}</label>
                            {{ form.attachment_name|add_class:"form-control" }}
                        </div>
                    </div>

                    <!-- الملاحظات -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "ملاحظات" %}</label>
                            {{ form.notes|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "ملاحظات إضافية" %}</label>
                            {{ form.additional_notes|add_class:"form-control" }}
                        </div>
                    </div>

                    <!-- قسم تحويلات وحدات القياس -->
                    <div class="col-md-12 mt-4">
                        <div class="uom-conversions-section">
                            <h5 class="mb-3">
                                <i class="fas fa-exchange-alt"></i> {% trans "تحويلات وحدات القياس" %}
                            </h5>
                            <small class="text-muted d-block mb-3">
                                {% trans "أضف التحويلات بين وحدات القياس (مثل: 1 كرتون = 12 قطعة)" %}
                            </small>

                            <div id="conversionsContainer">
                                <div class="alert alert-info alert-sm mb-2" role="alert" style="padding: 0.5rem; font-size: 0.875rem;">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>ملاحظة:</strong> التحويل يتم دائماً <strong>إلى وحدة القياس الأساسية</strong> للمادة.
                                    <br>
                                    <small>مثال: إذا كانت الوحدة الأساسية "قطعة"، يمكنك إضافة: 1 كرتون = 12 قطعة</small>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered" id="conversionsTable">
                                        <thead>
                                            <tr>
                                                <th width="200">{% trans "من وحدة" %}</th>
                                                <th width="150">{% trans "المعامل" %}</th>
                                                <th width="250">{% trans "الصيغة" %}</th>
                                                <th width="80">{% trans "الإجراء" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="conversionsBody">
                                            <!-- سيتم إضافة الصفوف هنا ديناميكياً -->
                                        </tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddConversion">
                                    <i class="fas fa-plus"></i> {% trans "إضافة تحويل" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Pricing -->
            <div class="tab-pane fade" id="pricing" role="tabpanel" aria-labelledby="pricing-tab">
                <h2 class="page-title">{% trans "الأسعار" %}</h2>
                <p class="page-description">{% trans "حدد أسعار البيع للمادة في قوائم الأسعار المختلفة" %}</p>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    {% trans "أدخل الأسعار في الجدول أدناه. يمكنك ترك الخلايا فارغة إن لم يكن للمتغير سعر في قائمة معينة." %}
                </div>

                {% if price_lists %}
                <input type="hidden" id="pricing_data" name="pricing_data" value="">

                <!-- Pricing Matrix Grid -->
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-bordered table-sm table-hover" id="pricing-matrix">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="min-width: 200px; position: sticky; right: 0; background: #f8f9fa; z-index: 10;">
                                    {% trans "المتغير / المادة" %}
                                </th>
                                {% for price_list in price_lists %}
                                <th style="min-width: 120px; text-align: center;">
                                    {{ price_list.name }}<br>
                                    <small class="text-muted">{{ price_list.currency.code }}</small>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody id="pricing-matrix-body">
                            {% if object.has_variants %}
                                {% for variant in object.variants.all %}
                                <tr data-variant-id="{{ variant.id }}">
                                    <td style="position: sticky; right: 0; background: white; font-weight: 500;">
                                        <strong>{{ variant.code }}</strong>
                                        <br>
                                        <small class="text-muted" style="line-height: 1.6;">
                                            {% for attr_value in variant.variant_attribute_values.all %}
                                                <span style="display: block;">
                                                    {{ attr_value.attribute.name }}: <strong>{{ attr_value.value.value }}</strong>
                                                </span>
                                            {% endfor %}
                                        </small>
                                    </td>
                                    {% for price_list in price_lists %}
                                    <td>
                                        <input type="number"
                                               class="form-control form-control-sm price-input"
                                               step="0.001"
                                               min="0"
                                               data-variant-id="{{ variant.id }}"
                                               data-price-list-id="{{ price_list.id }}"
                                               placeholder="0.000">
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr data-variant-id="">
                                    <td style="position: sticky; right: 0; background: white; font-weight: 500;">
                                        {{ object.name }}
                                        <br><small class="text-muted">{% trans "مادة بدون متغيرات" %}</small>
                                    </td>
                                    {% for price_list in price_lists %}
                                    <td>
                                        <input type="number"
                                               class="form-control form-control-sm price-input"
                                               step="0.001"
                                               min="0"
                                               data-variant-id=""
                                               data-price-list-id="{{ price_list.id }}"
                                               placeholder="0.000">
                                    </td>
                                    {% endfor %}
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <div class="mt-3 d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-sm btn-success" id="apply-single-price-btn">
                        <i class="fas fa-tag"></i> {% trans "تطبيق سعر واحد على قائمة" %}
                    </button>
                    <button type="button" class="btn btn-sm btn-info" id="apply-percentage-btn">
                        <i class="fas fa-percent"></i> {% trans "تطبيق نسبة مئوية" %}
                    </button>
                    <button type="button" class="btn btn-sm btn-primary" id="import-excel-btn">
                        <i class="fas fa-file-excel"></i> {% trans "استيراد من Excel" %}
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="copy-first-price">
                        <i class="fas fa-copy"></i> {% trans "نسخ من قائمة لأخرى" %}
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-all-prices">
                        <i class="fas fa-eraser"></i> {% trans "مسح الكل" %}
                    </button>
                </div>

                <div class="mt-3">
                    <p class="text-muted small">
                        <i class="fas fa-lightbulb"></i>
                        {% trans "نصيحة: اترك الخلايا فارغة للأسعار التي لا تريد تحديدها الآن" %}
                    </p>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    {% trans "لم يتم العثور على قوائم أسعار. يرجى إنشاء قائمة أسعار أولاً من قائمة التسعير." %}
                </div>
                {% endif %}
            </div>

            <!-- Step 5: Review -->
            <div class="tab-pane fade" id="review" role="tabpanel" aria-labelledby="review-tab">
                <div class="review-container">
                    <div class="review-header text-center mb-4">
                        <div class="review-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <h2 class="review-main-title">{% trans "مراجعة البيانات النهائية" %}</h2>
                        <p class="review-subtitle">{% trans "تأكد من صحة جميع البيانات قبل الحفظ" %}</p>
                    </div>

                    <!-- المعلومات الأساسية -->
                    <div class="review-card">
                        <div class="review-card-header">
                            <i class="fas fa-info-circle"></i>
                            <span>{% trans "المعلومات الأساسية" %}</span>
                        </div>
                        <div class="review-card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="review-field">
                                        <label><i class="fas fa-tag"></i> {% trans "اسم المادة" %}</label>
                                        <div class="review-field-value" id="review-name">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="review-field">
                                        <label><i class="fas fa-language"></i> {% trans "الاسم الإنجليزي" %}</label>
                                        <div class="review-field-value" id="review-name-en">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="review-field">
                                        <label><i class="fas fa-folder"></i> {% trans "التصنيف" %}</label>
                                        <div class="review-field-value" id="review-category">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="review-field">
                                        <label><i class="fas fa-ruler"></i> {% trans "وحدة القياس" %}</label>
                                        <div class="review-field-value" id="review-base-uom">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="review-field">
                                        <label><i class="fas fa-dollar-sign"></i> {% trans "العملة" %}</label>
                                        <div class="review-field-value" id="review-currency">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="review-field">
                                        <label><i class="fas fa-copyright"></i> {% trans "العلامة التجارية" %}</label>
                                        <div class="review-field-value" id="review-brand">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- الحسابات المحاسبية -->
                    <div class="review-card" id="accountsReview">
                        <div class="review-card-header">
                            <i class="fas fa-calculator"></i>
                            <span>{% trans "الحسابات المحاسبية" %}</span>
                        </div>
                        <div class="review-card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="review-field">
                                        <label><i class="fas fa-shopping-cart"></i> {% trans "حساب المبيعات" %}</label>
                                        <div class="review-field-value" id="review-sales-account">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="review-field">
                                        <label><i class="fas fa-shopping-bag"></i> {% trans "حساب المشتريات" %}</label>
                                        <div class="review-field-value" id="review-purchase-account">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="review-field">
                                        <label><i class="fas fa-warehouse"></i> {% trans "حساب المخزون" %}</label>
                                        <div class="review-field-value" id="review-inventory-account">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="review-field">
                                        <label><i class="fas fa-coins"></i> {% trans "حساب تكلفة البضاعة المباعة" %}</label>
                                        <div class="review-field-value" id="review-cogs-account">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تحويلات الوحدات -->
                    <div class="review-card" id="conversionsReview" style="display: none;">
                        <div class="review-card-header">
                            <i class="fas fa-exchange-alt"></i>
                            <span>{% trans "تحويلات الوحدات" %}</span>
                            <span class="badge bg-primary" id="conversions-count">0</span>
                        </div>
                        <div class="review-card-body">
                            <div id="conversionsPreviewList"></div>
                        </div>
                    </div>

                    <!-- المتغيرات -->
                    <div class="review-card" id="variantsReview" style="display: none;">
                        <div class="review-card-header">
                            <i class="fas fa-project-diagram"></i>
                            <span>{% trans "المتغيرات" %}</span>
                            <span class="badge bg-success" id="review-variant-count">0</span>
                        </div>
                        <div class="review-card-body">
                            <div id="variantPreviewList" class="variants-grid"></div>
                        </div>
                    </div>

                    <!-- الأسعار -->
                    <div class="review-card" id="pricingReview" style="display: none;">
                        <div class="review-card-header">
                            <i class="fas fa-tags"></i>
                            <span>{% trans "الأسعار" %}</span>
                            <span class="badge bg-info" id="prices-count">0</span>
                        </div>
                        <div class="review-card-body">
                            <div id="pricingPreviewList"></div>
                        </div>
                    </div>

                    <!-- رسالة النجاح -->
                    <div class="review-success text-center">
                        <div class="success-checkmark">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4>{% trans "جميع البيانات جاهزة للحفظ" %}</h4>
                        <p class="text-muted">{% trans "يمكنك الآن حفظ المادة بكل بياناتها" %}</p>
                    </div>
                </div>
            </div>

            <!-- Hidden field for generated variants -->
            <input type="hidden" name="generated_variants" id="generated_variants" value="[]">

        </div>

        <!-- Buttons -->
        <div class="wizard-buttons" style="justify-content: flex-end;">
            <div style="display: flex; gap: 10px;">
                <a href="{{ cancel_url }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    {% trans "إلغاء" %}
                </a>
                <button type="submit" class="btn btn-success" id="btnSave">
                    <i class="fas fa-save"></i>
                    {% trans "حفظ" %}
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Modal: تطبيق سعر واحد -->
<div class="modal fade" id="applySinglePriceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "تطبيق سعر واحد على جميع المتغيرات" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{% trans "قائمة الأسعار" %}</label>
                    <select class="form-select" id="single-price-list">
                        <option value="">{% trans "اختر القائمة" %}</option>
                        {% for price_list in price_lists %}
                        <option value="{{ price_list.id }}">{{ price_list.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">{% trans "السعر" %}</label>
                    <input type="number" class="form-control" id="single-price-value"
                           step="0.001" min="0" placeholder="0.000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                <button type="button" class="btn btn-success" id="apply-single-price-confirm">
                    {% trans "تطبيق" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: تطبيق نسبة مئوية -->
<div class="modal fade" id="applyPercentageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "تطبيق نسبة مئوية" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{% trans "القائمة المصدر (النسخ منها)" %}</label>
                    <select class="form-select" id="percentage-source-list">
                        <option value="">{% trans "اختر القائمة" %}</option>
                        {% for price_list in price_lists %}
                        <option value="{{ price_list.id }}">{{ price_list.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">{% trans "القائمة الهدف (التطبيق عليها)" %}</label>
                    <select class="form-select" id="percentage-target-list">
                        <option value="">{% trans "اختر القائمة" %}</option>
                        {% for price_list in price_lists %}
                        <option value="{{ price_list.id }}">{{ price_list.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">{% trans "النسبة المئوية" %}</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="percentage-value"
                               step="0.1" placeholder="10">
                        <span class="input-group-text">%</span>
                    </div>
                    <small class="text-muted">
                        {% trans "مثال: 10 = زيادة 10%, -10 = خصم 10%" %}
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                <button type="button" class="btn btn-info" id="apply-percentage-confirm">
                    {% trans "تطبيق" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: استيراد من Excel -->
<div class="modal fade" id="importExcelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "استيراد الأسعار من Excel" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    {% trans "قم بتحميل ملف Excel يحتوي على أعمدة: كود المتغير، قائمة الأسعار، السعر" %}
                </div>

                <div class="mb-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="download-template-btn">
                        <i class="fas fa-download"></i> {% trans "تحميل قالب Excel" %}
                    </button>
                </div>

                <div class="mb-3">
                    <label class="form-label">{% trans "رفع ملف CSV" %}</label>
                    <input type="file" class="form-control" id="excel-file-input"
                           accept=".csv">
                    <small class="text-muted">{% trans "يمكنك حفظ ملف Excel كـ CSV من Excel" %}</small>
                </div>

                <div id="excel-preview" class="mt-3" style="display: none;">
                    <h6>{% trans "معاينة البيانات:" %}</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "كود المتغير" %}</th>
                                    <th>{% trans "قائمة الأسعار" %}</th>
                                    <th>{% trans "السعر" %}</th>
                                </tr>
                            </thead>
                            <tbody id="excel-preview-body"></tbody>
                        </table>
                    </div>
                    <p class="text-muted small mt-2">
                        <span id="excel-rows-count">0</span> {% trans "سطر سيتم استيراده" %}
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                <button type="button" class="btn btn-primary" id="import-excel-confirm" disabled>
                    {% trans "استيراد" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p>{% trans "جاري الحفظ..." %}</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let generatedVariants = [];
    const hasVariantsCheckbox = document.getElementById('id_has_variants');
    const variantsSelection = document.getElementById('variantsSelection');

    // ============================================
    // تفعيل Select2 للتصنيف - مثل فاتورة المشتريات
    // ============================================
    if (typeof $.fn.select2 !== 'undefined') {
        $('.select2-category').select2({
            theme: 'bootstrap-5',
            dir: 'rtl',
            language: 'ar',
            placeholder: 'اختر التصنيف',
            allowClear: false,
            width: '100%'
        });
    }

    // Has variants checkbox
    hasVariantsCheckbox.addEventListener('change', function() {
        variantsSelection.style.display = this.checked ? 'block' : 'none';

        if (!this.checked) {
            document.querySelectorAll('.variant-checkbox').forEach(cb => cb.checked = false);
            updateVariantCount();
        }
    });

    // Variant checkboxes
    document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateVariantCount);
    });

    function updateVariantCount() {
        const variants = calculateVariants();
        document.getElementById('variantCount').textContent = variants.length;
    }

    function calculateVariants() {
        const attributes = {};

        document.querySelectorAll('.variant-checkbox:checked').forEach(cb => {
            const attrId = cb.dataset.attributeId;
            const attrName = cb.dataset.attributeName;
            const valueId = cb.dataset.valueId;
            const valueName = cb.dataset.valueName;

            if (!attributes[attrId]) {
                attributes[attrId] = {
                    name: attrName,
                    values: []
                };
            }

            attributes[attrId].values.push({
                id: valueId,
                name: valueName
            });
        });

        const attributeKeys = Object.keys(attributes);
        if (attributeKeys.length === 0) return [];

        // Calculate cartesian product
        const combinations = cartesianProduct(
            attributeKeys.map(key => attributes[key].values)
        );

        return combinations.map((combo, index) => ({
            index: index + 1,
            combination: combo,
            code: `V${(index + 1).toString().padStart(3, '0')}`,
            description: combo.map(v => v.name).join(' - ')
        }));
    }

    function cartesianProduct(arrays) {
        return arrays.reduce((acc, curr) => {
            const result = [];
            acc.forEach(a => {
                curr.forEach(b => {
                    result.push([...a, b]);
                });
            });
            return result;
        }, [[]]);
    }

    // Generate variants when checkbox changes
    hasVariantsCheckbox.addEventListener('change', function() {
        if (this.checked) {
            generatedVariants = calculateVariants();
            document.getElementById('generated_variants').value = JSON.stringify(generatedVariants);
        } else {
            generatedVariants = [];
            document.getElementById('generated_variants').value = '[]';
        }
    });

    // ============================================
    // UOM Conversions Management
    // ============================================
    const uomList = {{ uom_list_json|safe|default:"[]" }};
    let conversionIndex = 0;

    console.log('🔍 UOM Conversions initialized');
    console.log('📊 uomList:', uomList);
    console.log('📊 uomList length:', uomList.length);

    function addConversionRow() {
        try {
            console.log('➕ addConversionRow called');
            console.log('📊 Current conversionIndex:', conversionIndex);

            // التحقق من وجود tbody
            const tbody = document.getElementById('conversionsBody');
            if (!tbody) {
                console.error('❌ conversionsBody not found in DOM!');
                console.error('   Checking if table exists:', document.getElementById('conversionsTable'));
                alert('خطأ: جدول التحويلات غير موجود. تأكد من أنك في الخطوة 3.');
                return;
            }
            console.log('✅ conversionsBody found:', tbody);

            // التحقق من uomList
            if (!uomList) {
                console.error('❌ uomList is undefined!');
                alert('خطأ: قائمة وحدات القياس غير معرّفة.');
                return;
            }

            if (uomList.length === 0) {
                console.error('❌ uomList is empty!');
                alert('لا توجد وحدات قياس متاحة.\n\nيرجى:\n1. إضافة وحدات قياس أولاً من قائمة الإعدادات\n2. أو التواصل مع المسؤول');
                return;
            }
            console.log('✅ uomList has', uomList.length, 'items');

            // التحقق من base_uom
            const baseUom = document.getElementById('id_base_uom');
            if (!baseUom) {
                console.error('❌ base_uom field not found!');
                alert('خطأ: حقل الوحدة الأساسية غير موجود.');
                return;
            }

            if (!baseUom.value) {
                console.warn('⚠️ base_uom not selected yet');
                alert('يرجى اختيار وحدة قياس أساسية أولاً من الخطوة 1.');
                return;
            }
            console.log('✅ base_uom is set to:', baseUom.options[baseUom.selectedIndex].text);

            const currentIndex = conversionIndex;
            const row = document.createElement('tr');
            row.dataset.index = currentIndex;

            // Build UOM options (exclude base_uom to prevent meaningless conversions)
            let uomOptions = '<option value="">اختر الوحدة</option>';
            // استخدم baseUom المُعرّف في الأعلى - لا تُعرّفه مرة أخرى
            const baseUomId = baseUom ? baseUom.value : null;

        uomList.forEach(uom => {
            // Skip base_uom - can't convert from base unit to itself
            if (baseUomId && uom.id == baseUomId) {
                return; // skip this iteration
            }

            const symbol = uom.symbol ? `(${uom.symbol})` : '';
            uomOptions += `<option value="${uom.id}">${uom.name} ${symbol}</option>`;
        });

        // Build row HTML
        row.innerHTML = `
            <td>
                <select name="conversion_from_uom_${currentIndex}"
                        class="form-select form-select-sm conversion-from-uom"
                        data-index="${currentIndex}">
                    ${uomOptions}
                </select>
            </td>
            <td>
                <input type="number"
                       name="conversion_factor_${currentIndex}"
                       class="form-control form-control-sm conversion-factor"
                       placeholder="1.0"
                       step="0.001"
                       min="0.001"
                       data-index="${currentIndex}">
            </td>
            <td>
                <small class="text-muted conversion-formula" id="conversion_formula_${currentIndex}">
                    -
                </small>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger btn-remove-conversion">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;

        // Append row
        tbody.appendChild(row);

        // Add event listeners
        const fromSelect = row.querySelector('.conversion-from-uom');
        const factorInput = row.querySelector('.conversion-factor');
        const deleteBtn = row.querySelector('.btn-remove-conversion');

        // Update formula when from_uom or factor changes
        function updateFormula() {
            const fromUomId = fromSelect.value;
            const factor = factorInput.value;
            // استخدم baseUom من outer scope - لا تُعرّفه مرة أخرى
            const formulaSpan = document.getElementById(`conversion_formula_${currentIndex}`);

            if (fromUomId && factor && baseUom && baseUom.value) {
                const fromUomText = fromSelect.options[fromSelect.selectedIndex].text;
                const baseUomText = baseUom.options[baseUom.selectedIndex].text;
                formulaSpan.textContent = `1 ${fromUomText} = ${factor} ${baseUomText}`;
            } else {
                formulaSpan.textContent = '-';
            }
        }

        fromSelect.addEventListener('change', updateFormula);
        factorInput.addEventListener('input', updateFormula);

        // Delete handler
        deleteBtn.addEventListener('click', function() {
            row.remove();
            console.log('🗑️ Conversion row removed');
            console.log('📊 Total rows now:', tbody.children.length);
        });

            conversionIndex++;

            console.log('✅ Conversion row added successfully');
            console.log('📊 Total rows now:', tbody.children.length);

        } catch (error) {
            console.error('❌ Error in addConversionRow:', error);
            console.error('   Error message:', error.message);
            console.error('   Error stack:', error.stack);
            alert('حدث خطأ أثناء إضافة صف التحويل:\n' + error.message + '\n\nيرجى فتح Console (F12) لمزيد من التفاصيل.');
        }
    }

    // ============================================
    // Attach button event listener using EVENT DELEGATION
    // هذه الطريقة تضمن عمل الزر حتى لو تم إعادة إنشاء DOM
    // ============================================

    // طريقة 1: Event Delegation (الأكثر موثوقية)
    document.body.addEventListener('click', function(e) {
        // تحقق إذا كان العنصر المضغوط هو الزر أو داخل الزر
        const btn = e.target.closest('#btnAddConversion');
        if (btn) {
            e.preventDefault();
            e.stopPropagation();
            console.log('🖱️ Add Conversion button clicked (via delegation)');
            addConversionRow();
        }
    });

    // طريقة 2: Direct listener (backup)
    // محاولة إضافة event listener مباشرة
    function attachConversionButtonListener() {
        const btnAddConversion = document.getElementById('btnAddConversion');
        if (btnAddConversion) {
            // إزالة أي listeners قديمة
            const newBtn = btnAddConversion.cloneNode(true);
            btnAddConversion.parentNode.replaceChild(newBtn, btnAddConversion);

            // إضافة listener جديد
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('🖱️ Add Conversion button clicked (direct)');
                addConversionRow();
            });
            console.log('✅ Add Conversion button event listener attached (direct method)');
            return true;
        } else {
            console.error('❌ btnAddConversion not found!');
            return false;
        }
    }

    // محاولة الإضافة فوراً
    const listenerAttached = attachConversionButtonListener();

    // إذا فشلت، حاول مرة أخرى بعد تأخير قصير
    if (!listenerAttached) {
        console.log('⏳ Retrying to attach listener after delay...');
        setTimeout(function() {
            attachConversionButtonListener();
        }, 500);
    }

    console.log('✅ Event delegation for conversions button is active');

    // ============================================
    // تحميل البيانات الموجودة (للتعديل فقط)
    // ============================================
    console.log('🔍 Checking is_update status:', {{ is_update|yesno:"true,false,null" }});
    {% if is_update %}
    console.log('✅ is_update is TRUE - loading existing data...');

    // 1. تحميل المتغيرات الموجودة
    {% if existing_variants %}
    const existingVariants = [
        {% for variant in existing_variants %}
        {
            id: {{ variant.id }},
            code: "{{ variant.code }}",
            description: "{{ variant.get_full_name|escapejs }}",
            attributes: [
                {% for attr_val in variant.variant_attribute_values.all %}
                {
                    attribute_id: {{ attr_val.attribute.id }},
                    value_id: {{ attr_val.value.id }},
                    attribute_name: "{{ attr_val.attribute.name|escapejs }}",
                    value_name: "{{ attr_val.value.value|escapejs }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    console.log('📊 Existing variants with attributes:', existingVariants);

    // إذا كان للمادة متغيرات، املأ القائمة وولّد جداول الأسعار
    if (existingVariants.length > 0) {
        generatedVariants = existingVariants;

        // ✅ تفعيل checkbox الـ has_variants وإظهار قسم المتغيرات
        if (hasVariantsCheckbox) {
            hasVariantsCheckbox.checked = true;
            // إظهار قسم المتغيرات
            const variantsSelection = document.getElementById('variantsSelection');
            if (variantsSelection) {
                variantsSelection.style.display = 'block';
            }
        }

        const generatedVariantsField = document.getElementById('generated_variants');
        if (generatedVariantsField) {
            generatedVariantsField.value = JSON.stringify(existingVariants);
        }

        const variantCountElement = document.getElementById('variantCount');
        if (variantCountElement) {
            variantCountElement.textContent = existingVariants.length;
        }

        const variantPreviewElement = document.getElementById('variantPreview');
        if (variantPreviewElement) {
            variantPreviewElement.innerHTML = existingVariants
                .map(v => `<div class="variant-chip">${v.description}</div>`)
                .join('');
        }

        // ✅ تحديد الـ checkboxes للخصائص المستخدمة في المتغيرات الموجودة
        // استخدم setTimeout للتأكد من أن DOM جاهز
        setTimeout(() => {
            console.log('🔍 Auto-checking variant attribute checkboxes...');
            const usedAttributeValues = new Set();

            // جمع جميع الخصائص والقيم المستخدمة
            existingVariants.forEach(variant => {
                variant.attributes.forEach(attr => {
                    const key = `${attr.attribute_id}_${attr.value_id}`;
                    usedAttributeValues.add(key);
                    console.log(`   - Found: ${attr.attribute_name} = ${attr.value_name} (${key})`);
                });
            });

            console.log(`📊 Total unique attribute-value combinations: ${usedAttributeValues.size}`);

            // تحديد الـ checkboxes المناسبة
            let checkedCount = 0;
            usedAttributeValues.forEach(key => {
                const [attrId, valId] = key.split('_');
                const checkbox = document.getElementById(`attr_${attrId}_val_${valId}`);
                if (checkbox) {
                    checkbox.checked = true;
                    checkedCount++;
                    console.log(`   ✅ Checked: attr_${attrId}_val_${valId}`);
                } else {
                    console.warn(`   ⚠️ Checkbox not found: attr_${attrId}_val_${valId}`);
                }
            });

            console.log(`✅ Auto-checked ${checkedCount} checkboxes`);

            // تحديث عداد المتغيرات بناءً على الخصائص المحددة
            const variantCountElement = document.getElementById('variantCount');
            if (variantCountElement) {
                variantCountElement.textContent = existingVariants.length;
                console.log(`📊 Updated variant count display: ${existingVariants.length}`);
            }
        }, 500); // انتظر 500ms للتأكد من أن DOM جاهز
    }
    {% endif %}

    // 2. تحميل التحويلات الموجودة
    try {
        const existingConversionsRaw = '{{ existing_conversions_json|escapejs }}';
        console.log('🔍 Raw existing_conversions_json:', existingConversionsRaw);
        console.log('🔍 Length:', existingConversionsRaw.length);
        console.log('🔍 Is []?', existingConversionsRaw === '[]');
        console.log('🔍 Is empty?', existingConversionsRaw === '');

        if (existingConversionsRaw && existingConversionsRaw !== '[]' && existingConversionsRaw !== '') {
            const existingConversions = JSON.parse(existingConversionsRaw);
            console.log('🔄 Loading existing conversions...');
            console.log('📊 Existing conversions:', existingConversions);
            console.log('📊 Count:', existingConversions.length);

            if (existingConversions.length > 0) {

    existingConversions.forEach((conversion, idx) => {
        console.log(`Loading conversion ${idx + 1}:`, conversion);
        const tbody = document.getElementById('conversionsBody');

        const currentIndex = conversionIndex;
        const row = document.createElement('tr');
        row.dataset.index = currentIndex;

        // Build UOM options (exclude base_uom to prevent meaningless conversions)
        let uomOptions = '<option value="">اختر الوحدة</option>';
        const baseUom = document.getElementById('id_base_uom');
        const baseUomId = baseUom ? baseUom.value : null;

        uomList.forEach(uom => {
            // Skip base_uom - can't convert from base unit to itself
            if (baseUomId && uom.id == baseUomId) {
                return; // skip this iteration
            }

            const symbol = uom.symbol ? `(${uom.symbol})` : '';
            uomOptions += `<option value="${uom.id}">${uom.name} ${symbol}</option>`;
        });

        // Build row HTML
        row.innerHTML = `
            <td>
                <select name="conversion_from_uom_${currentIndex}"
                        class="form-select form-select-sm conversion-from-uom"
                        data-index="${currentIndex}">
                    ${uomOptions}
                </select>
            </td>
            <td>
                <input type="number"
                       name="conversion_factor_${currentIndex}"
                       class="form-control form-control-sm conversion-factor"
                       placeholder="1.0"
                       step="0.001"
                       min="0.001"
                       value="${conversion.factor}"
                       data-index="${currentIndex}">
            </td>
            <td>
                <small class="text-muted conversion-formula" id="conversion_formula_${currentIndex}">
                    ${conversion.formula || '-'}
                </small>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger btn-remove-conversion">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;

        tbody.appendChild(row);

        // Set selected value
        const fromSelect = row.querySelector('.conversion-from-uom');
        const factorInput = row.querySelector('.conversion-factor');
        const deleteBtn = row.querySelector('.btn-remove-conversion');

        fromSelect.value = conversion.from_uom_id;

        // Update formula function
        function updateFormula() {
            const fromUomId = fromSelect.value;
            const factor = factorInput.value;
            // استخدم baseUom من outer scope (line 1588) - لا تُعرّفه مرة أخرى
            const formulaSpan = document.getElementById(`conversion_formula_${currentIndex}`);

            if (fromUomId && factor && baseUom && baseUom.value) {
                const fromUomText = fromSelect.options[fromSelect.selectedIndex].text;
                const baseUomText = baseUom.options[baseUom.selectedIndex].text;
                formulaSpan.textContent = `1 ${fromUomText} = ${factor} ${baseUomText}`;
            } else {
                formulaSpan.textContent = '-';
            }
        }

        // Add event listeners
        fromSelect.addEventListener('change', updateFormula);
        factorInput.addEventListener('input', updateFormula);

        // Delete handler
        deleteBtn.addEventListener('click', function() {
            row.remove();
            console.log('🗑️ Conversion row removed');
            console.log('📊 Total rows now:', tbody.children.length);
        });

        // Initial formula update
        setTimeout(updateFormula, 100);

        conversionIndex++;
        console.log(`✅ Conversion ${idx + 1} loaded successfully`);
    });

            console.log(`✅ All ${existingConversions.length} conversions loaded`);
            console.log('📊 Total conversion rows:', document.getElementById('conversionsBody').children.length);
            } else {
                console.log('⚠️ existingConversions array is empty');
            }
        } else {
            console.log('⚠️ No existing conversions to load - raw value is empty or []');
        }
    } catch (error) {
        console.error('❌ Error loading conversions:', error);
    }

    {% endif %}
    // ============================================
    // نهاية تحميل البيانات الموجودة
    // ============================================

    // ============================================
    // إدارة جدول الأسعار (Pricing Matrix)
    // ============================================

    // تحميل الأسعار الموجودة
    {% if existing_prices_json %}
    try {
        const existingPrices = JSON.parse('{{ existing_prices_json|escapejs }}');
        console.log('💰 Loading existing prices:', existingPrices);

        document.querySelectorAll('.price-input').forEach(input => {
            const variantId = input.dataset.variantId || '';
            const priceListId = input.dataset.priceListId;
            const key = `${variantId}_${priceListId}`;

            if (existingPrices[key]) {
                input.value = existingPrices[key].price;
                input.dataset.existingId = existingPrices[key].id;
                console.log(`  ✅ Loaded price for ${key}: ${existingPrices[key].price}`);
            }
        });

        console.log('✅ All existing prices loaded');
    } catch (error) {
        console.error('❌ Error loading existing prices:', error);
    }
    {% endif %}

    // ===========================================
    // Pricing Helpers - أدوات مساعدة للأسعار
    // ===========================================

    // 1. تطبيق سعر واحد على قائمة
    const applySinglePriceBtn = document.getElementById('apply-single-price-btn');
    if (applySinglePriceBtn) {
        applySinglePriceBtn.addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('applySinglePriceModal'));
            modal.show();
        });
    }

    const applySinglePriceConfirm = document.getElementById('apply-single-price-confirm');
    if (applySinglePriceConfirm) {
        applySinglePriceConfirm.addEventListener('click', function() {
            const priceListId = document.getElementById('single-price-list').value;
            const priceValue = parseFloat(document.getElementById('single-price-value').value);

            if (!priceListId || !priceValue || priceValue <= 0) {
                alert('الرجاء إدخال قائمة الأسعار والسعر');
                return;
            }

            // تطبيق السعر على جميع المتغيرات في هذه القائمة
            let count = 0;
            document.querySelectorAll('.price-input').forEach(input => {
                if (input.dataset.priceListId == priceListId) {
                    input.value = priceValue.toFixed(3);
                    count++;
                }
            });

            bootstrap.Modal.getInstance(document.getElementById('applySinglePriceModal')).hide();
            alert(`تم تطبيق السعر ${priceValue} على ${count} متغير`);
        });
    }

    // 2. تطبيق نسبة مئوية
    const applyPercentageBtn = document.getElementById('apply-percentage-btn');
    if (applyPercentageBtn) {
        applyPercentageBtn.addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('applyPercentageModal'));
            modal.show();
        });
    }

    const applyPercentageConfirm = document.getElementById('apply-percentage-confirm');
    if (applyPercentageConfirm) {
        applyPercentageConfirm.addEventListener('click', function() {
            const sourceListId = document.getElementById('percentage-source-list').value;
            const targetListId = document.getElementById('percentage-target-list').value;
            const percentage = parseFloat(document.getElementById('percentage-value').value);

            if (!sourceListId || !targetListId || isNaN(percentage)) {
                alert('الرجاء إدخال جميع البيانات المطلوبة');
                return;
            }

            if (sourceListId === targetListId) {
                alert('يجب اختيار قائمتين مختلفتين');
                return;
            }

            // حساب الأسعار الجديدة
            let count = 0;
            const rows = document.querySelectorAll('#pricing-matrix-body tr');
            rows.forEach(row => {
                const variantId = row.dataset.variantId;
                const sourceInput = row.querySelector(`input[data-price-list-id="${sourceListId}"]`);
                const targetInput = row.querySelector(`input[data-price-list-id="${targetListId}"]`);

                if (sourceInput && targetInput && sourceInput.value) {
                    const sourcePrice = parseFloat(sourceInput.value);
                    const newPrice = sourcePrice * (1 + percentage / 100);
                    targetInput.value = newPrice.toFixed(3);
                    count++;
                }
            });

            bootstrap.Modal.getInstance(document.getElementById('applyPercentageModal')).hide();
            alert(`تم تطبيق النسبة ${percentage}% على ${count} متغير`);
        });
    }

    // 3. استيراد من Excel
    const importExcelBtn = document.getElementById('import-excel-btn');
    if (importExcelBtn) {
        importExcelBtn.addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('importExcelModal'));
            modal.show();
        });
    }

    // تحميل قالب CSV
    const downloadTemplateBtn = document.getElementById('download-template-btn');
    if (downloadTemplateBtn) {
        downloadTemplateBtn.addEventListener('click', function() {
            // إنشاء CSV مع جميع المتغيرات وقوائم الأسعار
            let csv = 'كود المتغير,قائمة الأسعار,السعر\n';

            // إضافة صفوف لجميع المتغيرات × قوائم الأسعار
            const rows = document.querySelectorAll('#pricing-matrix-body tr');
            const priceLists = [];
            {% for pl in price_lists %}
            priceLists.push({id: '{{ pl.id }}', name: '{{ pl.name }}'});
            {% endfor %}

            rows.forEach(row => {
                const variantCode = row.querySelector('td:first-child').textContent.split('\n')[0].trim();
                priceLists.forEach(pl => {
                    csv += `${variantCode},${pl.name},0.000\n`;
                });
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'pricing_template.csv';
            link.click();
        });
    }

    // معالجة رفع CSV
    const excelFileInput = document.getElementById('excel-file-input');
    let parsedData = [];

    if (excelFileInput) {
        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const csvText = event.target.result;
                parsedData = parseCSV(csvText);

                // عرض المعاينة
                displayPreview(parsedData);

                // تفعيل زر الاستيراد
                document.getElementById('import-excel-confirm').disabled = false;
            };
            reader.readAsText(file);
        });
    }

    function parseCSV(text) {
        const lines = text.split('\n');
        const data = [];

        // تخطي الصف الأول (العناوين)
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const parts = line.split(',');
            if (parts.length >= 3) {
                data.push({
                    variantCode: parts[0].trim(),
                    priceListName: parts[1].trim(),
                    price: parseFloat(parts[2].trim())
                });
            }
        }

        return data;
    }

    function displayPreview(data) {
        const preview = document.getElementById('excel-preview');
        const tbody = document.getElementById('excel-preview-body');
        const rowsCount = document.getElementById('excel-rows-count');

        tbody.innerHTML = '';
        data.slice(0, 10).forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.variantCode}</td>
                <td>${row.priceListName}</td>
                <td>${row.price.toFixed(3)}</td>
            `;
            tbody.appendChild(tr);
        });

        rowsCount.textContent = data.length;
        preview.style.display = 'block';
    }

    // تأكيد الاستيراد
    const importExcelConfirm = document.getElementById('import-excel-confirm');
    if (importExcelConfirm) {
        importExcelConfirm.addEventListener('click', function() {
            if (parsedData.length === 0) {
                alert('لا توجد بيانات للاستيراد');
                return;
            }

            // بناء mapping لقوائم الأسعار
            const priceListMapping = {};
            {% for pl in price_lists %}
            priceListMapping['{{ pl.name }}'] = '{{ pl.id }}';
            {% endfor %}

            // تطبيق الأسعار
            let successCount = 0;
            let failCount = 0;

            parsedData.forEach(row => {
                const priceListId = priceListMapping[row.priceListName];
                if (!priceListId) {
                    failCount++;
                    return;
                }

                // البحث عن الحقل المناسب
                const rows = document.querySelectorAll('#pricing-matrix-body tr');
                let found = false;

                rows.forEach(tableRow => {
                    const variantCode = tableRow.querySelector('td:first-child').textContent.split('\n')[0].trim();
                    if (variantCode === row.variantCode) {
                        const input = tableRow.querySelector(`input[data-price-list-id="${priceListId}"]`);
                        if (input) {
                            input.value = row.price.toFixed(3);
                            successCount++;
                            found = true;
                        }
                    }
                });

                if (!found) failCount++;
            });

            bootstrap.Modal.getInstance(document.getElementById('importExcelModal')).hide();
            alert(`تم الاستيراد بنجاح!\n✅ ${successCount} سعر\n❌ ${failCount} فشل`);

            // إعادة تعيين
            parsedData = [];
            excelFileInput.value = '';
            document.getElementById('excel-preview').style.display = 'none';
            document.getElementById('import-excel-confirm').disabled = true;
        });
    }

    // مسح جميع الأسعار
    const clearAllBtn = document.getElementById('clear-all-prices');
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', function() {
            if (confirm('هل أنت متأكد من مسح جميع الأسعار؟')) {
                document.querySelectorAll('.price-input').forEach(input => {
                    input.value = '';
                });
            }
        });
    }

    // نسخ سعر أول قائمة لجميع القوائم
    const copyFirstPriceBtn = document.getElementById('copy-first-price');
    if (copyFirstPriceBtn) {
        copyFirstPriceBtn.addEventListener('click', function() {
            const rows = document.querySelectorAll('#pricing-matrix-body tr');
            rows.forEach(row => {
                const inputs = row.querySelectorAll('.price-input');
                if (inputs.length > 0) {
                    const firstPrice = inputs[0].value;
                    if (firstPrice && firstPrice > 0) {
                        inputs.forEach((input, index) => {
                            if (index > 0) { // skip first one
                                input.value = firstPrice;
                            }
                        });
                    }
                }
            });
        });
    }

    // جمع بيانات الأسعار قبل الإرسال
    function collectPricingData() {
        const pricingData = [];
        const inputs = document.querySelectorAll('.price-input');

        inputs.forEach(input => {
            const price = parseFloat(input.value);
            if (price && price > 0) { // فقط الأسعار المملوءة
                pricingData.push({
                    variant_id: input.dataset.variantId || null,
                    price_list_id: input.dataset.priceListId,
                    price: price,
                    existing_id: input.dataset.existingId || null
                });
            }
        });

        return pricingData;
    }

    // Form submission
    document.getElementById('wizardForm').addEventListener('submit', function(e) {
        // جمع بيانات الأسعار وحفظها في حقل مخفي
        const pricingDataField = document.getElementById('pricing_data');
        if (pricingDataField) {
            const pricingData = collectPricingData();
            pricingDataField.value = JSON.stringify(pricingData);
            console.log('💰 Pricing data collected:', pricingData.length, 'prices');
        }

        document.getElementById('loadingOverlay').classList.add('active');
    });

    // ============================================
    // Initialize All Select Autocompletes
    // ============================================
    initSelectAutocomplete($('.category-search-input'), $('.category-select'));
    initSelectAutocomplete($('.base-uom-search-input'), $('.base-uom-select'));
    initSelectAutocomplete($('.currency-search-input'), $('.currency-select'));
    initSelectAutocomplete($('.brand-search-input'), $('.brand-select'));
    initSelectAutocomplete($('.sales-account-search-input'), $('.sales-account-select'));
    initSelectAutocomplete($('.purchase-account-search-input'), $('.purchase-account-select'));
    initSelectAutocomplete($('.inventory-account-search-input'), $('.inventory-account-select'));
    initSelectAutocomplete($('.cogs-account-search-input'), $('.cogs-account-select'));

    // ============================================
    // Update Review Tab
    // ============================================
    $('#review-tab').on('shown.bs.tab', function() {
        updateReviewTab();
    });

    function updateReviewTab() {
        console.log('🔄 Updating review tab...');

        // المعلومات الأساسية
        const name = $('#id_name').val() || '-';
        const nameEn = $('#id_name_en').val() || '-';
        const category = $('.category-search-input').val() || '-';
        const baseUom = $('.base-uom-search-input').val() || '-';
        const currency = $('.currency-search-input').val() || '-';
        const brand = $('.brand-search-input').val() || '-';

        console.log('📋 Basic Info:', {name, nameEn, category, baseUom, currency, brand});

        $('#review-name').text(name);
        $('#review-name-en').text(nameEn);
        $('#review-category').text(category);
        $('#review-base-uom').text(baseUom);
        $('#review-currency').text(currency);
        $('#review-brand').text(brand);

        // الحسابات المحاسبية
        const salesAccount = $('.sales-account-search-input').val() || '-';
        const purchaseAccount = $('.purchase-account-search-input').val() || '-';
        const inventoryAccount = $('.inventory-account-search-input').val() || '-';
        const cogsAccount = $('.cogs-account-search-input').val() || '-';

        $('#review-sales-account').text(salesAccount);
        $('#review-purchase-account').text(purchaseAccount);
        $('#review-inventory-account').text(inventoryAccount);
        $('#review-cogs-account').text(cogsAccount);

        // التحويلات
        const conversionsCount = $('#conversionsTableBody tr').length;
        if (conversionsCount > 0) {
            $('#conversionsReview').show();
            $('#conversions-count').text(conversionsCount);
            const $convList = $('#conversionsPreviewList');
            $convList.empty();

            const conversions = [];
            $('#conversionsTableBody tr').each(function() {
                const fromUnit = $(this).find('select[id^="from_unit_"]').find('option:selected').text().trim();
                const toUnit = $(this).find('select[id^="to_unit_"]').find('option:selected').text().trim();
                const factor = $(this).find('input[id^="factor_"]').val();
                const formula = $(this).find('input[id^="formula_"]').val();

                if (fromUnit && toUnit && factor) {
                    conversions.push(`<div class="conversion-item">
                        <strong>${fromUnit}</strong>
                        <i class="fas fa-arrow-left"></i>
                        <strong>${toUnit}</strong>
                        <span style="margin-right: auto;">المعامل: <strong>${factor}</strong></span>
                        ${formula ? '<small style="color: #718096;">(' + formula + ')</small>' : ''}
                    </div>`);
                }
            });

            if (conversions.length > 0) {
                $convList.html(conversions.join(''));
            }
        } else {
            $('#conversionsReview').hide();
        }

        // المتغيرات
        const hasVariants = $('#id_has_variants').is(':checked');

        if (hasVariants) {
            // جمع الخصائص المحددة
            const selectedAttributes = {};
            $('.variant-checkbox:checked').each(function() {
                const attrName = $(this).data('attribute-name');
                const valueName = $(this).data('value-name');

                if (!selectedAttributes[attrName]) {
                    selectedAttributes[attrName] = [];
                }
                selectedAttributes[attrName].push(valueName);
            });

            const attrKeys = Object.keys(selectedAttributes);

            if (attrKeys.length > 0) {
                $('#variantsReview').show();

                // حساب عدد المتغيرات المتوقعة
                let variantCount = 1;
                attrKeys.forEach(key => {
                    variantCount *= selectedAttributes[key].length;
                });

                $('#review-variant-count').text(variantCount);

                const $previewList = $('#variantPreviewList');
                $previewList.empty();

                // عرض الخصائص المحددة
                let variantsHtml = '<div class="mb-3">';
                attrKeys.forEach(attrName => {
                    variantsHtml += `<div class="mb-2">
                        <strong style="color: #667eea;"><i class="fas fa-tag"></i> ${attrName}:</strong>
                        <div style="margin-top: 8px;">`;

                    selectedAttributes[attrName].forEach(valueName => {
                        variantsHtml += `<span class="badge bg-light text-dark border me-2" style="font-size: 14px; padding: 6px 12px;">${valueName}</span>`;
                    });

                    variantsHtml += '</div></div>';
                });
                variantsHtml += '</div>';

                variantsHtml += `<div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle"></i>
                    <strong>سيتم إنشاء ${variantCount} متغير</strong> من التوافيق المختلفة للخصائص المحددة
                </div>`;

                $previewList.html(variantsHtml);
            } else {
                $('#variantsReview').hide();
            }
        } else {
            $('#variantsReview').hide();
        }

        // الأسعار
        console.log('📊 Collecting pricing data...');
        let pricingData = [];

        // جمع الأسعار مباشرة من جدول التسعير
        $('#pricing-matrix-body tr').each(function() {
            const $row = $(this);
            const variantCode = $row.find('td:first strong').text().trim();
            const variantId = $row.data('variant-id') || '';

            console.log('Processing row:', {variantCode, variantId});

            $row.find('input.price-input').each(function(index) {
                const $input = $(this);
                const price = $input.val();

                if (price && parseFloat(price) > 0) {
                    const priceListId = $input.data('price-list-id');

                    // البحث عن اسم قائمة الأسعار من الهيدر بناءً على الموقع
                    // الخلية الأولى هي اسم المتغير، لذا نضيف 1 للفهرس
                    const $headerCells = $('#pricing-matrix thead th');
                    const $headerCell = $headerCells.eq(index + 1);
                    let priceListName = 'قائمة الأسعار';

                    if ($headerCell.length) {
                        // استخراج اسم القائمة (السطر الأول قبل <br>)
                        const headerHtml = $headerCell.html();
                        if (headerHtml) {
                            priceListName = headerHtml.split('<br>')[0].trim();
                            // إزالة أي تاجات HTML متبقية
                            priceListName = $('<div>').html(priceListName).text();
                        }
                    }

                    pricingData.push({
                        variant_code: variantCode || 'المادة الأساسية',
                        price: price,
                        price_list_id: priceListId,
                        price_list_name: priceListName,
                        currency: currency
                    });

                    console.log('Found price:', {variantCode, priceListName, price, headerIndex: index + 1});
                }
            });
        });

        console.log('Total prices collected:', pricingData.length);

        if (pricingData && pricingData.length > 0) {
            $('#pricingReview').show();
            $('#prices-count').text(pricingData.length);
            const $pricingList = $('#pricingPreviewList');
            $pricingList.empty();

            // تجميع الأسعار حسب قائمة الأسعار
            const pricesByList = {};
            pricingData.forEach(function(price) {
                const listName = price.price_list_name || 'قائمة الأسعار';
                if (!pricesByList[listName]) {
                    pricesByList[listName] = [];
                }
                pricesByList[listName].push(price);
            });

            let pricingHtml = '';
            Object.keys(pricesByList).forEach(function(listName) {
                const prices = pricesByList[listName];
                pricingHtml += `<div class="price-list-section">
                    <h6><i class="fas fa-list"></i> ${listName}</h6>`;

                prices.forEach(function(price) {
                    const priceValue = parseFloat(price.price);
                    const formattedPrice = priceValue.toLocaleString('ar-EG', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 3
                    });

                    pricingHtml += `<div class="price-item">
                        <span><strong>${price.variant_code || 'المادة الأساسية'}</strong></span>
                        <span class="price-value">${formattedPrice} ${price.currency || currency}</span>
                    </div>`;
                });

                pricingHtml += '</div>';
            });

            $pricingList.html(pricingHtml);
        } else {
            $('#pricingReview').hide();
        }
    }

    // ============================================
    // Generic Select Autocomplete Function
    // ============================================
    function initSelectAutocomplete($input, $select) {
        // Prevent double initialization
        if ($input.data('autocomplete-initialized')) return;
        $input.data('autocomplete-initialized', true);

        var $wrapper = $input.closest('.autocomplete-wrapper');
        var $list = $wrapper.find('.autocomplete-list');
        var $clearBtn = $wrapper.find('.autocomplete-clear-btn');
        var currentIndex = -1;
        var filteredOptions = [];

        // Update clear button visibility
        function updateClearButton() {
            if ($select.val()) {
                $clearBtn.addClass('show');
            } else {
                $clearBtn.removeClass('show');
            }
        }

        // Extract level from option text (looks for indentation)
        function getLevel(text) {
            var spaces = text.match(/^(\s*)/)[0].length;
            return Math.floor(spaces / 2) + 1;
        }

        // Show all options
        function showAllOptions() {
            filteredOptions = [];
            $select.find('option').each(function() {
                var value = $(this).val();
                var text = $(this).text().trim();
                var fullText = $(this).text(); // with spaces for level detection
                if (value) {
                    filteredOptions.push({
                        value: value,
                        text: text,
                        level: getLevel(fullText)
                    });
                }
            });
            renderList();
            $list.addClass('show');
            $wrapper.addClass('open');
            currentIndex = -1;
        }

        // Filter options based on input
        function filterOptions(searchTerm) {
            filteredOptions = [];
            searchTerm = searchTerm.toLowerCase();

            $select.find('option').each(function() {
                var value = $(this).val();
                var text = $(this).text().trim();
                var fullText = $(this).text();
                if (value && text.toLowerCase().includes(searchTerm)) {
                    filteredOptions.push({
                        value: value,
                        text: text,
                        level: getLevel(fullText)
                    });
                }
            });

            renderList();
            $list.addClass('show');
            $wrapper.addClass('open');
            currentIndex = -1;
        }

        // Render filtered list
        function renderList() {
            $list.empty();

            if (filteredOptions.length === 0) {
                $list.html('<div class="autocomplete-list-item" style="color: #999;">لا توجد نتائج</div>');
                return;
            }

            filteredOptions.forEach(function(option, index) {
                var $item = $('<div class="autocomplete-list-item"></div>')
                    .attr('data-level', option.level)
                    .data('value', option.value)
                    .data('index', index);

                // Add level indicator
                var $indicator = $('<span class="level-indicator"></span>');
                $item.append($indicator);

                // Add text
                $item.append(document.createTextNode(option.text));

                // Mark as selected if it's the current value
                if (option.value == $select.val()) {
                    $item.addClass('selected');
                }

                $item.on('click', function() {
                    selectOption(option.value, option.text);
                });

                $list.append($item);
            });
        }

        // Select an option
        function selectOption(value, text) {
            $select.val(value).trigger('change');
            $input.val(text);
            $list.removeClass('show');
            $wrapper.removeClass('open');
            currentIndex = -1;
            updateClearButton();
        }

        // Clear selection
        function clearSelection() {
            $select.val('').trigger('change');
            $input.val('');
            $list.removeClass('show');
            $wrapper.removeClass('open');
            updateClearButton();
            $input.focus();
        }

        // Input events
        $input.on('input', function() {
            var searchTerm = $(this).val().trim();
            if (searchTerm === '') {
                showAllOptions();
            } else {
                filterOptions(searchTerm);
            }
        });

        $input.on('focus', function() {
            var searchTerm = $(this).val().trim();
            if (searchTerm === '') {
                showAllOptions();
            } else {
                filterOptions(searchTerm);
            }
        });

        // Keyboard navigation
        $input.on('keydown', function(e) {
            if (!$list.hasClass('show')) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentIndex = Math.min(currentIndex + 1, filteredOptions.length - 1);
                updateActiveItem();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentIndex = Math.max(currentIndex - 1, 0);
                updateActiveItem();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentIndex >= 0 && currentIndex < filteredOptions.length) {
                    var option = filteredOptions[currentIndex];
                    selectOption(option.value, option.text);
                }
            } else if (e.key === 'Escape') {
                $list.removeClass('show');
            }
        });

        function updateActiveItem() {
            $list.find('.autocomplete-list-item').removeClass('active');
            var $items = $list.find('.autocomplete-list-item');
            if (currentIndex >= 0 && currentIndex < $items.length) {
                var $activeItem = $items.eq(currentIndex);
                $activeItem.addClass('active');

                // Scroll into view
                var listHeight = $list.height();
                var itemTop = $activeItem.position().top;
                var itemHeight = $activeItem.outerHeight();

                if (itemTop < 0) {
                    $list.scrollTop($list.scrollTop() + itemTop);
                } else if (itemTop + itemHeight > listHeight) {
                    $list.scrollTop($list.scrollTop() + (itemTop + itemHeight - listHeight));
                }
            }
        }

        // Clear button click
        $clearBtn.on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            clearSelection();
        });

        // Dropdown button click - show all options
        $wrapper.find('.autocomplete-dropdown-btn').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            if ($list.hasClass('show')) {
                $list.removeClass('show');
                $wrapper.removeClass('open');
            } else {
                showAllOptions();
                $input.focus();
            }
        });

        // Close on click outside
        $(document).on('click', function(e) {
            if (!$wrapper.is(e.target) && $wrapper.has(e.target).length === 0) {
                $list.removeClass('show');
                $wrapper.removeClass('open');
            }
        });

        // If select has a value, show it in input
        if ($select.val()) {
            var selectedText = $select.find('option:selected').text().trim();
            $input.val(selectedText);
        }

        // Initialize clear button visibility
        updateClearButton();
    }
});

function toggleCheckbox(id) {
    const checkbox = document.getElementById(id);
    checkbox.checked = !checkbox.checked;
    checkbox.dispatchEvent(new Event('change'));
}
</script>
{% endblock %}
