{% extends 'base/base.html' %}
{% load i18n static widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
/* Windows Wizard Style */
:root {
    --primary-color: #0078d4;
    --success-color: #107c10;
    --border-color: #e1e1e1;
    --bg-light: #f3f3f3;
}

.wizard-container {
    max-width: 900px;
    margin: 30px auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* Progress Steps */
.wizard-progress {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 30px 50px;
    background: linear-gradient(to bottom, #ffffff, #f8f9fa);
    border-bottom: 2px solid var(--border-color);
}

.wizard-step {
    flex: 1;
    text-align: center;
    position: relative;
}

.wizard-step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    right: -50%;
    width: 100%;
    height: 2px;
    background: var(--border-color);
    z-index: 0;
}

.wizard-step.active:not(:last-child)::after,
.wizard-step.completed:not(:last-child)::after {
    background: var(--primary-color);
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    border: 2px solid var(--border-color);
    color: #666;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 16px;
    margin: 0 auto 8px;
    position: relative;
    z-index: 1;
    transition: all 0.3s ease;
}

.wizard-step.active .step-circle {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
    transform: scale(1.1);
}

.wizard-step.completed .step-circle {
    background: var(--success-color);
    border-color: var(--success-color);
    color: white;
}

.wizard-step.completed .step-circle::before {
    content: '\f00c';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
}

.wizard-step.completed .step-circle span {
    display: none;
}

.step-label {
    font-size: 13px;
    color: #666;
    font-weight: 500;
}

.wizard-step.active .step-label {
    color: var(--primary-color);
    font-weight: 600;
}

.wizard-step.completed .step-label {
    color: var(--success-color);
}

/* Content Area */
.wizard-content {
    padding: 40px 50px;
    min-height: 450px;
}

.wizard-page {
    display: none;
}

.wizard-page.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}

.page-title {
    font-size: 24px;
    font-weight: 600;
    color: #333;
    margin-bottom: 10px;
}

.page-description {
    color: #666;
    margin-bottom: 30px;
    font-size: 14px;
}

/* Form Fields */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #333;
    font-size: 14px;
}

.form-group label.required-field::after {
    content: ' *';
    color: #d13438;
}

.form-control, .form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-control:focus, .form-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
}

.form-text {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
    display: block;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 2px solid transparent;
    transition: all 0.2s;
    cursor: pointer;
}

.checkbox-wrapper:hover {
    border-color: var(--primary-color);
    background: #f0f6ff;
}

.checkbox-wrapper input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
}

.checkbox-label {
    flex: 1;
}

.checkbox-label strong {
    display: block;
    color: #333;
    margin-bottom: 4px;
}

.checkbox-label small {
    color: #666;
    font-size: 13px;
}

/* Review Section */
.review-section {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 20px;
}

.review-section h5 {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color);
}

.review-item {
    display: flex;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.review-item:last-child {
    border-bottom: none;
}

.review-label {
    font-weight: 500;
    color: #666;
    min-width: 140px;
}

.review-value {
    color: #333;
    font-weight: 500;
}

.variant-preview {
    background: white;
    border-radius: 4px;
    padding: 15px;
    margin-top: 10px;
}

.variant-item {
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.variant-item:last-child {
    margin-bottom: 0;
}

/* Buttons */
.wizard-buttons {
    display: flex;
    justify-content: space-between;
    padding: 20px 50px;
    background: #f8f9fa;
    border-top: 1px solid var(--border-color);
}

.btn-wizard {
    padding: 10px 30px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-wizard:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-back {
    background: white;
    color: #333;
    border: 1px solid var(--border-color);
}

.btn-back:hover:not(:disabled) {
    background: #f8f9fa;
    border-color: #999;
}

.btn-next {
    background: var(--primary-color);
    color: white;
}

.btn-next:hover:not(:disabled) {
    background: #106ebe;
}

.btn-save {
    background: var(--success-color);
    color: white;
}

.btn-save:hover:not(:disabled) {
    background: #0e6b0e;
}

.btn-cancel {
    background: transparent;
    color: #666;
    border: none;
}

.btn-cancel:hover {
    color: #333;
    text-decoration: underline;
}

/* Variants Selection */
.variants-container {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 20px;
    margin-top: 20px;
}

.attribute-group {
    margin-bottom: 25px;
}

.attribute-group h6 {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 12px;
}

.attribute-values {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
}

.attribute-value {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.attribute-value:hover {
    border-color: var(--primary-color);
    background: #f0f6ff;
}

.attribute-value input[type="checkbox"] {
    margin-right: 8px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.attribute-value label {
    margin: 0;
    cursor: pointer;
    flex: 1;
    font-weight: 500;
    color: #333;
}

.variants-summary {
    margin-top: 20px;
    padding: 15px;
    background: white;
    border-radius: 6px;
    border: 2px solid var(--primary-color);
}

.variants-summary strong {
    color: var(--primary-color);
    font-size: 16px;
}

/* Loading State */
.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    background: white;
    padding: 30px;
    border-radius: 8px;
    text-align: center;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .wizard-progress {
        padding: 20px;
    }

    .wizard-content {
        padding: 30px 20px;
    }

    .wizard-buttons {
        padding: 15px 20px;
        flex-direction: column;
        gap: 10px;
    }

    .btn-wizard {
        width: 100%;
        justify-content: center;
    }

    .step-label {
        font-size: 11px;
    }
}

/* Error Messages */
.error-message {
    color: #d13438;
    font-size: 13px;
    margin-top: 5px;
    display: none;
}

.error-message.active {
    display: block;
}

.form-control.error, .form-select.error {
    border-color: #d13438;
}

.success-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
    background: var(--success-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 30px;
}
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <form method="post" id="wizardForm" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Progress Steps -->
        <div class="wizard-progress">
            <div class="wizard-step active" data-step="1">
                <div class="step-circle"><span>1</span></div>
                <div class="step-label">{% trans "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©" %}</div>
            </div>
            <div class="wizard-step" data-step="2">
                <div class="step-circle"><span>2</span></div>
                <div class="step-label">{% trans "Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª" %}</div>
            </div>
            <div class="wizard-step" data-step="3">
                <div class="step-circle"><span>3</span></div>
                <div class="step-label">{% trans "Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±" %}</div>
            </div>
            <div class="wizard-step" data-step="4">
                <div class="step-circle"><span>4</span></div>
                <div class="step-label">{% trans "Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ­ÙØ¸" %}</div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="wizard-content">

            <!-- Step 1: Basic Information -->
            <div class="wizard-page active" data-step="1">
                <h2 class="page-title">{% trans "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©" %}</h2>
                <p class="page-description">{% trans "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù…Ø§Ø¯Ø©" %}</p>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required-field">{% trans "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" %}</label>
                            {{ form.name|add_class:"form-control" }}
                            <div class="error-message" id="error-name"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ" %}</label>
                            {{ form.name_en|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required-field">{% trans "Ø§Ù„ØªØµÙ†ÙŠÙ" %}</label>
                            {{ form.category|add_class:"form-select" }}
                            <div class="error-message" id="error-category"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required-field">{% trans "ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³" %}</label>
                            {{ form.base_uom|add_class:"form-select" }}
                            <div class="error-message" id="error-base_uom"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="required-field">{% trans "Ø§Ù„Ø¹Ù…Ù„Ø©" %}</label>
                            {{ form.currency|add_class:"form-select" }}
                            <div class="error-message" id="error-currency"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©" %}</label>
                            {{ form.brand|add_class:"form-select" }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Variants -->
            <div class="wizard-page" data-step="2">
                <h2 class="page-title">{% trans "Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª" %}</h2>
                <p class="page-description">{% trans "Ù‡Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ù‡Ø§ Ù…ØªØºÙŠØ±Ø§ØªØŸ (Ù…Ø«Ù„: Ø£Ù„ÙˆØ§Ù†ØŒ Ù…Ù‚Ø§Ø³Ø§ØªØŒ Ø¥Ù„Ø®)" %}</p>

                <div class="checkbox-wrapper" onclick="toggleCheckbox('id_has_variants')">
                    {{ form.has_variants }}
                    <div class="checkbox-label">
                        <strong>{% trans "Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ù‡Ø§ Ù…ØªØºÙŠØ±Ø§Øª" %}</strong>
                        <small>{% trans "Ù…Ø«Ø§Ù„: Ù‚Ù…ÙŠØµ Ø¨Ø£Ù„ÙˆØ§Ù† ÙˆÙ…Ù‚Ø§Ø³Ø§Øª Ù…Ø®ØªÙ„ÙØ©" %}</small>
                    </div>
                </div>

                <div id="variantsSelection" class="variants-container" style="display: none;">

                    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                    {% if is_update and existing_variants %}
                    <div class="alert alert-info mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-layer-group"></i> {% trans "Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©" %}
                            <span class="badge bg-primary ms-2">{{ existing_variants|length }}</span>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered bg-white">
                                <thead>
                                    <tr>
                                        <th width="50">#</th>
                                        <th>{% trans "Ø§Ù„ÙƒÙˆØ¯" %}</th>
                                        <th>{% trans "Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª" %}</th>
                                        <th>{% trans "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for variant in existing_variants %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td><code class="bg-light px-2 py-1">{{ variant.code }}</code></td>
                                        <td>
                                            {% for attr_val in variant.variant_attribute_values.all %}
                                                <span class="badge bg-light text-dark border me-1">
                                                    {{ attr_val.attribute.name }}: <strong>{{ attr_val.value.value }}</strong>
                                                </span>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% if variant.base_price %}
                                                <strong class="text-success">{{ variant.base_price }}</strong>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-success mt-3 mb-0" role="alert">
                            <i class="fas fa-check-circle"></i>
                            <strong>âœ… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø­Ù…ÙŠØ©:</strong> Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙ‚Ø·.
                            <br>
                            <small class="text-muted">Ù„Ø­Ø°Ù Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø©.</small>
                        </div>
                    </div>
                    {% endif %}

                    <h6>
                        {% trans "Ø§Ø®ØªØ± Ø§Ù„Ø®ØµØ§Ø¦Øµ ÙˆØ§Ù„Ù‚ÙŠÙ…:" %}
                        {% if is_update and existing_variants %}
                        <small class="text-muted">(Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø­Ø¯Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</small>
                        {% endif %}
                    </h6>

                    {% for attribute in variant_attributes %}
                    <div class="attribute-group">
                        <h6>{{ attribute.name }}</h6>
                        <div class="attribute-values">
                            {% for value in attribute.values.all %}
                            <div class="attribute-value">
                                <input type="checkbox"
                                       id="attr_{{ attribute.id }}_val_{{ value.id }}"
                                       class="variant-checkbox"
                                       data-attribute-id="{{ attribute.id }}"
                                       data-attribute-name="{{ attribute.name }}"
                                       data-value-id="{{ value.id }}"
                                       data-value-name="{{ value.value }}">
                                <label for="attr_{{ attribute.id }}_val_{{ value.id }}">
                                    {{ value.value }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}

                    <div class="variants-summary">
                        <strong>{% trans "Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:" %} <span id="variantCount">0</span></strong>
                    </div>
                </div>
            </div>

            <!-- Step 3: Details & Pricing -->
            <div class="wizard-page" data-step="3">
                <h2 class="page-title">{% trans "Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±" %}</h2>
                <p class="page-description">{% trans "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" %}</p>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ø±Ù…Ø² Ø§Ù„ÙƒÙˆØ¯" %}</label>
                            {{ form.item_code|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" %}</label>
                            {{ form.barcode|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ø±Ù‚Ù… Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬" %}</label>
                            {{ form.catalog_number|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©" %} (%)</label>
                            {{ form.tax_rate|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ø§Ù„ÙˆØ²Ù†" %} (ÙƒØ¬Ù…)</label>
                            {{ form.weight|add_class:"form-control" }}
                        </div>
                    </div>

                    <!-- Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ© -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>{% trans "Ø§Ù„Ø·ÙˆÙ„" %} (Ø³Ù…)</label>
                            {{ form.length|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group">
                            <label>{% trans "Ø§Ù„Ø¹Ø±Ø¶" %} (Ø³Ù…)</label>
                            {{ form.width|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group">
                            <label>{% trans "Ø§Ù„Ø§Ø±ØªÙØ§Ø¹" %} (Ø³Ù…)</label>
                            {{ form.height|add_class:"form-control" }}
                        </div>
                    </div>

                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø© -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©" %}</label>
                            {{ form.manufacturer|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„" %}</label>
                            {{ form.model_number|add_class:"form-control" }}
                        </div>
                    </div>

                    <!-- Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…Ù…ÙŠØ²Ø§Øª -->
                    <div class="col-md-12">
                        <div class="form-group">
                            <label>{% trans "ÙˆØµÙ Ù…Ø®ØªØµØ±" %}</label>
                            {{ form.short_description|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-group">
                            <label>{% trans "Ø§Ù„ÙˆØµÙ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ" %}</label>
                            {{ form.description|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-group">
                            <label>{% trans "Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª" %}</label>
                            {{ form.features|add_class:"form-control" }}
                            <small class="text-muted">{% trans "ÙƒÙ„ Ù…ÙŠØ²Ø© ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„" %}</small>
                        </div>
                    </div>

                    <!-- Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø¯Ø©" %}</label>
                            {{ form.image|add_class:"form-control" }}
                            <small class="text-muted">{% trans "ØµÙˆØ±Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ù„Ù„Ù…Ø§Ø¯Ø©" %}</small>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ù…Ù„Ù Ù…Ø±ÙÙ‚" %}</label>
                            {{ form.attachment|add_class:"form-control" }}
                            <small class="text-muted">{% trans "Ù…Ù„Ù PDF Ø£Ùˆ Ù…Ø³ØªÙ†Ø¯" %}</small>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-group">
                            <label>{% trans "Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚" %}</label>
                            {{ form.attachment_name|add_class:"form-control" }}
                        </div>
                    </div>

                    <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ù…Ù„Ø§Ø­Ø¸Ø§Øª" %}</label>
                            {{ form.notes|add_class:"form-control" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label>{% trans "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©" %}</label>
                            {{ form.additional_notes|add_class:"form-control" }}
                        </div>
                    </div>

                    <!-- Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± -->
                    <div class="col-md-12">
                        <div class="pricing-section">
                            <h5 class="pricing-title">
                                <i class="fas fa-tags"></i> {% trans "Ø§Ù„Ø£Ø³Ø¹Ø§Ø±" %}
                            </h5>
                            <small class="text-muted">{% trans "Ø£Ø¶Ù Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© Ù„ÙƒÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±" %}</small>

                            {% if price_lists %}
                                <!-- Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ù„Ù…ÙˆØ§Ø¯ Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±Ø§Øª -->
                                <div id="simplePricesSection" style="display: block;">
                                    <table class="table table-sm table-bordered mt-3">
                                        <thead>
                                            <tr>
                                                <th>{% trans "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø¹Ø±" %}</th>
                                                <th width="150">{% trans "Ø§Ù„Ø³Ø¹Ø±" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for price_list in price_lists %}
                                            <tr>
                                                <td>
                                                    <strong>{{ price_list.name }}</strong>
                                                    {% if price_list.is_default %}
                                                        <span class="badge bg-warning text-dark ms-1">
                                                            <i class="fas fa-star"></i> {% trans "Ø§ÙØªØ±Ø§Ø¶ÙŠ" %}
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="input-group input-group-sm">
                                                        <input type="number"
                                                               class="form-control price-input"
                                                               name="price_{{ price_list.id }}"
                                                               id="price_{{ price_list.id }}"
                                                               placeholder="0.00"
                                                               step="0.001"
                                                               min="0">
                                                        <span class="input-group-text">{{ price_list.currency.symbol }}</span>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª -->
                                <div id="variantPricesSection" style="display: none;">
                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle"></i>
                                        {% trans "ÙŠØ±Ø¬Ù‰ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù‡Ù†Ø§." %}
                                    </div>
                                    <div id="variantPricesTables"></div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    {% trans "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø± Ù†Ø´Ø·Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹." %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Ù‚Ø³Ù… ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ -->
                    <div class="col-md-12 mt-4">
                        <div class="uom-conversions-section">
                            <h5 class="mb-3">
                                <i class="fas fa-exchange-alt"></i> {% trans "ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³" %}
                            </h5>
                            <small class="text-muted d-block mb-3">
                                {% trans "Ø£Ø¶Ù Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø¨ÙŠÙ† ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ (Ù…Ø«Ù„: 1 ÙƒØ±ØªÙˆÙ† = 12 Ù‚Ø·Ø¹Ø©)" %}
                            </small>

                            <div id="conversionsContainer">
                                <div class="alert alert-info alert-sm mb-2" role="alert" style="padding: 0.5rem; font-size: 0.875rem;">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙŠØªÙ… Ø¯Ø§Ø¦Ù…Ø§Ù‹ <strong>Ø¥Ù„Ù‰ ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</strong> Ù„Ù„Ù…Ø§Ø¯Ø©.
                                    <br>
                                    <small>Ù…Ø«Ø§Ù„: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© "Ù‚Ø·Ø¹Ø©"ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ©: 1 ÙƒØ±ØªÙˆÙ† = 12 Ù‚Ø·Ø¹Ø©</small>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered" id="conversionsTable">
                                        <thead>
                                            <tr>
                                                <th width="200">{% trans "Ù…Ù† ÙˆØ­Ø¯Ø©" %}</th>
                                                <th width="150">{% trans "Ø§Ù„Ù…Ø¹Ø§Ù…Ù„" %}</th>
                                                <th width="250">{% trans "Ø§Ù„ØµÙŠØºØ©" %}</th>
                                                <th width="80">{% trans "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="conversionsBody">
                                            <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                                        </tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddConversion">
                                    <i class="fas fa-plus"></i> {% trans "Ø¥Ø¶Ø§ÙØ© ØªØ­ÙˆÙŠÙ„" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review -->
            <div class="wizard-page" data-step="4">
                <h2 class="page-title">{% trans "Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" %}</h2>
                <p class="page-description">{% trans "ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸" %}</p>

                <div class="review-section">
                    <h5>{% trans "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©" %}</h5>
                    <div class="review-item">
                        <div class="review-label">{% trans "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:" %}</div>
                        <div class="review-value" id="review-name">-</div>
                    </div>
                    <div class="review-item">
                        <div class="review-label">{% trans "Ø§Ù„ØªØµÙ†ÙŠÙ:" %}</div>
                        <div class="review-value" id="review-category">-</div>
                    </div>
                    <div class="review-item">
                        <div class="review-label">{% trans "ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³:" %}</div>
                        <div class="review-value" id="review-base_uom">-</div>
                    </div>
                    <div class="review-item">
                        <div class="review-label">{% trans "Ø§Ù„Ø¹Ù…Ù„Ø©:" %}</div>
                        <div class="review-value" id="review-currency">-</div>
                    </div>
                </div>

                <div class="review-section" id="variantsReview" style="display: none;">
                    <h5>{% trans "Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª" %}</h5>
                    <div class="review-item">
                        <div class="review-label">{% trans "Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª:" %}</div>
                        <div class="review-value" id="review-variant-count">0</div>
                    </div>
                    <div class="variant-preview" id="variantPreviewList"></div>
                </div>

                <div class="text-center mt-4">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <p>{% trans "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø­ÙØ¸" %}</p>
                </div>
            </div>

            <!-- Hidden field for generated variants -->
            <input type="hidden" name="generated_variants" id="generated_variants" value="[]">

        </div>

        <!-- Buttons -->
        <div class="wizard-buttons">
            <div>
                <button type="button" class="btn-wizard btn-back" id="btnBack" disabled>
                    <i class="fas fa-chevron-right"></i>
                    {% trans "Ø§Ù„Ø³Ø§Ø¨Ù‚" %}
                </button>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="{{ cancel_url }}" class="btn-wizard btn-cancel">
                    {% trans "Ø¥Ù„ØºØ§Ø¡" %}
                </a>
                <button type="button" class="btn-wizard btn-next" id="btnNext">
                    {% trans "Ø§Ù„ØªØ§Ù„ÙŠ" %}
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button type="submit" class="btn-wizard btn-save" id="btnSave" style="display: none;">
                    <i class="fas fa-save"></i>
                    {% trans "Ø­ÙØ¸" %}
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p>{% trans "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..." %}</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 4;
    let generatedVariants = [];

    const btnBack = document.getElementById('btnBack');
    const btnNext = document.getElementById('btnNext');
    const btnSave = document.getElementById('btnSave');
    const hasVariantsCheckbox = document.getElementById('id_has_variants');
    const variantsSelection = document.getElementById('variantsSelection');

    // Navigate to step
    function goToStep(step) {
        if (step < 1 || step > totalSteps) return;

        // Hide all pages
        document.querySelectorAll('.wizard-page').forEach(page => {
            page.classList.remove('active');
        });

        // Show current page
        document.querySelector(`.wizard-page[data-step="${step}"]`).classList.add('active');

        // Update progress
        document.querySelectorAll('.wizard-step').forEach(stepEl => {
            const stepNum = parseInt(stepEl.dataset.step);
            stepEl.classList.remove('active', 'completed');

            if (stepNum < step) {
                stepEl.classList.add('completed');
            } else if (stepNum === step) {
                stepEl.classList.add('active');
            }
        });

        // Update buttons
        btnBack.disabled = (step === 1);

        if (step === totalSteps) {
            btnNext.style.display = 'none';
            btnSave.style.display = 'inline-flex';
            updateReview();
        } else {
            btnNext.style.display = 'inline-flex';
            btnSave.style.display = 'none';
        }

        currentStep = step;
    }

    // Validation
    function validateStep(step) {
        let isValid = true;
        const errors = [];

        // Clear previous errors
        document.querySelectorAll('.error-message').forEach(el => {
            el.classList.remove('active');
            el.textContent = '';
        });
        document.querySelectorAll('.form-control, .form-select').forEach(el => {
            el.classList.remove('error');
        });

        if (step === 1) {
            // Validate basic info
            const name = document.getElementById('id_name');
            const category = document.getElementById('id_category');
            const base_uom = document.getElementById('id_base_uom');
            const currency = document.getElementById('id_currency');

            if (!name.value.trim()) {
                showError('name', '{% trans "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" %}');
                isValid = false;
            }

            if (!category.value) {
                showError('category', '{% trans "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ" %}');
                isValid = false;
            }

            if (!base_uom.value) {
                showError('base_uom', '{% trans "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³" %}');
                isValid = false;
            }

            if (!currency.value) {
                showError('currency', '{% trans "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©" %}');
                isValid = false;
            }
        }

        if (step === 2) {
            // Generate variants if has_variants is checked
            if (hasVariantsCheckbox.checked) {
                generatedVariants = calculateVariants();
                document.getElementById('generated_variants').value = JSON.stringify(generatedVariants);

                // Generate variant price tables for step 3
                if (generatedVariants.length > 0) {
                    generateVariantPricesTables(generatedVariants);
                }
            } else {
                generatedVariants = [];
                document.getElementById('generated_variants').value = '[]';
            }
        }

        return isValid;
    }

    function showError(fieldName, message) {
        const field = document.getElementById('id_' + fieldName);
        const errorEl = document.getElementById('error-' + fieldName);

        if (field) field.classList.add('error');
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }
    }

    // Next button
    btnNext.addEventListener('click', function() {
        if (validateStep(currentStep)) {
            goToStep(currentStep + 1);
        }
    });

    // Back button
    btnBack.addEventListener('click', function() {
        goToStep(currentStep - 1);
    });

    // Has variants checkbox
    hasVariantsCheckbox.addEventListener('change', function() {
        variantsSelection.style.display = this.checked ? 'block' : 'none';

        // Toggle pricing sections
        const simplePricesSection = document.getElementById('simplePricesSection');
        const variantPricesSection = document.getElementById('variantPricesSection');

        if (this.checked) {
            // Show variant prices message, hide simple prices
            if (simplePricesSection) simplePricesSection.style.display = 'none';
            if (variantPricesSection) variantPricesSection.style.display = 'block';
        } else {
            // Show simple prices, hide variant prices message
            if (simplePricesSection) simplePricesSection.style.display = 'block';
            if (variantPricesSection) variantPricesSection.style.display = 'none';
        }

        if (!this.checked) {
            document.querySelectorAll('.variant-checkbox').forEach(cb => cb.checked = false);
            updateVariantCount();
        }
    });

    // Variant checkboxes
    document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateVariantCount);
    });

    function updateVariantCount() {
        const variants = calculateVariants();
        document.getElementById('variantCount').textContent = variants.length;
    }

    function calculateVariants() {
        const attributes = {};

        document.querySelectorAll('.variant-checkbox:checked').forEach(cb => {
            const attrId = cb.dataset.attributeId;
            const attrName = cb.dataset.attributeName;
            const valueId = cb.dataset.valueId;
            const valueName = cb.dataset.valueName;

            if (!attributes[attrId]) {
                attributes[attrId] = {
                    name: attrName,
                    values: []
                };
            }

            attributes[attrId].values.push({
                id: valueId,
                name: valueName
            });
        });

        const attributeKeys = Object.keys(attributes);
        if (attributeKeys.length === 0) return [];

        // Calculate cartesian product
        const combinations = cartesianProduct(
            attributeKeys.map(key => attributes[key].values)
        );

        return combinations.map((combo, index) => ({
            index: index + 1,
            combination: combo,
            code: `V${(index + 1).toString().padStart(3, '0')}`,
            description: combo.map(v => v.name).join(' - ')
        }));
    }

    function cartesianProduct(arrays) {
        return arrays.reduce((acc, curr) => {
            const result = [];
            acc.forEach(a => {
                curr.forEach(b => {
                    result.push([...a, b]);
                });
            });
            return result;
        }, [[]]);
    }

    // Generate variant prices tables
    function generateVariantPricesTables(variants) {
        console.log('ğŸ¯ generateVariantPricesTables called with:', variants);

        const container = document.getElementById('variantPricesTables');
        if (!container) {
            console.error('âŒ variantPricesTables container not found!');
            return;
        }

        container.innerHTML = '';

        const priceLists = {{ price_lists_json|safe|default:"[]" }};
        console.log('ğŸ“‹ Price lists:', priceLists);

        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
        let variantsPricesData = {};
        {% if variants_prices_data %}
        variantsPricesData = {{ variants_prices_data|safe }};
        console.log('ğŸ’° Loaded variants prices data:', variantsPricesData);
        console.log('ğŸ’° Keys:', Object.keys(variantsPricesData));
        {% else %}
        console.log('âš ï¸ No variants_prices_data available');
        {% endif %}

        if (!priceLists || priceLists.length === 0) {
            container.innerHTML = `
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    {% trans "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø± Ù†Ø´Ø·Ø©." %}
                </div>
            `;
            return;
        }

        let tablesHTML = '<div class="variant-prices-tables mt-3">';

        // Create a table for each price list
        priceLists.forEach(priceList => {
            tablesHTML += `
                <div class="price-list-table mb-4">
                    <h6 class="border-bottom pb-2">
                        <i class="fas fa-list-alt"></i> ${priceList.name}
                        ${priceList.is_default ? '<span class="badge bg-warning text-dark ms-2"><i class="fas fa-star"></i> Ø§ÙØªØ±Ø§Ø¶ÙŠ</span>' : ''}
                    </h6>
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th width="120">{% trans "Ø§Ù„ÙƒÙˆØ¯" %}</th>
                                <th>{% trans "Ø§Ù„Ù…ØªØºÙŠØ±" %}</th>
                                <th width="150">{% trans "Ø§Ù„Ø³Ø¹Ø±" %} (${priceList.currency__symbol})</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            variants.forEach((variant, index) => {
                // Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
                let existingPrice = '';
                const variantIdStr = String(variant.id);
                const priceListIdStr = String(priceList.id);

                console.log(`   Checking variant ${variantIdStr} (${variant.code}) for price list ${priceListIdStr}`);
                console.log(`   - Has variant.id? ${!!variant.id}`);
                console.log(`   - variantsPricesData[${variantIdStr}] exists? ${!!variantsPricesData[variantIdStr]}`);

                if (variant.id && variantsPricesData[variantIdStr]) {
                    console.log(`   - Available prices for variant:`, variantsPricesData[variantIdStr]);
                    if (variantsPricesData[variantIdStr][priceListIdStr]) {
                        existingPrice = variantsPricesData[variantIdStr][priceListIdStr];
                        console.log(`   âœ… Found price: ${existingPrice}`);
                    } else {
                        console.log(`   âš ï¸ No price for price list ${priceListIdStr}`);
                    }
                } else {
                    console.log(`   âš ï¸ No price data for variant ${variantIdStr}`);
                }

                tablesHTML += `
                    <tr>
                        <td><code>${variant.code}</code></td>
                        <td><small>${variant.description}</small></td>
                        <td>
                            <input type="number"
                                   class="form-control form-control-sm"
                                   name="variant_price_${priceList.id}_${index}"
                                   data-variant-index="${index}"
                                   data-price-list-id="${priceList.id}"
                                   data-variant-id="${variant.id || ''}"
                                   placeholder="0.00"
                                   step="0.001"
                                   min="0"
                                   value="${existingPrice}">
                        </td>
                    </tr>
                `;
            });

            tablesHTML += `
                        </tbody>
                    </table>
                </div>
            `;
        });

        tablesHTML += '</div>';
        container.innerHTML = tablesHTML;
    }

    // Update review
    function updateReview() {
        document.getElementById('review-name').textContent = document.getElementById('id_name').value || '-';

        const category = document.getElementById('id_category');
        document.getElementById('review-category').textContent =
            category.options[category.selectedIndex]?.text || '-';

        const base_uom = document.getElementById('id_base_uom');
        document.getElementById('review-base_uom').textContent =
            base_uom.options[base_uom.selectedIndex]?.text || '-';

        const currency = document.getElementById('id_currency');
        document.getElementById('review-currency').textContent =
            currency.options[currency.selectedIndex]?.text || '-';

        // Variants review
        if (hasVariantsCheckbox.checked && generatedVariants.length > 0) {
            document.getElementById('variantsReview').style.display = 'block';
            document.getElementById('review-variant-count').textContent = generatedVariants.length;

            let variantsHTML = '';
            generatedVariants.slice(0, 5).forEach(variant => {
                variantsHTML += `
                    <div class="variant-item">
                        <span><strong>${variant.code}</strong></span>
                        <span>${variant.description}</span>
                    </div>
                `;
            });

            if (generatedVariants.length > 5) {
                variantsHTML += `<div class="variant-item"><em>... Ùˆ ${generatedVariants.length - 5} Ù…ØªØºÙŠØ± Ø¢Ø®Ø±</em></div>`;
            }

            document.getElementById('variantPreviewList').innerHTML = variantsHTML;
        } else {
            document.getElementById('variantsReview').style.display = 'none';
        }
    }

    // ============================================
    // UOM Conversions Management
    // ============================================
    const uomList = {{ uom_list_json|safe|default:"[]" }};
    let conversionIndex = 0;

    console.log('ğŸ” UOM Conversions initialized');
    console.log('ğŸ“Š uomList:', uomList);
    console.log('ğŸ“Š uomList length:', uomList.length);

    function addConversionRow() {
        try {
            console.log('â• addConversionRow called');
            console.log('ğŸ“Š Current conversionIndex:', conversionIndex);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ tbody
            const tbody = document.getElementById('conversionsBody');
            if (!tbody) {
                console.error('âŒ conversionsBody not found in DOM!');
                console.error('   Checking if table exists:', document.getElementById('conversionsTable'));
                alert('Ø®Ø·Ø£: Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© 3.');
                return;
            }
            console.log('âœ… conversionsBody found:', tbody);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† uomList
            if (!uomList) {
                console.error('âŒ uomList is undefined!');
                alert('Ø®Ø·Ø£: Ù‚Ø§Ø¦Ù…Ø© ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ ØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙØ©.');
                return;
            }

            if (uomList.length === 0) {
                console.error('âŒ uomList is empty!');
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù‚ÙŠØ§Ø³ Ù…ØªØ§Ø­Ø©.\n\nÙŠØ±Ø¬Ù‰:\n1. Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø§Øª Ù‚ÙŠØ§Ø³ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª\n2. Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„');
                return;
            }
            console.log('âœ… uomList has', uomList.length, 'items');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† base_uom
            const baseUom = document.getElementById('id_base_uom');
            if (!baseUom) {
                console.error('âŒ base_uom field not found!');
                alert('Ø®Ø·Ø£: Ø­Ù‚Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
                return;
            }

            if (!baseUom.value) {
                console.warn('âš ï¸ base_uom not selected yet');
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ­Ø¯Ø© Ù‚ÙŠØ§Ø³ Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø®Ø·ÙˆØ© 1.');
                return;
            }
            console.log('âœ… base_uom is set to:', baseUom.options[baseUom.selectedIndex].text);

            const currentIndex = conversionIndex;
            const row = document.createElement('tr');
            row.dataset.index = currentIndex;

            // Build UOM options (exclude base_uom to prevent meaningless conversions)
            let uomOptions = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>';
            // Ø§Ø³ØªØ®Ø¯Ù… baseUom Ø§Ù„Ù…ÙØ¹Ø±Ù‘Ù ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ - Ù„Ø§ ØªÙØ¹Ø±Ù‘ÙÙ‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            const baseUomId = baseUom ? baseUom.value : null;

        uomList.forEach(uom => {
            // Skip base_uom - can't convert from base unit to itself
            if (baseUomId && uom.id == baseUomId) {
                return; // skip this iteration
            }

            const symbol = uom.symbol ? `(${uom.symbol})` : '';
            uomOptions += `<option value="${uom.id}">${uom.name} ${symbol}</option>`;
        });

        // Build row HTML
        row.innerHTML = `
            <td>
                <select name="conversion_from_uom_${currentIndex}"
                        class="form-select form-select-sm conversion-from-uom"
                        data-index="${currentIndex}">
                    ${uomOptions}
                </select>
            </td>
            <td>
                <input type="number"
                       name="conversion_factor_${currentIndex}"
                       class="form-control form-control-sm conversion-factor"
                       placeholder="1.0"
                       step="0.001"
                       min="0.001"
                       data-index="${currentIndex}">
            </td>
            <td>
                <small class="text-muted conversion-formula" id="conversion_formula_${currentIndex}">
                    -
                </small>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger btn-remove-conversion">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;

        // Append row
        tbody.appendChild(row);

        // Add event listeners
        const fromSelect = row.querySelector('.conversion-from-uom');
        const factorInput = row.querySelector('.conversion-factor');
        const deleteBtn = row.querySelector('.btn-remove-conversion');

        // Update formula when from_uom or factor changes
        function updateFormula() {
            const fromUomId = fromSelect.value;
            const factor = factorInput.value;
            // Ø§Ø³ØªØ®Ø¯Ù… baseUom Ù…Ù† outer scope - Ù„Ø§ ØªÙØ¹Ø±Ù‘ÙÙ‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            const formulaSpan = document.getElementById(`conversion_formula_${currentIndex}`);

            if (fromUomId && factor && baseUom && baseUom.value) {
                const fromUomText = fromSelect.options[fromSelect.selectedIndex].text;
                const baseUomText = baseUom.options[baseUom.selectedIndex].text;
                formulaSpan.textContent = `1 ${fromUomText} = ${factor} ${baseUomText}`;
            } else {
                formulaSpan.textContent = '-';
            }
        }

        fromSelect.addEventListener('change', updateFormula);
        factorInput.addEventListener('input', updateFormula);

        // Delete handler
        deleteBtn.addEventListener('click', function() {
            row.remove();
            console.log('ğŸ—‘ï¸ Conversion row removed');
            console.log('ğŸ“Š Total rows now:', tbody.children.length);
        });

            conversionIndex++;

            console.log('âœ… Conversion row added successfully');
            console.log('ğŸ“Š Total rows now:', tbody.children.length);

        } catch (error) {
            console.error('âŒ Error in addConversionRow:', error);
            console.error('   Error message:', error.message);
            console.error('   Error stack:', error.stack);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„ØªØ­ÙˆÙŠÙ„:\n' + error.message + '\n\nÙŠØ±Ø¬Ù‰ ÙØªØ­ Console (F12) Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.');
        }
    }

    // ============================================
    // Attach button event listener using EVENT DELEGATION
    // Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© ØªØ¶Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ø²Ø± Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ DOM
    // ============================================

    // Ø·Ø±ÙŠÙ‚Ø© 1: Event Delegation (Ø§Ù„Ø£ÙƒØ«Ø± Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©)
    document.body.addEventListener('click', function(e) {
        // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¶ØºÙˆØ· Ù‡Ùˆ Ø§Ù„Ø²Ø± Ø£Ùˆ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø²Ø±
        const btn = e.target.closest('#btnAddConversion');
        if (btn) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ğŸ–±ï¸ Add Conversion button clicked (via delegation)');
            addConversionRow();
        }
    });

    // Ø·Ø±ÙŠÙ‚Ø© 2: Direct listener (backup)
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© event listener Ù…Ø¨Ø§Ø´Ø±Ø©
    function attachConversionButtonListener() {
        const btnAddConversion = document.getElementById('btnAddConversion');
        if (btnAddConversion) {
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ listeners Ù‚Ø¯ÙŠÙ…Ø©
            const newBtn = btnAddConversion.cloneNode(true);
            btnAddConversion.parentNode.replaceChild(newBtn, btnAddConversion);

            // Ø¥Ø¶Ø§ÙØ© listener Ø¬Ø¯ÙŠØ¯
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ğŸ–±ï¸ Add Conversion button clicked (direct)');
                addConversionRow();
            });
            console.log('âœ… Add Conversion button event listener attached (direct method)');
            return true;
        } else {
            console.error('âŒ btnAddConversion not found!');
            return false;
        }
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙÙˆØ±Ø§Ù‹
    const listenerAttached = attachConversionButtonListener();

    // Ø¥Ø°Ø§ ÙØ´Ù„ØªØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ±
    if (!listenerAttached) {
        console.log('â³ Retrying to attach listener after delay...');
        setTimeout(function() {
            attachConversionButtonListener();
        }, 500);
    }

    console.log('âœ… Event delegation for conversions button is active');

    // ============================================
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø·)
    // ============================================
    console.log('ğŸ” Checking is_update status:', {{ is_update|yesno:"true,false,null" }});
    {% if is_update %}
    console.log('âœ… is_update is TRUE - loading existing data...');

    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    {% if existing_variants %}
    const existingVariants = [
        {% for variant in existing_variants %}
        {
            id: {{ variant.id }},
            code: "{{ variant.code }}",
            description: "{{ variant.get_full_name|escapejs }}",
            attributes: [
                {% for attr_val in variant.variant_attribute_values.all %}
                {
                    attribute_id: {{ attr_val.attribute.id }},
                    value_id: {{ attr_val.value.id }},
                    attribute_name: "{{ attr_val.attribute.name|escapejs }}",
                    value_name: "{{ attr_val.value.value|escapejs }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    console.log('ğŸ“Š Existing variants with attributes:', existingVariants);

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ù…Ø§Ø¯Ø© Ù…ØªØºÙŠØ±Ø§ØªØŒ Ø§Ù…Ù„Ø£ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆÙˆÙ„Ù‘Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    if (existingVariants.length > 0) {
        generatedVariants = existingVariants;

        // âœ… ØªÙØ¹ÙŠÙ„ checkbox Ø§Ù„Ù€ has_variants ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        if (hasVariantsCheckbox) {
            hasVariantsCheckbox.checked = true;
            // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            const variantsSelection = document.getElementById('variantsSelection');
            if (variantsSelection) {
                variantsSelection.style.display = 'block';
            }
        }

        const generatedVariantsField = document.getElementById('generated_variants');
        if (generatedVariantsField) {
            generatedVariantsField.value = JSON.stringify(existingVariants);
        }

        const variantCountElement = document.getElementById('variantCount');
        if (variantCountElement) {
            variantCountElement.textContent = existingVariants.length;
        }

        const variantPreviewElement = document.getElementById('variantPreview');
        if (variantPreviewElement) {
            variantPreviewElement.innerHTML = existingVariants
                .map(v => `<div class="variant-chip">${v.description}</div>`)
                .join('');
        }

        // âœ… ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        generateVariantPricesTables(existingVariants);

        // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        const simplePricesSection = document.getElementById('simplePricesSection');
        const variantPricesSection = document.getElementById('variantPricesSection');
        if (simplePricesSection) simplePricesSection.style.display = 'none';
        if (variantPricesSection) variantPricesSection.style.display = 'block';

        // âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù€ checkboxes Ù„Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        // Ø§Ø³ØªØ®Ø¯Ù… setTimeout Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† DOM Ø¬Ø§Ù‡Ø²
        setTimeout(() => {
            console.log('ğŸ” Auto-checking variant attribute checkboxes...');
            const usedAttributeValues = new Set();

            // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ØµØ§Ø¦Øµ ÙˆØ§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
            existingVariants.forEach(variant => {
                variant.attributes.forEach(attr => {
                    const key = `${attr.attribute_id}_${attr.value_id}`;
                    usedAttributeValues.add(key);
                    console.log(`   - Found: ${attr.attribute_name} = ${attr.value_name} (${key})`);
                });
            });

            console.log(`ğŸ“Š Total unique attribute-value combinations: ${usedAttributeValues.size}`);

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù€ checkboxes Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            let checkedCount = 0;
            usedAttributeValues.forEach(key => {
                const [attrId, valId] = key.split('_');
                const checkbox = document.getElementById(`attr_${attrId}_val_${valId}`);
                if (checkbox) {
                    checkbox.checked = true;
                    checkedCount++;
                    console.log(`   âœ… Checked: attr_${attrId}_val_${valId}`);
                } else {
                    console.warn(`   âš ï¸ Checkbox not found: attr_${attrId}_val_${valId}`);
                }
            });

            console.log(`âœ… Auto-checked ${checkedCount} checkboxes`);

            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            const variantCountElement = document.getElementById('variantCount');
            if (variantCountElement) {
                variantCountElement.textContent = existingVariants.length;
                console.log(`ğŸ“Š Updated variant count display: ${existingVariants.length}`);
            }
        }, 500); // Ø§Ù†ØªØ¸Ø± 500ms Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† DOM Ø¬Ø§Ù‡Ø²
    }
    {% endif %}

    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    {% if item_prices_data %}
    // Ù„Ù„Ù…ÙˆØ§Ø¯ Ø¨Ø¯ÙˆÙ† Ù…ØªØºÙŠØ±Ø§Øª
    const itemPrices = {{ item_prices_data|safe }};
    for (const [priceListId, price] of Object.entries(itemPrices)) {
        const input = document.querySelector(`input[name="price_${priceListId}"]`);
        if (input) {
            input.value = price;
        }
    }
    {% endif %}

    {% if variants_prices_data %}
    // Ù„Ù„Ù…ÙˆØ§Ø¯ Ø¨Ù…ØªØºÙŠØ±Ø§Øª
    const variantsPrices = {{ variants_prices_data|safe }};
    // Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    {% endif %}

    // 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    try {
        const existingConversionsRaw = '{{ existing_conversions_json|escapejs }}';
        console.log('ğŸ” Raw existing_conversions_json:', existingConversionsRaw);
        console.log('ğŸ” Length:', existingConversionsRaw.length);
        console.log('ğŸ” Is []?', existingConversionsRaw === '[]');
        console.log('ğŸ” Is empty?', existingConversionsRaw === '');

        if (existingConversionsRaw && existingConversionsRaw !== '[]' && existingConversionsRaw !== '') {
            const existingConversions = JSON.parse(existingConversionsRaw);
            console.log('ğŸ”„ Loading existing conversions...');
            console.log('ğŸ“Š Existing conversions:', existingConversions);
            console.log('ğŸ“Š Count:', existingConversions.length);

            if (existingConversions.length > 0) {

    existingConversions.forEach((conversion, idx) => {
        console.log(`Loading conversion ${idx + 1}:`, conversion);
        const tbody = document.getElementById('conversionsBody');

        const currentIndex = conversionIndex;
        const row = document.createElement('tr');
        row.dataset.index = currentIndex;

        // Build UOM options (exclude base_uom to prevent meaningless conversions)
        let uomOptions = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>';
        const baseUom = document.getElementById('id_base_uom');
        const baseUomId = baseUom ? baseUom.value : null;

        uomList.forEach(uom => {
            // Skip base_uom - can't convert from base unit to itself
            if (baseUomId && uom.id == baseUomId) {
                return; // skip this iteration
            }

            const symbol = uom.symbol ? `(${uom.symbol})` : '';
            uomOptions += `<option value="${uom.id}">${uom.name} ${symbol}</option>`;
        });

        // Build row HTML
        row.innerHTML = `
            <td>
                <select name="conversion_from_uom_${currentIndex}"
                        class="form-select form-select-sm conversion-from-uom"
                        data-index="${currentIndex}">
                    ${uomOptions}
                </select>
            </td>
            <td>
                <input type="number"
                       name="conversion_factor_${currentIndex}"
                       class="form-control form-control-sm conversion-factor"
                       placeholder="1.0"
                       step="0.001"
                       min="0.001"
                       value="${conversion.factor}"
                       data-index="${currentIndex}">
            </td>
            <td>
                <small class="text-muted conversion-formula" id="conversion_formula_${currentIndex}">
                    ${conversion.formula || '-'}
                </small>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger btn-remove-conversion">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;

        tbody.appendChild(row);

        // Set selected value
        const fromSelect = row.querySelector('.conversion-from-uom');
        const factorInput = row.querySelector('.conversion-factor');
        const deleteBtn = row.querySelector('.btn-remove-conversion');

        fromSelect.value = conversion.from_uom_id;

        // Update formula function
        function updateFormula() {
            const fromUomId = fromSelect.value;
            const factor = factorInput.value;
            // Ø§Ø³ØªØ®Ø¯Ù… baseUom Ù…Ù† outer scope (line 1588) - Ù„Ø§ ØªÙØ¹Ø±Ù‘ÙÙ‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            const formulaSpan = document.getElementById(`conversion_formula_${currentIndex}`);

            if (fromUomId && factor && baseUom && baseUom.value) {
                const fromUomText = fromSelect.options[fromSelect.selectedIndex].text;
                const baseUomText = baseUom.options[baseUom.selectedIndex].text;
                formulaSpan.textContent = `1 ${fromUomText} = ${factor} ${baseUomText}`;
            } else {
                formulaSpan.textContent = '-';
            }
        }

        // Add event listeners
        fromSelect.addEventListener('change', updateFormula);
        factorInput.addEventListener('input', updateFormula);

        // Delete handler
        deleteBtn.addEventListener('click', function() {
            row.remove();
            console.log('ğŸ—‘ï¸ Conversion row removed');
            console.log('ğŸ“Š Total rows now:', tbody.children.length);
        });

        // Initial formula update
        setTimeout(updateFormula, 100);

        conversionIndex++;
        console.log(`âœ… Conversion ${idx + 1} loaded successfully`);
    });

            console.log(`âœ… All ${existingConversions.length} conversions loaded`);
            console.log('ğŸ“Š Total conversion rows:', document.getElementById('conversionsBody').children.length);
            } else {
                console.log('âš ï¸ existingConversions array is empty');
            }
        } else {
            console.log('âš ï¸ No existing conversions to load - raw value is empty or []');
        }
    } catch (error) {
        console.error('âŒ Error loading conversions:', error);
    }

    {% endif %}
    // ============================================
    // Ù†Ù‡Ø§ÙŠØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    // ============================================

    // Form submission
    document.getElementById('wizardForm').addEventListener('submit', function(e) {
        document.getElementById('loadingOverlay').classList.add('active');
    });

    // Initialize
    goToStep(1);
});

function toggleCheckbox(id) {
    const checkbox = document.getElementById(id);
    checkbox.checked = !checkbox.checked;
    checkbox.dispatchEvent(new Event('change'));
}
</script>
{% endblock %}
