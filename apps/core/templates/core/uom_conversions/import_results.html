{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}نتائج الاستيراد - Import Results{% endblock %}

{% block extra_css %}
<style>
    .results-card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-card {
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
    }

    .stat-label {
        font-size: 1rem;
        color: #6c757d;
    }

    .error-item, .warning-item {
        border-left: 4px solid;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: 5px;
        background-color: #fff;
    }

    .error-item {
        border-color: #dc3545;
        background-color: #f8d7da;
    }

    .warning-item {
        border-color: #ffc107;
        background-color: #fff3cd;
    }

    .row-number {
        display: inline-block;
        background-color: #6c757d;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-size: 0.875rem;
        font-weight: bold;
        margin-left: 0.5rem;
    }

    .success-animation {
        animation: successPulse 1.5s ease-in-out;
    }

    @keyframes successPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-clipboard-check"></i>
                        نتائج الاستيراد
                    </h2>
                    <p class="text-muted mb-0">Import Results Summary</p>
                </div>
                <div>
                    <a href="{% url 'core:uom_conversion_import' %}" class="btn btn-primary">
                        <i class="fas fa-file-import"></i>
                        استيراد جديد
                    </a>
                    <a href="{% url 'core:uom_conversion_list' %}" class="btn btn-success">
                        <i class="fas fa-list"></i>
                        عرض التحويلات
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if results %}
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <!-- Created -->
        <div class="col-md-3 mb-3">
            <div class="stat-card bg-success text-white {% if results.created > 0 %}success-animation{% endif %}">
                <i class="fas fa-check-circle stat-icon"></i>
                <div class="stat-number">{{ results.created|default:0 }}</div>
                <div class="stat-label">تم إنشاؤها بنجاح</div>
                <small>Created Successfully</small>
            </div>
        </div>

        <!-- Skipped -->
        <div class="col-md-3 mb-3">
            <div class="stat-card bg-info text-white">
                <i class="fas fa-forward stat-icon"></i>
                <div class="stat-number">{{ results.skipped|default:0 }}</div>
                <div class="stat-label">تم تخطيها</div>
                <small>Skipped (Duplicates)</small>
            </div>
        </div>

        <!-- Errors -->
        <div class="col-md-3 mb-3">
            <div class="stat-card {% if has_errors %}bg-danger{% else %}bg-secondary{% endif %} text-white">
                <i class="fas fa-times-circle stat-icon"></i>
                <div class="stat-number">{{ results.errors|length|default:0 }}</div>
                <div class="stat-label">أخطاء</div>
                <small>Errors</small>
            </div>
        </div>

        <!-- Warnings -->
        <div class="col-md-3 mb-3">
            <div class="stat-card {% if has_warnings %}bg-warning{% else %}bg-secondary{% endif %} text-white">
                <i class="fas fa-exclamation-triangle stat-icon"></i>
                <div class="stat-number">{{ results.warnings|length|default:0 }}</div>
                <div class="stat-label">تحذيرات</div>
                <small>Warnings</small>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    {% if results.success %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <h4 class="alert-heading">
                    <i class="fas fa-check-circle"></i>
                    تم الاستيراد بنجاح!
                </h4>
                <p>تم استيراد {{ results.created }} تحويل بنجاح.</p>
                {% if results.skipped > 0 %}
                <hr>
                <p class="mb-0">
                    <i class="fas fa-info-circle"></i>
                    تم تخطي {{ results.skipped }} تحويل مكرر.
                </p>
                {% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Errors Section -->
    {% if has_errors %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card results-card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-times-circle"></i>
                        الأخطاء ({{ results.errors|length }})
                        <span class="badge bg-light text-danger float-end">يجب الإصلاح</span>
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">الرجاء تصحيح الأخطاء التالية وإعادة المحاولة:</p>

                    <div class="accordion" id="errorsAccordion">
                        {% for error in results.errors %}
                        <div class="error-item mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong>
                                        <i class="fas fa-exclamation-circle text-danger"></i>
                                        {% if error.sheet %}
                                            <span class="badge bg-secondary">{{ error.sheet }}</span>
                                        {% endif %}
                                        {% if error.row %}
                                            <span class="row-number">صف {{ error.row }}</span>
                                        {% endif %}
                                    </strong>
                                    <p class="mb-0 mt-2">{{ error.error }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {% if results.errors|length > 10 %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        عرض أول 10 أخطاء فقط. إجمالي الأخطاء: {{ results.errors|length }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Warnings Section -->
    {% if has_warnings %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card results-card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i>
                        التحذيرات ({{ results.warnings|length }})
                        <span class="badge bg-light text-warning float-end">للعلم</span>
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">التحذيرات التالية لا تمنع الاستيراد ولكن يجب مراجعتها:</p>

                    {% for warning in results.warnings %}
                    <div class="warning-item">
                        <strong>
                            <i class="fas fa-exclamation-triangle text-warning"></i>
                            {% if warning.sheet %}
                                <span class="badge bg-secondary">{{ warning.sheet }}</span>
                            {% endif %}
                            {% if warning.row %}
                                <span class="row-number">صف {{ warning.row }}</span>
                            {% endif %}
                        </strong>
                        <p class="mb-0 mt-2">{{ warning.warning }}</p>
                    </div>
                    {% endfor %}

                    {% if results.warnings|length > 10 %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        عرض أول 10 تحذيرات فقط. إجمالي التحذيرات: {{ results.warnings|length }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card results-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks"></i>
                        الخطوات التالية
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if has_errors %}
                        <div class="col-md-6 mb-3">
                            <div class="card border-danger h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-redo fa-3x text-danger mb-3"></i>
                                    <h5>إعادة المحاولة</h5>
                                    <p class="text-muted">قم بتصحيح الأخطاء في ملف Excel وأعد الاستيراد</p>
                                    <a href="{% url 'core:uom_conversion_import' %}" class="btn btn-danger">
                                        <i class="fas fa-file-import"></i>
                                        استيراد مرة أخرى
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="col-md-6 mb-3">
                            <div class="card border-success h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-list fa-3x text-success mb-3"></i>
                                    <h5>مراجعة التحويلات</h5>
                                    <p class="text-muted">عرض جميع التحويلات المستوردة في القائمة</p>
                                    <a href="{% url 'core:uom_conversion_list' %}" class="btn btn-success">
                                        <i class="fas fa-eye"></i>
                                        عرض القائمة
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="card border-primary h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-export fa-3x text-primary mb-3"></i>
                                    <h5>تصدير البيانات</h5>
                                    <p class="text-muted">تصدير التحويلات الحالية للمراجعة أو النسخ الاحتياطي</p>
                                    <a href="{% url 'core:uom_conversion_export' %}" class="btn btn-primary">
                                        <i class="fas fa-download"></i>
                                        تصدير
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="card border-info h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-layer-group fa-3x text-info mb-3"></i>
                                    <h5>إدارة المجموعات</h5>
                                    <p class="text-muted">عرض وإدارة مجموعات وحدات القياس</p>
                                    <a href="{% url 'core:uom_group_list' %}" class="btn btn-info">
                                        <i class="fas fa-cog"></i>
                                        المجموعات
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Results -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info text-center" role="alert">
                <i class="fas fa-info-circle fa-3x mb-3"></i>
                <h4>لا توجد نتائج</h4>
                <p>لم يتم العثور على نتائج استيراد. الرجاء القيام باستيراد أولاً.</p>
                <a href="{% url 'core:uom_conversion_import' %}" class="btn btn-primary">
                    <i class="fas fa-file-import"></i>
                    بدء الاستيراد
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Auto-dismiss success alert after 5 seconds
    {% if results.success and not has_errors %}
    setTimeout(function() {
        $('.alert-success').fadeOut('slow');
    }, 5000);
    {% endif %}

    // Smooth scroll to errors if present
    {% if has_errors %}
    $('html, body').animate({
        scrollTop: $('.border-danger').offset().top - 100
    }, 1000);
    {% endif %}
});
</script>
{% endblock %}
