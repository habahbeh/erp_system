{% extends 'base/base.html' %}
{% load i18n %}

{% block content %}
<div class="container-fluid py-4">
    <h1>إدارة صلاحيات: {{ user_obj.get_full_name|default:user_obj.username }}</h1>

    <form method="post">
        {% csrf_token %}

        <!-- المجموعات (الأدوار) -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>المجموعات (الأدوار)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for group in all_groups %}
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="groups" value="{{ group.id }}"
                                   {% if group.id in user_groups %}checked{% endif %}>
                            <label class="form-check-label">
                                {{ group.name }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- الصلاحيات المباشرة -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>الصلاحيات المباشرة</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for permission in all_permissions %}
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="permissions" value="{{ permission.id }}"
                                   {% if permission.id in user_permissions %}checked{% endif %}>
                            <label class="form-check-label">
                                {{ permission.name }}
                                <small class="text-muted">({{ permission.content_type.model }})</small>
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- أزرار الحفظ -->
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> حفظ الصلاحيات
            </button>
            <a href="{% url 'core:user_detail' pk=user_obj.pk %}" class="btn btn-secondary">
                إلغاء
            </a>
        </div>
    </form>
</div>
{% endblock %}


{# templates/core/user_profiles/user_permissions.html #}
{#{% extends 'base/base.html' %}#}
{#{% load i18n static widget_tweaks %}#}
{##}
{#{% block title %}{{ title }}{% endblock %}#}
{##}
{#{% block content %}#}
{#<div class="container-fluid py-4">#}
{#    <!-- Breadcrumbs -->#}
{#    <nav aria-label="breadcrumb" class="mb-3">#}
{#        <ol class="breadcrumb">#}
{#            {% for breadcrumb in breadcrumbs %}#}
{#                {% if forloop.last %}#}
{#                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>#}
{#                {% else %}#}
{#                    <li class="breadcrumb-item">#}
{#                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>#}
{#                    </li>#}
{#                {% endif %}#}
{#            {% endfor %}#}
{#        </ol>#}
{#    </nav>#}
{##}
{#    <!-- Header -->#}
{#    <div class="d-flex justify-content-between align-items-center mb-4">#}
{#        <div>#}
{#            <h1 class="h3 mb-1">{{ title }}</h1>#}
{#            <p class="text-muted mb-0">{% trans "تخصيص الصلاحيات المتقدمة للمستخدم" %}</p>#}
{#        </div>#}
{#    </div>#}
{##}
{#    <!-- User Info -->#}
{#    <div class="card shadow-sm mb-4">#}
{#        <div class="card-header bg-primary text-white">#}
{#            <h6 class="card-title mb-0">#}
{#                <i class="fas fa-user"></i> {% trans "معلومات المستخدم" %}#}
{#            </h6>#}
{#        </div>#}
{#        <div class="card-body">#}
{#            <div class="d-flex align-items-center">#}
{#                <div class="flex-shrink-0 me-3">#}
{#                    <div class="user-avatar">#}
{#                        {{ user_obj.first_name.0|default:user_obj.username.0|upper }}#}
{#                    </div>#}
{#                </div>#}
{#                <div class="flex-grow-1">#}
{#                    <h5 class="mb-1">{{ user_obj.get_full_name|default:user_obj.username }}</h5>#}
{#                    <p class="text-muted mb-1">{{ user_obj.email }}</p>#}
{#                    <div class="d-flex align-items-center gap-2">#}
{#                        {% if user_obj.is_superuser %}#}
{#                            <span class="badge bg-danger">#}
{#                                <i class="fas fa-crown"></i> {% trans "مدير نظام" %}#}
{#                            </span>#}
{#                        {% elif user_obj.is_staff %}#}
{#                            <span class="badge bg-warning">#}
{#                                <i class="fas fa-user-tie"></i> {% trans "طاقم الإدارة" %}#}
{#                            </span>#}
{#                        {% else %}#}
{#                            <span class="badge bg-secondary">#}
{#                                <i class="fas fa-user"></i> {% trans "مستخدم عادي" %}#}
{#                            </span>#}
{#                        {% endif %}#}
{##}
{#                        {% if user_obj.is_active %}#}
{#                            <span class="badge bg-success">{% trans "نشط" %}</span>#}
{#                        {% else %}#}
{#                            <span class="badge bg-secondary">{% trans "غير نشط" %}</span>#}
{#                        {% endif %}#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{##}
{#    <!-- Check if CustomPermission model exists -->#}
{#    {% load custom_tags %}#}
{#    {% if not custom_permissions_available %}#}
{#    <div class="alert alert-info border-0 shadow-sm mb-4" role="alert">#}
{#        <div class="d-flex align-items-center">#}
{#            <div class="flex-shrink-0">#}
{#                <i class="fas fa-info-circle fa-lg"></i>#}
{#            </div>#}
{#            <div class="flex-grow-1 ms-3">#}
{#                <h6 class="alert-heading mb-1">{% trans "الصلاحيات المخصصة غير متاحة" %}</h6>#}
{#                <p class="mb-0">#}
{#                    {% trans "لم يتم إنشاء صلاحيات مخصصة بعد. يمكنك استخدام صلاحيات Django الافتراضية من خلال لوحة الإدارة." %}#}
{#                </p>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#    {% endif %}#}
{##}
{#    <!-- Permissions Form -->#}
{#    <form method="post" class="needs-validation" novalidate>#}
{#        {% csrf_token %}#}
{##}
{#        {% if user_obj.is_superuser %}#}
{#        <!-- تحذير لمديري النظام -->#}
{#        <div class="alert alert-warning border-0 shadow-sm mb-4" role="alert">#}
{#            <div class="d-flex align-items-center">#}
{#                <div class="flex-shrink-0">#}
{#                    <i class="fas fa-crown fa-lg text-warning"></i>#}
{#                </div>#}
{#                <div class="flex-grow-1 ms-3">#}
{#                    <h6 class="alert-heading mb-1">{% trans "مدير نظام" %}</h6>#}
{#                    <small class="mb-0">#}
{#                        {% trans "هذا المستخدم مدير نظام ولديه صلاحيات كاملة على جميع أجزاء النظام تلقائياً." %}#}
{#                    </small>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#        {% endif %}#}
{##}
{#        <!-- عرض الصلاحيات الحالية من Django -->#}
{#        <div class="card shadow-sm mb-4">#}
{#            <div class="card-header bg-info text-white">#}
{#                <h6 class="card-title mb-0">#}
{#                    <i class="fas fa-shield-alt"></i> {% trans "صلاحيات Django الافتراضية" %}#}
{#                </h6>#}
{#            </div>#}
{#            <div class="card-body">#}
{#                <div class="row">#}
{#                    <div class="col-md-4">#}
{#                        <h6 class="text-muted">{% trans "الصلاحيات الأساسية" %}</h6>#}
{#                        <ul class="list-unstyled">#}
{#                            <li>#}
{#                                {% if user_obj.is_superuser %}#}
{#                                    <i class="fas fa-check text-success"></i>#}
{#                                {% else %}#}
{#                                    <i class="fas fa-times text-muted"></i>#}
{#                                {% endif %}#}
{#                                {% trans "مدير نظام" %}#}
{#                            </li>#}
{#                            <li>#}
{#                                {% if user_obj.is_staff %}#}
{#                                    <i class="fas fa-check text-success"></i>#}
{#                                {% else %}#}
{#                                    <i class="fas fa-times text-muted"></i>#}
{#                                {% endif %}#}
{#                                {% trans "عضو في الطاقم" %}#}
{#                            </li>#}
{#                            <li>#}
{#                                {% if user_obj.is_active %}#}
{#                                    <i class="fas fa-check text-success"></i>#}
{#                                {% else %}#}
{#                                    <i class="fas fa-times text-muted"></i>#}
{#                                {% endif %}#}
{#                                {% trans "حساب نشط" %}#}
{#                            </li>#}
{#                        </ul>#}
{#                    </div>#}
{#                    <div class="col-md-8">#}
{#                        <h6 class="text-muted">{% trans "صلاحيات المجموعات" %}</h6>#}
{#                        {% if user_obj.groups.exists %}#}
{#                            <div class="d-flex flex-wrap gap-1">#}
{#                                {% for group in user_obj.groups.all %}#}
{#                                    <span class="badge bg-secondary">{{ group.name }}</span>#}
{#                                {% endfor %}#}
{#                            </div>#}
{#                        {% else %}#}
{#                            <p class="text-muted mb-0">{% trans "لا ينتمي لأي مجموعة" %}</p>#}
{#                        {% endif %}#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{##}
{#      <!-- الصلاحيات -->#}
{#{% if form.fields %}#}
{#<div class="row">#}
{#    {% for field_name, field in form.fields.items %}#}
{#        <div class="col-lg-6 mb-4">#}
{#            <div class="card shadow-sm h-100">#}
{#                <div class="card-header#}
{#                    {% if 'django_' in field_name %}bg-warning text-dark#}
{#                    {% else %}bg-success text-white#}
{#                    {% endif %}">#}
{#                    <h6 class="card-title mb-0">#}
{#                        {% if 'django_' in field_name %}#}
{#                            <i class="fas fa-cogs"></i>#}
{#                        {% else %}#}
{#                            <i class="fas fa-key"></i>#}
{#                        {% endif %}#}
{#                        {{ field.label }}#}
{#                        <span class="badge bg-light text-dark ms-2">{{ field.field.queryset.count }}</span>#}
{#                    </h6>#}
{#                </div>#}
{#                <div class="card-body">#}
{#                    <!-- التحقق من وجود بيانات -->#}
{#                    {% if field.field.queryset.count > 0 %}#}
{#                        <!-- أزرار التحكم -->#}
{#                        <div class="d-flex justify-content-between align-items-center mb-3">#}
{#                            <small class="text-muted">{{ field.field.queryset.count }} صلاحية متاحة</small>#}
{#                            <div class="btn-group btn-group-sm">#}
{#                                <button type="button" class="btn btn-outline-success select-all-btn"#}
{#                                        data-category="{{ field_name }}">#}
{#                                    <i class="fas fa-check"></i> الكل#}
{#                                </button>#}
{#                                <button type="button" class="btn btn-outline-secondary deselect-all-btn"#}
{#                                        data-category="{{ field_name }}">#}
{#                                    <i class="fas fa-times"></i> لا شيء#}
{#                                </button>#}
{#                            </div>#}
{#                        </div>#}
{##}
{#                        <!-- قائمة الصلاحيات -->#}
{#                        <div class="permissions-list border rounded p-2" style="max-height: 400px; overflow-y: auto;">#}
{#                            {% for permission in field.field.queryset %}#}
{#                                <div class="form-check mb-1">#}
{#                                    <input class="form-check-input" type="checkbox"#}
{#                                           name="{{ field_name }}"#}
{#                                           value="{{ permission.pk }}"#}
{#                                           id="id_{{ field_name }}_{{ forloop.counter0 }}"#}
{#                                           {% if permission.pk in field.initial %}checked{% endif %}>#}
{#                                    <label class="form-check-label small" for="id_{{ field_name }}_{{ forloop.counter0 }}">#}
{#                                        <strong>{{ permission.name }}</strong>#}
{#                                        {% if 'django_' in field_name %}#}
{#                                            <br><span class="text-muted">{{ permission.content_type.model|title }} | {{ permission.codename }}</span>#}
{#                                        {% elif permission.description %}#}
{#                                            <br><span class="text-muted">{{ permission.description }}</span>#}
{#                                        {% endif %}#}
{#                                    </label>#}
{#                                </div>#}
{#                            {% endfor %}#}
{#                        </div>#}
{#                    {% else %}#}
{#                        <!-- لا توجد صلاحيات -->#}
{#                        <div class="text-center text-muted py-4">#}
{#                            <i class="fas fa-info-circle fa-2x mb-2"></i>#}
{#                            <p>لا توجد صلاحيات في هذا التصنيف</p>#}
{#                        </div>#}
{#                    {% endif %}#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    {% endfor %}#}
{#</div>#}
{#{% else %}#}
{#<div class="alert alert-warning">#}
{#    <i class="fas fa-exclamation-triangle"></i>#}
{#    <strong>لا توجد أقسام صلاحيات!</strong> تأكد من وجود صلاحيات في النظام.#}
{#</div>#}
{#{% endif %}#}
{##}
{##}
{##}
{#        <!-- Action Buttons -->#}
{#        <div class="card shadow-sm">#}
{#            <div class="card-body">#}
{#                <div class="d-flex justify-content-between align-items-center">#}
{#                    <a href="{{ cancel_url }}" class="btn btn-secondary">#}
{#                        <i class="fas fa-times"></i> {% trans "إلغاء" %}#}
{#                    </a>#}
{##}
{#                    <div class="d-flex gap-2">#}
{#                        {% if form.fields %}#}
{#                        <button type="button" class="btn btn-outline-success" id="selectAllPermissions">#}
{#                            <i class="fas fa-check-double"></i> {% trans "تحديد جميع الصلاحيات" %}#}
{#                        </button>#}
{#                        <button type="button" class="btn btn-outline-secondary" id="deselectAllPermissions">#}
{#                            <i class="fas fa-times"></i> {% trans "إلغاء جميع الصلاحيات" %}#}
{#                        </button>#}
{#                        {% endif %}#}
{#                        <button type="submit" class="btn btn-success">#}
{#                            <i class="fas fa-save"></i> {{ submit_text }}#}
{#                        </button>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </form>#}
{#</div>#}
{#{% endblock %}#}
{##}
{#{% block extra_css %}#}
{#<style>#}
{#.permissions-list {#}
{#    max-height: 400px;#}
{#    overflow-y: auto;#}
{#    border: 1px solid #dee2e6;#}
{#    border-radius: 0.375rem;#}
{#    padding: 0.5rem;#}
{#}#}
{##}
{#.form-check {#}
{#    transition: all 0.2s ease;#}
{#}#}
{##}
{#.form-check:hover {#}
{#    background-color: #f8f9fa;#}
{#}#}
{##}
{#.form-check-input:checked + .form-check-label {#}
{#    color: #0d6efd;#}
{#    font-weight: 500;#}
{#}#}
{##}
{#.btn-xs {#}
{#    padding: 0.25rem 0.5rem;#}
{#    font-size: 0.75rem;#}
{#}#}
{##}
{#.card-header small {#}
{#    font-size: 0.8rem;#}
{#}#}
{#</style>#}
{#{% endblock %}#}
{##}
{#{% block extra_js %}#}
{#<script>#}
{#document.addEventListener('DOMContentLoaded', function() {#}
{#    console.log('🔧 تم تحميل صفحة الصلاحيات');#}
{##}
{#    // عد الصلاحيات المعروضة#}
{#    const totalFields = document.querySelectorAll('.card').length;#}
{#    const totalCheckboxes = document.querySelectorAll('input[type="checkbox"]').length;#}
{#    console.log(`📊 الإحصائيات: ${totalFields} قسم، ${totalCheckboxes} صلاحية`);#}
{##}
{#    // أزرار تحديد الكل#}
{#    document.querySelectorAll('.select-all-btn').forEach(btn => {#}
{#        btn.addEventListener('click', function() {#}
{#            const category = this.dataset.category;#}
{#            const checkboxes = document.querySelectorAll(`input[name="${category}"]`);#}
{#            checkboxes.forEach(checkbox => {#}
{#                checkbox.checked = true;#}
{#            });#}
{#            console.log(`✅ تم تحديد جميع صلاحيات ${category}`);#}
{#        });#}
{#    });#}
{##}
{#    // أزرار إلغاء الكل#}
{#    document.querySelectorAll('.deselect-all-btn').forEach(btn => {#}
{#        btn.addEventListener('click', function() {#}
{#            const category = this.dataset.category;#}
{#            const checkboxes = document.querySelectorAll(`input[name="${category}"]`);#}
{#            checkboxes.forEach(checkbox => {#}
{#                checkbox.checked = false;#}
{#            });#}
{#            console.log(`❌ تم إلغاء جميع صلاحيات ${category}`);#}
{#        });#}
{#    });#}
{##}
{#    // تأكيد الحفظ#}
{#    const form = document.querySelector('form');#}
{#    if (form) {#}
{#        form.addEventListener('submit', function(e) {#}
{#            const checkedCount = document.querySelectorAll('input[type="checkbox"]:checked').length;#}
{#            console.log(`💾 جاري حفظ ${checkedCount} صلاحية`);#}
{##}
{#            if (checkedCount === 0) {#}
{#                if (!confirm('لم يتم تحديد أي صلاحيات. هل تريد المتابعة؟')) {#}
{#                    e.preventDefault();#}
{#                }#}
{#            }#}
{#        });#}
{#    }#}
{#});#}
{#</script>#}
{#{% endblock %}#}