{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "قواعد التسعير" %}{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<style>
    .dataTables_wrapper {
        direction: rtl;
    }

    .dt-buttons {
        float: right;
        margin-bottom: 10px;
    }

    .dt-button {
        margin-left: 5px !important;
        margin-right: 0 !important;
    }

    table.dataTable thead th {
        text-align: right;
    }

    table.dataTable tbody td {
        text-align: right;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stats-cards {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        flex: 1;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
    }

    .table-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h2><i class="fas fa-percentage me-2"></i>{% trans "قواعد التسعير" %}</h2>
            <p class="text-muted mb-0">{% trans "إدارة وتحديث قواعد التسعير" %}</p>
        </div>
        <div>
            <a href="{% url 'core:pricing_rule_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> {% trans "قاعدة جديدة" %}
            </a>
            <a href="{% url 'core:pricing_dashboard' %}" class="btn btn-outline-info">
                <i class="fas fa-chart-line"></i> {% trans "لوحة التحكم" %}
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-label">
                <i class="fas fa-list text-primary"></i> {% trans "إجمالي القواعد" %}
            </div>
            <div class="stat-value">{{ total_rules }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">
                <i class="fas fa-check-circle text-success"></i> {% trans "نشطة" %}
            </div>
            <div class="stat-value text-success">{{ active_rules }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">
                <i class="fas fa-pause-circle text-warning"></i> {% trans "غير نشطة" %}
            </div>
            <div class="stat-value text-warning">{{ inactive_rules }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">
                <i class="fas fa-percentage text-info"></i> {% trans "خصومات" %}
            </div>
            <div class="stat-value text-info">{{ discount_rules }}</div>
        </div>
    </div>

    <!-- DataTable -->
    <div class="table-card">
        <table id="pricingRulesTable" class="table table-striped table-hover" style="width:100%">
            <thead>
                <tr>
                    <th>{% trans "الرمز" %}</th>
                    <th>{% trans "الاسم" %}</th>
                    <th>{% trans "النوع" %}</th>
                    <th>{% trans "الأولوية" %}</th>
                    <th>{% trans "نشط" %}</th>
                    <th>{% trans "تاريخ الإنشاء" %}</th>
                    <th>{% trans "الإجراءات" %}</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data loaded via AJAX -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<!-- JSZip for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    var table = $('#pricingRulesTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{% url "core:dt_pricing_rules" %}',
            type: 'GET'
        },
        columns: [
            { data: 'code' },
            { data: 'name' },
            { data: 'rule_type' },
            { data: 'priority' },
            { data: 'is_active' },
            { data: 'created_at' },
            { data: 'actions', orderable: false, searchable: false }
        ],
        order: [[3, 'desc']], // Order by priority descending
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "الكل"]],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/ar.json',
            processing: '<i class="fas fa-spinner fa-spin fa-3x"></i>',
            paginate: {
                first: 'الأول',
                last: 'الأخير',
                next: 'التالي',
                previous: 'السابق'
            },
            lengthMenu: 'عرض _MENU_ صف',
            info: 'عرض _START_ إلى _END_ من _TOTAL_ قاعدة',
            infoEmpty: 'لا توجد بيانات',
            infoFiltered: '(منتقاة من _MAX_ إجمالي)',
            search: 'بحث:',
            zeroRecords: 'لا توجد نتائج مطابقة'
        },
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5]
                },
                action: function(e, dt, button, config) {
                    // Use server-side export
                    window.location.href = '{% url "core:export_pricing_rules" %}?format=excel';
                }
            },
            {
                extend: 'csv',
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: 'btn btn-info btn-sm',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5]
                },
                action: function(e, dt, button, config) {
                    // Use server-side export
                    window.location.href = '{% url "core:export_pricing_rules" %}?format=csv';
                }
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> طباعة',
                className: 'btn btn-secondary btn-sm',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5]
                },
                customize: function(win) {
                    $(win.document.body).css('direction', 'rtl');
                    $(win.document.body).find('table').addClass('display').css('font-size', '12pt');
                }
            },
            {
                text: '<i class="fas fa-sync"></i> تحديث',
                className: 'btn btn-primary btn-sm',
                action: function(e, dt, node, config) {
                    dt.ajax.reload();
                }
            }
        ],
        responsive: true
    });

    // Custom search delay
    var searchDelay;
    $('#pricingRulesTable_filter input').off().on('keyup', function() {
        var input = this;
        clearTimeout(searchDelay);
        searchDelay = setTimeout(function() {
            table.search($(input).val()).draw();
        }, 500);
    });
});
</script>
{% endblock %}
