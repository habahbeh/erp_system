{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "عناصر قائمة الأسعار" %}{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<style>
    .dataTables_wrapper {
        direction: rtl;
    }

    .dt-buttons {
        float: right;
        margin-bottom: 10px;
    }

    .dt-button {
        margin-left: 5px !important;
        margin-right: 0 !important;
    }

    table.dataTable thead th {
        text-align: right;
    }

    table.dataTable tbody td {
        text-align: right;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filter-row {
        display: flex;
        gap: 15px;
        align-items: end;
    }

    .filter-group {
        flex: 1;
    }

    .table-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h2><i class="fas fa-tags me-2"></i>{% trans "عناصر قائمة الأسعار" %}</h2>
            <p class="text-muted mb-0">{% trans "عرض وتحديث أسعار الأصناف" %}</p>
        </div>
        <div>
            <a href="{% url 'core:bulk_price_update' %}" class="btn btn-primary">
                <i class="fas fa-edit"></i> {% trans "تحديث جماعي" %}
            </a>
            <a href="{% url 'core:price_list_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-list"></i> {% trans "قوائم الأسعار" %}
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <h5 class="mb-3"><i class="fas fa-filter"></i> {% trans "التصفية" %}</h5>
        <div class="filter-row">
            <div class="filter-group">
                <label for="priceListFilter" class="form-label">{% trans "قائمة الأسعار" %}</label>
                <select id="priceListFilter" class="form-select">
                    <option value="">{% trans "جميع القوائم" %}</option>
                    {% for pl in price_lists %}
                    <option value="{{ pl.id }}">{{ pl.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <button type="button" class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-search"></i> {% trans "تطبيق" %}
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> {% trans "إعادة تعيين" %}
                </button>
            </div>
        </div>
    </div>

    <!-- DataTable -->
    <div class="table-card">
        <table id="priceListItemsTable" class="table table-striped table-hover" style="width:100%">
            <thead>
                <tr>
                    <th>{% trans "رمز الصنف" %}</th>
                    <th>{% trans "اسم الصنف" %}</th>
                    <th>{% trans "التصنيف" %}</th>
                    <th>{% trans "قائمة الأسعار" %}</th>
                    <th>{% trans "الوحدة" %}</th>
                    <th>{% trans "السعر" %}</th>
                    <th>{% trans "آخر تحديث" %}</th>
                    <th>{% trans "الإجراءات" %}</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data loaded via AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Price Modal -->
<div class="modal fade" id="editPriceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "تعديل السعر" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPriceForm">
                    <input type="hidden" id="priceItemId">
                    <div class="mb-3">
                        <label for="newPrice" class="form-label">{% trans "السعر الجديد" %}</label>
                        <input type="number" class="form-control" id="newPrice" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                <button type="button" class="btn btn-primary" onclick="savePrice()">{% trans "حفظ" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<!-- JSZip for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
var table;

$(document).ready(function() {
    initDataTable();

    // Edit price button click
    $(document).on('click', '.edit-price-btn', function() {
        var priceItemId = $(this).data('id');
        var currentPrice = $(this).data('price');

        $('#priceItemId').val(priceItemId);
        $('#newPrice').val(currentPrice);

        var modal = new bootstrap.Modal(document.getElementById('editPriceModal'));
        modal.show();
    });
});

function initDataTable() {
    var ajaxUrl = '{% url "core:dt_price_list_items" %}';
    var priceListId = $('#priceListFilter').val();

    if (priceListId) {
        ajaxUrl += '?price_list_id=' + priceListId;
    }

    table = $('#priceListItemsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: ajaxUrl,
            type: 'GET'
        },
        columns: [
            { data: 'item__code' },
            { data: 'item__name' },
            { data: 'item__category__name' },
            { data: 'price_list__name' },
            { data: 'uom__name' },
            { data: 'price' },
            { data: 'updated_at' },
            { data: 'actions', orderable: false, searchable: false }
        ],
        order: [[0, 'asc']], // Order by item code
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "الكل"]],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/ar.json',
            processing: '<i class="fas fa-spinner fa-spin fa-3x"></i>',
            paginate: {
                first: 'الأول',
                last: 'الأخير',
                next: 'التالي',
                previous: 'السابق'
            },
            lengthMenu: 'عرض _MENU_ صف',
            info: 'عرض _START_ إلى _END_ من _TOTAL_ سعر',
            infoEmpty: 'لا توجد بيانات',
            infoFiltered: '(منتقاة من _MAX_ إجمالي)',
            search: 'بحث:',
            zeroRecords: 'لا توجد نتائج مطابقة'
        },
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm',
                action: function(e, dt, button, config) {
                    var url = '{% url "core:export_price_list_items" %}?format=excel';
                    var priceListId = $('#priceListFilter').val();
                    if (priceListId) {
                        url += '&price_list_id=' + priceListId;
                    }
                    window.location.href = url;
                }
            },
            {
                extend: 'csv',
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: 'btn btn-info btn-sm',
                action: function(e, dt, button, config) {
                    var url = '{% url "core:export_price_list_items" %}?format=csv';
                    var priceListId = $('#priceListFilter').val();
                    if (priceListId) {
                        url += '&price_list_id=' + priceListId;
                    }
                    window.location.href = url;
                }
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> طباعة',
                className: 'btn btn-secondary btn-sm',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6]
                },
                customize: function(win) {
                    $(win.document.body).css('direction', 'rtl');
                    $(win.document.body).find('table').addClass('display').css('font-size', '10pt');
                }
            },
            {
                text: '<i class="fas fa-sync"></i> تحديث',
                className: 'btn btn-primary btn-sm',
                action: function(e, dt, node, config) {
                    dt.ajax.reload();
                }
            }
        ],
        responsive: true
    });
}

function applyFilters() {
    if (table) {
        table.destroy();
    }
    initDataTable();
}

function resetFilters() {
    $('#priceListFilter').val('');
    applyFilters();
}

function savePrice() {
    // This would send AJAX request to update price
    // For now, just close modal and reload table
    alert('سيتم تنفيذ حفظ السعر عبر AJAX في المرحلة القادمة');
    var modal = bootstrap.Modal.getInstance(document.getElementById('editPriceModal'));
    modal.hide();
    table.ajax.reload();
}
</script>
{% endblock %}
