{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
<style>
.badge-default {
    background-color: #28a745;
    color: white;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-badge.active {
    background-color: rgba(76, 175, 80, 0.1);
    color: #4caf50;
}

.status-badge.inactive {
    background-color: rgba(244, 67, 54, 0.1);
    color: #f44336;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'core:pricing_dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±</a></li>
            <li class="breadcrumb-item active">Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h1>
            <p class="text-muted mb-0">{% trans "Ø¥Ø¯Ø§Ø±Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ù„Ø´Ø±ÙƒØ©" %}</p>
        </div>
        <div>
            <a href="{% url 'core:price_list_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> {% trans "Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯Ø©" %}
            </a>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="viewMode" id="listView" value="list" checked>
                    <label class="btn btn-outline-primary" for="listView">
                        <i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø©
                    </label>

                    <input type="radio" class="btn-check" name="viewMode" id="gridView" value="grid">
                    <label class="btn btn-outline-primary" for="gridView">
                        <i class="fas fa-th"></i> Ø¨Ø·Ø§Ù‚Ø§Øª
                    </label>
                </div>

                <span class="text-muted small">
                    <i class="fas fa-info-circle"></i> Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
                </span>
            </div>
        </div>
    </div>

    <!-- List View -->
    <div id="listViewContainer" class="view-container">
        <div class="card shadow-sm mb-4" id="filtersCard">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="fas fa-filter"></i> {% trans "Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©" %}
                </h6>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="collapse show" id="filtersCollapse">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">{% trans "Ø§Ù„Ø¹Ù…Ù„Ø©" %}</label>
                            <select class="form-select" id="currencyFilter">
                                <option value="">{% trans "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª" %}</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">{% trans "Ø§Ù„Ø­Ø§Ù„Ø©" %}</label>
                            <select class="form-select" id="isActiveFilter">
                                <option value="">{% trans "Ø§Ù„ÙƒÙ„" %}</option>
                                <option value="1">{% trans "Ù†Ø´Ø·" %}</option>
                                <option value="0">{% trans "Ù…ÙˆÙ‚ÙˆÙ" %}</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">{% trans "Ø§ÙØªØ±Ø§Ø¶ÙŠØ©" %}</label>
                            <select class="form-select" id="isDefaultFilter">
                                <option value="">{% trans "Ø§Ù„ÙƒÙ„" %}</option>
                                <option value="1">{% trans "Ø§ÙØªØ±Ø§Ø¶ÙŠØ©" %}</option>
                                <option value="0">{% trans "Ø¹Ø§Ø¯ÙŠØ©" %}</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">{% trans "Ø§Ù„Ø¨Ø­Ø«" %}</label>
                            <input type="text" class="form-control" id="searchFilter" placeholder="{% trans 'Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø±Ù…Ø² Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…' %}">
                        </div>

                        <div class="col-md-2 d-flex align-items-end gap-2">
                            <button type="button" class="btn btn-outline-secondary" id="clearFilters">
                                <i class="fas fa-times"></i> {% trans "Ù…Ø³Ø­" %}
                            </button>

                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-success" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importModal">
                                    <i class="fas fa-upload"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-striped" id="priceListsTable" style="width: 100%">
                        <thead class="table-dark">
                            <tr>
                                <th>{% trans "Ø§Ù„Ø±Ù…Ø²" %}</th>
                                <th>{% trans "Ø§Ù„Ø§Ø³Ù…" %}</th>
                                <th>{% trans "Ø§Ù„Ø¹Ù…Ù„Ø©" %}</th>
                                <th>{% trans "Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù" %}</th>
                                <th>{% trans "Ø§ÙØªØ±Ø§Ø¶ÙŠØ©" %}</th>
                                <th>{% trans "Ø§Ù„Ø­Ø§Ù„Ø©" %}</th>
                                <th class="no-sort text-center">{% trans "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="tableInfo" class="text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" style="width: auto;" onchange="changePageLength(this.value)">
                            <option value="10">10 Ø³Ø·Ø±</option>
                            <option value="25" selected>25 Ø³Ø·Ø±</option>
                            <option value="50">50 Ø³Ø·Ø±</option>
                            <option value="100">100 Ø³Ø·Ø±</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid View -->
    <div id="gridViewContainer" class="view-container" style="display: none;">
        <div class="row g-4" id="priceListsGrid">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                </div>
                <p class="text-muted mt-3">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±...</p>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload"></i> {% trans "Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'core:price_list_import' %}" enctype="multipart/form-data" id="importForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_file" class="form-label">{% trans "Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯" %}</label>
                        <input type="file" class="form-control" id="id_file" name="file" accept=".xlsx,.xls,.csv" required>
                        <div class="form-text">
                            ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª Excel (.xlsx, .xls) Ùˆ CSV (.csv)
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="price_list" class="form-label">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</label>
                        <select class="form-select" id="price_list" name="price_list" required>
                            <option value="">Ø§Ø®ØªØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</option>
                        </select>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="update_existing" name="update_existing">
                        <label class="form-check-label" for="update_existing">
                            ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                        </label>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</h6>
                        <p class="mb-1">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</p>
                        <ul class="mb-0">
                            <li><strong>item_code:</strong> Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù</li>
                            <li><strong>variant_code:</strong> Ø±Ù…Ø² Ø§Ù„Ù…ØªØºÙŠØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</li>
                            <li><strong>uom_code:</strong> Ø±Ù…Ø² ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</li>
                            <li><strong>price:</strong> Ø§Ù„Ø³Ø¹Ø±</li>
                            <li><strong>min_quantity:</strong> Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø£Ø¯Ù†Ù‰ (Ø§ÙØªØ±Ø§Ø¶ÙŠ: 1)</li>
                        </ul>
                    </div>

                    <div class="text-center">
                        <a href="{% url 'core:price_list_template' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
var priceListsDataTable = null;
var currentView = 'list';

function initDataTable() {
    console.log('ğŸ”„ Initializing Price Lists DataTable...');

    if (priceListsDataTable) {
        console.log('âœ… DataTable already initialized');
        return priceListsDataTable;
    }

    priceListsDataTable = $('#priceListsTable').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "{% url 'core:price_list_datatable_ajax' %}",
            "type": "GET",
            "data": function(d) {
                d.currency = $('#currencyFilter').val();
                d.is_active = $('#isActiveFilter').val();
                d.is_default = $('#isDefaultFilter').val();
                d.search_filter = $('#searchFilter').val();
            },
            "error": function(xhr, error, code) {
                console.error('âŒ DataTable AJAX Error:', error, code);
            }
        },
        "columns": [
            {"data": "code", "name": "code"},
            {"data": "name", "name": "name"},
            {"data": "currency", "name": "currency__code"},
            {"data": "items_count", "name": "items_count", "orderable": false},
            {"data": "is_default", "name": "is_default"},
            {"data": "is_active", "name": "is_active"},
            {"data": "actions", "name": "actions", "orderable": false, "searchable": false}
        ],
        "order": [[0, "asc"]],
        "pageLength": 25,
        "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
        "responsive": true,
        "language": {
            "url": "https://cdn.datatables.net/plug-ins/1.13.7/i18n/ar.json"
        },
        "columnDefs": [
            { "targets": "no-sort", "orderable": false },
            { "className": "text-center", "targets": [4, 5, 6] }
        ],
        "drawCallback": function(settings) {
            $('[data-bs-toggle="tooltip"]').tooltip();
            var info = priceListsDataTable.page.info();
            updateTableInfo(info);
        }
    });

    console.log('âœ… DataTable initialized successfully');
    return priceListsDataTable;
}

function updateTableInfo(info) {
    var infoText = 'Ø¹Ø±Ø¶ ' + (info.start + 1) + ' Ø¥Ù„Ù‰ ' + info.end + ' Ù…Ù† ' + info.recordsTotal + ' Ù‚Ø§Ø¦Ù…Ø©';
    if (info.recordsFiltered !== info.recordsTotal) {
        infoText += ' (Ù…ÙÙ„ØªØ± Ù…Ù† ' + info.recordsTotal + ')';
    }
    $('#tableInfo').text(infoText);
}

window.changePageLength = function(length) {
    if (priceListsDataTable) {
        priceListsDataTable.page.len(parseInt(length)).draw();
    }
};

window.exportToExcel = function() {
    window.location.href = '{% url "core:price_list_export" %}';
};

window.deletePriceList = function(id) {
    Swal.fire({
        title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
        text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    }).then((result) => {
        if (result.isConfirmed) {
            var form = $('<form>', {
                'method': 'POST',
                'action': '/price-lists/' + id + '/delete/'
            });

            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                csrfToken = $('<input>', {
                    'type': 'hidden',
                    'name': 'csrfmiddlewaretoken',
                    'value': '{{ csrf_token }}'
                });
            }

            form.append(csrfToken);
            $('body').append(form);
            form.submit();
        }
    });
};

function loadCurrencies() {
    $.get('{% url "core:price_list_datatable_ajax" %}?get_currencies=1', function(data) {
        var select = $('#currencyFilter');
        select.empty().append('<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</option>');
        if (data.currencies) {
            $.each(data.currencies, function(i, currency) {
                select.append('<option value="' + currency.id + '">' + currency.name + '</option>');
            });
        }
    });
}

function loadPriceListsForImport() {
    $.get('{% url "core:price_list_datatable_ajax" %}?get_price_lists=1', function(data) {
        var select = $('#price_list');
        select.empty().append('<option value="">Ø§Ø®ØªØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</option>');
        if (data.price_lists) {
            $.each(data.price_lists, function(i, list) {
                select.append('<option value="' + list.id + '">' + list.code + ' - ' + list.name + '</option>');
            });
        }
    });
}

function loadGridView() {
    $.get('{% url "core:price_list_datatable_ajax" %}?view=grid', function(data) {
        if (data.data && data.data.length > 0) {
            var html = '';
            $.each(data.data, function(i, item) {
                html += `
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${item.name}</h6>
                                    ${item.is_default ? '<span class="badge badge-default">Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</span>' : ''}
                                </div>
                                <p class="text-muted small mb-2">
                                    <i class="fas fa-code"></i> ${item.code}
                                </p>
                                <p class="text-muted small mb-2">
                                    <i class="fas fa-money-bill"></i> ${item.currency}
                                </p>
                                <p class="text-muted small mb-3">
                                    <i class="fas fa-boxes"></i> ${item.items_count} ØµÙ†Ù
                                </p>
                                <div class="d-flex gap-1">
                                    <a href="/price-lists/${item.id}/" class="btn btn-sm btn-outline-primary flex-fill">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/price-lists/${item.id}/update/" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="/price-lists/${item.id}/items/" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-list"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#priceListsGrid').html(html);
        } else {
            $('#priceListsGrid').html(`
                <div class="col-12 text-center py-5">
                    <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³Ø¹Ø§Ø±</p>
                </div>
            `);
        }
    });
}

$(document).ready(function() {
    console.log('ğŸ“„ Document ready - Initializing Price Lists...');

    initDataTable();
    loadCurrencies();
    loadPriceListsForImport();

    $('#currencyFilter, #isActiveFilter, #isDefaultFilter').on('change', function() {
        if (priceListsDataTable) {
            priceListsDataTable.ajax.reload();
        }
    });

    $('#searchFilter').on('keyup', function() {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(function() {
            if (priceListsDataTable) {
                priceListsDataTable.ajax.reload();
            }
        }, 500);
    });

    $('#clearFilters').on('click', function() {
        $('#currencyFilter, #isActiveFilter, #isDefaultFilter').val('');
        $('#searchFilter').val('');
        if (priceListsDataTable) {
            priceListsDataTable.ajax.reload();
        }
    });

    $('input[name="viewMode"]').on('change', function() {
        currentView = $(this).val();
        if (currentView === 'list') {
            $('#listViewContainer').show();
            $('#gridViewContainer').hide();
        } else {
            $('#listViewContainer').hide();
            $('#gridViewContainer').show();
            loadGridView();
        }
    });
});

$('#importForm').on('submit', function(e) {
    var fileInput = $('#id_file')[0];
    var priceList = $('#price_list').val();

    if (!fileInput.files[0] || !priceList) {
        e.preventDefault();
        Swal.fire({
            icon: 'warning',
            title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø©',
            text: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±'
        });
        return;
    }

    Swal.fire({
        title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...',
        html: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ Ø§ÙƒØªÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });
});
</script>
{% endblock %}
