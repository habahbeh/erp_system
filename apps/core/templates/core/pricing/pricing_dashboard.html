{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}لوحة التسعير{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
:root {
  --primary-color: #1976d2;
  --primary-light: #42a5f5;
  --primary-dark: #1565c0;
  --secondary-color: #424242;
  --success-color: #4caf50;
  --warning-color: #ff9800;
  --error-color: #f44336;
  --info-color: #2196f3;
  --surface-color: #ffffff;
  --background-color: #f8f9fa;
  --text-primary: #212121;
  --text-secondary: #757575;
  --border-color: #e0e0e0;
  --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
  --shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
  --shadow-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
  --border-radius: 8px;
  --border-radius-large: 12px;
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Cairo', sans-serif;
  background-color: var(--background-color);
  color: var(--text-primary);
  line-height: 1.6;
}

.dashboard-container {
  max-width: 1440px;
  margin: 0 auto;
  padding: 24px;
}

.dashboard-header {
  margin-bottom: 32px;
  padding: 0;
}

.dashboard-title {
  font-size: 2.125rem;
  font-weight: 400;
  color: var(--text-primary);
  margin: 0 0 8px 0;
  letter-spacing: 0.0125em;
}

.dashboard-subtitle {
  font-size: 1rem;
  color: var(--text-secondary);
  margin: 0 0 16px 0;
  font-weight: 400;
}

.company-info {
  display: inline-flex;
  align-items: center;
  background: var(--surface-color);
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid var(--border-color);
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.company-info .material-icons {
  font-size: 18px;
  margin-left: 8px;
  color: var(--primary-color);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
  margin-bottom: 40px;
}

.stats-card {
  background: var(--surface-color);
  border-radius: var(--border-radius-large);
  padding: 24px;
  box-shadow: var(--shadow-1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  border: 1px solid var(--border-color);
}

.stats-card:hover {
  box-shadow: var(--shadow-2);
  transform: translateY(-2px);
}

.stats-card-content {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
}

.stats-text {
  flex: 1;
}

.stats-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin: 0 0 8px 0;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stats-value {
  font-size: 2rem;
  font-weight: 300;
  color: var(--text-primary);
  margin: 0;
  line-height: 1.2;
}

.stats-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 16px;
}

.stats-icon .material-icons {
  font-size: 24px;
  color: var(--surface-color);
}

.stats-card.price-lists .stats-icon { background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); }
.stats-card.items .stats-icon { background: linear-gradient(135deg, var(--success-color), #66bb6a); }
.stats-card.rules .stats-icon { background: linear-gradient(135deg, var(--warning-color), #ffb74d); }
.stats-card.changes .stats-icon { background: linear-gradient(135deg, var(--info-color), #42a5f5); }

.quick-actions {
  margin-bottom: 40px;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 400;
  color: var(--text-primary);
  margin: 0 0 24px 0;
}

.actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
}

.action-card {
  background: var(--surface-color);
  border-radius: var(--border-radius-large);
  padding: 24px;
  text-align: center;
  box-shadow: var(--shadow-1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-decoration: none;
  color: inherit;
  border: 1px solid var(--border-color);
  position: relative;
  overflow: hidden;
}

.action-card:hover {
  box-shadow: var(--shadow-2);
  transform: translateY(-4px);
  text-decoration: none;
  color: inherit;
}

.action-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--primary-color);
  transform: scaleX(0);
  transition: transform 0.3s ease;
}

.action-card:hover::before {
  transform: scaleX(1);
}

.action-icon {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  margin: 0 auto 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.action-icon .material-icons {
  font-size: 32px;
  color: var(--surface-color);
}

.action-card.quick .action-icon { background: linear-gradient(135deg, #ff6b35, #f7931e); }
.action-card.detailed .action-icon { background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); }
.action-card.rules .action-icon { background: linear-gradient(135deg, var(--success-color), #66bb6a); }
.action-card.reports .action-icon { background: linear-gradient(135deg, #9c27b0, #e91e63); }

.action-title {
  font-size: 1.125rem;
  font-weight: 500;
  color: var(--text-primary);
  margin: 0 0 8px 0;
}

.action-description {
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin: 0 0 16px 0;
  line-height: 1.5;
}

.action-button {
  background: var(--primary-color);
  color: var(--surface-color);
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.action-button:hover {
  background: var(--primary-dark);
  transform: scale(1.05);
}

.content-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 32px;
}

.content-card {
  background: var(--surface-color);
  border-radius: var(--border-radius-large);
  padding: 0;
  box-shadow: var(--shadow-1);
  border: 1px solid var(--border-color);
  overflow: hidden;
}

.card-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-color);
  background: #fafafa;
}

.card-title {
  font-size: 1.25rem;
  font-weight: 500;
  color: var(--text-primary);
  margin: 0;
  display: flex;
  align-items: center;
}

.card-title .material-icons {
  font-size: 24px;
  margin-left: 12px;
  color: var(--primary-color);
}

.card-body {
  padding: 24px;
}

.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 48px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--border-color);
  border-top: 4px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.task-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.task-item {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
  transition: background-color 0.2s ease;
  text-decoration: none;
  color: inherit;
  display: flex;
  align-items: center;
}

.task-item:hover {
  background-color: #f5f5f5;
  text-decoration: none;
  color: inherit;
}

.task-item:last-child {
  border-bottom: none;
}

.task-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 16px;
  font-size: 18px;
}

.task-icon.warning { background: rgba(255, 152, 0, 0.1); color: var(--warning-color); }
.task-icon.primary { background: rgba(25, 118, 210, 0.1); color: var(--primary-color); }
.task-icon.success { background: rgba(76, 175, 80, 0.1); color: var(--success-color); }
.task-icon.info { background: rgba(33, 150, 243, 0.1); color: var(--info-color); }

.task-content {
  flex: 1;
}

.task-text {
  font-size: 0.875rem;
  color: var(--text-primary);
  margin: 0;
  font-weight: 500;
}

.fade-in {
  animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.slide-up {
  animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 968px) {
  .content-grid {
    grid-template-columns: 1fr;
    gap: 24px;
  }

  .dashboard-container {
    padding: 16px;
  }

  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
  }

  .actions-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }
}

@media (max-width: 576px) {
  .dashboard-title {
    font-size: 1.75rem;
  }

  .stats-card {
    padding: 20px;
  }

  .action-card {
    padding: 20px;
  }

  .stats-value {
    font-size: 1.75rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header fade-in">
        <h1 class="dashboard-title">لوحة إدارة التسعير</h1>
        <p class="dashboard-subtitle">نظرة شاملة على قوائم الأسعار وقواعد التسعير والتحديثات الأخيرة</p>
        <div class="company-info">
            <span class="material-icons">business</span>
            <span>{{ request.current_company.name }}</span>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stats-card price-lists slide-up" style="animation-delay: 0.1s">
            <div class="stats-card-content">
                <div class="stats-text">
                    <div class="stats-label">قوائم الأسعار</div>
                    <div class="stats-value" id="totalPriceLists">...</div>
                </div>
                <div class="stats-icon">
                    <span class="material-icons">list_alt</span>
                </div>
            </div>
        </div>

        <div class="stats-card items slide-up" style="animation-delay: 0.2s">
            <div class="stats-card-content">
                <div class="stats-text">
                    <div class="stats-label">الأسعار المسجلة</div>
                    <div class="stats-value" id="totalPriceItems">...</div>
                </div>
                <div class="stats-icon">
                    <span class="material-icons">attach_money</span>
                </div>
            </div>
        </div>

        <div class="stats-card rules slide-up" style="animation-delay: 0.3s">
            <div class="stats-card-content">
                <div class="stats-text">
                    <div class="stats-label">قواعد التسعير النشطة</div>
                    <div class="stats-value" id="activeRules">...</div>
                </div>
                <div class="stats-icon">
                    <span class="material-icons">rule</span>
                </div>
            </div>
        </div>

        <div class="stats-card changes slide-up" style="animation-delay: 0.4s">
            <div class="stats-card-content">
                <div class="stats-text">
                    <div class="stats-label">تحديثات هذا الشهر</div>
                    <div class="stats-value" id="monthlyChanges">...</div>
                </div>
                <div class="stats-icon">
                    <span class="material-icons">update</span>
                </div>
            </div>
        </div>
    </div>

    <div class="quick-actions">
        <h2 class="section-title">إجراءات سريعة</h2>
        <div class="actions-grid">
            <a href="{% url 'core:price_list_create' %}" class="action-card quick slide-up" style="animation-delay: 0.5s">
                <div class="action-icon">
                    <span class="material-icons">add</span>
                </div>
                <h3 class="action-title">قائمة أسعار جديدة</h3>
                <p class="action-description">إنشاء قائمة أسعار جديدة للعملاء</p>
                <button class="action-button">إنشاء قائمة</button>
            </a>

            <a href="{% url 'core:bulk_price_update' %}" class="action-card detailed slide-up" style="animation-delay: 0.6s">
                <div class="action-icon">
                    <span class="material-icons">published_with_changes</span>
                </div>
                <h3 class="action-title">تحديث جماعي</h3>
                <p class="action-description">تحديث أسعار مجموعة من المواد دفعة واحدة</p>
                <button class="action-button">تحديث الأسعار</button>
            </a>

            <a href="{% url 'core:pricing_rule_create' %}" class="action-card rules slide-up" style="animation-delay: 0.7s">
                <div class="action-icon">
                    <span class="material-icons">rule</span>
                </div>
                <h3 class="action-title">قاعدة تسعير</h3>
                <p class="action-description">إنشاء قاعدة تسعير ديناميكية جديدة</p>
                <button class="action-button">إضافة قاعدة</button>
            </a>

            <a href="{% url 'core:price_report' %}" class="action-card reports slide-up" style="animation-delay: 0.8s">
                <div class="action-icon">
                    <span class="material-icons">analytics</span>
                </div>
                <h3 class="action-title">التقارير</h3>
                <p class="action-description">عرض تقارير وتحليلات الأسعار</p>
                <button class="action-button">عرض التقارير</button>
            </a>
        </div>
    </div>

    <div class="content-grid">
        <div class="content-card slide-up" style="animation-delay: 0.9s">
            <div class="card-header">
                <h3 class="card-title">
                    <span class="material-icons">history</span>
                    آخر التحديثات
                </h3>
            </div>
            <div class="card-body">
                <div id="recentChanges">
                    <div class="loading-container">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card slide-up" style="animation-delay: 1s">
            <div class="card-header">
                <h3 class="card-title">
                    <span class="material-icons">task</span>
                    مهام سريعة
                </h3>
            </div>
            <div class="card-body">
                <div class="task-list">
                    <a href="{% url 'core:price_list_list' %}" class="task-item">
                        <div class="task-icon primary">
                            <span class="material-icons">list</span>
                        </div>
                        <div class="task-content">
                            <p class="task-text">عرض جميع قوائم الأسعار</p>
                        </div>
                    </a>

                    <a href="{% url 'core:pricing_rule_list' %}" class="task-item">
                        <div class="task-icon success">
                            <span class="material-icons">rule</span>
                        </div>
                        <div class="task-content">
                            <p class="task-text">إدارة قواعد التسعير</p>
                        </div>
                    </a>

                    <a href="{% url 'core:price_simulator' %}" class="task-item">
                        <div class="task-icon info">
                            <span class="material-icons">calculate</span>
                        </div>
                        <div class="task-content">
                            <p class="task-text">محاكي الأسعار</p>
                        </div>
                    </a>

                    <a href="{% url 'core:price_comparison' %}" class="task-item">
                        <div class="task-icon warning">
                            <span class="material-icons">compare</span>
                        </div>
                        <div class="task-content">
                            <p class="task-text">مقارنة الأسعار</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    Promise.all([
        loadDashboardStats(),
        loadRecentChanges()
    ]).then(() => {
        console.log('تم تحميل جميع بيانات لوحة التسعير');
    }).catch(error => {
        console.error('خطأ في تحميل البيانات:', error);
    });
});

async function loadDashboardStats() {
    try {
        animateCounter('totalPriceLists', {{ total_price_lists|default:0 }});
        animateCounter('totalPriceItems', {{ total_price_items|default:0 }});
        animateCounter('activeRules', {{ active_rules|default:0 }});
        animateCounter('monthlyChanges', {{ monthly_changes|default:0 }});
    } catch (error) {
        console.error('خطأ في تحميل الإحصائيات:', error);
        document.getElementById('totalPriceLists').textContent = '--';
        document.getElementById('totalPriceItems').textContent = '--';
        document.getElementById('activeRules').textContent = '--';
        document.getElementById('monthlyChanges').textContent = '--';
    }
}

async function loadRecentChanges() {
    try {
        const recentChanges = {{ recent_changes|default:"[]"|safe }};

        if (!recentChanges || recentChanges.length === 0) {
            document.getElementById('recentChanges').innerHTML = `
                <div class="text-center py-4">
                    <p class="text-muted">لا توجد تحديثات حديثة</p>
                </div>
            `;
            return;
        }

        let html = '<div class="list-group list-group-flush">';
        recentChanges.forEach(change => {
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${change.title}</h6>
                            <p class="mb-0 text-muted small">${change.description}</p>
                        </div>
                        <small class="text-muted">${change.date}</small>
                    </div>
                </div>
            `;
        });
        html += '</div>';

        document.getElementById('recentChanges').innerHTML = html;
    } catch (error) {
        console.error('خطأ في تحميل التحديثات:', error);
        document.getElementById('recentChanges').innerHTML = `
            <div class="text-center py-4">
                <p class="text-muted">خطأ في تحميل التحديثات</p>
            </div>
        `;
    }
}

function animateCounter(elementId, target) {
    const element = document.getElementById(elementId);
    if (!element) return;

    let current = 0;
    const increment = Math.max(1, Math.ceil(target / 50));
    const duration = 2000;
    const stepTime = Math.abs(Math.floor(duration / (target / increment)));

    const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
            element.textContent = target;
            clearInterval(timer);
        } else {
            element.textContent = current;
        }
    }, stepTime);
}
</script>
{% endblock %}
