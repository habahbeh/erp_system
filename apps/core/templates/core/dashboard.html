{# templates/core/dashboard.html #}
{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{% trans "لوحة التحكم" %}{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
/* إصلاح شريط التمرير الأفقي */
html, body {
    overflow-x: hidden;
    width: 100%;
    max-width: 100vw;
}

/* Google Material Design Dashboard */
:root {
    --google-blue: #1a73e8;
    --google-red: #ea4335;
    --google-yellow: #fbbc05;
    --google-green: #34a853;
    --google-grey-50: #f8f9fa;
    --google-grey-100: #f1f3f4;
    --google-grey-200: #e8eaed;
    --google-grey-300: #dadce0;
    --google-grey-400: #bdc1c6;
    --google-grey-500: #9aa0a6;
    --google-grey-600: #80868b;
    --google-grey-700: #5f6368;
    --google-grey-800: #3c4043;
    --google-grey-900: #202124;
}

body {
    font-family: 'Google Sans', 'Roboto', 'Cairo', sans-serif;
    background-color: var(--google-grey-50);
    color: var(--google-grey-800);
    line-height: 1.5;
}

.main-content {
    background-color: var(--google-grey-50);
    min-height: 100vh;
    overflow-x: hidden;
    width: 100%;
}

/* Header - بدون negative margin */
.dashboard-header {
    background: white;
    border-bottom: 1px solid var(--google-grey-200);
    padding: 24px 32px;
    margin: 0 0 32px 0;
    width: 100%;
}

.dashboard-title {
    font-size: 28px;
    font-weight: 400;
    color: var(--google-grey-800);
    margin: 0;
    letter-spacing: 0;
}

.dashboard-subtitle {
    font-size: 14px;
    color: var(--google-grey-600);
    margin: 4px 0 0 0;
}

/* Cards */
.google-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
    border: none;
    transition: box-shadow 0.3s ease;
    overflow: hidden;
}

.google-card:hover {
    box-shadow: 0 2px 6px 2px rgba(60, 64, 67, 0.15), 0 8px 24px 4px rgba(60, 64, 67, 0.15);
}

.google-card .card-body {
    padding: 24px;
}

/* Stat Cards */
.stat-card {
    cursor: pointer;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-header {
    display: flex;
    align-items: center;
    margin-bottom: 16px;
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 16px;
    font-size: 20px;
    color: white;
}

.stat-icon.blue { background-color: var(--google-blue); }
.stat-icon.red { background-color: var(--google-red); }
.stat-icon.green { background-color: var(--google-green); }
.stat-icon.yellow { background-color: var(--google-yellow); color: var(--google-grey-800); }

.stat-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--google-grey-600);
    margin: 0;
}

.stat-number {
    font-size: 36px;
    font-weight: 400;
    color: var(--google-grey-800);
    margin: 8px 0;
    line-height: 1.1;
}

.stat-change {
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.stat-change.positive {
    color: var(--google-green);
}

.stat-change.negative {
    color: var(--google-red);
}

.stat-change .material-icons {
    font-size: 16px;
}

/* Chart Cards */
.chart-card {
    margin-bottom: 32px;
}

.chart-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--google-grey-200);
    background: white;
}

.chart-title {
    font-size: 16px;
    font-weight: 500;
    color: var(--google-grey-800);
    margin: 0;
}

.chart-subtitle {
    font-size: 13px;
    color: var(--google-grey-600);
    margin: 4px 0 0 0;
}

.chart-body {
    padding: 24px;
    background: white;
}

/* Filters */
.chart-filters {
    display: flex;
    gap: 8px;
}

.filter-chip {
    padding: 6px 16px;
    background: var(--google-grey-100);
    border: 1px solid var(--google-grey-300);
    border-radius: 16px;
    font-size: 13px;
    font-weight: 500;
    color: var(--google-grey-700);
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
}

.filter-chip:hover {
    background: var(--google-grey-200);
    color: var(--google-grey-800);
}

.filter-chip.active {
    background: var(--google-blue);
    color: white;
    border-color: var(--google-blue);
}

/* Activity List */
.activity-list {
    padding: 0;
}

.activity-item {
    padding: 16px 24px;
    border-bottom: 1px solid var(--google-grey-200);
    display: flex;
    align-items: center;
    transition: background-color 0.2s ease;
    cursor: pointer;
}

.activity-item:hover {
    background-color: var(--google-grey-50);
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 16px;
    font-size: 16px;
    color: white;
}

.activity-content h6 {
    font-size: 14px;
    font-weight: 500;
    color: var(--google-grey-800);
    margin: 0 0 4px 0;
}

.activity-content p {
    font-size: 13px;
    color: var(--google-grey-600);
    margin: 0;
}

.activity-time {
    font-size: 12px;
    color: var(--google-grey-500);
    margin-right: auto;
}

/* Quick Actions */
.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
    padding: 24px;
}

.quick-action {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 16px;
    background: white;
    border: 1px solid var(--google-grey-300);
    border-radius: 8px;
    text-decoration: none;
    color: var(--google-grey-700);
    transition: all 0.2s ease;
    cursor: pointer;
}

.quick-action:hover {
    border-color: var(--google-blue);
    box-shadow: 0 1px 3px rgba(26, 115, 232, 0.3);
    color: var(--google-blue);
    text-decoration: none;
}

.quick-action .material-icons {
    font-size: 32px;
    margin-bottom: 8px;
    color: var(--google-grey-500);
    transition: color 0.2s ease;
}

.quick-action:hover .material-icons {
    color: var(--google-blue);
}

.quick-action span {
    font-size: 13px;
    font-weight: 500;
    text-align: center;
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard-header {
        padding: 16px 20px;
        margin: 0 0 20px 0;
    }

    .dashboard-title {
        font-size: 20px;
    }

    .google-card .card-body {
        padding: 16px;
    }

    .stat-number {
        font-size: 24px;
    }

    .container-fluid {
        padding-right: 15px;
        padding-left: 15px;
    }

    .quick-actions-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        padding: 16px;
    }
}

/* Custom scrollbar */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: var(--google-grey-100);
}

::-webkit-scrollbar-thumb {
    background: var(--google-grey-400);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--google-grey-500);
}

/* Animations */
.fade-in {
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1 class="dashboard-title">{% trans "لوحة التحكم" %}</h1>
    <p class="dashboard-subtitle">
        {% trans "مرحباً" %} {{ user.get_full_name|default:user.username }}،
        {{ today|date:"l, d F Y" }}
    </p>
</div>

<div class="container-fluid">
    <!-- Stats Grid -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="google-card stat-card fade-in">
                <div class="card-body">
                    <div class="stat-header">
                        <div class="stat-icon blue">
                            <span class="material-icons">people</span>
                        </div>
                        <div class="flex-grow-1">
                            <p class="stat-title">{% trans "إجمالي المستخدمين" %}</p>
                        </div>
                    </div>
                    <div class="stat-number" id="usersCount">{{ total_users|default:"1,247" }}</div>
                    <div class="stat-change positive">
                        <span class="material-icons">trending_up</span>
                        <span>12% {% trans "من الشهر الماضي" %}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="google-card stat-card fade-in" style="animation-delay: 0.1s">
                <div class="card-body">
                    <div class="stat-header">
                        <div class="stat-icon green">
                            <span class="material-icons">business</span>
                        </div>
                        <div class="flex-grow-1">
                            <p class="stat-title">{% trans "الشركات النشطة" %}</p>
                        </div>
                    </div>
                    <div class="stat-number">{{ total_companies|default:"45" }}</div>
                    <div class="stat-change positive">
                        <span class="material-icons">trending_up</span>
                        <span>8.5% {% trans "هذا الأسبوع" %}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="google-card stat-card fade-in" style="animation-delay: 0.2s">
                <div class="card-body">
                    <div class="stat-header">
                        <div class="stat-icon red">
                            <span class="material-icons">security</span>
                        </div>
                        <div class="flex-grow-1">
                            <p class="stat-title">{% trans "الصلاحيات المخصصة" %}</p>
                        </div>
                    </div>
                    <div class="stat-number">{{ total_permissions|default:"234" }}</div>
                    <div class="stat-change negative">
                        <span class="material-icons">trending_down</span>
                        <span>3% {% trans "اليوم" %}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="google-card stat-card fade-in" style="animation-delay: 0.3s">
                <div class="card-body">
                    <div class="stat-header">
                        <div class="stat-icon yellow">
                            <span class="material-icons">speed</span>
                        </div>
                        <div class="flex-grow-1">
                            <p class="stat-title">{% trans "صحة النظام" %}</p>
                        </div>
                    </div>
                    <div class="stat-number">98%</div>
                    <div class="stat-change positive">
                        <span class="material-icons">check_circle</span>
                        <span>{% trans "يعمل بكفاءة" %}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="google-card chart-card fade-in" style="animation-delay: 0.4s">
                <div class="chart-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h3 class="chart-title">{% trans "نشاط المستخدمين" %}</h3>
                            <p class="chart-subtitle">{% trans "آخر 30 يوم" %}</p>
                        </div>
                        <div class="chart-filters">
                            <span class="filter-chip active">30د</span>
                            <span class="filter-chip">7د</span>
                            <span class="filter-chip">يوم</span>
                        </div>
                    </div>
                </div>
                <div class="chart-body">
                    <canvas id="activityChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="google-card chart-card fade-in" style="animation-delay: 0.5s">
                <div class="chart-header">
                    <h3 class="chart-title">{% trans "توزيع الصلاحيات" %}</h3>
                    <p class="chart-subtitle">{% trans "حسب النوع" %}</p>
                </div>
                <div class="chart-body">
                    <canvas id="permissionsChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Row -->
    <div class="row g-4">
        <div class="col-lg-7">
            <div class="google-card fade-in" style="animation-delay: 0.6s">
                <div class="chart-header">
                    <h3 class="chart-title">{% trans "الأنشطة الأخيرة" %}</h3>
                    <p class="chart-subtitle">{% trans "آخر التحديثات في النظام" %}</p>
                </div>
                <div class="activity-list">
                    {% if recent_activities %}
                        {% for activity in recent_activities %}
                        <div class="activity-item">
                            <div class="activity-icon {{ activity.type|default:'blue' }}">
                                <span class="material-icons">{{ activity.icon|default:'notification_important' }}</span>
                            </div>
                            <div class="activity-content flex-grow-1">
                                <h6>{{ activity.title }}</h6>
                                <p>{{ activity.description }}</p>
                            </div>
                            <div class="activity-time">{{ activity.created_at|timesince }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="activity-item">
                            <div class="activity-icon blue">
                                <span class="material-icons">person_add</span>
                            </div>
                            <div class="activity-content flex-grow-1">
                                <h6>{% trans "مستخدم جديد انضم" %}</h6>
                                <p>{% trans "سارة أحمد انضمت للنظام" %}</p>
                            </div>
                            <div class="activity-time">{% trans "5 دقائق" %}</div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon green">
                                <span class="material-icons">business_center</span>
                            </div>
                            <div class="activity-content flex-grow-1">
                                <h6>{% trans "شركة جديدة أضيفت" %}</h6>
                                <p>{% trans "شركة المستقبل التجارية" %}</p>
                            </div>
                            <div class="activity-time">{% trans "12 دقيقة" %}</div>
                        </div>

                        <div class="activity-item">
                            <div class="activity-icon yellow">
                                <span class="material-icons">admin_panel_settings</span>
                            </div>
                            <div class="activity-content flex-grow-1">
                                <h6>{% trans "تحديث الصلاحيات" %}</h6>
                                <p>{% trans "تم تحديث صلاحيات المستخدمين" %}</p>
                            </div>
                            <div class="activity-time">{% trans "ساعة" %}</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="google-card fade-in" style="animation-delay: 0.7s">
                <div class="chart-header">
                    <h3 class="chart-title">{% trans "إجراءات سريعة" %}</h3>
                    <p class="chart-subtitle">{% trans "المهام الأكثر استخداماً" %}</p>
                </div>
                <div class="quick-actions-grid">
                    <a href="{% url 'core:user_create' %}" class="quick-action">
                        <span class="material-icons">person_add</span>
                        <span>{% trans "مستخدم جديد" %}</span>
                    </a>

                    <a href="{% url 'core:company_detail' %}" class="quick-action">
                        <span class="material-icons">add_business</span>
                        <span>{% trans "شركة جديدة" %}</span>
                    </a>

                    <a href="{% url 'core:permission_create' %}" class="quick-action">
                        <span class="material-icons">shield</span>
                        <span>{% trans "صلاحية جديدة" %}</span>
                    </a>

                    <a href="#" class="quick-action" data-feature="فاتورة جديدة">
                        <span class="material-icons">receipt_long</span>
                        <span>{% trans "فاتورة جديدة" %}</span>
                    </a>

                    <a href="#" class="quick-action" data-feature="تقرير">
                        <span class="material-icons">analytics</span>
                        <span>{% trans "تقرير جديد" %}</span>
                    </a>

                    <a href="#" class="quick-action">
                        <span class="material-icons">settings</span>
                        <span>{% trans "الإعدادات" %}</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Coming Soon handler
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.quick-action[data-feature]').forEach(action => {
        action.addEventListener('click', function(e) {
            e.preventDefault();
            const feature = this.getAttribute('data-feature');
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'info',
                    title: 'قريباً',
                    text: `وحدة ${feature} قيد التطوير وستكون متاحة قريباً`,
                    confirmButtonText: 'حسناً'
                });
            }
        });
    });
});

// Charts with Google colors
const googleColors = {
    blue: '#1a73e8',
    red: '#ea4335',
    yellow: '#fbbc05',
    green: '#34a853'
};

// Activity Chart
const activityCtx = document.getElementById('activityChart');
if (activityCtx) {
    new Chart(activityCtx.getContext('2d'), {
        type: 'line',
        data: {
            labels: ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'],
            datasets: [{
                label: 'تسجيل الدخول',
                data: [12, 19, 15, 25, 22, 18, 30],
                borderColor: googleColors.blue,
                backgroundColor: googleColors.blue + '20',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: googleColors.blue,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 4
            }, {
                label: 'المستخدمين النشطين',
                data: [8, 15, 12, 20, 18, 14, 25],
                borderColor: googleColors.green,
                backgroundColor: googleColors.green + '20',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: googleColors.green,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: { family: 'Google Sans', size: 12 }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#f1f3f4' },
                    ticks: { color: '#5f6368', font: { family: 'Google Sans' } }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#5f6368', font: { family: 'Google Sans' } }
                }
            }
        }
    });
}

// Permissions Chart
const permissionsCtx = document.getElementById('permissionsChart');
if (permissionsCtx) {
    new Chart(permissionsCtx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['المبيعات', 'المشتريات', 'المخازن', 'المحاسبة', 'النظام', 'التقارير'],
            datasets: [{
                data: [25, 20, 15, 20, 10, 10],
                backgroundColor: [
                    googleColors.blue,
                    googleColors.red,
                    googleColors.yellow,
                    googleColors.green,
                    '#9aa0a6',
                    '#80868b'
                ],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: { family: 'Google Sans', size: 11 }
                    }
                }
            }
        }
    });
}

// Filter chips functionality
document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', function() {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
    });
});

// Number animation for stats
function animateValue(obj, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const current = Math.floor(progress * (end - start) + start);
        obj.innerHTML = current.toLocaleString();
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

// Initialize counters
window.addEventListener('load', () => {
    const userCount = document.getElementById('usersCount');
    if (userCount) {
        const targetValue = parseInt(userCount.textContent.replace(/,/g, ''));
        setTimeout(() => animateValue(userCount, 0, targetValue, 1500), 300);
    }
});
</script>
{% endblock %}