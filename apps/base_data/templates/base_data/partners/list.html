<!-- apps/base_data/templates/base_data/partners/list.html -->
{% extends 'base_data/base/list_base.html' %}
{% load i18n %}

{% block list_icon %}<i class="fas fa-users me-2"></i>{% endblock %}
{% block list_title %}{% trans "الشركاء التجاريون" %}{% endblock %}
{% block total_count %}({{ stats.total }} {% trans "شريك" %}){% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">{% trans "الشركاء التجاريون" %}</li>
{% endblock %}

{% block add_url %}{% url 'base_data:partner_create' %}{% endblock %}
{% block import_url %}{% url 'base_data:partner_import' %}{% endblock %}
{% block export_excel_url %}{% url 'base_data:partner_export' %}{% endblock %}
{% block export_csv_url %}{% url 'base_data:partner_export' %}{% endblock %}

{% block list_actions %}
{{ block.super }}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
        <i class="fas fa-plus me-1"></i>{% trans "إضافة شريك" %}
    </button>
    <ul class="dropdown-menu">
        {% if perms.base_data.add_businesspartner %}
        <li><a class="dropdown-item" href="{% url 'base_data:partner_create' %}">
            <i class="fas fa-handshake me-1"></i>{% trans "شريك عام" %}
        </a></li>
        <li><a class="dropdown-item" href="{% url 'base_data:customer_create' %}">
            <i class="fas fa-user-tie me-1"></i>{% trans "عميل" %}
        </a></li>
        <li><a class="dropdown-item" href="{% url 'base_data:supplier_create' %}">
            <i class="fas fa-truck me-1"></i>{% trans "مورد" %}
        </a></li>
        {% endif %}
    </ul>
</div>
{% endblock %}

{% block filters %}
<div class="card-header bg-light border-bottom">
    <form method="get" id="filter-form">
        <div class="row g-3">
            <div class="col-md-3">
                {{ filter_form.search.label_tag }}
                {{ filter_form.search }}
            </div>
            <div class="col-md-2">
                {{ filter_form.partner_type.label_tag }}
                {{ filter_form.partner_type }}
            </div>
            <div class="col-md-2">
                {{ filter_form.account_type.label_tag }}
                {{ filter_form.account_type }}
            </div>
            <div class="col-md-2">
                {{ filter_form.city.label_tag }}
                {{ filter_form.city }}
            </div>
            <div class="col-md-2">
                {{ filter_form.is_active.label_tag }}
                {{ filter_form.is_active }}
            </div>
            <div class="col-md-1">
                <label>&nbsp;</label>
                <div>
                    <button type="button" class="btn btn-primary btn-sm" id="apply-filters">
                        <i class="fas fa-search"></i>
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" id="clear-filters">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- الصف الثاني من الفلاتر -->
        <div class="row g-3 mt-2">
            <div class="col-md-2">
                {{ filter_form.tax_status.label_tag }}
                {{ filter_form.tax_status }}
            </div>
            <div class="col-md-2">
                {{ filter_form.salesperson.label_tag }}
                {{ filter_form.salesperson }}
            </div>
            <div class="col-md-2">
                {{ filter_form.customer_category.label_tag }}
                {{ filter_form.customer_category }}
            </div>
            <div class="col-md-2">
                {{ filter_form.supplier_category.label_tag }}
                {{ filter_form.supplier_category }}
            </div>
            <div class="col-md-2">
                {{ filter_form.has_email.label_tag }}
                {{ filter_form.has_email }}
            </div>
            <div class="col-md-2">
                <div class="form-check form-switch mt-4">
                    <input class="form-check-input" type="checkbox" id="advanced-filters">
                    <label class="form-check-label" for="advanced-filters">
                        {% trans "فلاتر متقدمة" %}
                    </label>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block table_headers %}
<tr>
    <th width="40">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="select-all">
        </div>
    </th>
    <th>{% trans "الكود" %}</th>
    <th>{% trans "اسم الشريك" %}</th>
    <th>{% trans "نوع الشريك" %}</th>
    <th>{% trans "الهاتف" %}</th>
    <th>{% trans "البريد الإلكتروني" %}</th>
    <th>{% trans "المدينة" %}</th>
    <th>{% trans "الرصيد" %}</th>
    <th>{% trans "الحالة" %}</th>
    <th width="150">{% trans "الإجراءات" %}</th>
</tr>
{% endblock %}

{% block datatable_url %}{% url 'base_data:partner_datatable' %}{% endblock %}

{% block datatable_columns %}
{ data: 'checkbox', orderable: false, searchable: false, render: function(data, type, row) {
    return '<div class="form-check"><input class="form-check-input" type="checkbox" value="' + row.id + '"></div>';
}},
{ data: 'code', name: 'code' },
{ data: 'name', name: 'name', render: function(data, type, row) {
    let html = '<div><strong><a href="{% url 'base_data:partner_detail' 0 %}'.replace('0', row.id) + '" class="text-decoration-none">' + data + '</a></strong>';
    if(row.contact_person) {
        html += '<br><small class="text-muted"><i class="fas fa-user me-1"></i>' + row.contact_person + '</small>';
    }
    html += '</div>';
    return html;
}},
{ data: 'partner_type', name: 'partner_type', render: function(data, type, row) {
    let badgeClass = '';
    let icon = '';
    if(data === 'عميل') {
        badgeClass = 'bg-primary';
        icon = 'fa-user-tie';
    } else if(data === 'مورد') {
        badgeClass = 'bg-success';
        icon = 'fa-truck';
    } else {
        badgeClass = 'bg-info';
        icon = 'fa-handshake';
    }
    return '<span class="badge ' + badgeClass + '"><i class="fas ' + icon + ' me-1"></i>' + data + '</span>';
}},
{ data: 'phone', name: 'phone', render: function(data, type, row) {
    if(!data && !row.mobile) return '-';
    let html = '';
    if(data) html += '<div><i class="fas fa-phone me-1"></i>' + data + '</div>';
    if(row.mobile) html += '<div><i class="fas fa-mobile-alt me-1"></i>' + row.mobile + '</div>';
    return html;
}},
{ data: 'email', name: 'email', render: function(data, type, row) {
    if(!data) return '-';
    return '<a href="mailto:' + data + '" class="text-decoration-none"><i class="fas fa-envelope me-1"></i>' + data + '</a>';
}},
{ data: 'city', name: 'city' },
{ data: 'balance', name: 'balance', render: function(data, type, row) {
    if(!data || data == 0) return '<span class="text-muted">0.00</span>';
    let balanceClass = parseFloat(data) > 0 ? 'text-success' : 'text-danger';
    return '<span class="fw-bold ' + balanceClass + '">' + parseFloat(data).toLocaleString('ar-SA', {minimumFractionDigits: 2}) + '</span>';
}},
{ data: 'is_active', name: 'is_active', render: function(data, type, row) {
    if(data) {
        return '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>{% trans "نشط" %}</span>';
    } else {
        return '<span class="badge bg-secondary"><i class="fas fa-pause-circle me-1"></i>{% trans "غير نشط" %}</span>';
    }
}},
{ data: 'actions', orderable: false, searchable: false }
{% endblock %}

{% block bulk_action_url %}{% url 'base_data:partner_bulk_action' %}{% endblock %}

{% block filter_data %}
// إرسال بيانات الفلاتر
d.search = $('#id_search').val();
d.partner_type = $('#id_partner_type').val();
d.account_type = $('#id_account_type').val();
d.tax_status = $('#id_tax_status').val();
d.city = $('#id_city').val();
d.is_active = $('#id_is_active').val();
d.salesperson = $('#id_salesperson').val();
d.customer_category = $('#id_customer_category').val();
d.supplier_category = $('#id_supplier_category').val();
d.has_email = $('#id_has_email').val();
{% endblock %}

{% block clear_filters %}
$('#filter-form')[0].reset();
$('#id_is_active').val('1'); // إعادة تعيين القيمة الافتراضية
{% endblock %}

{% block custom_js %}
// إحصائيات سريعة
let statsHtml = `
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4>{{ stats.total }}</h4>
                    <small>{% trans "إجمالي الشركاء" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4>{{ stats.customers }}</h4>
                    <small>{% trans "العملاء" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4>{{ stats.suppliers }}</h4>
                    <small>{% trans "الموردين" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4>{{ stats.active }}</h4>
                    <small>{% trans "النشطين" %}</small>
                </div>
            </div>
        </div>
    </div>
`;

$('.card-body').prepend(statsHtml);

// تفعيل/إلغاء تفعيل الشريك
function togglePartnerStatus(partnerId) {
    if(confirm('{% trans "هل أنت متأكد من تغيير حالة هذا الشريك؟" %}')) {
        $.ajax({
            url: '{% url 'base_data:partner_toggle_active' 0 %}'.replace('0', partnerId),
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if(response.success) {
                    table.ajax.reload();
                    showAlert('success', response.message);
                } else {
                    showAlert('danger', response.message);
                }
            }
        });
    }
}

// تحويل نوع الشريك
function convertPartnerType(partnerId, newType) {
    if(confirm('{% trans "هل أنت متأكد من تحويل نوع هذا الشريك؟" %}')) {
        $.ajax({
            url: '{% url 'base_data:partner_convert_type' 0 %}'.replace('0', partnerId),
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            data: {
                'new_type': newType
            },
            success: function(response) {
                if(response.success) {
                    table.ajax.reload();
                    showAlert('success', response.message);
                } else {
                    showAlert('danger', response.message);
                }
            }
        });
    }
}

// عرض التنبيهات
function showAlert(type, message) {
    let alertHtml = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
                   message +
                   '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                   '</div>';
    $('.card-body').prepend(alertHtml);

    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}

// فلاتر متقدمة
$('#advanced-filters').change(function() {
    if($(this).is(':checked')) {
        $('.row:last', '#filter-form').show();
    } else {
        $('.row:last', '#filter-form').hide();
    }
});

// إخفاء الفلاتر المتقدمة افتراضياً
$('.row:last', '#filter-form').hide();

// إضافة أزرار سريعة
$('.card-header .btn-group').append(
    '<button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#quickAddModal">' +
    '<i class="fas fa-plus-circle me-1"></i>{% trans "إضافة سريعة" %}</button>'
);
{% endblock %}