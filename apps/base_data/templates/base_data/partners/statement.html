<!-- apps/base_data/templates/base_data/partners/statement.html -->
{% extends 'base_data/base/base_data.html' %}
{% load i18n humanize %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'base_data:partner_list' %}">{% trans "الشركاء التجاريون" %}</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'base_data:partner_detail' partner.pk %}">{{ partner.name }}</a>
</li>
<li class="breadcrumb-item active">{% trans "كشف الحساب" %}</li>
{% endblock %}

{% block card_header %}
<div class="card-header bg-white border-bottom">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-file-invoice me-2"></i>
            {% trans "كشف حساب" %}: {{ partner.name }}
        </h5>
        <div class="btn-group">
            <a href="{% url 'base_data:partner_detail' partner.pk %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-right me-1"></i>{% trans "رجوع للشريك" %}
            </a>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-file-export me-1"></i>{% trans "تصدير" %}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="exportStatement('pdf')">
                        <i class="fas fa-file-pdf me-1"></i>PDF</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportStatement('excel')">
                        <i class="fas fa-file-excel me-1"></i>Excel</a></li>
                    <li><a class="dropdown-item" href="#" onclick="printStatement()">
                        <i class="fas fa-print me-1"></i>{% trans "طباعة" %}</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- معلومات الشريك والفترة -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i>{% trans "بيانات الشريك" %}
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong>{% trans "الكود" %}:</strong> {{ partner.code|default:"-" }}</p>
                        <p class="mb-2"><strong>{% trans "الاسم" %}:</strong> {{ partner.name }}</p>
                        <p class="mb-0"><strong>{% trans "نوع الشريك" %}:</strong>
                            <span class="badge {% if partner.partner_type == 'customer' %}bg-primary{% elif partner.partner_type == 'supplier' %}bg-success{% else %}bg-info{% endif %}">
                                {{ partner.get_partner_type_display }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>{% trans "الهاتف" %}:</strong> {{ partner.phone|default:"-" }}</p>
                        <p class="mb-2"><strong>{% trans "البريد الإلكتروني" %}:</strong> {{ partner.email|default:"-" }}</p>
                        <p class="mb-0"><strong>{% trans "حد الائتمان" %}:</strong>
                            <span class="text-success fw-bold">{{ partner.credit_limit|floatformat:2|intcomma }} {% trans "ريال" %}</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- فلتر الفترة الزمنية -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-calendar me-2"></i>{% trans "فلتر الفترة" %}
                </h6>
            </div>
            <div class="card-body">
                <form id="date-filter-form">
                    <div class="form-group mb-3">
                        <label class="form-label">{% trans "من تاريخ" %}</label>
                        <input type="date" name="date_from" class="form-control form-control-sm"
                               value="{{ request.GET.date_from }}">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">{% trans "إلى تاريخ" %}</label>
                        <input type="date" name="date_to" class="form-control form-control-sm"
                               value="{{ request.GET.date_to }}">
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-filter me-1"></i>{% trans "تطبيق" %}
                        </button>
                    </div>
                </form>

                <!-- روابط سريعة للفترات -->
                <div class="mt-3">
                    <small class="text-muted">{% trans "فترات سريعة" %}:</small>
                    <div class="d-grid gap-1 mt-2">
                        <a href="?period=today" class="btn btn-outline-primary btn-sm">{% trans "اليوم" %}</a>
                        <a href="?period=week" class="btn btn-outline-primary btn-sm">{% trans "هذا الأسبوع" %}</a>
                        <a href="?period=month" class="btn btn-outline-primary btn-sm">{% trans "هذا الشهر" %}</a>
                        <a href="?period=year" class="btn btn-outline-primary btn-sm">{% trans "هذا العام" %}</a>
                        <a href="?" class="btn btn-outline-secondary btn-sm">{% trans "كامل" %}</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ملخص الأرصدة -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 class="mb-1">{{ opening_balance|floatformat:2|intcomma }}</h4>
                <small>{% trans "الرصيد الافتتاحي" %}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 class="mb-1">{{ total_debit|floatformat:2|intcomma }}</h4>
                <small>{% trans "إجمالي المدين" %}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4 class="mb-1">{{ total_credit|floatformat:2|intcomma }}</h4>
                <small>{% trans "إجمالي الدائن" %}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-{% if closing_balance > 0 %}danger{% elif closing_balance < 0 %}info{% else %}secondary{% endif %} text-white">
            <div class="card-body text-center">
                <h4 class="mb-1">{{ closing_balance|floatformat:2|intcomma }}</h4>
                <small>{% trans "الرصيد الختامي" %}</small>
            </div>
        </div>
    </div>
</div>

<!-- كشف الحساب -->
{% if transactions %}
<div class="card">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>{% trans "حركات الحساب" %}
            <span class="badge bg-info ms-2">{{ transactions|length }} {% trans "حركة" %}</span>
        </h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0" id="statement-table">
                <thead class="table-primary">
                    <tr>
                        <th>{% trans "التاريخ" %}</th>
                        <th>{% trans "البيان" %}</th>
                        <th>{% trans "رقم المرجع" %}</th>
                        <th class="text-center">{% trans "مدين" %}</th>
                        <th class="text-center">{% trans "دائن" %}</th>
                        <th class="text-center">{% trans "الرصيد" %}</th>
                        <th class="text-center">{% trans "إجراءات" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td>
                            <div>
                                <strong>{{ transaction.date|date:"d/m/Y" }}</strong>
                                <br><small class="text-muted">{{ transaction.date|time:"H:i" }}</small>
                            </div>
                        </td>
                        <td>
                            <div>
                                <strong>{{ transaction.description }}</strong>
                                {% if transaction.notes %}
                                    <br><small class="text-muted">{{ transaction.notes|truncatechars:50 }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if transaction.reference_number %}
                                <code>{{ transaction.reference_number }}</code>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if transaction.debit_amount > 0 %}
                                <span class="fw-bold text-success">
                                    {{ transaction.debit_amount|floatformat:2|intcomma }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if transaction.credit_amount > 0 %}
                                <span class="fw-bold text-warning">
                                    {{ transaction.credit_amount|floatformat:2|intcomma }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="fw-bold {% if transaction.balance > 0 %}text-danger{% elif transaction.balance < 0 %}text-info{% else %}text-muted{% endif %}">
                                {{ transaction.balance|floatformat:2|intcomma }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                {% if transaction.invoice_url %}
                                <a href="{{ transaction.invoice_url }}" class="btn btn-light btn-sm"
                                   title="{% trans 'عرض الفاتورة' %}">
                                    <i class="fas fa-file-invoice"></i>
                                </a>
                                {% endif %}
                                {% if transaction.receipt_url %}
                                <a href="{{ transaction.receipt_url }}" class="btn btn-info btn-sm"
                                   title="{% trans 'عرض السند' %}">
                                    <i class="fas fa-receipt"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr class="fw-bold">
                        <td colspan="3">{% trans "الإجماليات" %}</td>
                        <td class="text-center text-success">{{ total_debit|floatformat:2|intcomma }}</td>
                        <td class="text-center text-warning">{{ total_credit|floatformat:2|intcomma }}</td>
                        <td class="text-center {% if closing_balance > 0 %}text-danger{% elif closing_balance < 0 %}text-info{% else %}text-muted{% endif %}">
                            {{ closing_balance|floatformat:2|intcomma }}
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="fas fa-file-invoice text-muted" style="font-size: 4rem;"></i>
        <h5 class="text-muted mt-3">{% trans "لا توجد حركات في هذه الفترة" %}</h5>
        <p class="text-muted">
            {% if request.GET.date_from or request.GET.date_to %}
                {% trans "لا توجد معاملات للشريك في الفترة المحددة" %}
            {% else %}
                {% trans "لم يتم تسجيل أي معاملات لهذا الشريك بعد" %}
            {% endif %}
        </p>

        <div class="mt-3">
            {% if partner.partner_type in 'customer,both' %}
            <a href="#" class="btn btn-primary btn-sm me-2">
                <i class="fas fa-plus me-1"></i>{% trans "إضافة فاتورة مبيعات" %}
            </a>
            {% endif %}
            {% if partner.partner_type in 'supplier,both' %}
            <a href="#" class="btn btn-success btn-sm me-2">
                <i class="fas fa-plus me-1"></i>{% trans "إضافة فاتورة شراء" %}
            </a>
            {% endif %}
            <a href="#" class="btn btn-info btn-sm">
                <i class="fas fa-plus me-1"></i>{% trans "إضافة قيد يومية" %}
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- معلومات إضافية -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>{% trans "ملاحظات" %}
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li><i class="fas fa-check text-success me-2"></i>{% trans "المبالغ بالريال السعودي" %}</li>
                    <li><i class="fas fa-check text-success me-2"></i>{% trans "الرصيد الموجب يعني مديونية على الشريك" %}</li>
                    <li><i class="fas fa-check text-success me-2"></i>{% trans "الرصيد السالب يعني مديونية للشريك" %}</li>
                    {% if partner.credit_limit > 0 %}
                    <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        {% trans "حد الائتمان المسموح" %}: {{ partner.credit_limit|floatformat:2|intcomma }} {% trans "ريال" %}
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>{% trans "إحصائيات سريعة" %}
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <h6 class="text-muted mb-1">{% trans "الحركات" %}</h6>
                        <h5 class="text-primary">{{ transactions|length }}</h5>
                    </div>
                    <div class="col-4">
                        <h6 class="text-muted mb-1">{% trans "متوسط الحركة" %}</h6>
                        <h5 class="text-success">
                            {% if transactions %}
                                {{ total_debit|add:total_credit|div:transactions|length|floatformat:0 }}
                            {% else %}
                                0
                            {% endif %}
                        </h5>
                    </div>
                    <div class="col-4">
                        <h6 class="text-muted mb-1">{% trans "أيام الائتمان" %}</h6>
                        <h5 class="text-info">{{ partner.credit_period }}</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // تفعيل DataTables للجدول
    $('#statement-table').DataTable({
        order: [[0, 'desc']], // ترتيب حسب التاريخ (الأحدث أولاً)
        pageLength: 50,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/ar.json'
        },
        columnDefs: [
            { targets: [3, 4, 5], className: 'text-center' },
            { targets: [6], orderable: false }
        ]
    });

    // تفعيل تواريخ اليوم كافتراضي إذا لم يتم تحديد فترة
    if(!$('input[name="date_from"]').val() && !$('input[name="date_to"]').val()) {
        let today = new Date();
        let firstDay = new Date(today.getFullYear(), today.getMonth() - 2, 1); // آخر 3 شهور

        $('input[name="date_from"]').val(firstDay.toISOString().split('T')[0]);
        $('input[name="date_to"]').val(today.toISOString().split('T')[0]);
    }
});

// فلتر التواريخ
$('#date-filter-form').on('submit', function(e) {
    e.preventDefault();

    let dateFrom = $('input[name="date_from"]').val();
    let dateTo = $('input[name="date_to"]').val();

    let url = window.location.pathname;
    let params = new URLSearchParams();

    if(dateFrom) params.append('date_from', dateFrom);
    if(dateTo) params.append('date_to', dateTo);

    window.location.href = url + (params.toString() ? '?' + params.toString() : '');
});

// تصدير كشف الحساب
function exportStatement(format) {
    let url = '{% url 'base_data:partner_statement_export' partner.pk %}';
    let params = new URLSearchParams(window.location.search);
    params.append('format', format);

    window.open(url + '?' + params.toString(), '_blank');
}

// طباعة كشف الحساب
function printStatement() {
    window.print();
}

// تحسين المظهر للطباعة
window.addEventListener('beforeprint', function() {
    // إخفاء العناصر غير المطلوبة للطباعة
    $('.btn, .card-header .dropdown, nav, .breadcrumb').hide();
});

window.addEventListener('afterprint', function() {
    // إظهار العناصر مرة أخرى
    $('.btn, .card-header .dropdown, nav, .breadcrumb').show();
});
</script>

<style>
@media print {
    .btn, .dropdown, .breadcrumb, nav {
        display: none !important;
    }
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    body {
        background: white !important;
    }
}

/* تحسين عرض الأرصدة */
.card h4 {
    font-size: 1.5rem;
    font-weight: bold;
}

/* تحسين الجدول */
#statement-table th {
    background-color: var(--bs-primary) !important;
    color: white !important;
    border: none !important;
}

#statement-table .table-light th,
#statement-table .table-light td {
    background-color: #f8f9fa !important;
}
</style>
{% endblock %}