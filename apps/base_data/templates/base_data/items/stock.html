<!-- apps/base_data/templates/base_data/items/stock.html -->
{% extends 'base_data/base/base_data.html' %}
{% load i18n humanize %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'base_data:item_list' %}">{% trans "الأصناف" %}</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'base_data:item_detail' item.pk %}">{{ item.name }}</a>
</li>
<li class="breadcrumb-item active">{% trans "المخزون" %}</li>
{% endblock %}

{% block card_header %}
<div class="card-header bg-white border-bottom">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-warehouse me-2"></i>{% trans "مخزون الصنف" %}: {{ item.name }}
        </h5>
        <div class="btn-group">
            <a href="{% url 'base_data:item_detail' item.pk %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-right me-1"></i>{% trans "رجوع للصنف" %}
            </a>
            {% if perms.base_data.change_warehouse %}
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#adjustInventoryModal">
                <i class="fas fa-edit me-1"></i>{% trans "تسوية المخزون" %}
            </button>
            {% endif %}
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-file-export me-1"></i>{% trans "تصدير" %}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="exportStock('pdf')">
                        <i class="fas fa-file-pdf me-1"></i>PDF</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportStock('excel')">
                        <i class="fas fa-file-excel me-1"></i>Excel</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- معلومات الصنف -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>{% trans "معلومات الصنف" %}
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <p class="mb-2"><strong>{% trans "الكود" %}:</strong> {{ item.code|default:"-" }}</p>
                        <p class="mb-2"><strong>{% trans "التصنيف" %}:</strong> {{ item.category.name }}</p>
                        <p class="mb-0"><strong>{% trans "وحدة القياس" %}:</strong> {{ item.unit.name }}</p>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-2"><strong>{% trans "سعر البيع" %}:</strong> {{ item.sale_price|floatformat:2 }} {% trans "ريال" %}</p>
                        <p class="mb-2"><strong>{% trans "الحد الأدنى" %}:</strong> {{ item.minimum_quantity|floatformat:2 }}</p>
                        <p class="mb-0"><strong>{% trans "الحد الأعلى" %}:</strong> {{ item.maximum_quantity|floatformat:2|default:"-" }}</p>
                    </div>
                    <div class="col-md-4">
                        {% if item.image %}
                        <img src="{{ item.image.url }}" alt="{{ item.name }}"
                             class="img-thumbnail" style="max-height: 80px;">
                        {% else %}
                        <div class="bg-light border rounded d-flex align-items-center justify-content-center"
                             style="height: 80px; width: 80px;">
                            <i class="fas fa-image text-muted"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- إجمالي المخزون -->
        <div class="card {% if low_stock_alert %}border-warning{% else %}border-success{% endif %}">
            <div class="card-header {% if low_stock_alert %}bg-warning{% else %}bg-success{% endif %} text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-boxes me-2"></i>{% trans "إجمالي المخزون" %}
                </h6>
            </div>
            <div class="card-body text-center">
                <h2 class="mb-2 {% if low_stock_alert %}text-warning{% else %}text-success{% endif %}">
                    {{ total_stock|floatformat:3 }}
                </h2>
                <p class="mb-1">{{ item.unit.name }}</p>
                {% if low_stock_alert %}
                <div class="alert alert-warning py-2 mb-0">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% trans "مخزون منخفض!" %}
                </div>
                {% endif %}

                {% if total_value > 0 %}
                <hr>
                <p class="mb-0"><strong>{% trans "القيمة الإجمالية" %}:</strong></p>
                <h5 class="text-primary">{{ total_value|floatformat:2|intcomma }} {% trans "ريال" %}</h5>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- توزيع المخزون -->
{% if warehouse_items %}
<div class="card">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-warehouse me-2"></i>{% trans "توزيع المخزون على المستودعات" %}
            <span class="badge bg-primary ms-2">{{ warehouse_items.count }} {% trans "مستودع" %}</span>
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-primary">
                    <tr>
                        <th>{% trans "المستودع" %}</th>
                        <th>{% trans "الموقع" %}</th>
                        <th>{% trans "أمين المستودع" %}</th>
                        <th class="text-center">{% trans "الكمية" %}</th>
                        <th class="text-center">{% trans "متوسط التكلفة" %}</th>
                        <th class="text-center">{% trans "القيمة الإجمالية" %}</th>
                        <th class="text-center">{% trans "الحالة" %}</th>
                        {% if perms.base_data.change_warehouse %}
                        <th class="text-center">{% trans "إجراءات" %}</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for warehouse_item in warehouse_items %}
                    {% widthratio warehouse_item.quantity warehouse_item.average_cost 1 as item_total_value %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-warehouse text-primary me-2"></i>
                                <div>
                                    <strong>
                                        <a href="{% url 'base_data:warehouse_detail' warehouse_item.warehouse.pk %}">
                                            {{ warehouse_item.warehouse.name }}
                                        </a>
                                    </strong>
                                    <br>
                                    <small class="text-muted">{{ warehouse_item.warehouse.code }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ warehouse_item.warehouse.location|default:"-" }}</td>
                        <td>
                            {% if warehouse_item.warehouse.keeper %}
                                {{ warehouse_item.warehouse.keeper.get_full_name }}
                            {% else %}
                                <span class="text-muted">{% trans "غير محدد" %}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="fw-bold {% if warehouse_item.quantity > 0 %}text-success{% elif warehouse_item.quantity < 0 %}text-danger{% else %}text-muted{% endif %}">
                                {{ warehouse_item.quantity|floatformat:3 }}
                            </span>
                        </td>
                        <td class="text-center">
                            {{ warehouse_item.average_cost|floatformat:2 }} {% trans "ريال" %}
                        </td>
                        <td class="text-center">
                            <strong>{{ item_total_value|floatformat:2|intcomma }} {% trans "ريال" %}</strong>
                        </td>
                        <td class="text-center">
                            {% if warehouse_item.quantity > item.minimum_quantity %}
                                <span class="badge bg-success">{% trans "طبيعي" %}</span>
                            {% elif warehouse_item.quantity > 0 %}
                                <span class="badge bg-warning">{% trans "منخفض" %}</span>
                            {% else %}
                                <span class="badge bg-danger">{% trans "نفذ" %}</span>
                            {% endif %}
                        </td>
                        {% if perms.base_data.change_warehouse %}
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary btn-sm"
                                        onclick="adjustWarehouseStock({{ warehouse_item.warehouse.pk }}, {{ warehouse_item.quantity }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm"
                                        onclick="viewWarehouseMovements({{ warehouse_item.warehouse.pk }})">
                                    <i class="fas fa-history"></i>
                                </button>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th colspan="3">{% trans "الإجمالي" %}</th>
                        <th class="text-center">
                            <strong class="text-primary">{{ total_stock|floatformat:3 }}</strong>
                        </th>
                        <th class="text-center">-</th>
                        <th class="text-center">
                            <strong class="text-primary">{{ total_value|floatformat:2|intcomma }} {% trans "ريال" %}</strong>
                        </th>
                        <th colspan="2"></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="fas fa-boxes text-muted" style="font-size: 4rem;"></i>
        <h5 class="text-muted mt-3">{% trans "لا يوجد مخزون لهذا الصنف" %}</h5>
        <p class="text-muted">{% trans "لم يتم تسجيل أي كميات لهذا الصنف في المستودعات" %}</p>
        {% if perms.base_data.change_warehouse %}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#adjustInventoryModal">
            <i class="fas fa-plus me-1"></i>{% trans "إضافة رصيد افتتاحي" %}
        </button>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Modal تسوية المخزون -->
{% if perms.base_data.change_warehouse %}
<div class="modal fade" id="adjustInventoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>{% trans "تسوية مخزون" %}: {{ item.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="adjust-inventory-form">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label required-field">{% trans "المستودع" %}</label>
                                <select name="warehouse" class="form-select" required>
                                    <option value="">{% trans "اختر المستودع" %}</option>
                                    {% for warehouse_item in warehouse_items %}
                                    <option value="{{ warehouse_item.warehouse.pk }}"
                                            data-current="{{ warehouse_item.quantity }}">
                                        {{ warehouse_item.warehouse.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">{% trans "الكمية الحالية" %}</label>
                                <input type="text" class="form-control" id="current-quantity" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label required-field">{% trans "الكمية الفعلية" %}</label>
                                <input type="number" name="actual_quantity" class="form-control"
                                       step="0.001" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">{% trans "الفرق" %}</label>
                                <input type="text" class="form-control" id="quantity-difference" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label required-field">{% trans "سبب التسوية" %}</label>
                                <select name="reason" class="form-select" required>
                                    <option value="">{% trans "اختر السبب" %}</option>
                                    <option value="damage">{% trans "تلف" %}</option>
                                    <option value="loss">{% trans "فقدان" %}</option>
                                    <option value="theft">{% trans "سرقة" %}</option>
                                    <option value="expired">{% trans "انتهاء صلاحية" %}</option>
                                    <option value="count_error">{% trans "خطأ في الجرد" %}</option>
                                    <option value="other">{% trans "أخرى" %}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label required-field">{% trans "تاريخ التسوية" %}</label>
                                <input type="date" name="adjustment_date" class="form-control"
                                       value="{{ today|date:'Y-m-d' }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">{% trans "ملاحظات" %}</label>
                        <textarea name="notes" class="form-control" rows="3"
                                  placeholder="{% trans 'ملاحظات على التسوية' %}"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "إلغاء" %}
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>{% trans "حفظ التسوية" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // تحديث الكمية الحالية عند تغيير المستودع
    $('select[name="warehouse"]').on('change', function() {
        let currentQty = $(this).find(':selected').data('current') || 0;
        $('#current-quantity').val(currentQty.toFixed(3));
        calculateDifference();
    });

    // حساب الفرق عند تغيير الكمية الفعلية
    $('input[name="actual_quantity"]').on('input', function() {
        calculateDifference();
    });

    function calculateDifference() {
        let currentQty = parseFloat($('#current-quantity').val()) || 0;
        let actualQty = parseFloat($('input[name="actual_quantity"]').val()) || 0;
        let difference = actualQty - currentQty;

        let differenceText = difference.toFixed(3);
        let differenceClass = '';
        if (difference > 0) {
            differenceText = '+' + differenceText;
            differenceClass = 'text-success';
        } else if (difference < 0) {
            differenceClass = 'text-danger';
        } else {
            differenceClass = 'text-muted';
        }

        $('#quantity-difference').val(differenceText).removeClass('text-success text-danger text-muted').addClass(differenceClass);
    }
});

// تسوية المخزون
$('#adjust-inventory-form').on('submit', function(e) {
    e.preventDefault();

    $.ajax({
        url: '{% url 'base_data:inventory_adjustment' %}',
        method: 'POST',
        data: $(this).serialize() + '&item=' + {{ item.pk }},
        success: function(response) {
            if(response.success) {
                $('#adjustInventoryModal').modal('hide');
                location.reload();
            } else {
                alert(response.message || '{% trans "حدث خطأ" %}');
            }
        },
        error: function() {
            alert('{% trans "حدث خطأ في الاتصال" %}');
        }
    });
});

function adjustWarehouseStock(warehouseId, currentQty) {
    $('select[name="warehouse"]').val(warehouseId).trigger('change');
    $('#adjustInventoryModal').modal('show');
}

function viewWarehouseMovements(warehouseId) {
    // عرض حركات المستودع - يمكن تطويرها لاحقاً
    alert('{% trans "سيتم تطوير هذه الميزة قريباً" %}');
}

function exportStock(format) {
    let url = '{% url 'base_data:item_stock_export' item.pk %}?format=' + format;
    window.open(url, '_blank');
}
</script>
{% endblock %}