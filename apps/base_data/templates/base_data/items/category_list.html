{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{% trans "تصنيفات الأصناف" %}{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'core:dashboard' %}">{% trans "الرئيسية" %}</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'base_data:index' %}">{% trans "البيانات الأساسية" %}</a>
        </li>
        <li class="breadcrumb-item active">{% trans "تصنيفات الأصناف" %}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-tags me-2"></i>
                {% trans "إدارة تصنيفات الأصناف" %}
            </h1>
            <p class="text-muted small mt-1">{% trans "إدارة وتنظيم تصنيفات المواد والأصناف" %}</p>
        </div>
        {% if perms.base_data.add_itemcategory %}
        <div>
            <a href="{% url 'base_data:category_add' %}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>
                {% trans "إضافة تصنيف جديد" %}
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Filters Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-filter me-1"></i>
                {% trans "البحث والفلترة" %}
            </h6>
        </div>
        <div class="card-body">
            <form id="filterForm" method="get">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="parent_category" class="form-label">{% trans "التصنيف الأب" %}</label>
                        <select class="form-select" id="parent_category" name="parent_category">
                            <option value="">{% trans "كل التصنيفات" %}</option>
                            {% for category in parent_categories %}
                            <option value="{{ category.id }}" {% if request.GET.parent_category == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="level" class="form-label">{% trans "المستوى" %}</label>
                        <select class="form-select" id="level" name="level">
                            <option value="">{% trans "كل المستويات" %}</option>
                            <option value="1" {% if request.GET.level == "1" %}selected{% endif %}>{% trans "الأول" %}</option>
                            <option value="2" {% if request.GET.level == "2" %}selected{% endif %}>{% trans "الثاني" %}</option>
                            <option value="3" {% if request.GET.level == "3" %}selected{% endif %}>{% trans "الثالث" %}</option>
                            <option value="4" {% if request.GET.level == "4" %}selected{% endif %}>{% trans "الرابع" %}</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="is_active" class="form-label">{% trans "الحالة" %}</label>
                        <select class="form-select" id="is_active" name="is_active">
                            <option value="">{% trans "الكل" %}</option>
                            <option value="true" {% if request.GET.is_active == "true" %}selected{% endif %}>{% trans "نشط" %}</option>
                            <option value="false" {% if request.GET.is_active == "false" %}selected{% endif %}>{% trans "غير نشط" %}</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="search" class="form-label">{% trans "البحث السريع" %}</label>
                        <input type="text" class="form-control" id="search" name="search"
                               placeholder="{% trans 'البحث في الكود أو الاسم...' %}"
                               value="{{ request.GET.search }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label d-block">&nbsp;</label>
                        <button type="submit" class="btn btn-info w-100">
                            <i class="fas fa-search me-1"></i>
                            {% trans "بحث" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Data Table Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-table me-1"></i>
                {% trans "قائمة التصنيفات" %}
            </h6>
            <div>
                {% if perms.base_data.add_itemcategory %}
                <button type="button" class="btn btn-sm btn-success me-2" data-bs-toggle="modal" data-bs-target="#quickAddModal">
                    <i class="fas fa-plus me-1"></i>
                    {% trans "إضافة سريعة" %}
                </button>
                {% endif %}
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="table.ajax.reload();">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportData();">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="categoriesTable" width="100%" cellspacing="0">
                    <thead class="table-light">
                        <tr>
                            <th>{% trans "الكود" %}</th>
                            <th>{% trans "الاسم" %}</th>
                            <th>{% trans "الاسم الإنجليزي" %}</th>
                            <th>{% trans "التصنيف الأب" %}</th>
                            <th>{% trans "المستوى" %}</th>
                            <th>{% trans "عدد الأصناف" %}</th>
                            <th>{% trans "الحالة" %}</th>
                            <th class="text-center">{% trans "الإجراءات" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- DataTables will populate this -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Modal -->
{% if perms.base_data.add_itemcategory %}
<div class="modal fade" id="quickAddModal" tabindex="-1" aria-labelledby="quickAddModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickAddModalLabel">
                    <i class="fas fa-plus me-2"></i>
                    {% trans "إضافة تصنيف سريع" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="quickAddForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quick_code" class="form-label">{% trans "كود التصنيف" %} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="quick_code" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label for="quick_name" class="form-label">{% trans "اسم التصنيف" %} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="quick_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="quick_name_en" class="form-label">{% trans "الاسم الإنجليزي" %}</label>
                        <input type="text" class="form-control" id="quick_name_en" name="name_en">
                    </div>
                    <div class="mb-3">
                        <label for="quick_parent" class="form-label">{% trans "التصنيف الأب" %}</label>
                        <select class="form-select" id="quick_parent" name="parent">
                            <option value="">{% trans "بدون تصنيف أب (مستوى أول)" %}</option>
                            {% for category in parent_categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="alert alert-success d-none" id="quickAddSuccess">
                        <i class="fas fa-check-circle me-1"></i>
                        <span id="quickAddSuccessMessage"></span>
                    </div>
                    <div class="alert alert-danger d-none" id="quickAddError">
                        <i class="fas fa-times-circle me-1"></i>
                        <span id="quickAddErrorMessage"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "إلغاء" %}
                    </button>
                    <button type="submit" class="btn btn-primary" id="quickAddBtn">
                        <i class="fas fa-save me-1"></i> {% trans "حفظ" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {% trans "تأكيد الحذف" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "هل أنت متأكد من حذف التصنيف:" %} <strong id="deleteItemName"></strong>؟</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "تحذير: سيتم حذف جميع التصنيفات الفرعية والأصناف المرتبطة بهذا التصنيف!" %}
                </div>
                <div class="alert alert-success d-none" id="deleteSuccess">
                    <i class="fas fa-check-circle me-1"></i>
                    <span id="deleteSuccessMessage"></span>
                </div>
                <div class="alert alert-danger d-none" id="deleteError">
                    <i class="fas fa-times-circle me-1"></i>
                    <span id="deleteErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "إلغاء" %}
                </button>
                <form method="post" id="deleteForm" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i> {% trans "حذف" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    window.table = $('#categoriesTable').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "{% url 'base_data:category_datatable' %}",
            "data": function(d) {
                d.parent_category = $('#parent_category').val();
                d.level = $('#level').val();
                d.is_active = $('#is_active').val();
                d.search = $('#search').val();
            }
        },
        "columns": [
            {"data": 0, "name": "code"},
            {"data": 1, "name": "name"},
            {"data": 2, "name": "name_en"},
            {"data": 3, "name": "parent__name"},
            {"data": 4, "name": "level"},
            {"data": 5, "name": "items_count", "orderable": false},
            {"data": 6, "name": "is_active", "orderable": false},
            {"data": 7, "name": "actions", "orderable": false, "searchable": false}
        ],
        "order": [[0, "asc"]],
        "pageLength": 25,
        "responsive": true,
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json"
        }
    });

    // Reload table when filters change
    $('#filterForm input, #filterForm select').on('change', function() {
        table.ajax.reload();
    });

    // Submit filter form
    $('#filterForm').on('submit', function(e) {
        e.preventDefault();
        table.ajax.reload();
    });

    // Quick Add Form
    $('#quickAddForm').on('submit', function(e) {
        e.preventDefault();

        var formData = new FormData(this);
        $('#quickAddBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> {% trans "جاري الحفظ..." %}');

        $.ajax({
            url: "{% url 'base_data:category_quick_add' %}",
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if(response.success) {
                    $('#quickAddSuccess').removeClass('d-none');
                    $('#quickAddSuccessMessage').text(response.message);
                    $('#quickAddError').addClass('d-none');
                    $('#quickAddForm')[0].reset();
                    table.ajax.reload();

                    setTimeout(function() {
                        $('#quickAddModal').modal('hide');
                        $('#quickAddSuccess').addClass('d-none');
                    }, 2000);
                } else {
                    $('#quickAddError').removeClass('d-none');
                    $('#quickAddErrorMessage').text(response.message);
                    $('#quickAddSuccess').addClass('d-none');
                }
            },
            error: function(xhr) {
                $('#quickAddError').removeClass('d-none');
                $('#quickAddErrorMessage').text('{% trans "حدث خطأ أثناء الحفظ" %}');
                $('#quickAddSuccess').addClass('d-none');
            },
            complete: function() {
                $('#quickAddBtn').prop('disabled', false).html('<i class="fas fa-save me-1"></i> {% trans "حفظ" %}');
            }
        });
    });
});

// Show delete confirmation
function showDeleteConfirm(id, name) {
    $('#deleteItemName').text(name);
    $('#deleteForm').attr('action', "{% url 'base_data:category_delete' 0 %}".replace('0', id));
    $('#deleteModal').modal('show');
}

// Export data
function exportData() {
    window.location.href = "{% url 'base_data:category_export' %}?" + $('#filterForm').serialize();
}
</script>

{% endblock %}