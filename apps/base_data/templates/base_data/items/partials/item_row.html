<!-- apps/base_data/templates/base_data/items/partials/item_row.html -->
{% load i18n humanize %}

<tr data-item-id="{{ item.pk }}" class="item-row {% if not item.is_active %}table-secondary{% endif %}">
    <td>
        <div class="form-check">
            <input class="form-check-input row-checkbox" type="checkbox" value="{{ item.pk }}">
        </div>
    </td>

    <td>
        <div class="d-flex align-items-center">
            {% if item.image %}
                <img src="{{ item.image.url }}" alt="{{ item.name }}"
                     class="rounded me-2" style="width: 32px; height: 32px; object-fit: cover;">
            {% else %}
                <div class="bg-light border rounded me-2 d-flex align-items-center justify-content-center"
                     style="width: 32px; height: 32px;">
                    <i class="fas fa-box text-muted"></i>
                </div>
            {% endif %}
            <div>
                <code class="text-primary">{{ item.code|default:"-" }}</code>
            </div>
        </div>
    </td>

    <td>
        <div>
            <strong>
                <a href="{% url 'base_data:item_detail' item.pk %}" class="text-decoration-none">
                    {{ item.name }}
                </a>
            </strong>
            {% if item.name_en %}
                <br><small class="text-muted">{{ item.name_en }}</small>
            {% endif %}
            {% if item.barcode %}
                <br><small class="badge bg-light text-dark"><i class="fas fa-barcode me-1"></i>{{ item.barcode }}</small>
            {% endif %}
        </div>
    </td>

    <td>
        <span class="badge bg-info">
            <i class="fas fa-sitemap me-1"></i>{{ item.category.name }}
        </span>
    </td>

    <td>
        <span class="badge bg-secondary">{{ item.unit.name }}</span>
    </td>

    <td class="text-center">
        <strong class="text-success">{{ item.sale_price|floatformat:2|intcomma }}</strong>
        <small class="text-muted d-block">{% trans "ريال" %}</small>
        {% if item.purchase_price %}
            <small class="text-muted">
                ({% trans "الشراء" %}: {{ item.purchase_price|floatformat:2|intcomma }})
            </small>
        {% endif %}
    </td>

    <td class="text-center">
        {% with total_stock=item.warehouse_items.all|length %}
            {% if total_stock > 0 %}
                <span class="fw-bold {% if total_stock > item.minimum_quantity %}text-success{% else %}text-warning{% endif %}">
                    {{ total_stock|floatformat:3 }}
                </span>
                <small class="text-muted d-block">{{ item.unit.name }}</small>
                {% if total_stock <= item.minimum_quantity and item.minimum_quantity > 0 %}
                    <small class="badge bg-warning">{% trans "منخفض" %}</small>
                {% endif %}
            {% else %}
                <span class="text-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>{% trans "نفذ" %}
                </span>
            {% endif %}
        {% endwith %}
    </td>

    <td class="text-center">
        {% if item.is_active and not item.is_inactive %}
            <span class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>{% trans "نشط" %}
            </span>
        {% else %}
            <span class="badge bg-secondary">
                <i class="fas fa-pause-circle me-1"></i>{% trans "غير نشط" %}
            </span>
        {% endif %}
    </td>

    <td class="text-center">
        <div class="btn-group btn-group-sm">
            {% if perms.base_data.view_item %}
            <a href="{% url 'base_data:item_detail' item.pk %}"
               class="btn btn-light btn-sm" title="{% trans 'عرض' %}">
                <i class="fas fa-eye"></i>
            </a>
            {% endif %}

            {% if perms.base_data.change_item %}
            <a href="{% url 'base_data:item_update' item.pk %}"
               class="btn btn-warning btn-sm" title="{% trans 'تعديل' %}">
                <i class="fas fa-edit"></i>
            </a>
            {% endif %}

            <div class="btn-group" role="group">
                <button type="button" class="btn btn-info btn-sm dropdown-toggle"
                        data-bs-toggle="dropdown" title="{% trans 'المزيد' %}">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <a class="dropdown-item" href="{% url 'base_data:item_stock' item.pk %}">
                            <i class="fas fa-warehouse me-1"></i>{% trans "المخزون" %}
                        </a>
                    </li>
                    {% if perms.base_data.add_item %}
                    <li>
                        <a class="dropdown-item" href="{% url 'base_data:item_duplicate' item.pk %}">
                            <i class="fas fa-copy me-1"></i>{% trans "تكرار" %}
                        </a>
                    </li>
                    {% endif %}

                    {% if perms.base_data.change_item %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="toggleItemStatus({{ item.pk }})">
                            <i class="fas fa-toggle-{% if item.is_active %}off{% else %}on{% endif %} me-1"></i>
                            {% if item.is_active %}{% trans "إلغاء تفعيل" %}{% else %}{% trans "تفعيل" %}{% endif %}
                        </a>
                    </li>
                    {% endif %}

                    {% if perms.base_data.delete_item %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item text-danger" href="{% url 'base_data:item_delete' item.pk %}">
                            <i class="fas fa-trash me-1"></i>{% trans "حذف" %}
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </td>
</tr>