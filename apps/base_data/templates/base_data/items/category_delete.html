{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{% trans "حذف التصنيف" %}: {{ object.name }}{% endblock %}

{% block extra_css %}
<style>
.warning-card {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-left: 4px solid #ffc107;
}
.danger-card {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    border-left: 4px solid #dc3545;
}
.stats-card {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border-left: 4px solid #17a2b8;
}
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'core:dashboard' %}">{% trans "الرئيسية" %}</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'base_data:index' %}">{% trans "البيانات الأساسية" %}</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'base_data:category_list' %}">{% trans "تصنيفات الأصناف" %}</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'base_data:category_edit' object.pk %}">{{ object.name }}</a>
        </li>
        <li class="breadcrumb-item active">{% trans "حذف" %}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {% trans "حذف التصنيف" %}: {{ object.name }}
            </h1>
            <p class="text-muted small mt-1">{% trans "تأكيد حذف التصنيف والتحقق من الارتباطات" %}</p>
        </div>
        <div>
            <a href="{% url 'base_data:category_edit' object.pk %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                {% trans "العودة للتصنيف" %}
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            
            <!-- Category Information -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle me-1"></i>
                        {% trans "بيانات التصنيف المراد حذفه" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold">{% trans "الكود:" %}</td>
                                    <td>{{ object.code }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">{% trans "الاسم:" %}</td>
                                    <td>{{ object.name }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">{% trans "الاسم الإنجليزي:" %}</td>
                                    <td>{{ object.name_en|default:"-" }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">{% trans "المستوى:" %}</td>
                                    <td>
                                        <span class="badge badge-info">{% trans "المستوى" %} {{ object.level }}</span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold">{% trans "التصنيف الأب:" %}</td>
                                    <td>
                                        {% if object.parent %}
                                            <a href="{% url 'base_data:category_edit' object.parent.pk %}">
                                                {{ object.parent.name }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">{% trans "تصنيف جذر" %}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">{% trans "المسار الكامل:" %}</td>
                                    <td>
                                        <span class="text-muted small">
                                            {{ object.get_full_path|default:object.name }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">{% trans "الحالة:" %}</td>
                                    <td>
                                        {% if object.is_inactive %}
                                            <span class="badge badge-warning">{% trans "غير نشط" %}</span>
                                        {% else %}
                                            <span class="badge badge-success">{% trans "نشط" %}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">{% trans "تاريخ الإنشاء:" %}</td>
                                    <td>
                                        {% if object.created_at %}
                                            {{ object.created_at|date:"Y-m-d H:i" }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation -->
            {% if not has_items and not has_children %}
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-success text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-check-circle me-1"></i>
                        {% trans "يمكن حذف التصنيف بأمان" %}
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-3">{% trans "هذا التصنيف لا يحتوي على أصناف أو تصنيفات فرعية ويمكن حذفه بأمان." %}</p>
                    
                    <form method="post">
                        {% csrf_token %}
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a href="{% url 'base_data:category_edit' object.pk %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>
                                    {% trans "إلغاء" %}
                                </a>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash me-1"></i>
                                    {% trans "حذف التصنيف نهائياً" %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

        </div>
        
        <div class="col-lg-4">
            
            <!-- Statistics -->
            <div class="card stats-card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-chart-bar me-1"></i>
                        {% trans "إحصائيات التصنيف" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="h4 text-info mb-0">{{ items_count }}</div>
                            <div class="small text-muted">{% trans "الأصناف" %}</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h4 text-warning mb-0">{{ children_count }}</div>
                            <div class="small text-muted">{% trans "التصنيفات الفرعية" %}</div>
                        </div>
                        {% if total_descendants > children_count %}
                        <div class="col-12">
                            <div class="h5 text-secondary mb-0">{{ total_descendants }}</div>
                            <div class="small text-muted">{% trans "إجمالي التصنيفات الفرعية" %}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Warnings -->
            {% if has_items %}
            <div class="card danger-card shadow mb-4">
                <div class="card-header py-3 bg-danger text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        {% trans "لا يمكن الحذف!" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger border-0" role="alert">
                        <h6 class="alert-heading">
                            <i class="fas fa-box me-1"></i>
                            {% trans "يحتوي على أصناف" %}
                        </h6>
                        <p class="mb-2">
                            {% trans "هذا التصنيف يحتوي على" %} 
                            <strong>{{ items_count }}</strong> 
                            {% trans "صنف. يجب نقل أو حذف هذه الأصناف أولاً." %}
                        </p>
                        <hr>
                        <div class="d-grid">
                            <a href="{% url 'base_data:item_list' %}?category={{ object.pk }}" 
                               class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-list me-1"></i>
                                {% trans "عرض الأصناف المرتبطة" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if has_children %}
            <div class="card warning-card shadow mb-4">
                <div class="card-header py-3 bg-warning text-dark">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-sitemap me-1"></i>
                        {% trans "تصنيفات فرعية" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning border-0" role="alert">
                        <h6 class="alert-heading">
                            <i class="fas fa-folder-tree me-1"></i>
                            {% trans "يحتوي على تصنيفات فرعية" %}
                        </h6>
                        <p class="mb-2">
                            {% trans "هذا التصنيف يحتوي على" %} 
                            <strong>{{ children_count }}</strong> 
                            {% trans "تصنيف فرعي. يجب حذف أو نقل التصنيفات الفرعية أولاً." %}
                        </p>
                        <hr>
                        <div class="d-grid">
                            <a href="{% url 'base_data:category_list' %}?parent_category={{ object.pk }}" 
                               class="btn btn-outline-warning btn-sm">
                                <i class="fas fa-list me-1"></i>
                                {% trans "عرض التصنيفات الفرعية" %}
                            </a>
                        </div>
                    </div>

                    <!-- قائمة التصنيفات الفرعية -->
                    {% if object.children.all %}
                    <div class="mt-3">
                        <h6 class="text-muted">{% trans "التصنيفات الفرعية المباشرة:" %}</h6>
                        <div class="list-group list-group-flush">
                            {% for child in object.children.all %}
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <div>
                                    <strong>{{ child.name }}</strong>
                                    <small class="text-muted d-block">{{ child.code }}</small>
                                </div>
                                <div>
                                    <span class="badge badge-info">{{ child.items.count }} {% trans "صنف" %}</span>
                                    <a href="{% url 'base_data:category_edit' child.pk %}" 
                                       class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-secondary">
                        <i class="fas fa-cog me-1"></i>
                        {% trans "إجراءات أخرى" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'base_data:category_edit' object.pk %}" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-1"></i>
                            {% trans "تعديل التصنيف" %}
                        </a>
                        <a href="{% url 'base_data:category_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-list me-1"></i>
                            {% trans "قائمة التصنيفات" %}
                        </a>
                        <a href="{% url 'base_data:category_tree' %}" class="btn btn-outline-info">
                            <i class="fas fa-sitemap me-1"></i>
                            {% trans "شجرة التصنيفات" %}
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // تأكيد الحذف
    $('form').on('submit', function(e) {
        var confirmed = confirm('{% trans "هل أنت متأكد من حذف هذا التصنيف نهائياً؟" %}');
        if (!confirmed) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}