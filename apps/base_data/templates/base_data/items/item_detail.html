<!-- templates/base_data/items/item_detail.html -->
{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{% trans "تفاصيل الصنف" %}: {{ item.name }}{% endblock %}

{% block extra_css %}
<style>
.detail-card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: transform 0.2s;
}
.detail-card:hover {
    transform: translateY(-2px);
}
.info-label {
    font-weight: 600;
    color: #6c757d;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.info-value {
    font-size: 1.1rem;
    color: #495057;
    margin-bottom: 15px;
}
.status-badge {
    font-size: 0.9rem;
    padding: 6px 12px;
}
.item-image {
    max-width: 200px;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}
.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
}
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.bg-gradient-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}
.bg-gradient-info {
    background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
}
.bg-gradient-warning {
    background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header with Breadcrumbs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 text-gray-800 mb-2">{{ title }}</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            {% for breadcrumb in breadcrumbs %}
                                {% if breadcrumb.active %}
                                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                                {% else %}
                                    <li class="breadcrumb-item">
                                        {% if breadcrumb.url %}
                                            <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                                        {% else %}
                                            {{ breadcrumb.title }}
                                        {% endif %}
                                    </li>
                                {% endif %}
                            {% endfor %}
                        </ol>
                    </nav>
                </div>
                <div>
                    {% if perms.base_data.change_item %}
                    <a href="{% url 'base_data:item_edit' item.pk %}" class="btn btn-warning">
                        <i class="fas fa-edit"></i> {% trans "تعديل" %}
                    </a>
                    {% endif %}
                    {% if perms.base_data.delete_item %}
                    <a href="{% url 'base_data:item_delete' item.pk %}" class="btn btn-danger">
                        <i class="fas fa-trash"></i> {% trans "حذف" %}
                    </a>
                    {% endif %}
                    <a href="{% url 'base_data:item_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-right"></i> {% trans "العودة للقائمة" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- العمود الرئيسي -->
        <div class="col-lg-8">

            <!-- المعلومات الأساسية -->
            <div class="card detail-card shadow mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="m-0">
                        <i class="fas fa-info-circle"></i> {% trans "المعلومات الأساسية" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-label">{% trans "رمز الصنف" %}</div>
                            <div class="info-value">
                                <strong>{{ item.code }}</strong>
                                {% if item.is_inactive %}
                                    <span class="badge bg-warning status-badge me-2">{% trans "غير نشط" %}</span>
                                {% else %}
                                    <span class="badge bg-success status-badge me-2">{% trans "نشط" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-label">{% trans "الباركود" %}</div>
                            <div class="info-value">{{ item.barcode|default:"-" }}</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-label">{% trans "اسم الصنف" %}</div>
                            <div class="info-value">{{ item.name }}</div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-label">{% trans "الاسم بالإنجليزية" %}</div>
                            <div class="info-value">{{ item.name_en|default:"-" }}</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-label">{% trans "التصنيف" %}</div>
                            <div class="info-value">
                                {% if item.category %}
                                    <i class="fas fa-layer-group text-info"></i> {{ item.category }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-label">{% trans "وحدة القياس" %}</div>
                            <div class="info-value">
                                {% if item.unit %}
                                    <i class="fas fa-ruler text-success"></i> {{ item.unit }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-label">{% trans "الشركة المصنعة" %}</div>
                            <div class="info-value">{{ item.manufacturer|default:"-" }}</div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-label">{% trans "الوزن" %}</div>
                            <div class="info-value">
                                {% if item.weight %}
                                    {{ item.weight }} {% trans "كجم" %}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- الأسعار والضرائب -->
            <div class="card detail-card shadow mb-4">
                <div class="card-header bg-gradient-success text-white">
                    <h5 class="m-0">
                        <i class="fas fa-dollar-sign"></i> {% trans "الأسعار والضرائب" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="info-label">{% trans "سعر الشراء" %}</div>
                            <div class="info-value">
                                <span class="badge bg-info fs-6">{{ item.purchase_price|floatformat:2 }} {% trans "ر.س" %}</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-label">{% trans "سعر البيع" %}</div>
                            <div class="info-value">
                                <span class="badge bg-primary fs-6">{{ item.sale_price|floatformat:2 }} {% trans "ر.س" %}</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-label">{% trans "نسبة الضريبة" %}</div>
                            <div class="info-value">
                                <span class="badge bg-warning fs-6">{{ item.tax_rate|floatformat:2 }}%</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-label">{% trans "الحد الأدنى" %}</div>
                            <div class="info-value">{{ item.minimum_quantity|floatformat:2 }}</div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-label">{% trans "الحد الأعلى" %}</div>
                            <div class="info-value">{{ item.maximum_quantity|default:"-"|floatformat:2 }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- المواصفات والملاحظات -->
            {% if item.specifications or item.notes %}
            <div class="card detail-card shadow mb-4">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="m-0">
                        <i class="fas fa-clipboard-list"></i> {% trans "المواصفات والملاحظات" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if item.specifications %}
                    <div class="mb-3">
                        <div class="info-label">{% trans "المواصفات" %}</div>
                        <div class="info-value">{{ item.specifications|linebreaks }}</div>
                    </div>
                    {% endif %}

                    {% if item.notes %}
                    <div class="mb-3">
                        <div class="info-label">{% trans "الملاحظات" %}</div>
                        <div class="info-value">{{ item.notes|linebreaks }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

        </div>

        <!-- العمود الجانبي -->
        <div class="col-lg-4">

            <!-- صورة الصنف -->
            <div class="card detail-card shadow mb-4">
                <div class="card-header bg-gradient-warning text-dark">
                    <h5 class="m-0">
                        <i class="fas fa-image"></i> {% trans "صورة الصنف" %}
                    </h5>
                </div>
                <div class="card-body text-center">
                    {% if item.image %}
                        <img src="{{ item.image.url }}" alt="{{ item.name }}" class="item-image img-fluid">
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-image fa-5x text-muted"></i>
                            <p class="text-muted mt-3">{% trans "لا توجد صورة" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- روابط سريعة -->
            <div class="card detail-card shadow mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="m-0">
                        <i class="fas fa-link"></i> {% trans "إدارة الصنف" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if perms.base_data.change_item %}
                    <a href="{% url 'base_data:item_components' item.pk %}" class="btn btn-outline-primary btn-sm d-block mb-2">
                        <i class="fas fa-puzzle-piece"></i> {% trans "إدارة المكونات" %}
                        {% if components %}
                            <span class="badge bg-primary">{{ components.count }}</span>
                        {% endif %}
                    </a>

                    <a href="{% url 'base_data:item_conversions' item.pk %}" class="btn btn-outline-info btn-sm d-block mb-2">
                        <i class="fas fa-exchange-alt"></i> {% trans "معدلات التحويل" %}
                        {% if conversions %}
                            <span class="badge bg-info">{{ conversions.count }}</span>
                        {% endif %}
                    </a>

                    <a href="{% url 'base_data:item_substitutes' item.pk %}" class="btn btn-outline-success btn-sm d-block mb-2">
                        <i class="fas fa-sync-alt"></i> {% trans "المواد البديلة" %}
                        {% if substitutes %}
                            <span class="badge bg-success">{{ substitutes.count }}</span>
                        {% endif %}
                    </a>
                    {% endif %}

                    <hr>

                    <a href="#" class="btn btn-outline-secondary btn-sm d-block mb-2">
                        <i class="fas fa-chart-line"></i> {% trans "تقرير الحركة" %}
                    </a>

                    <a href="#" class="btn btn-outline-warning btn-sm d-block">
                        <i class="fas fa-history"></i> {% trans "سجل التعديلات" %}
                    </a>
                </div>
            </div>

        </div>
    </div>

    <!-- أرصدة المخازن -->
    {% if warehouse_balances %}
    <div class="row">
        <div class="col-12">
            <div class="card detail-card shadow mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="m-0">
                        <i class="fas fa-warehouse"></i> {% trans "أرصدة المخازن" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "المستودع" %}</th>
                                    <th>{% trans "الكمية المتاحة" %}</th>
                                    <th>{% trans "الكمية المحجوزة" %}</th>
                                    <th>{% trans "الكمية الإجمالية" %}</th>
                                    <th>{% trans "آخر حركة" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for balance in warehouse_balances %}
                                <tr>
                                    <td>
                                        <i class="fas fa-warehouse text-info"></i> {{ balance.warehouse.name }}
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ balance.available_quantity|floatformat:2 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">{{ balance.reserved_quantity|default:"0.00"|floatformat:2 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ balance.quantity|floatformat:2 }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ balance.updated_at|date:"d/m/Y H:i" }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- المواد البديلة -->
    {% if substitutes %}
    <div class="row">
        <div class="col-12">
            <div class="card detail-card shadow mb-4">
                <div class="card-header bg-gradient-success text-white">
                    <h5 class="m-0">
                        <i class="fas fa-sync-alt"></i> {% trans "المواد البديلة" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for substitute in substitutes %}
                        <div class="col-md-4 mb-3">
                            <div class="card border-success">
                                <div class="card-body p-3">
                                    <h6 class="card-title">{{ substitute.code }}</h6>
                                    <p class="card-text small">{{ substitute.name }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-success">{{ substitute.sale_price|floatformat:2 }} {% trans "ر.س" %}</small>
                                        <a href="{% url 'base_data:item_detail' substitute.pk %}" class="btn btn-sm btn-outline-success">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- المكونات -->
    {% if components %}
    <div class="row">
        <div class="col-12">
            <div class="card detail-card shadow mb-4">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="m-0">
                        <i class="fas fa-puzzle-piece"></i> {% trans "مكونات الصنف" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "المادة المكونة" %}</th>
                                    <th>{% trans "الكمية" %}</th>
                                    <th>{% trans "الوحدة" %}</th>
                                    <th>{% trans "نسبة الهدر" %}</th>
                                    <th>{% trans "الكمية الإجمالية" %}</th>
                                    <th>{% trans "ملاحظات" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for component in components %}
                                <tr>
                                    <td>
                                        <a href="{% url 'base_data:item_detail' component.component_item.pk %}" class="text-decoration-none">
                                            <i class="fas fa-box text-primary"></i> {{ component.component_item.name }}
                                        </a>
                                    </td>
                                    <td>{{ component.quantity|floatformat:3 }}</td>
                                    <td>{{ component.unit }}</td>
                                    <td>{{ component.waste_percentage|floatformat:2 }}%</td>
                                    <td>
                                        <span class="badge bg-primary">{{ component.get_total_quantity|floatformat:3 }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ component.notes|default:"-" }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- معدلات التحويل -->
    {% if conversions %}
    <div class="row">
        <div class="col-12">
            <div class="card detail-card shadow mb-4">
                <div class="card-header bg-gradient-warning text-dark">
                    <h5 class="m-0">
                        <i class="fas fa-exchange-alt"></i> {% trans "معدلات التحويل" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "من وحدة" %}</th>
                                    <th>{% trans "إلى وحدة" %}</th>
                                    <th>{% trans "معامل التحويل" %}</th>
                                    <th>{% trans "مثال" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for conversion in conversions %}
                                <tr>
                                    <td>
                                        <span class="badge bg-info">{{ conversion.from_unit }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ conversion.to_unit }}</span>
                                    </td>
                                    <td>{{ conversion.factor|floatformat:4 }}</td>
                                    <td>
                                        <small class="text-muted">
                                            1 {{ conversion.from_unit }} = {{ conversion.factor|floatformat:4 }} {{ conversion.to_unit }}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // تأثيرات تفاعلية للبطاقات
    $('.detail-card').hover(
        function() {
            $(this).addClass('shadow-lg');
        },
        function() {
            $(this).removeClass('shadow-lg');
        }
    );

    // تأكيد الحذف
    $('a[href*="delete"]').on('click', function(e) {
        e.preventDefault();
        if (confirm('{% trans "هل أنت متأكد من حذف هذا الصنف؟" %}')) {
            window.location.href = $(this).attr('href');
        }
    });
});
</script>
{% endblock %}