{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{% trans "شجرة التصنيفات" %}{% endblock %}

{% block extra_css %}
<!-- jsTree CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.15/themes/default/style.min.css">
<style>
.jstree-default .jstree-clicked {
    background: #007bff !important;
    border-radius: 4px;
}
.category-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border-left: 4px solid #007bff;
}
.tree-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    min-height: 500px;
}
.stats-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'core:dashboard' %}">{% trans "الرئيسية" %}</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'base_data:index' %}">{% trans "البيانات الأساسية" %}</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'base_data:category_list' %}">{% trans "تصنيفات الأصناف" %}</a>
        </li>
        <li class="breadcrumb-item active">{% trans "شجرة التصنيفات" %}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-sitemap me-2"></i>
                {% trans "شجرة التصنيفات الهرمية" %}
            </h1>
            <p class="text-muted small mt-1">{% trans "عرض وإدارة التصنيفات في شكل شجرة هرمية تفاعلية" %}</p>
        </div>
        <div>
            {% if perms.base_data.add_itemcategory %}
            <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#quickAddModal">
                <i class="fas fa-plus me-1"></i>
                {% trans "إضافة تصنيف" %}
            </button>
            {% endif %}
            <a href="{% url 'base_data:category_list' %}" class="btn btn-outline-primary">
                <i class="fas fa-list me-1"></i>
                {% trans "عرض جدولي" %}
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            
            <!-- Tree Container -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-tree me-1"></i>
                        {% trans "الهيكل الهرمي للتصنيفات" %}
                    </h6>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="expandAll()">
                            <i class="fas fa-expand-alt me-1"></i>
                            {% trans "توسيع الكل" %}
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">
                            <i class="fas fa-compress-alt me-1"></i>
                            {% trans "طي الكل" %}
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="refreshTree()">
                            <i class="fas fa-sync-alt me-1"></i>
                            {% trans "تحديث" %}
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="tree-container">
                        <div id="categoryTree"></div>
                        <div class="text-center mt-4" id="treeLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">{% trans "جاري التحميل..." %}</span>
                            </div>
                            <p class="mt-2 text-muted">{% trans "جاري تحميل شجرة التصنيفات..." %}</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        <div class="col-lg-4">
            
            <!-- Statistics -->
            <div class="stats-box">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">{% trans "إحصائيات التصنيفات" %}</h5>
                        <p class="mb-0 small opacity-75">{% trans "نظرة عامة على البيانات" %}</p>
                    </div>
                    <div>
                        <i class="fas fa-chart-pie fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-6">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="text-center">
                                <h4 class="mb-0" id="totalCategories">{{ total_categories|default:0 }}</h4>
                                <small>{% trans "إجمالي التصنيفات" %}</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="text-center">
                                <h4 class="mb-0" id="activeCategories">{{ active_categories|default:0 }}</h4>
                                <small>{% trans "النشطة" %}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selected Category Info -->
            <div class="card shadow mb-4" id="categoryInfoCard" style="display: none;">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-info-circle me-1"></i>
                        {% trans "معلومات التصنيف المحدد" %}
                    </h6>
                </div>
                <div class="card-body" id="categoryInfoContent">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
            </div>

            <!-- Level Statistics -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-secondary">
                        <i class="fas fa-layer-group me-1"></i>
                        {% trans "إحصائيات المستويات" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div id="levelStats">
                        <!-- سيتم ملؤها ديناميكياً -->
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p class="mt-2">{% trans "جاري التحميل..." %}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-cog me-1"></i>
                        {% trans "إجراءات سريعة" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if perms.base_data.add_itemcategory %}
                        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#quickAddModal">
                            <i class="fas fa-plus me-1"></i>
                            {% trans "إضافة تصنيف جديد" %}
                        </button>
                        {% endif %}
                        <a href="{% url 'base_data:category_list' %}" class="btn btn-outline-primary">
                            <i class="fas fa-table me-1"></i>
                            {% trans "العرض الجدولي" %}
                        </a>
                        <a href="{% url 'base_data:category_export' %}" class="btn btn-outline-info">
                            <i class="fas fa-download me-1"></i>
                            {% trans "تصدير البيانات" %}
                        </a>
                        <button type="button" class="btn btn-outline-secondary" onclick="printTree()">
                            <i class="fas fa-print me-1"></i>
                            {% trans "طباعة الشجرة" %}
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Quick Add Modal -->
{% if perms.base_data.add_itemcategory %}
<div class="modal fade" id="quickAddModal" tabindex="-1" aria-labelledby="quickAddModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickAddModalLabel">
                    <i class="fas fa-plus me-2"></i>
                    {% trans "إضافة تصنيف جديد" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="quickAddForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quick_code" class="form-label">{% trans "كود التصنيف" %} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="quick_code" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label for="quick_name" class="form-label">{% trans "اسم التصنيف" %} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="quick_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="quick_name_en" class="form-label">{% trans "الاسم الإنجليزي" %}</label>
                        <input type="text" class="form-control" id="quick_name_en" name="name_en">
                    </div>
                    <div class="mb-3">
                        <label for="quick_parent" class="form-label">{% trans "التصنيف الأب" %}</label>
                        <select class="form-select" id="quick_parent" name="parent">
                            <option value="">{% trans "بدون تصنيف أب (مستوى أول)" %}</option>
                            <!-- سيتم ملؤها ديناميكياً -->
                        </select>
                        <div class="form-text">{% trans "اختر التصنيف الأب من الشجرة أو اتركه فارغاً" %}</div>
                    </div>
                    <div class="alert alert-success d-none" id="quickAddSuccess">
                        <i class="fas fa-check-circle me-1"></i>
                        <span id="quickAddSuccessMessage"></span>
                    </div>
                    <div class="alert alert-danger d-none" id="quickAddError">
                        <i class="fas fa-times-circle me-1"></i>
                        <span id="quickAddErrorMessage"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "إلغاء" %}
                    </button>
                    <button type="submit" class="btn btn-primary" id="quickAddBtn">
                        <i class="fas fa-save me-1"></i> {% trans "حفظ" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<!-- jsTree JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.15/jstree.min.js"></script>

<script>
var categoryTree;
var selectedCategoryId = null;

$(document).ready(function() {
    // تهيئة الشجرة
    initializeTree();
    
    // تحميل الإحصائيات
    loadLevelStats();
    
    // Quick Add Form
    $('#quickAddForm').on('submit', function(e) {
        e.preventDefault();
        submitQuickAdd();
    });

    // تحديث القائمة المنسدلة عند فتح المودال
    $('#quickAddModal').on('show.bs.modal', function() {
        loadParentOptions();
    });
});

// تهيئة شجرة التصنيفات
function initializeTree() {
    categoryTree = $('#categoryTree').jstree({
        'core': {
            'data': {
                'url': function(node) {
                    return "{% url 'base_data:category_tree_ajax' %}";
                },
                'data': function(node) {
                    return { 'parent_id': node.id };
                }
            },
            'themes': {
                'name': 'default',
                'responsive': true,
                'variant': 'large'
            }
        },
        'plugins': ['search', 'contextmenu', 'dnd', 'state', 'types'],
        'contextmenu': {
            'items': function(node) {
                var items = {};
                
                items.view = {
                    'label': '{% trans "عرض" %}',
                    'icon': 'fas fa-eye',
                    'action': function() {
                        showCategoryInfo(node.id);
                    }
                };
                
                {% if perms.base_data.change_itemcategory %}
                items.edit = {
                    'label': '{% trans "تعديل" %}',
                    'icon': 'fas fa-edit',
                    'action': function() {
                        window.location.href = "{% url 'base_data:category_edit' 0 %}".replace('0', node.id);
                    }
                };
                {% endif %}
                
                {% if perms.base_data.add_itemcategory %}
                items.add = {
                    'label': '{% trans "إضافة تصنيف فرعي" %}',
                    'icon': 'fas fa-plus',
                    'action': function() {
                        addSubCategory(node.id);
                    }
                };
                {% endif %}
                
                {% if perms.base_data.delete_itemcategory %}
                items.delete = {
                    'label': '{% trans "حذف" %}',
                    'icon': 'fas fa-trash',
                    'action': function() {
                        deleteCategory(node.id, node.text);
                    }
                };
                {% endif %}
                
                return items;
            }
        },
        'types': {
            'default': {
                'icon': 'fas fa-folder'
            }
        }
    });

    // أحداث الشجرة
    categoryTree.on('ready.jstree', function() {
        $('#treeLoading').hide();
        updateStats();
    });

    categoryTree.on('select_node.jstree', function(e, data) {
        selectedCategoryId = data.node.id;
        showCategoryInfo(data.node.id);
    });
}

// عرض معلومات التصنيف
function showCategoryInfo(categoryId) {
    $('#categoryInfoCard').show();
    $('#categoryInfoContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> {% trans "جاري التحميل..." %}</div>');

    $.ajax({
        url: "{% url 'base_data:category_info_ajax' 0 %}".replace('0', categoryId),
        method: 'GET',
        success: function(response) {
            if (response.success) {
                var category = response.category;
                var html = `
                    <table class="table table-sm table-borderless">
                        <tr><td class="fw-bold">{% trans "الكود:" %}</td><td>${category.code}</td></tr>
                        <tr><td class="fw-bold">{% trans "الاسم:" %}</td><td>${category.name}</td></tr>
                        <tr><td class="fw-bold">{% trans "المستوى:" %}</td><td><span class="badge badge-info">المستوى ${category.level}</span></td></tr>
                        <tr><td class="fw-bold">{% trans "الأصناف:" %}</td><td><span class="badge badge-primary">${category.items_count}</span></td></tr>
                        <tr><td class="fw-bold">{% trans "التصنيفات الفرعية:" %}</td><td><span class="badge badge-warning">${category.children_count}</span></td></tr>
                        <tr><td class="fw-bold">{% trans "الحالة:" %}</td><td>${category.is_inactive ? '<span class="badge badge-warning">غير نشط</span>' : '<span class="badge badge-success">نشط</span>'}</td></tr>
                    </table>
                    <div class="d-grid gap-2 mt-3">
                        <a href="{% url 'base_data:category_edit' 0 %}".replace('0', '${category.id}') class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-edit me-1"></i> {% trans "تعديل" %}
                        </a>
                        <a href="{% url 'base_data:item_list' %}?category=${category.id}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-list me-1"></i> {% trans "عرض الأصناف" %}
                        </a>
                    </div>
                `;
                $('#categoryInfoContent').html(html);
            } else {
                $('#categoryInfoContent').html('<div class="alert alert-danger">{% trans "خطأ في تحميل البيانات" %}</div>');
            }
        },
        error: function() {
            $('#categoryInfoContent').html('<div class="alert alert-danger">{% trans "خطأ في تحميل البيانات" %}</div>');
        }
    });
}

// تحميل إحصائيات المستويات
function loadLevelStats() {
    // يمكن إضافة endpoint منفصل للإحصائيات
    var html = `
        <div class="row text-center">
            <div class="col-6 mb-2">
                <div class="h6 text-primary mb-0">{{ level_1_count|default:0 }}</div>
                <div class="small text-muted">{% trans "المستوى الأول" %}</div>
            </div>
            <div class="col-6 mb-2">
                <div class="h6 text-info mb-0">{{ level_2_count|default:0 }}</div>
                <div class="small text-muted">{% trans "المستوى الثاني" %}</div>
            </div>
            <div class="col-6 mb-2">
                <div class="h6 text-warning mb-0">{{ level_3_count|default:0 }}</div>
                <div class="small text-muted">{% trans "المستوى الثالث" %}</div>
            </div>
            <div class="col-6 mb-2">
                <div class="h6 text-success mb-0">{{ level_4_count|default:0 }}</div>
                <div class="small text-muted">{% trans "المستوى الرابع" %}</div>
            </div>
        </div>
    `;
    $('#levelStats').html(html);
}

// تحديث الإحصائيات
function updateStats() {
    var totalNodes = categoryTree.jstree('get_json').length;
    $('#totalCategories').text(totalNodes);
}

// وظائف التحكم في الشجرة
function expandAll() {
    categoryTree.jstree('open_all');
}

function collapseAll() {
    categoryTree.jstree('close_all');
}

function refreshTree() {
    categoryTree.jstree('refresh');
    loadLevelStats();
}

// إضافة تصنيف فرعي
function addSubCategory(parentId) {
    $('#quick_parent').val(parentId);
    $('#quickAddModal').modal('show');
}

// حذف تصنيف
function deleteCategory(categoryId, categoryName) {
    if (confirm('{% trans "هل أنت متأكد من حذف التصنيف: " %}' + categoryName + '؟')) {
        window.location.href = "{% url 'base_data:category_delete' 0 %}".replace('0', categoryId);
    }
}

// تحميل خيارات التصنيف الأب
function loadParentOptions() {
    $.ajax({
        url: "{% url 'base_data:category_search_ajax' %}",
        method: 'GET',
        data: { term: '', limit: 100 },
        success: function(response) {
            var select = $('#quick_parent');
            select.find('option[value!=""]').remove();
            
            response.results.forEach(function(category) {
                select.append($('<option>', {
                    value: category.id,
                    text: category.text
                }));
            });
        }
    });
}

// إرسال نموذج الإضافة السريعة
function submitQuickAdd() {
    var formData = new FormData($('#quickAddForm')[0]);
    $('#quickAddBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> {% trans "جاري الحفظ..." %}');
    
    $.ajax({
        url: "{% url 'base_data:category_quick_add' %}",
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                $('#quickAddSuccess').removeClass('d-none');
                $('#quickAddSuccessMessage').text(response.message);
                $('#quickAddError').addClass('d-none');
                $('#quickAddForm')[0].reset();
                
                // تحديث الشجرة
                categoryTree.jstree('refresh');
                
                setTimeout(function() {
                    $('#quickAddModal').modal('hide');
                    $('#quickAddSuccess').addClass('d-none');
                }, 2000);
            } else {
                $('#quickAddError').removeClass('d-none');
                $('#quickAddErrorMessage').text(response.message);
                $('#quickAddSuccess').addClass('d-none');
            }
        },
        error: function() {
            $('#quickAddError').removeClass('d-none');
            $('#quickAddErrorMessage').text('{% trans "حدث خطأ أثناء الحفظ" %}');
            $('#quickAddSuccess').addClass('d-none');
        },
        complete: function() {
            $('#quickAddBtn').prop('disabled', false).html('<i class="fas fa-save me-1"></i> {% trans "حفظ" %}');
        }
    });
}

// طباعة الشجرة
function printTree() {
    var printContent = $('#categoryTree').html();
    var printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write(`
        <html>
        <head>
            <title>{% trans "شجرة التصنيفات" %}</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.15/themes/default/style.min.css">
        </head>
        <body>
            <h2>{% trans "شجرة التصنيفات" %}</h2>
            <div id="categoryTree">${printContent}</div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
</script>

{% endblock %}