<!-- apps/base_data/templates/base_data/items/create.html -->
{% extends 'base_data/base/form_base.html' %}
{% load i18n widget_tweaks %}

{% block form_icon %}<i class="fas fa-plus me-2"></i>{% endblock %}
{% block form_title %}{% trans "إضافة صنف جديد" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'base_data:item_list' %}">{% trans "الأصناف" %}</a>
</li>
<li class="breadcrumb-item active">{% trans "إضافة جديد" %}</li>
{% endblock %}

{% block back_url %}{% url 'base_data:item_list' %}{% endblock %}
{% block cancel_url %}{% url 'base_data:item_list' %}{% endblock %}

{% block main_fields %}
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-info-circle me-2"></i>{% trans "المعلومات الأساسية" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label {% if form.code.field.required %}required-field{% endif %}">
                        {{ form.code.label }}
                    </label>
                    {{ form.code|add_class:"form-control" }}
                    {% if form.code.errors %}
                        <div class="invalid-feedback d-block">{{ form.code.errors.0 }}</div>
                    {% endif %}
                    <div class="form-text">{% trans "اتركه فارغاً للتوليد التلقائي" %}</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label required-field">{{ form.name.label }}</label>
                    {{ form.name|add_class:"form-control" }}
                    {% if form.name.errors %}
                        <div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.name_en.label }}</label>
                    {{ form.name_en|add_class:"form-control" }}
                    {% if form.name_en.errors %}
                        <div class="invalid-feedback d-block">{{ form.name_en.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.barcode.label }}</label>
                    {{ form.barcode|add_class:"form-control" }}
                    {% if form.barcode.errors %}
                        <div class="invalid-feedback d-block">{{ form.barcode.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label required-field">{{ form.category.label }}</label>
                    <div class="input-group">
                        {{ form.category|add_class:"form-select" }}
                        <button type="button" class="btn btn-outline-secondary quick-add-btn"
                                data-modal="categoryQuickAddModal" title="{% trans 'إضافة تصنيف جديد' %}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    {% if form.category.errors %}
                        <div class="invalid-feedback d-block">{{ form.category.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label required-field">{{ form.unit.label }}</label>
                    <div class="input-group">
                        {{ form.unit|add_class:"form-select" }}
                        <button type="button" class="btn btn-outline-secondary quick-add-btn"
                                data-modal="unitQuickAddModal" title="{% trans 'إضافة وحدة جديدة' %}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    {% if form.unit.errors %}
                        <div class="invalid-feedback d-block">{{ form.unit.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.manufacturer.label }}</label>
                    {{ form.manufacturer|add_class:"form-control" }}
                    {% if form.manufacturer.errors %}
                        <div class="invalid-feedback d-block">{{ form.manufacturer.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- الأسعار والضرائب -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-dollar-sign me-2"></i>{% trans "الأسعار والضرائب" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.purchase_price.label }}</label>
                    {{ form.purchase_price|add_class:"form-control" }}
                    {% if form.purchase_price.errors %}
                        <div class="invalid-feedback d-block">{{ form.purchase_price.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.sale_price.label }}</label>
                    {{ form.sale_price|add_class:"form-control" }}
                    {% if form.sale_price.errors %}
                        <div class="invalid-feedback d-block">{{ form.sale_price.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.tax_rate.label }}</label>
                    <div class="input-group">
                        {{ form.tax_rate|add_class:"form-control" }}
                        <span class="input-group-text">%</span>
                    </div>
                    {% if form.tax_rate.errors %}
                        <div class="invalid-feedback d-block">{{ form.tax_rate.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- المواصفات -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-clipboard-list me-2"></i>{% trans "المواصفات والتفاصيل" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.weight.label }}</label>
                    <div class="input-group">
                        {{ form.weight|add_class:"form-control" }}
                        <span class="input-group-text">{% trans "كجم" %}</span>
                    </div>
                    {% if form.weight.errors %}
                        <div class="invalid-feedback d-block">{{ form.weight.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.image.label }}</label>
                    {{ form.image|add_class:"form-control" }}
                    {% if form.image.errors %}
                        <div class="invalid-feedback d-block">{{ form.image.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-group mb-3">
            <label class="form-label">{{ form.specifications.label }}</label>
            {{ form.specifications|add_class:"form-control" }}
            {% if form.specifications.errors %}
                <div class="invalid-feedback d-block">{{ form.specifications.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group mb-3">
            <label class="form-label">{{ form.notes.label }}</label>
            {{ form.notes|add_class:"form-control" }}
            {% if form.notes.errors %}
                <div class="invalid-feedback d-block">{{ form.notes.errors.0 }}</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block side_fields %}
<!-- حدود المخزون -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-warehouse me-2"></i>{% trans "حدود المخزون" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="form-group mb-3">
            <label class="form-label">{{ form.minimum_quantity.label }}</label>
            {{ form.minimum_quantity|add_class:"form-control" }}
            {% if form.minimum_quantity.errors %}
                <div class="invalid-feedback d-block">{{ form.minimum_quantity.errors.0 }}</div>
            {% endif %}
            <div class="form-text">{% trans "إنذار عند الوصول لهذا الحد" %}</div>
        </div>

        <div class="form-group mb-3">
            <label class="form-label">{{ form.maximum_quantity.label }}</label>
            {{ form.maximum_quantity|add_class:"form-control" }}
            {% if form.maximum_quantity.errors %}
                <div class="invalid-feedback d-block">{{ form.maximum_quantity.errors.0 }}</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- الحسابات المحاسبية -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-calculator me-2"></i>{% trans "الحسابات المحاسبية" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="form-group mb-3">
            <label class="form-label">{{ form.sales_account.label }}</label>
            {{ form.sales_account|add_class:"form-select" }}
            {% if form.sales_account.errors %}
                <div class="invalid-feedback d-block">{{ form.sales_account.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group mb-3">
            <label class="form-label">{{ form.purchase_account.label }}</label>
            {{ form.purchase_account|add_class:"form-select" }}
            {% if form.purchase_account.errors %}
                <div class="invalid-feedback d-block">{{ form.purchase_account.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group mb-3">
            <label class="form-label">{{ form.inventory_account.label }}</label>
            {{ form.inventory_account|add_class:"form-select" }}
            {% if form.inventory_account.errors %}
                <div class="invalid-feedback d-block">{{ form.inventory_account.errors.0 }}</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- إعدادات إضافية -->
<div class="card">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-cog me-2"></i>{% trans "إعدادات" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="form-check form-switch mb-3">
            {{ form.is_inactive|add_class:"form-check-input" }}
            <label class="form-check-label" for="{{ form.is_inactive.id_for_label }}">
                {{ form.is_inactive.label }}
            </label>
            {% if form.is_inactive.errors %}
                <div class="invalid-feedback d-block">{{ form.is_inactive.errors.0 }}</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block quick_add_modals %}
<!-- Modal إضافة تصنيف سريع -->
<div class="modal fade" id="categoryQuickAddModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "إضافة تصنيف جديد" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="categoryQuickAddForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label class="form-label required-field">{% trans "اسم التصنيف" %}</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">{% trans "التصنيف الأب" %}</label>
                        <select name="parent" class="form-select">
                            <option value="">{% trans "بدون تصنيف أب" %}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "حفظ" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal إضافة وحدة قياس سريعة -->
<div class="modal fade" id="unitQuickAddModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "إضافة وحدة قياس جديدة" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="unitQuickAddForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label class="form-label required-field">{% trans "اسم الوحدة" %}</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">{% trans "الاسم بالإنجليزية" %}</label>
                        <input type="text" name="name_en" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "حفظ" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block form_custom_js %}
// التعامل مع الإضافة السريعة للتصنيفات
$('#categoryQuickAddForm').on('submit', function(e) {
    e.preventDefault();

    $.ajax({
        url: '{% url 'base_data:category_quick_add' %}',
        method: 'POST',
        data: $(this).serialize(),
        success: function(response) {
            if(response.success) {
                // إضافة للقائمة المنسدلة
                $('#id_category').append(
                    '<option value="' + response.category.id + '" selected>' +
                    response.category.name + '</option>'
                );
                $('#categoryQuickAddModal').modal('hide');
                $('#categoryQuickAddForm')[0].reset();
                showAlert('success', response.message);
            } else {
                showAlert('danger', response.message);
            }
        }
    });
});

// التعامل مع الإضافة السريعة لوحدات القياس
$('#unitQuickAddForm').on('submit', function(e) {
    e.preventDefault();

    $.ajax({
        url: '{% url 'base_data:unit_quick_add' %}',
        method: 'POST',
        data: $(this).serialize(),
        success: function(response) {
            if(response.success) {
                // إضافة للقائمة المنسدلة
                $('#id_unit').append(
                    '<option value="' + response.unit.id + '" selected>' +
                    response.unit.name + '</option>'
                );
                $('#unitQuickAddModal').modal('hide');
                $('#unitQuickAddForm')[0].reset();
                showAlert('success', response.message);
            } else {
                showAlert('danger', response.message);
            }
        }
    });
});

function showAlert(type, message) {
    let alertHtml = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
                   message +
                   '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                   '</div>';
    $('form').prepend(alertHtml);

    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}
{% endblock %}