{% extends 'base/base.html' %}
{% load i18n static crispy_forms_tags %}

{% block title %}
{% if object %}
    {% trans "تعديل التصنيف" %}: {{ object.name }}
{% else %}
    {% trans "إضافة تصنيف جديد" %}
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.form-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
}
.required-field {
    color: #dc3545;
}
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'core:dashboard' %}">{% trans "الرئيسية" %}</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'base_data:index' %}">{% trans "البيانات الأساسية" %}</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'base_data:category_list' %}">{% trans "تصنيفات الأصناف" %}</a>
        </li>
        <li class="breadcrumb-item active">
            {% if object %}{% trans "تعديل" %}{% else %}{% trans "إضافة" %}{% endif %}
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-{% if object %}edit{% else %}plus{% endif %} me-2"></i>
                {% if object %}
                    {% trans "تعديل التصنيف" %}: {{ object.name }}
                {% else %}
                    {% trans "إضافة تصنيف جديد" %}
                {% endif %}
            </h1>
            <p class="text-muted small mt-1">
                {% if object %}
                    {% trans "تعديل بيانات التصنيف المحدد" %}
                {% else %}
                    {% trans "إضافة تصنيف جديد للأصناف مع إمكانية التصنيف الهرمي" %}
                {% endif %}
            </p>
        </div>
        <div>
            <a href="{% url 'base_data:category_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                {% trans "العودة للقائمة" %}
            </a>
        </div>
    </div>

    <!-- Form Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-info-circle me-1"></i>
                {% trans "بيانات التصنيف" %}
            </h6>
        </div>
        <div class="card-body">
            <form method="post" id="categoryForm" novalidate>
                {% csrf_token %}

                <!-- Basic Information Section -->
                <div class="form-section">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-file-alt me-2"></i>
                        {% trans "المعلومات الأساسية" %}
                    </h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.code.id_for_label }}" class="form-label">
                                    {{ form.code.label }}
                                    <span class="required-field">*</span>
                                </label>
                                {{ form.code }}
                                {% if form.code.help_text %}
                                <div class="form-text">{{ form.code.help_text }}</div>
                                {% endif %}
                                <div class="invalid-feedback">
                                    {{ form.code.errors.0 }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    {{ form.name.label }}
                                    <span class="required-field">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.help_text %}
                                <div class="form-text">{{ form.name.help_text }}</div>
                                {% endif %}
                                <div class="invalid-feedback">
                                    {{ form.name.errors.0 }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.name_en.id_for_label }}" class="form-label">
                                    {{ form.name_en.label }}
                                </label>
                                {{ form.name_en }}
                                {% if form.name_en.help_text %}
                                <div class="form-text">{{ form.name_en.help_text }}</div>
                                {% endif %}
                                <div class="invalid-feedback">
                                    {{ form.name_en.errors.0 }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hierarchy Section -->
                <div class="form-section">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-sitemap me-2"></i>
                        {% trans "التصنيف الهرمي" %}
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.parent.id_for_label }}" class="form-label">
                                    {{ form.parent.label }}
                                </label>
                                {{ form.parent }}
                                {% if form.parent.help_text %}
                                <div class="form-text">{{ form.parent.help_text }}</div>
                                {% else %}
                                <div class="form-text">{% trans "اختر التصنيف الأب لإنشاء تصنيف فرعي، أو اتركه فارغاً لتصنيف المستوى الأول" %}</div>
                                {% endif %}
                                <div class="invalid-feedback">
                                    {{ form.parent.errors.0 }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            {% if object.parent %}
                            <div class="mb-3">
                                <label class="form-label">{% trans "مسار التصنيف" %}</label>
                                <div class="form-control-plaintext bg-light p-2 rounded">
                                    <i class="fas fa-folder me-1"></i>
                                    {{ object.get_full_path }}
                                </div>
                                <div class="form-text">{% trans "المسار الكامل للتصنيف في الهيكل الهرمي" %}</div>
                            </div>
                            {% endif %}

                            {% if object %}
                            <div class="mb-3">
                                <label class="form-label">{% trans "المستوى الحالي" %}</label>
                                <div class="form-control-plaintext bg-light p-2 rounded">
                                    <i class="fas fa-layer-group me-1"></i>
                                    {% trans "المستوى" %} {{ object.level }}
                                    {% if object.level == 1 %}({% trans "أساسي" %})
                                    {% elif object.level == 2 %}({% trans "فرعي" %})
                                    {% elif object.level == 3 %}({% trans "فرعي ثانوي" %})
                                    {% elif object.level == 4 %}({% trans "فرعي ثالثي" %}){% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="form-section">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-cog me-2"></i>
                        {% trans "الإعدادات" %}
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            {% if form.is_active %}
                            <div class="form-check form-switch mb-3">
                                {{ form.is_active }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                    {{ form.is_active.label }}
                                </label>
                                {% if form.is_active.help_text %}
                                <div class="form-text">{{ form.is_active.help_text }}</div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if object %}
                            <div class="mb-3">
                                <label class="form-label">{% trans "عدد الأصناف" %}</label>
                                <div class="form-control-plaintext bg-light p-2 rounded">
                                    <i class="fas fa-box me-1"></i>
                                    {{ object.items.count }} {% trans "صنف" %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Description Section -->
                {% if form.description %}
                <div class="form-section">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-align-left me-2"></i>
                        {% trans "وصف إضافي" %}
                    </h5>
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.help_text %}
                        <div class="form-text">{{ form.description.help_text }}</div>
                        {% endif %}
                        <div class="invalid-feedback">
                            {{ form.description.errors.0 }}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Submit Buttons -->
                <div class="d-flex justify-content-between">
                    <div>
                        <a href="{% url 'base_data:category_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>
                            {% trans "إلغاء" %}
                        </a>
                    </div>
                    <div>
                        {% if object and perms.base_data.delete_itemcategory %}
                        <button type="button" class="btn btn-danger me-2" onclick="showDeleteConfirm({{ object.pk }}, '{{ object.name }}')">
                            <i class="fas fa-trash me-1"></i>
                            {% trans "حذف" %}
                        </button>
                        {% endif %}
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save me-1"></i>
                            {% if object %}{% trans "تحديث" %}{% else %}{% trans "حفظ" %}{% endif %}
                        </button>
                        {% if not object %}
                        <button type="submit" name="save_and_add" class="btn btn-success" id="saveAndAddBtn">
                            <i class="fas fa-plus me-1"></i>
                            {% trans "حفظ وإضافة آخر" %}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Sub Categories Card (Only for existing categories) -->
    {% if object and object.children.exists %}
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-success">
                <i class="fas fa-sitemap me-1"></i>
                {% trans "التصنيفات الفرعية" %}
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% for child in object.children.all %}
                <div class="col-md-4 mb-3">
                    <div class="card border-left-success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ child.name }}</h6>
                                    <small class="text-muted">{{ child.code }}</small>
                                    <div class="text-muted small">
                                        <i class="fas fa-box me-1"></i>
                                        {{ child.items.count }} {% trans "صنف" %}
                                    </div>
                                </div>
                                <div>
                                    {% if perms.base_data.change_itemcategory %}
                                    <a href="{% url 'base_data:category_edit' child.pk %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
{% if object and perms.base_data.delete_itemcategory %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {% trans "تأكيد حذف التصنيف" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-1"></i> {% trans "تحذير مهم!" %}</h6>
                    <p class="mb-0">{% trans "حذف هذا التصنيف سيؤدي إلى:" %}</p>
                    <ul class="mt-2 mb-0">
                        <li>{% trans "حذف جميع التصنيفات الفرعية" %} ({{ object.get_descendant_count }})</li>
                        <li>{% trans "إعادة تصنيف الأصناف المرتبطة" %} ({{ object.items.count }})</li>
                    </ul>
                </div>
                <p>{% trans "هل أنت متأكد من حذف التصنيف:" %} <strong id="deleteItemName"></strong>؟</p>

                <div class="alert alert-success d-none" id="deleteSuccess">
                    <i class="fas fa-check-circle me-1"></i>
                    <span id="deleteSuccessMessage"></span>
                </div>
                <div class="alert alert-danger d-none" id="deleteError">
                    <i class="fas fa-times-circle me-1"></i>
                    <span id="deleteErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "إلغاء" %}
                </button>
                <form method="post" id="deleteForm" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i> {% trans "حذف نهائياً" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Form validation
    $('#categoryForm').on('submit', function(e) {
        var isValid = true;

        // Check required fields
        $(this).find('input[required], select[required]').each(function() {
            if (!$(this).val()) {
                $(this).addClass('is-invalid');
                isValid = false;
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        // Check for duplicate codes via AJAX
        var code = $('#id_code').val();
        var currentId = {% if object %}{{ object.pk }}{% else %}null{% endif %};

        if (code && isValid) {
            e.preventDefault();

            $('#submitBtn, #saveAndAddBtn').prop('disabled', true).each(function() {
                $(this).html('<i class="fas fa-spinner fa-spin me-1"></i> {% trans "جاري التحقق..." %}');
            });

            $.ajax({
                url: "{% url 'base_data:category_check_code' %}",
                method: 'POST',
                data: {
                    'code': code,
                    'id': currentId,
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.exists) {
                        $('#id_code').addClass('is-invalid');
                        $('#id_code').next('.invalid-feedback').text('{% trans "هذا الكود مستخدم من قبل" %}');
                        isValid = false;
                    } else {
                        $('#categoryForm').off('submit').submit();
                    }
                },
                error: function() {
                    // If check fails, proceed anyway
                    $('#categoryForm').off('submit').submit();
                },
                complete: function() {
                    $('#submitBtn').prop('disabled', false).html('<i class="fas fa-save me-1"></i> {% if object %}{% trans "تحديث" %}{% else %}{% trans "حفظ" %}{% endif %}');
                    $('#saveAndAddBtn').prop('disabled', false).html('<i class="fas fa-plus me-1"></i> {% trans "حفظ وإضافة آخر" %}');
                }
            });
        }

        if (!isValid) {
            e.preventDefault();
        }
    });

    // Real-time validation
    $('#categoryForm input, #categoryForm select').on('blur', function() {
        if ($(this).prop('required') && !$(this).val()) {
            $(this).addClass('is-invalid');
        } else {
            $(this).removeClass('is-invalid');
        }
    });

    // Parent category change handler
    $('#id_parent').on('change', function() {
        var parentId = $(this).val();
        if (parentId) {
            // Could add AJAX call to show hierarchy info
            console.log('Parent changed to: ' + parentId);
        }
    });

    // Auto-generate English name
    $('#id_name').on('input', function() {
        if (!$('#id_name_en').val()) {
            // Simple transliteration - you can enhance this
            var arabicName = $(this).val();
            // Add your transliteration logic here
        }
    });
});

// Show delete confirmation
function showDeleteConfirm(id, name) {
    $('#deleteItemName').text(name);
    $('#deleteModal').modal('show');
}

// Handle delete form submission
$('#deleteForm').on('submit', function(e) {
    e.preventDefault();

    $('#confirmDeleteBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> {% trans "جاري الحذف..." %}');

    $.ajax({
        url: window.location.href,
        method: 'POST',
        data: $(this).serialize(),
        success: function(response) {
            if (response.success) {
                $('#deleteSuccess').removeClass('d-none');
                $('#deleteSuccessMessage').text(response.message);

                setTimeout(function() {
                    window.location.href = "{% url 'base_data:category_list' %}";
                }, 1500);
            } else {
                $('#deleteError').removeClass('d-none');
                $('#deleteErrorMessage').text(response.message);
            }
        },
        error: function() {
            $('#deleteError').removeClass('d-none');
            $('#deleteErrorMessage').text('{% trans "حدث خطأ أثناء الحذف" %}');
        },
        complete: function() {
            $('#confirmDeleteBtn').prop('disabled', false).html('<i class="fas fa-trash me-1"></i> {% trans "حذف نهائياً" %}');
        }
    });
});
</script>

{% endblock %}