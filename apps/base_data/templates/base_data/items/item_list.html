<!-- templates/base_data/items/item_list.html -->
{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{% trans "قائمة الأصناف" %}{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header with Breadcrumbs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 text-gray-800 mb-2">{% trans "إدارة الأصناف" %}</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            {% for breadcrumb in breadcrumbs %}
                                {% if breadcrumb.active %}
                                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                                {% else %}
                                    <li class="breadcrumb-item">
                                        {% if breadcrumb.url %}
                                            <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                                        {% else %}
                                            {{ breadcrumb.title }}
                                        {% endif %}
                                    </li>
                                {% endif %}
                            {% endfor %}
                        </ol>
                    </nav>
                </div>
                {% if perms.base_data.add_item %}
                <div>
                    <a href="{% url 'base_data:item_add' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> {% trans "إضافة صنف جديد" %}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- إحصائيات سريعة -->
    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="text-uppercase mb-2">{% trans "إجمالي الأصناف" %}</h6>
                            <span class="h4 mb-0">{{ total_items }}</span>
                        </div>
                        <div class="col-auto">
                            <div class="icon icon-shape bg-white text-primary rounded-circle shadow">
                                <i class="fas fa-boxes"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-gradient-success text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="text-uppercase mb-2">{% trans "الأصناف النشطة" %}</h6>
                            <span class="h4 mb-0">{{ active_items }}</span>
                        </div>
                        <div class="col-auto">
                            <div class="icon icon-shape bg-white text-success rounded-circle shadow">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-gradient-info text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="text-uppercase mb-2">{% trans "التصنيفات" %}</h6>
                            <span class="h4 mb-0">{{ categories_count }}</span>
                        </div>
                        <div class="col-auto">
                            <div class="icon icon-shape bg-white text-info rounded-circle shadow">
                                <i class="fas fa-layer-group"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="text-uppercase mb-2">{% trans "أصناف غير نشطة" %}</h6>
                            <span class="h4 mb-0">{{ total_items|add:'-'|add:active_items }}</span>
                        </div>
                        <div class="col-auto">
                            <div class="icon icon-shape bg-white text-warning rounded-circle shadow">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- فلاتر البحث -->
    <div class="card shadow mb-4">
        <div class="card-header bg-light">
            <h6 class="m-0 fw-bold text-primary">
                <i class="fas fa-filter"></i> {% trans "فلاتر البحث" %}
            </h6>
        </div>
        <div class="card-body">
            <form method="get" id="filterForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        {{ filter_form.search.label_tag }}
                        {{ filter_form.search }}
                    </div>
                    <div class="col-md-3">
                        {{ filter_form.category.label_tag }}
                        {{ filter_form.category }}
                    </div>
                    <div class="col-md-3">
                        {{ filter_form.item_type.label_tag }}
                        {{ filter_form.item_type }}
                    </div>
                    <div class="col-md-3">
                        {{ filter_form.is_inactive.label_tag }}
                        {{ filter_form.is_inactive }}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> {% trans "بحث" %}
                        </button>
                        <a href="{% url 'base_data:item_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> {% trans "مسح" %}
                        </a>
                        {% if perms.base_data.view_item %}
                        <a href="{% url 'base_data:item_export' %}?format=excel" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> {% trans "تصدير Excel" %}
                        </a>
                        <a href="{% url 'base_data:item_export' %}?format=csv" class="btn btn-info">
                            <i class="fas fa-file-csv"></i> {% trans "تصدير CSV" %}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- جدول الأصناف -->
    <div class="card shadow">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="m-0 fw-bold text-primary">
                <i class="fas fa-list"></i> {% trans "قائمة الأصناف" %}
            </h6>
            <div>
                {% if perms.base_data.add_itemcategory %}
                <a href="{% url 'base_data:category_add' %}" class="btn btn-sm btn-outline-info">
                    <i class="fas fa-layer-group"></i> {% trans "إدارة التصنيفات" %}
                </a>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="itemsTable">
                    <thead class="table-light">
                        <tr>
                            <th>{% trans "رمز الصنف" %}</th>
                            <th>{% trans "اسم الصنف" %}</th>
                            <th>{% trans "التصنيف" %}</th>
                            <th>{% trans "نوع الصنف" %}</th>
                            <th>{% trans "وحدة القياس" %}</th>
                            <th>{% trans "سعر البيع" %}</th>
                            <th>{% trans "الحالة" %}</th>
                            <th width="120">{% trans "الإجراءات" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- يتم تحميل البيانات عبر DataTables Ajax -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // إعداد DataTables
    $('#itemsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: "{% url 'base_data:item_datatable' %}",
            type: "GET"
        },
        columns: [
            { data: 0, name: 'code' },
            { data: 1, name: 'name' },
            { data: 2, name: 'category' },
            { data: 3, name: 'item_type' },
            { data: 4, name: 'unit_of_measure' },
            {
                data: 5,
                name: 'sale_price',
                render: function(data, type, row) {
                    return data ? parseFloat(data).toFixed(2) + ' {% trans "ر.س" %}' : '';
                }
            },
            { data: 6, name: 'is_inactive', orderable: false },
            { data: 7, name: 'actions', orderable: false, searchable: false }
        ],
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json"
        },
        responsive: true,
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "{% trans 'الكل' %}"]],
        order: [[0, 'asc']],
        dom: 'lBfrtip',
        buttons: []
    });

    // تطبيق الفلاتر عند تغيير القيم
    $('#filterForm select, #filterForm input').on('change keyup', function() {
        var table = $('#itemsTable').DataTable();
        table.search('').draw();
    });
});
</script>

<style>
/* أسلوب مخصص للبطاقات */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.bg-gradient-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}
.bg-gradient-info {
    background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
}
.bg-gradient-warning {
    background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
}

.icon-shape {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card {
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-2px);
}

/* تحسين DataTables RTL */
.dataTables_wrapper .dataTables_filter {
    float: left;
}
.dataTables_wrapper .dataTables_length {
    float: right;
}
</style>
{% endblock %}