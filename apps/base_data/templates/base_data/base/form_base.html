{% extends 'base_data/base/base_data.html' %}
{% load i18n widget_tweaks %}

{% block extra_css %}
<style>
    .form-group {
        margin-bottom: 1rem;
    }
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .invalid-feedback {
        display: block;
    }
</style>
{% endblock %}

{% block card_header %}
<div class="card-header bg-white border-bottom">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            {% block form_icon %}{% endblock %}
            {% block form_title %}{% endblock %}
        </h5>
        <div class="btn-group" role="group">
            {% block form_actions %}
            <a href="{% block back_url %}{% endblock %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-right me-1"></i>{% trans "رجوع" %}
            </a>
            {% endblock %}
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <!-- Form Errors -->
    {% if form.non_field_errors %}
    <div class="alert alert-danger">
        {{ form.non_field_errors }}
    </div>
    {% endif %}

    <div class="row">
        {% block form_content %}
        <div class="col-md-8">
            {% block main_fields %}
            <!-- Main form fields go here -->
            {% endblock %}
        </div>

        <div class="col-md-4">
            {% block side_fields %}
            <!-- Side form fields go here -->
            {% endblock %}
        </div>
        {% endblock %}
    </div>

    <!-- Form Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-end gap-2">
                {% block form_buttons %}
                <a href="{% block cancel_url %}{% endblock %}" class="btn btn-secondary">
                    <i class="fas fa-times me-1"></i>{% trans "إلغاء" %}
                </a>
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    <i class="fas fa-save me-1"></i>
                    {% block submit_text %}{% trans "حفظ" %}{% endblock %}
                </button>
                {% endblock %}
            </div>
        </div>
    </div>
</form>

<!-- Quick Add Modals -->
{% block quick_add_modals %}{% endblock %}
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Form validation
    $('form').on('submit', function(e) {
        var isValid = true;

        // Clear previous errors
        $('.is-invalid').removeClass('is-invalid');
        $('.invalid-feedback').remove();

        // Validate required fields
        $('[required]').each(function() {
            var $field = $(this);
            var value = $field.val();

            if (!value || value.trim() === '') {
                isValid = false;
                $field.addClass('is-invalid');

                var errorMsg = $field.data('error') || '{% trans "هذا الحقل مطلوب" %}';
                $field.after('<div class="invalid-feedback">' + errorMsg + '</div>');
            }
        });

        if (!isValid) {
            e.preventDefault();
            $('html, body').animate({
                scrollTop: $('.is-invalid:first').offset().top - 100
            }, 500);
            return false;
        }

        // Show loading on submit
        $('#submit-btn').prop('disabled', true)
                      .html('<i class="fas fa-spinner fa-spin me-1"></i>{% trans "جاري الحفظ..." %}');
        showLoading();
    });

    // Auto-resize textareas
    $('textarea').each(function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });

    // File upload preview
    $('input[type="file"]').on('change', function() {
        var file = this.files[0];
        var $preview = $('#' + $(this).attr('id') + '-preview');

        if (file && file.type.startsWith('image/') && $preview.length) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $preview.attr('src', e.target.result).removeClass('d-none');
            };
            reader.readAsDataURL(file);
        }
    });

    // Initialize Select2 for select fields
    $('.select2').select2({
        theme: 'bootstrap-5',
        dir: 'rtl',
        language: 'ar'
    });

    // Quick Add Modal handlers
    $('.quick-add-btn').on('click', function(e) {
        e.preventDefault();
        var modalId = $(this).data('modal');
        $('#' + modalId).modal('show');
    });

    {% block form_custom_js %}{% endblock %}
});
</script>
{% endblock %}