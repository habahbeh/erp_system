{% extends 'base_data/base/base_data.html' %}
{% load i18n %}
{% load base_data_tags %}

{% block extra_css %}
<style>
    .table-responsive {
        border-radius: 0.375rem;
    }
    .dataTables_wrapper .dataTables_filter input {
        border-radius: 0.375rem;
    }
    .btn-group .btn {
        border-radius: 0.375rem;
    }
</style>
{% endblock %}

{% block card_header %}
<div class="card-header bg-white border-bottom">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            {% block list_icon %}{% endblock %}
            {% block list_title %}{% endblock %}
            <small class="text-muted ms-2" id="total-count">
                {% block total_count %}{% endblock %}
            </small>
        </h5>
        <div class="btn-group" role="group">
            {% block list_actions %}
            {% if perms|lookup:add_permission %}
            <a href="{% block add_url %}{% endblock %}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i>{% trans "إضافة جديد" %}
            </a>
            {% endif %}

            {% if perms|lookup:import_permission %}
            <a href="{% block import_url %}{% endblock %}" class="btn btn-success btn-sm">
                <i class="fas fa-file-import me-1"></i>{% trans "استيراد" %}
            </a>
            {% endif %}

            {% if perms|lookup:export_permission %}
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-file-export me-1"></i>{% trans "تصدير" %}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% block export_excel_url %}{% endblock %}?format=xlsx">
                        <i class="fas fa-file-excel me-1"></i>Excel
                    </a></li>
                    <li><a class="dropdown-item" href="{% block export_csv_url %}{% endblock %}?format=csv">
                        <i class="fas fa-file-csv me-1"></i>CSV
                    </a></li>
                </ul>
            </div>
            {% endif %}
            {% endblock %}
        </div>
    </div>
</div>

<!-- Filters Section -->
{% block filters %}
{% if show_filters %}
<div class="card-header bg-light border-bottom">
    <div class="row g-3">
        {% block filter_fields %}{% endblock %}
        <div class="col-md-3">
            <button type="button" class="btn btn-outline-primary btn-sm" id="apply-filters">
                <i class="fas fa-filter me-1"></i>{% trans "تطبيق الفلاتر" %}
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="clear-filters">
                <i class="fas fa-times me-1"></i>{% trans "إلغاء الفلاتر" %}
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
{% endblock %}

{% block content %}
<!-- Bulk Actions Bar (Hidden by default) -->
<div id="bulk-actions-bar" class="alert alert-info d-none">
    <div class="d-flex justify-content-between align-items-center">
        <span>
            <strong id="selected-count">0</strong> {% trans "عنصر محدد" %}
        </span>
        <div class="btn-group btn-group-sm">
            {% block bulk_actions %}
            {% if perms|lookup:delete_permission %}
            <button type="button" class="btn btn-danger" id="bulk-delete-btn">
                <i class="fas fa-trash me-1"></i>{% trans "حذف المحدد" %}
            </button>
            {% endif %}

            {% if perms|lookup:change_permission %}
            <button type="button" class="btn btn-warning" id="bulk-deactivate-btn">
                <i class="fas fa-eye-slash me-1"></i>{% trans "إلغاء تفعيل" %}
            </button>
            <button type="button" class="btn btn-success" id="bulk-activate-btn">
                <i class="fas fa-eye me-1"></i>{% trans "تفعيل" %}
            </button>
            {% endif %}

            <button type="button" class="btn btn-secondary" id="bulk-cancel-btn">
                <i class="fas fa-times me-1"></i>{% trans "إلغاء" %}
            </button>
            {% endblock %}
        </div>
    </div>
</div>

<!-- DataTable -->
<div class="table-responsive">
    <table id="data-table" class="table table-hover table-striped w-100">
        <thead class="table-primary">
            {% block table_headers %}{% endblock %}
        </thead>
        <tbody>
            <!-- DataTables will populate this -->
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize DataTable
    var table = $('#data-table').DataTable({
        ajax: {
            url: '{% block datatable_url %}{% endblock %}',
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            data: function(d) {
                // Add filter data
                {% block filter_data %}{% endblock %}
                return d;
            }
        },
        columns: [
            {% block datatable_columns %}{% endblock %}
        ],
        order: [[1, 'asc']], // Default sort by second column
        select: {
            style: 'multi',
            selector: 'td:first-child input[type="checkbox"]'
        }
    });

    // Handle row selection
    $('#data-table tbody').on('change', 'input[type="checkbox"]', function() {
        var checkedCount = $('#data-table tbody input[type="checkbox"]:checked').length;
        $('#selected-count').text(checkedCount);

        if (checkedCount > 0) {
            $('#bulk-actions-bar').removeClass('d-none');
        } else {
            $('#bulk-actions-bar').addClass('d-none');
        }
    });

    // Handle select all checkbox
    $('#data-table thead').on('change', 'input[type="checkbox"]', function() {
        var isChecked = $(this).prop('checked');
        $('#data-table tbody input[type="checkbox"]').prop('checked', isChecked).trigger('change');
    });

    // Apply filters
    $('#apply-filters').on('click', function() {
        showLoading();
        table.ajax.reload(function() {
            hideLoading();
        });
    });

    // Clear filters
    $('#clear-filters').on('click', function() {
        {% block clear_filters %}{% endblock %}
        showLoading();
        table.ajax.reload(function() {
            hideLoading();
        });
    });

    // Bulk actions
    $('#bulk-delete-btn').on('click', function() {
        if (confirm('{% trans "هل أنت متأكد من حذف العناصر المحددة؟" %}')) {
            performBulkAction('delete');
        }
    });

    $('#bulk-activate-btn').on('click', function() {
        performBulkAction('activate');
    });

    $('#bulk-deactivate-btn').on('click', function() {
        performBulkAction('deactivate');
    });

    $('#bulk-cancel-btn').on('click', function() {
        $('#data-table tbody input[type="checkbox"]').prop('checked', false);
        $('#bulk-actions-bar').addClass('d-none');
    });

    function performBulkAction(action) {
        var selectedIds = [];
        $('#data-table tbody input[type="checkbox"]:checked').each(function() {
            selectedIds.push($(this).val());
        });

        if (selectedIds.length === 0) return;

        showLoading();
        $.ajax({
            url: '{% block bulk_action_url %}{% endblock %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            data: {
                'action': action,
                'ids': selectedIds
            },
            success: function(response) {
                hideLoading();
                if (response.success) {
                    table.ajax.reload();
                    $('#bulk-actions-bar').addClass('d-none');
                    // Show success message
                    location.reload(); // Reload to show messages
                } else {
                    alert(response.message || '{% trans "حدث خطأ" %}');
                }
            },
            error: function() {
                hideLoading();
                alert('{% trans "حدث خطأ في الاتصال" %}');
            }
        });
    }

    {% block custom_js %}{% endblock %}
});
</script>
{% endblock %}