<!-- apps/base_data/templates/base_data/warehouses/create.html -->
{% extends 'base_data/base/form_base.html' %}
{% load i18n widget_tweaks %}

{% block form_icon %}<i class="fas fa-warehouse me-2"></i>{% endblock %}
{% block form_title %}{% trans "إضافة مستودع جديد" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'base_data:warehouse_list' %}">{% trans "المستودعات" %}</a>
</li>
<li class="breadcrumb-item active">{% trans "إضافة جديد" %}</li>
{% endblock %}

{% block back_url %}{% url 'base_data:warehouse_list' %}{% endblock %}
{% block cancel_url %}{% url 'base_data:warehouse_list' %}{% endblock %}

{% block main_fields %}
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-info-circle me-2"></i>{% trans "المعلومات الأساسية" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label {% if form.code.field.required %}required-field{% endif %}">
                        {{ form.code.label }}
                    </label>
                    {{ form.code|add_class:"form-control" }}
                    {% if form.code.errors %}
                        <div class="invalid-feedback d-block">{{ form.code.errors.0 }}</div>
                    {% endif %}
                    <div class="form-text">{% trans "اتركه فارغاً للتوليد التلقائي" %}</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label required-field">{{ form.name.label }}</label>
                    {{ form.name|add_class:"form-control" }}
                    {% if form.name.errors %}
                        <div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.name_en.label }}</label>
                    {{ form.name_en|add_class:"form-control" }}
                    {% if form.name_en.errors %}
                        <div class="invalid-feedback d-block">{{ form.name_en.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label required-field">{{ form.warehouse_type.label }}</label>
                    {{ form.warehouse_type|add_class:"form-select" }}
                    {% if form.warehouse_type.errors %}
                        <div class="invalid-feedback d-block">{{ form.warehouse_type.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-group mb-3">
            <label class="form-label">{{ form.description.label }}</label>
            {{ form.description|add_class:"form-control" }}
            {% if form.description.errors %}
                <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- معلومات الموقع -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-map-marker-alt me-2"></i>{% trans "معلومات الموقع" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="form-group mb-3">
            <label class="form-label">{{ form.address.label }}</label>
            {{ form.address|add_class:"form-control" }}
            {% if form.address.errors %}
                <div class="invalid-feedback d-block">{{ form.address.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.city.label }}</label>
                    {{ form.city|add_class:"form-control" }}
                    {% if form.city.errors %}
                        <div class="invalid-feedback d-block">{{ form.city.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.region.label }}</label>
                    {{ form.region|add_class:"form-control" }}
                    {% if form.region.errors %}
                        <div class="invalid-feedback d-block">{{ form.region.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.phone.label }}</label>
                    {{ form.phone|add_class:"form-control" }}
                    {% if form.phone.errors %}
                        <div class="invalid-feedback d-block">{{ form.phone.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.email.label }}</label>
                    {{ form.email|add_class:"form-control" }}
                    {% if form.email.errors %}
                        <div class="invalid-feedback d-block">{{ form.email.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- الإعدادات المتقدمة -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-cogs me-2"></i>{% trans "الإعدادات المتقدمة" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.capacity.label }}</label>
                    <div class="input-group">
                        {{ form.capacity|add_class:"form-control" }}
                        <span class="input-group-text">{% trans "متر مكعب" %}</span>
                    </div>
                    {% if form.capacity.errors %}
                        <div class="invalid-feedback d-block">{{ form.capacity.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.max_weight.label }}</label>
                    <div class="input-group">
                        {{ form.max_weight|add_class:"form-control" }}
                        <span class="input-group-text">{% trans "كجم" %}</span>
                    </div>
                    {% if form.max_weight.errors %}
                        <div class="invalid-feedback d-block">{{ form.max_weight.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.temperature_min.label }}</label>
                    <div class="input-group">
                        {{ form.temperature_min|add_class:"form-control" }}
                        <span class="input-group-text">°C</span>
                    </div>
                    {% if form.temperature_min.errors %}
                        <div class="invalid-feedback d-block">{{ form.temperature_min.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label class="form-label">{{ form.temperature_max.label }}</label>
                    <div class="input-group">
                        {{ form.temperature_max|add_class:"form-control" }}
                        <span class="input-group-text">°C</span>
                    </div>
                    {% if form.temperature_max.errors %}
                        <div class="invalid-feedback d-block">{{ form.temperature_max.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-check form-switch">
                    {{ form.climate_controlled }}
                    <label class="form-check-label" for="{{ form.climate_controlled.id_for_label }}">
                        {{ form.climate_controlled.label }}
                    </label>
                </div>
                {% if form.climate_controlled.errors %}
                    <div class="invalid-feedback d-block">{{ form.climate_controlled.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <div class="form-check form-switch">
                    {{ form.allow_negative_stock }}
                    <label class="form-check-label" for="{{ form.allow_negative_stock.id_for_label }}">
                        {{ form.allow_negative_stock.label }}
                    </label>
                </div>
                {% if form.allow_negative_stock.errors %}
                    <div class="invalid-feedback d-block">{{ form.allow_negative_stock.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block side_fields %}
<!-- أمين المستودع -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-user-shield me-2"></i>{% trans "أمين المستودع" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="form-group mb-3">
            <label class="form-label">{{ form.keeper.label }}</label>
            {{ form.keeper|add_class:"form-select" }}
            {% if form.keeper.errors %}
                <div class="invalid-feedback d-block">{{ form.keeper.errors.0 }}</div>
            {% endif %}
            <div class="form-text">{% trans "الموظف المسؤول عن المستودع" %}</div>
        </div>

        <div class="form-group mb-3">
            <label class="form-label">{{ form.backup_keeper.label }}</label>
            {{ form.backup_keeper|add_class:"form-select" }}
            {% if form.backup_keeper.errors %}
                <div class="invalid-feedback d-block">{{ form.backup_keeper.errors.0 }}</div>
            {% endif %}
            <div class="form-text">{% trans "أمين احتياطي" %}</div>
        </div>
    </div>
</div>

<!-- إعدادات الأمان -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-shield-alt me-2"></i>{% trans "إعدادات الأمان" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="form-group mb-3">
            <div class="form-check form-switch">
                {{ form.requires_approval }}
                <label class="form-check-label" for="{{ form.requires_approval.id_for_label }}">
                    {{ form.requires_approval.label }}
                </label>
            </div>
            {% if form.requires_approval.errors %}
                <div class="invalid-feedback d-block">{{ form.requires_approval.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group mb-3">
            <div class="form-check form-switch">
                {{ form.track_serial_numbers }}
                <label class="form-check-label" for="{{ form.track_serial_numbers.id_for_label }}">
                    {{ form.track_serial_numbers.label }}
                </label>
            </div>
            {% if form.track_serial_numbers.errors %}
                <div class="invalid-feedback d-block">{{ form.track_serial_numbers.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group mb-3">
            <div class="form-check form-switch">
                {{ form.track_batches }}
                <label class="form-check-label" for="{{ form.track_batches.id_for_label }}">
                    {{ form.track_batches.label }}
                </label>
            </div>
            {% if form.track_batches.errors %}
                <div class="invalid-feedback d-block">{{ form.track_batches.errors.0 }}</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- المحاسبة -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-calculator me-2"></i>{% trans "الحسابات المحاسبية" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="form-group mb-3">
            <label class="form-label">{{ form.inventory_account.label }}</label>
            {{ form.inventory_account|add_class:"form-select" }}
            {% if form.inventory_account.errors %}
                <div class="invalid-feedback d-block">{{ form.inventory_account.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group mb-3">
            <label class="form-label">{{ form.cost_center.label }}</label>
            {{ form.cost_center|add_class:"form-select" }}
            {% if form.cost_center.errors %}
                <div class="invalid-feedback d-block">{{ form.cost_center.errors.0 }}</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ملاحظات -->
<div class="card">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-sticky-note me-2"></i>{% trans "ملاحظات" %}
        </h6>
    </div>
    <div class="card-body">
        <div class="form-group">
            {{ form.notes|add_class:"form-control" }}
            {% if form.notes.errors %}
                <div class="invalid-feedback d-block">{{ form.notes.errors.0 }}</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block form_custom_js %}
$(document).ready(function() {
    // تحديث الحقول حسب نوع المستودع
    $('#id_warehouse_type').change(function() {
        updateWarehouseTypeFields();
    });

    function updateWarehouseTypeFields() {
        let warehouseType = $('#id_warehouse_type').val();

        // إظهار/إخفاء الحقول حسب النوع
        if(warehouseType === 'virtual') {
            // المستودعات الافتراضية لا تحتاج موقع أو أمين
            $('#id_address, #id_city, #id_region, #id_phone').closest('.form-group').hide();
            $('#id_keeper, #id_backup_keeper').closest('.form-group').hide();
            $('#id_capacity, #id_max_weight').closest('.form-group').hide();

            // إضافة تنبيه
            if($('.virtual-warehouse-alert').length === 0) {
                $('.card-body').first().prepend(`
                    <div class="alert alert-info virtual-warehouse-alert">
                        <i class="fas fa-info-circle me-1"></i>
                        {% trans "المستودع الافتراضي لا يحتاج إلى معلومات الموقع أو أمين المستودع" %}
                    </div>
                `);
            }
        } else {
            // إظهار جميع الحقول للمستودعات العادية
            $('#id_address, #id_city, #id_region, #id_phone').closest('.form-group').show();
            $('#id_keeper, #id_backup_keeper').closest('.form-group').show();
            $('#id_capacity, #id_max_weight').closest('.form-group').show();

            // إزالة التنبيه
            $('.virtual-warehouse-alert').remove();
        }
    }

    // تطبيق التحديث عند تحميل الصفحة
    updateWarehouseTypeFields();

    // تحديث قائمة الأمين الاحتياطي لتستبعد الأمين الرئيسي
    $('#id_keeper').change(function() {
        let keeperId = $(this).val();
        let backupKeeper = $('#id_backup_keeper');

        // حفظ القيمة الحالية
        let currentBackupValue = backupKeeper.val();

        // إزالة الأمين الرئيسي من قائمة الأمناء الاحتياطيين
        backupKeeper.find('option').each(function() {
            if($(this).val() === keeperId) {
                $(this).hide();
            } else {
                $(this).show();
            }
        });

        // إذا كان الأمين الاحتياطي نفس الرئيسي، مسح القيمة
        if(currentBackupValue === keeperId) {
            backupKeeper.val('');
        }
    });

    // تحديد درجة الحرارة الدنيا والعليا
    $('#id_temperature_min').change(function() {
        let minTemp = parseFloat($(this).val());
        let maxTemp = parseFloat($('#id_temperature_max').val());

        if(maxTemp && minTemp >= maxTemp) {
            alert('{% trans "درجة الحرارة الدنيا يجب أن تكون أقل من العليا" %}');
            $(this).val('');
        }
    });

    $('#id_temperature_max').change(function() {
        let maxTemp = parseFloat($(this).val());
        let minTemp = parseFloat($('#id_temperature_min').val());

        if(minTemp && maxTemp <= minTemp) {
            alert('{% trans "درجة الحرارة العليا يجب أن تكون أعلى من الدنيا" %}');
            $(this).val('');
        }
    });
});
{% endblock %}