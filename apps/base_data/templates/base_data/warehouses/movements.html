<!-- apps/base_data/templates/base_data/warehouses/movements.html -->
{% extends 'base_data/base/base_data.html' %}
{% load i18n humanize %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'base_data:warehouse_list' %}">{% trans "المستودعات" %}</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'base_data:warehouse_detail' warehouse.pk %}">{{ warehouse.name }}</a>
</li>
<li class="breadcrumb-item active">{% trans "الحركات" %}</li>
{% endblock %}

{% block card_header %}
<div class="card-header bg-white border-bottom">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-exchange-alt me-2"></i>
            {% trans "حركات المستودع" %}: {{ warehouse.name }}
        </h5>
        <div class="btn-group">
            <a href="{% url 'base_data:warehouse_detail' warehouse.pk %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-right me-1"></i>{% trans "رجوع للمستودع" %}
            </a>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-file-export me-1"></i>{% trans "تصدير" %}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="exportMovements('pdf')">
                        <i class="fas fa-file-pdf me-1"></i>PDF</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportMovements('excel')">
                        <i class="fas fa-file-excel me-1"></i>Excel</a></li>
                    <li><a class="dropdown-item" href="#" onclick="printMovements()">
                        <i class="fas fa-print me-1"></i>{% trans "طباعة" %}</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- فلاتر الحركات -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>{% trans "فلتر الحركات" %}
                </h6>
            </div>
            <div class="card-body">
                <form method="get" id="movements-filter">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">{% trans "من تاريخ" %}</label>
                            <input type="date" name="date_from" class="form-control form-control-sm"
                                   value="{{ request.GET.date_from }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">{% trans "إلى تاريخ" %}</label>
                            <input type="date" name="date_to" class="form-control form-control-sm"
                                   value="{{ request.GET.date_to }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">{% trans "الصنف" %}</label>
                            <select name="item" class="form-select form-select-sm">
                                <option value="">{% trans "جميع الأصناف" %}</option>
                                {% for item in warehouse_items %}
                                <option value="{{ item.pk }}" {% if request.GET.item == item.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ item.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">{% trans "نوع الحركة" %}</label>
                            <select name="movement_type" class="form-select form-select-sm">
                                <option value="">{% trans "جميع الأنواع" %}</option>
                                <option value="in" {% if request.GET.movement_type == 'in' %}selected{% endif %}>{% trans "دخول" %}</option>
                                <option value="out" {% if request.GET.movement_type == 'out' %}selected{% endif %}>{% trans "خروج" %}</option>
                                <option value="adjustment" {% if request.GET.movement_type == 'adjustment' %}selected{% endif %}>{% trans "تسوية" %}</option>
                                <option value="transfer" {% if request.GET.movement_type == 'transfer' %}selected{% endif %}>{% trans "نقل" %}</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">{% trans "المرجع" %}</label>
                            <input type="text" name="reference" class="form-control form-control-sm"
                                   placeholder="{% trans 'رقم المرجع' %}" value="{{ request.GET.reference }}">
                        </div>
                        <div class="col-md-2">
                            <label>&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-search me-1"></i>{% trans "فلترة" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- إحصائيات الحركات -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4>{{ stats.total_movements|intcomma }}</h4>
                <small>{% trans "إجمالي الحركات" %}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4>{{ stats.in_movements|intcomma }}</h4>
                <small>{% trans "حركات الدخول" %}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h4>{{ stats.out_movements|intcomma }}</h4>
                <small>{% trans "حركات الخروج" %}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4>{{ stats.adjustment_movements|intcomma }}</h4>
                <small>{% trans "حركات التسوية" %}</small>
            </div>
        </div>
    </div>
</div>

<!-- جدول الحركات -->
{% if movements %}
<div class="card">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>{% trans "سجل الحركات" %}
            <span class="badge bg-info ms-2">{{ movements|length }}</span>
        </h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0" id="movements-table">
                <thead class="table-primary">
                    <tr>
                        <th>{% trans "التاريخ والوقت" %}</th>
                        <th>{% trans "الصنف" %}</th>
                        <th>{% trans "نوع الحركة" %}</th>
                        <th class="text-center">{% trans "الكمية" %}</th>
                        <th class="text-center">{% trans "التكلفة" %}</th>
                        <th class="text-center">{% trans "الرصيد بعد" %}</th>
                        <th>{% trans "المرجع" %}</th>
                        <th>{% trans "المستخدم" %}</th>
                        <th>{% trans "ملاحظات" %}</th>
                        <th width="100">{% trans "إجراءات" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for movement in movements %}
                    <tr>
                        <td>
                            <div>
                                <strong>{{ movement.created_at|date:"d/m/Y" }}</strong>
                                <br><small class="text-muted">{{ movement.created_at|time:"H:i:s" }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if movement.item.image %}
                                    <img src="{{ movement.item.image.url }}" alt="{{ movement.item.name }}"
                                         class="rounded me-2" style="width: 24px; height: 24px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-light border rounded me-2 d-flex align-items-center justify-content-center"
                                         style="width: 24px; height: 24px;">
                                        <i class="fas fa-box text-muted" style="font-size: 10px;"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <a href="{% url 'base_data:item_detail' movement.item.pk %}" class="text-decoration-none">
                                        <strong>{{ movement.item.name }}</strong>
                                    </a>
                                    <br><small class="text-muted">{{ movement.item.code }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if movement.movement_type == 'in' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-arrow-down me-1"></i>{% trans "دخول" %}
                                </span>
                            {% elif movement.movement_type == 'out' %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-arrow-up me-1"></i>{% trans "خروج" %}
                                </span>
                            {% elif movement.movement_type == 'adjustment' %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-edit me-1"></i>{% trans "تسوية" %}
                                </span>
                            {% elif movement.movement_type == 'transfer_in' %}
                                <span class="badge bg-info">
                                    <i class="fas fa-arrow-right me-1"></i>{% trans "نقل وارد" %}
                                </span>
                            {% elif movement.movement_type == 'transfer_out' %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-arrow-left me-1"></i>{% trans "نقل صادر" %}
                                </span>
                            {% else %}
                                <span class="badge bg-light text-dark">{{ movement.get_movement_type_display }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="fw-bold {% if movement.movement_type in 'in,transfer_in,adjustment' and movement.quantity > 0 %}text-success{% elif movement.movement_type in 'out,transfer_out' or movement.quantity < 0 %}text-danger{% else %}text-muted{% endif %}">
                                {% if movement.movement_type in 'out,transfer_out' %}-{% endif %}{{ movement.quantity|floatformat:3 }}
                            </span>
                            <br><small class="text-muted">{{ movement.item.unit.name }}</small>
                        </td>
                        <td class="text-center">
                            {% if movement.unit_cost %}
                                <span class="fw-bold">{{ movement.unit_cost|floatformat:2 }}</span>
                                <br><small class="text-muted">{% trans "ريال" %}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="fw-bold text-primary">{{ movement.balance_after|floatformat:3 }}</span>
                        </td>
                        <td>
                            {% if movement.reference_number %}
                                <code>{{ movement.reference_number }}</code>
                                {% if movement.reference_url %}
                                    <br><a href="{{ movement.reference_url }}" target="_blank" class="btn btn-light btn-sm">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if movement.created_by %}
                                <div>
                                    <i class="fas fa-user me-1"></i>{{ movement.created_by.get_full_name }}
                                </div>
                            {% else %}
                                <span class="text-muted">{% trans "النظام" %}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if movement.notes %}
                                <span class="text-truncate d-inline-block" style="max-width: 150px;"
                                      title="{{ movement.notes }}">{{ movement.notes }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-light btn-sm"
                                        onclick="showMovementDetails({{ movement.pk }})"
                                        title="{% trans 'التفاصيل' %}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if movement.can_reverse and perms.base_data.change_warehouse %}
                                <button type="button" class="btn btn-warning btn-sm"
                                        onclick="reverseMovement({{ movement.pk }})"
                                        title="{% trans 'عكس الحركة' %}">
                                    <i class="fas fa-undo"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- إحصائيات الجدول -->
    <div class="card-footer bg-light">
        <div class="row text-center">
            <div class="col-md-3">
                <strong class="text-success">{{ stats.total_in_quantity|floatformat:2|intcomma }}</strong>
                <br><small class="text-muted">{% trans "إجمالي الوارد" %}</small>
            </div>
            <div class="col-md-3">
                <strong class="text-danger">{{ stats.total_out_quantity|floatformat:2|intcomma }}</strong>
                <br><small class="text-muted">{% trans "إجمالي الصادر" %}</small>
            </div>
            <div class="col-md-3">
                <strong class="text-primary">{{ stats.net_change|floatformat:2|intcomma }}</strong>
                <br><small class="text-muted">{% trans "صافي التغيير" %}</small>
            </div>
            <div class="col-md-3">
                <strong class="text-info">{{ stats.total_value|floatformat:2|intcomma }}</strong>
                <br><small class="text-muted">{% trans "إجمالي القيمة" %}</small>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<nav aria-label="{% trans 'التنقل بين الصفحات' %}" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="fas fa-exchange-alt text-muted" style="font-size: 4rem;"></i>
        <h5 class="text-muted mt-3">{% trans "لا توجد حركات" %}</h5>
        <p class="text-muted">
            {% if request.GET.date_from or request.GET.date_to or request.GET.item or request.GET.movement_type %}
                {% trans "لا توجد حركات تطابق الفلاتر المحددة" %}
            {% else %}
                {% trans "لم يتم تسجيل أي حركات في هذا المستودع بعد" %}
            {% endif %}
        </p>
    </div>
</div>
{% endif %}

<!-- Modal تفاصيل الحركة -->
<div class="modal fade" id="movementDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>{% trans "تفاصيل الحركة" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="movement-details-content">
                <!-- سيتم تحميل المحتوى عبر AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "إغلاق" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // تفعيل DataTables
    $('#movements-table').DataTable({
        order: [[0, 'desc']], // ترتيب حسب التاريخ (الأحدث أولاً)
        pageLength: 100,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/ar.json'
        },
        columnDefs: [
            { targets: [3, 4, 5], className: 'text-center' },
            { targets: [-1], orderable: false }
        ]
    });

    // تعيين تواريخ افتراضية إذا لم تكن محددة
    if(!$('input[name="date_from"]').val() && !$('input[name="date_to"]').val()) {
        let today = new Date();
        let lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

        $('input[name="date_from"]').val(lastMonth.toISOString().split('T')[0]);
        $('input[name="date_to"]').val(today.toISOString().split('T')[0]);
    }
});

function showMovementDetails(movementId) {
    $('#movement-details-content').html('<div class="text-center"><div class="spinner-border" role="status"></div></div>');
    $('#movementDetailsModal').modal('show');

    $.ajax({
        url: '{% url 'base_data:warehouse_movement_detail' warehouse.pk 0 %}'.replace('0', movementId),
        method: 'GET',
        success: function(response) {
            $('#movement-details-content').html(response);
        },
        error: function() {
            $('#movement-details-content').html('<div class="alert alert-danger">{% trans "حدث خطأ في تحميل البيانات" %}</div>');
        }
    });
}

function reverseMovement(movementId) {
    if(confirm('{% trans "هل أنت متأكد من عكس هذه الحركة؟ سيتم إنشاء حركة مضادة." %}')) {
        $.ajax({
            url: '{% url 'base_data:warehouse_movement_reverse' warehouse.pk 0 %}'.replace('0', movementId),
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if(response.success) {
                    location.reload();
                } else {
                    alert(response.message || '{% trans "حدث خطأ" %}');
                }
            },
            error: function() {
                alert('{% trans "حدث خطأ في الاتصال" %}');
            }
        });
    }
}

function exportMovements(format) {
    let url = '{% url 'base_data:warehouse_movements_export' warehouse.pk %}?format=' + format;
    let params = new URLSearchParams(window.location.search);

    for (const [key, value] of params) {
        if(key !== 'page') {
            url += '&' + key + '=' + encodeURIComponent(value);
        }
    }

    window.open(url, '_blank');
}

function printMovements() {
    window.print();
}
</script>

<style>
@media print {
    .btn, .dropdown, .breadcrumb, nav, .card-header .btn-group {
        display: none !important;
    }
    .card {
        border: none !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}