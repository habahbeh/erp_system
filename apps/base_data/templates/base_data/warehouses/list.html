<!-- apps/base_data/templates/base_data/warehouses/list.html -->
{% extends 'base_data/base/list_base.html' %}
{% load i18n %}

{% block list_icon %}<i class="fas fa-warehouse me-2"></i>{% endblock %}
{% block list_title %}{% trans "المستودعات" %}{% endblock %}
{% block total_count %}({{ stats.total }} {% trans "مستودع" %}){% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">{% trans "المستودعات" %}</li>
{% endblock %}

{% block add_url %}{% url 'base_data:warehouse_create' %}{% endblock %}
{% block import_url %}{% url 'base_data:warehouse_import' %}{% endblock %}
{% block export_excel_url %}{% url 'base_data:warehouse_export' %}{% endblock %}
{% block export_csv_url %}{% url 'base_data:warehouse_export' %}{% endblock %}

{% block list_actions %}
{{ block.super }}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown">
        <i class="fas fa-chart-bar me-1"></i>{% trans "التقارير" %}
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="{% url 'base_data:warehouse_inventory_report' %}">
            <i class="fas fa-boxes me-1"></i>{% trans "تقرير المخزون" %}
        </a></li>
        <li><a class="dropdown-item" href="{% url 'base_data:warehouse_movements_report' %}">
            <i class="fas fa-exchange-alt me-1"></i>{% trans "تقرير الحركات" %}
        </a></li>
        <li><a class="dropdown-item" href="{% url 'base_data:warehouse_valuation_report' %}">
            <i class="fas fa-calculator me-1"></i>{% trans "تقرير التقييم" %}
        </a></li>
    </ul>
</div>
{% endblock %}

{% block filters %}
<div class="card-header bg-light border-bottom">
    <form method="get" id="filter-form">
        <div class="row g-3">
            <div class="col-md-3">
                {{ filter_form.search.label_tag }}
                {{ filter_form.search }}
            </div>
            <div class="col-md-2">
                {{ filter_form.warehouse_type.label_tag }}
                {{ filter_form.warehouse_type }}
            </div>
            <div class="col-md-2">
                {{ filter_form.city.label_tag }}
                {{ filter_form.city }}
            </div>
            <div class="col-md-2">
                {{ filter_form.keeper.label_tag }}
                {{ filter_form.keeper }}
            </div>
            <div class="col-md-2">
                {{ filter_form.is_active.label_tag }}
                {{ filter_form.is_active }}
            </div>
            <div class="col-md-1">
                <label>&nbsp;</label>
                <div>
                    <button type="button" class="btn btn-primary btn-sm" id="apply-filters">
                        <i class="fas fa-search"></i>
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" id="clear-filters">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- الصف الثاني من الفلاتر -->
        <div class="row g-3 mt-2">
            <div class="col-md-2">
                {{ filter_form.has_items.label_tag }}
                {{ filter_form.has_items }}
            </div>
            <div class="col-md-2">
                {{ filter_form.low_stock_alert.label_tag }}
                {{ filter_form.low_stock_alert }}
            </div>
            <div class="col-md-2">
                {{ filter_form.capacity_range.label_tag }}
                {{ filter_form.capacity_range }}
            </div>
            <div class="col-md-4">
                <div class="form-check form-switch mt-4">
                    <input class="form-check-input" type="checkbox" id="advanced-filters">
                    <label class="form-check-label" for="advanced-filters">
                        {% trans "فلاتر متقدمة" %}
                    </label>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block table_headers %}
<tr>
    <th width="40">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="select-all">
        </div>
    </th>
    <th>{% trans "الكود" %}</th>
    <th>{% trans "اسم المستودع" %}</th>
    <th>{% trans "النوع" %}</th>
    <th>{% trans "الموقع" %}</th>
    <th>{% trans "أمين المستودع" %}</th>
    <th>{% trans "عدد الأصناف" %}</th>
    <th>{% trans "القيمة الإجمالية" %}</th>
    <th>{% trans "الحالة" %}</th>
    <th width="150">{% trans "الإجراءات" %}</th>
</tr>
{% endblock %}

{% block datatable_url %}{% url 'base_data:warehouse_datatable' %}{% endblock %}

{% block datatable_columns %}
{ data: 'checkbox', orderable: false, searchable: false, render: function(data, type, row) {
    return '<div class="form-check"><input class="form-check-input" type="checkbox" value="' + row.id + '"></div>';
}},
{ data: 'code', name: 'code' },
{ data: 'name', name: 'name', render: function(data, type, row) {
    let html = '<div><strong><a href="{% url 'base_data:warehouse_detail' 0 %}'.replace('0', row.id) + '" class="text-decoration-none">' + data + '</a></strong>';
    if(row.description) {
        html += '<br><small class="text-muted">' + row.description + '</small>';
    }
    html += '</div>';
    return html;
}},
{ data: 'warehouse_type', name: 'warehouse_type', render: function(data, type, row) {
    let badgeClass = 'bg-info';
    let icon = 'fa-warehouse';

    if(data === 'main') {
        badgeClass = 'bg-primary';
        icon = 'fa-building';
    } else if(data === 'branch') {
        badgeClass = 'bg-success';
        icon = 'fa-store';
    } else if(data === 'virtual') {
        badgeClass = 'bg-warning';
        icon = 'fa-cloud';
    }

    return '<span class="badge ' + badgeClass + '"><i class="fas ' + icon + ' me-1"></i>' + data + '</span>';
}},
{ data: 'location', name: 'location', render: function(data, type, row) {
    if(!data) return '-';
    let html = '<div><i class="fas fa-map-marker-alt me-1"></i>' + data + '</div>';
    if(row.city) {
        html += '<small class="text-muted">' + row.city + '</small>';
    }
    return html;
}},
{ data: 'keeper', name: 'keeper', render: function(data, type, row) {
    if(!data) return '<span class="text-muted">{% trans "غير محدد" %}</span>';
    return '<div><i class="fas fa-user me-1"></i>' + data + '</div>';
}},
{ data: 'items_count', name: 'items_count', render: function(data, type, row) {
    return '<span class="badge bg-info">' + parseInt(data || 0).toLocaleString('ar-SA') + '</span>';
}},
{ data: 'total_value', name: 'total_value', render: function(data, type, row) {
    if(!data || data == 0) return '<span class="text-muted">0.00</span>';
    return '<span class="fw-bold text-success">' + parseFloat(data).toLocaleString('ar-SA', {minimumFractionDigits: 2}) + '</span>';
}},
{ data: 'is_active', name: 'is_active', render: function(data, type, row) {
    if(data) {
        return '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>{% trans "نشط" %}</span>';
    } else {
        return '<span class="badge bg-secondary"><i class="fas fa-pause-circle me-1"></i>{% trans "غير نشط" %}</span>';
    }
}},
{ data: 'actions', orderable: false, searchable: false }
{% endblock %}

{% block bulk_action_url %}{% url 'base_data:warehouse_bulk_action' %}{% endblock %}

{% block filter_data %}
// إرسال بيانات الفلاتر
d.search = $('#id_search').val();
d.warehouse_type = $('#id_warehouse_type').val();
d.city = $('#id_city').val();
d.keeper = $('#id_keeper').val();
d.is_active = $('#id_is_active').val();
d.has_items = $('#id_has_items').val();
d.low_stock_alert = $('#id_low_stock_alert').val();
d.capacity_range = $('#id_capacity_range').val();
{% endblock %}

{% block clear_filters %}
$('#filter-form')[0].reset();
$('#id_is_active').val('1'); // إعادة تعيين القيمة الافتراضية
{% endblock %}

{% block custom_js %}
// إحصائيات سريعة
let statsHtml = `
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4>{{ stats.total }}</h4>
                    <small>{% trans "إجمالي المستودعات" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4>{{ stats.active }}</h4>
                    <small>{% trans "النشطة" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4>{{ stats.with_items }}</h4>
                    <small>{% trans "تحتوي على أصناف" %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4>{{ stats.low_stock_alerts }}</h4>
                    <small>{% trans "تنبيهات المخزون" %}</small>
                </div>
            </div>
        </div>
    </div>
`;

$('.card-body').prepend(statsHtml);

// تفعيل/إلغاء تفعيل المستودع
function toggleWarehouseStatus(warehouseId) {
    if(confirm('{% trans "هل أنت متأكد من تغيير حالة هذا المستودع؟" %}')) {
        $.ajax({
            url: '{% url 'base_data:warehouse_toggle_active' 0 %}'.replace('0', warehouseId),
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if(response.success) {
                    table.ajax.reload();
                    showAlert('success', response.message);
                } else {
                    showAlert('danger', response.message);
                }
            }
        });
    }
}

// نقل المخزون بين المستودعات
function showTransferModal(warehouseId) {
    $('#transfer-warehouse-id').val(warehouseId);
    $('#transferModal').modal('show');
    loadWarehouseOptions();
}

// تحميل قائمة المستودعات للنقل
function loadWarehouseOptions() {
    $.ajax({
        url: '{% url 'base_data:warehouse_select' %}',
        method: 'GET',
        success: function(response) {
            let select = $('#transfer-to-warehouse');
            select.empty().append('<option value="">{% trans "اختر المستودع المستهدف" %}</option>');

            $.each(response.results, function(index, warehouse) {
                if(warehouse.id != $('#transfer-warehouse-id').val()) {
                    select.append('<option value="' + warehouse.id + '">' + warehouse.text + '</option>');
                }
            });
        }
    });
}

// عرض التنبيهات
function showAlert(type, message) {
    let alertHtml = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
                   message +
                   '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                   '</div>';
    $('.card-body').prepend(alertHtml);

    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}

// فلاتر متقدمة
$('#advanced-filters').change(function() {
    if($(this).is(':checked')) {
        $('.row:last', '#filter-form').show();
    } else {
        $('.row:last', '#filter-form').hide();
    }
});

// إخفاء الفلاتر المتقدمة افتراضياً
$('.row:last', '#filter-form').hide();

// إضافة modal نقل المخزون
$('body').append(`
    <div class="modal fade" id="transferModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exchange-alt me-2"></i>{% trans "نقل المخزون" %}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transfer-form">
                        <input type="hidden" id="transfer-warehouse-id" name="from_warehouse">

                        <div class="form-group mb-3">
                            <label class="form-label required-field">{% trans "إلى مستودع" %}</label>
                            <select class="form-select" id="transfer-to-warehouse" name="to_warehouse" required>
                                <option value="">{% trans "اختر المستودع" %}</option>
                            </select>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-1"></i>
                            {% trans "سيتم نقل جميع الأصناف الموجودة في المستودع المحدد" %}
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "إلغاء" %}
                    </button>
                    <button type="button" class="btn btn-warning" onclick="confirmTransfer()">
                        <i class="fas fa-exchange-alt me-1"></i>{% trans "نقل المخزون" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
`);

function confirmTransfer() {
    if(!$('#transfer-to-warehouse').val()) {
        alert('{% trans "يرجى اختيار المستودع المستهدف" %}');
        return;
    }

    if(confirm('{% trans "هل أنت متأكد من نقل جميع المخزون؟" %}')) {
        $.ajax({
            url: '{% url 'base_data:warehouse_transfer_inventory' %}',
            method: 'POST',
            data: $('#transfer-form').serialize(),
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if(response.success) {
                    $('#transferModal').modal('hide');
                    table.ajax.reload();
                    showAlert('success', response.message);
                } else {
                    alert(response.message || '{% trans "حدث خطأ" %}');
                }
            }
        });
    }
}
{% endblock %}