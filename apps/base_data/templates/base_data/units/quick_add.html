<!-- apps/base_data/templates/base_data/units/quick_add.html -->
<div class="modal fade" id="unitQuickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>{% trans "إضافة وحدة قياس سريعة" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="unitQuickAddForm" method="post" action="{% url 'base_data:unit_quick_add' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- رسائل الأخطاء -->
                    <div id="quick-add-errors" class="d-none">
                        <div class="alert alert-danger" role="alert">
                            <ul class="mb-0" id="error-list"></ul>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="form-group mb-3">
                                <label for="quick_name" class="form-label required-field">
                                    {% trans "اسم الوحدة" %}
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="quick_name"
                                       name="name"
                                       required
                                       placeholder="{% trans 'مثل: قطعة، كيلوجرام، متر...' %}"
                                       autocomplete="off">
                                <div class="form-text">
                                    {% trans "مثال: قطعة، كيلو، متر، لتر، صندوق..." %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="quick_code" class="form-label">
                                    {% trans "الكود" %}
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="quick_code"
                                       name="code"
                                       placeholder="{% trans 'سيتم توليده تلقائياً' %}"
                                       autocomplete="off">
                                <div class="form-text">
                                    {% trans "اختياري - سيتم التوليد التلقائي" %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="quick_name_en" class="form-label">
                                    {% trans "الاسم الإنجليزي" %}
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="quick_name_en"
                                       name="name_en"
                                       placeholder="{% trans 'مثل: Piece, Kg, Meter...' %}"
                                       autocomplete="off">
                                <div class="form-text">
                                    {% trans "اختياري" %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- وحدات مقترحة -->
                    <div class="card bg-light">
                        <div class="card-header py-2">
                            <h6 class="card-title mb-0 small">
                                <i class="fas fa-lightbulb me-2"></i>{% trans "وحدات شائعة" %}
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <div class="row small">
                                <div class="col-md-6">
                                    <strong>{% trans "الوزن:" %}</strong><br>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1 suggestion-btn" data-name="كيلوجرام" data-code="KG" data-name-en="Kilogram">كيلو</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1 suggestion-btn" data-name="جرام" data-code="GM" data-name-en="Gram">جرام</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1 suggestion-btn" data-name="طن" data-code="TON" data-name-en="Ton">طن</button>
                                </div>
                                <div class="col-md-6">
                                    <strong>{% trans "العدد:" %}</strong><br>
                                    <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1 suggestion-btn" data-name="قطعة" data-code="PC" data-name-en="Piece">قطعة</button>
                                    <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1 suggestion-btn" data-name="حبة" data-code="PCS" data-name-en="Pieces">حبة</button>
                                    <button type="button" class="btn btn-sm btn-outline-success me-1 mb-1 suggestion-btn" data-name="صندوق" data-code="BOX" data-name-en="Box">صندوق</button>
                                </div>
                            </div>
                            <div class="row small mt-2">
                                <div class="col-md-6">
                                    <strong>{% trans "الحجم:" %}</strong><br>
                                    <button type="button" class="btn btn-sm btn-outline-info me-1 mb-1 suggestion-btn" data-name="لتر" data-code="LTR" data-name-en="Liter">لتر</button>
                                    <button type="button" class="btn btn-sm btn-outline-info me-1 mb-1 suggestion-btn" data-name="مليلتر" data-code="ML" data-name-en="Milliliter">مليلتر</button>
                                </div>
                                <div class="col-md-6">
                                    <strong>{% trans "الطول:" %}</strong><br>
                                    <button type="button" class="btn btn-sm btn-outline-warning me-1 mb-1 suggestion-btn" data-name="متر" data-code="M" data-name-en="Meter">متر</button>
                                    <button type="button" class="btn btn-sm btn-outline-warning me-1 mb-1 suggestion-btn" data-name="سنتيمتر" data-code="CM" data-name-en="Centimeter">سم</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>{% trans "إلغاء" %}
                    </button>
                    <button type="submit" class="btn btn-primary" id="quick-add-submit-btn">
                        <i class="fas fa-save me-1"></i>{% trans "حفظ سريع" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // معالج النموذج
    $('#unitQuickAddForm').on('submit', function(e) {
        e.preventDefault();

        var $form = $(this);
        var $submitBtn = $('#quick-add-submit-btn');
        var originalText = $submitBtn.html();

        // إخفاء الأخطاء السابقة
        $('#quick-add-errors').addClass('d-none');

        // تعطيل الزر وإظهار تحميل
        $submitBtn.prop('disabled', true)
                  .html('<i class="fas fa-spinner fa-spin me-1"></i>{% trans "جاري الحفظ..." %}');

        $.ajax({
            url: $form.attr('action'),
            method: 'POST',
            data: $form.serialize(),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    // إظهار رسالة نجاح
                    $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                      response.message +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                      '</div>').prependTo('.card-body');

                    // إغلاق النافذة
                    $('#unitQuickAddModal').modal('hide');

                    // تحديث الصفحة أو إضافة للقائمة
                    if (typeof table !== 'undefined') {
                        table.ajax.reload();
                    } else {
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    }

                    // إعادة تعيين النموذج
                    $form[0].reset();
                } else {
                    // إظهار الأخطاء
                    var errorList = $('#error-list');
                    errorList.empty();

                    if (response.errors) {
                        $.each(response.errors, function(field, errors) {
                            $.each(errors, function(index, error) {
                                errorList.append('<li>' + error + '</li>');
                            });
                        });
                    } else {
                        errorList.append('<li>' + (response.message || '{% trans "حدث خطأ غير معروف" %}') + '</li>');
                    }

                    $('#quick-add-errors').removeClass('d-none');
                }
            },
            error: function(xhr, status, error) {
                var errorList = $('#error-list');
                errorList.empty();
                errorList.append('<li>{% trans "حدث خطأ في الاتصال بالخادم" %}</li>');
                $('#quick-add-errors').removeClass('d-none');
            },
            complete: function() {
                // إعادة تفعيل الزر
                $submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });

    // معالج الوحدات المقترحة
    $('.suggestion-btn').on('click', function() {
        var $this = $(this);
        $('#quick_name').val($this.data('name'));
        $('#quick_code').val($this.data('code'));
        $('#quick_name_en').val($this.data('name-en'));

        // تركيز على زر الحفظ
        $('#quick-add-submit-btn').focus();
    });

    // تركيز تلقائي عند فتح النافذة
    $('#unitQuickAddModal').on('shown.bs.modal', function() {
        $('#quick_name').focus();
    });

    // مسح النموذج عند إغلاق النافذة
    $('#unitQuickAddModal').on('hidden.bs.modal', function() {
        $('#unitQuickAddForm')[0].reset();
        $('#quick-add-errors').addClass('d-none');
    });

    // اقتراح كود من الاسم
    $('#quick_name').on('input', function() {
        if (!$('#quick_code').val()) {
            var code = $(this).val()
                .replace(/\s+/g, '')     // إزالة المسافات
                .substring(0, 6)         // أول 6 أحرف
                .toUpperCase();          // أحرف كبيرة

            $('#quick_code').val(code);
        }
    });
});
</script>