<!-- File: apps/base_data/templates/base_data/components/datatables_config.html -->
{% load i18n %}

<script>
// DataTables Arabic Configuration
$.extend(true, $.fn.dataTable.defaults, {
    language: {
        "sProcessing": "{% trans 'جاري المعالجة...' %}",
        "sLengthMenu": "{% trans 'أظهر' %} _MENU_ {% trans 'مداخل' %}",
        "sZeroRecords": "{% trans 'لم يتم العثور على أية سجلات' %}",
        "sInfo": "{% trans 'إظهار' %} _START_ {% trans 'إلى' %} _END_ {% trans 'من أصل' %} _TOTAL_ {% trans 'مدخل' %}",
        "sInfoEmpty": "{% trans 'يعرض' %} 0 {% trans 'إلى' %} 0 {% trans 'من أصل' %} 0 {% trans 'سجل' %}",
        "sInfoFiltered": "({% trans 'منتقاة من مجموع' %} _MAX_ {% trans 'مُدخل' %})",
        "sInfoPostFix": "",
        "sSearch": "{% trans 'ابحث' %}:",
        "sUrl": "",
        "oPaginate": {
            "sFirst": "{% trans 'الأول' %}",
            "sPrevious": "{% trans 'السابق' %}",
            "sNext": "{% trans 'التالي' %}",
            "sLast": "{% trans 'الأخير' %}"
        },
        "oAria": {
            "sSortAscending": ": {% trans 'تفعيل لترتيب العمود تصاعدياً' %}",
            "sSortDescending": ": {% trans 'تفعيل لترتيب العمود تنازلياً' %}"
        },
        "select": {
            "rows": {
                "_": "{% trans 'تم تحديد' %} %d {% trans 'صفوف' %}",
                "0": "{% trans 'انقر على صف لتحديده' %}",
                "1": "{% trans 'تم تحديد صف واحد' %}"
            }
        },
        "buttons": {
            "copy": "{% trans 'نسخ' %}",
            "excel": "{% trans 'إكسل' %}",
            "pdf": "{% trans 'PDF' %}",
            "print": "{% trans 'طباعة' %}",
            "colvis": "{% trans 'إظهار/إخفاء الأعمدة' %}"
        }
    },

    // Default settings
    processing: true,
    serverSide: true,
    responsive: true,
    stateSave: true,
    stateDuration: 60 * 60 * 24, // 24 hours
    pageLength: 25,
    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "{% trans 'الكل' %}"]],

    // Layout
    dom: '<"row"<"col-md-6"l><"col-md-6"f>>' +
         '<"row"<"col-md-12"tr>>' +
         '<"row"<"col-md-5"i><"col-md-7"p>>',

    // Column defaults
    columnDefs: [
        {
            targets: '_all',
            className: 'text-center align-middle'
        },
        {
            targets: 'no-sort',
            orderable: false,
            searchable: false
        },
        {
            targets: 'date',
            type: 'date'
        },
        {
            targets: 'currency',
            className: 'text-end'
        }
    ],

    // Styling
    initComplete: function(settings, json) {
        // Add custom styling to search input
        $('.dataTables_filter input').addClass('form-control form-control-sm');
        $('.dataTables_length select').addClass('form-select form-select-sm');

        // Hide loading spinner when done
        hideLoading();
    },

    // Error handling
    error: function(xhr, error, thrown) {
        console.error('DataTable Error:', error);
        hideLoading();

        // Show user-friendly error
        if (xhr.status === 403) {
            showAlert('{% trans "ليس لديك صلاحية لعرض هذه البيانات" %}', 'danger');
        } else if (xhr.status === 500) {
            showAlert('{% trans "خطأ في الخادم، يرجى المحاولة مرة أخرى" %}', 'danger');
        } else {
            showAlert('{% trans "خطأ في تحميل البيانات" %}', 'danger');
        }
    }
});

// Global DataTable functions
function initDataTable(selector, options = {}) {
    showLoading();

    const defaultOptions = {
        ajax: {
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCookie('csrftoken')
            },
            error: function(xhr, error, thrown) {
                hideLoading();
                handleAjaxError(xhr, error, thrown);
            }
        }
    };

    const mergedOptions = $.extend(true, {}, defaultOptions, options);
    return $(selector).DataTable(mergedOptions);
}

function refreshDataTable(table) {
    showLoading();
    table.ajax.reload(function() {
        hideLoading();
    }, false);
}

// Bulk actions helper
function handleBulkSelection() {
    const selectedCount = $('.row-checkbox:checked').length;
    const $bulkActions = $('#bulk-actions-bar');

    if (selectedCount > 0) {
        $bulkActions.removeClass('d-none');
        $('#selected-count').text(selectedCount);
    } else {
        $bulkActions.addClass('d-none');
    }
}

// Select all functionality
function initBulkSelection() {
    // Master checkbox
    $('#select-all').on('change', function() {
        const isChecked = $(this).prop('checked');
        $('.row-checkbox').prop('checked', isChecked);
        handleBulkSelection();
    });

    // Individual checkboxes
    $(document).on('change', '.row-checkbox', function() {
        const totalCheckboxes = $('.row-checkbox').length;
        const checkedCheckboxes = $('.row-checkbox:checked').length;

        $('#select-all').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
        $('#select-all').prop('checked', checkedCheckboxes === totalCheckboxes);

        handleBulkSelection();
    });
}

// Initialize on document ready
$(document).ready(function() {
    initBulkSelection();
});
</script>

<!-- DataTable Custom Styles -->
<style>
.dataTables_wrapper {
    direction: rtl;
}

.dataTables_filter {
    text-align: right;
}

.dataTables_filter input {
    margin-right: 0.5em;
    margin-left: 0;
}

.dataTables_length {
    text-align: right;
}

.dataTables_info {
    text-align: right;
}

.dataTables_paginate {
    text-align: left;
}

.table th {
    background-color: var(--bs-primary);
    color: white;
    font-weight: 600;
    border-color: var(--bs-primary);
}

.table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.1);
}

.dataTables_processing {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ddd;
    border-radius: 4px;
    color: #333;
    font-size: 14px;
    padding: 10px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1001;
}

/* Responsive table improvements */
@media (max-width: 768px) {
    .dataTables_length,
    .dataTables_filter {
        text-align: center;
        margin-bottom: 1rem;
    }

    .dataTables_info,
    .dataTables_paginate {
        text-align: center;
        margin-top: 1rem;
    }
}

/* Status badges in tables */
.status-active { color: #198754; }
.status-inactive { color: #dc3545; }
.status-pending { color: #fd7e14; }
.status-draft { color: #6c757d; }
</style>