<!-- File: apps/base_data/templates/base_data/components/messages.html -->
{% load i18n %}

{% if messages %}
<div class="messages-container mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show message-alert" 
         role="alert" 
         data-message-level="{{ message.level }}"
         data-auto-hide="{% if message.tags == 'error' or message.tags == 'danger' %}false{% else %}true{% endif %}">
        
        <!-- Message Icon -->
        <div class="d-flex align-items-start">
            <div class="message-icon me-3 mt-1">
                {% if message.tags == 'error' or message.tags == 'danger' %}
                    <i class="fas fa-exclamation-triangle fa-lg text-danger"></i>
                {% elif message.tags == 'warning' %}
                    <i class="fas fa-exclamation-circle fa-lg text-warning"></i>
                {% elif message.tags == 'success' %}
                    <i class="fas fa-check-circle fa-lg text-success"></i>
                {% elif message.tags == 'info' %}
                    <i class="fas fa-info-circle fa-lg text-info"></i>
                {% else %}
                    <i class="fas fa-bell fa-lg text-primary"></i>
                {% endif %}
            </div>
            
            <!-- Message Content -->
            <div class="message-content flex-grow-1">
                {% if message.tags == 'error' or message.tags == 'danger' %}
                    <h6 class="alert-heading mb-2">
                        <strong>{% trans "خطأ!" %}</strong>
                    </h6>
                {% elif message.tags == 'warning' %}
                    <h6 class="alert-heading mb-2">
                        <strong>{% trans "تنبيه!" %}</strong>
                    </h6>
                {% elif message.tags == 'success' %}
                    <h6 class="alert-heading mb-2">
                        <strong>{% trans "نجح!" %}</strong>
                    </h6>
                {% elif message.tags == 'info' %}
                    <h6 class="alert-heading mb-2">
                        <strong>{% trans "معلومة:" %}</strong>
                    </h6>
                {% endif %}
                
                <div class="message-text">
                    {{ message|safe }}
                </div>
                
                <!-- Message timestamp -->
                <small class="message-timestamp text-muted d-block mt-2">
                    <i class="fas fa-clock me-1"></i>
                    <span class="timestamp">{% now "H:i" %}</span>
                </small>
            </div>
        </div>
        
        <!-- Close Button -->
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{% trans 'إغلاق' %}"></button>
        
        <!-- Progress Bar for Auto-hide -->
        <div class="message-progress">
            <div class="progress-bar-custom"></div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Toast Container (for AJAX messages) -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <!-- Toasts will be added here dynamically -->
</div>

<!-- Message Template for JavaScript -->
<div class="d-none" id="message-template">
    <div class="alert alert-{type} alert-dismissible fade show message-alert" role="alert">
        <div class="d-flex align-items-start">
            <div class="message-icon me-3 mt-1">
                <i class="{icon} fa-lg"></i>
            </div>
            <div class="message-content flex-grow-1">
                <h6 class="alert-heading mb-2">
                    <strong>{title}</strong>
                </h6>
                <div class="message-text">{message}</div>
                <small class="message-timestamp text-muted d-block mt-2">
                    <i class="fas fa-clock me-1"></i>
                    <span class="timestamp">{timestamp}</span>
                </small>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{% trans 'إغلاق' %}"></button>
        <div class="message-progress">
            <div class="progress-bar-custom"></div>
        </div>
    </div>
</div>

<!-- Toast Template -->
<div class="d-none" id="toast-template">
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
        <div class="toast-header">
            <i class="{icon} me-2"></i>
            <strong class="me-auto">{title}</strong>
            <small>{timestamp}</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="{% trans 'إغلاق' %}"></button>
        </div>
        <div class="toast-body">
            {message}
        </div>
    </div>
</div>

{% endif %}

<!-- Messages JavaScript -->
<script>
// Global message functions
window.showAlert = function(message, type = 'info', title = null, autoHide = true) {
    const icons = {
        'success': 'fas fa-check-circle text-success',
        'error': 'fas fa-exclamation-triangle text-danger',
        'danger': 'fas fa-exclamation-triangle text-danger',
        'warning': 'fas fa-exclamation-circle text-warning',
        'info': 'fas fa-info-circle text-info',
        'primary': 'fas fa-bell text-primary'
    };
    
    const titles = {
        'success': '{% trans "نجح!" %}',
        'error': '{% trans "خطأ!" %}',
        'danger': '{% trans "خطأ!" %}',
        'warning': '{% trans "تنبيه!" %}',
        'info': '{% trans "معلومة:" %}',
        'primary': '{% trans "إشعار:" %}'
    };
    
    const now = new Date();
    const timestamp = now.getHours().toString().padStart(2, '0') + ':' + 
                     now.getMinutes().toString().padStart(2, '0');
    
    let template = $('#message-template .alert').clone();
    template.removeClass('alert-{type}').addClass('alert-' + type);
    template.attr('data-auto-hide', autoHide);
    
    // Replace placeholders
    let html = template.prop('outerHTML');
    html = html.replace('{type}', type);
    html = html.replace('{icon}', icons[type] || icons['info']);
    html = html.replace('{title}', title || titles[type] || titles['info']);
    html = html.replace('{message}', message);
    html = html.replace('{timestamp}', timestamp);
    
    // Add to container
    const $alert = $(html);
    $('.messages-container').append($alert);
    
    // Auto-hide
    if (autoHide && type !== 'error' && type !== 'danger') {
        startMessageProgress($alert);
        setTimeout(function() {
            $alert.fadeOut('slow', function() {
                $(this).remove();
            });
        }, 5000);
    }
    
    // Scroll to message
    $('html, body').animate({
        scrollTop: $alert.offset().top - 20
    }, 300);
    
    return $alert;
};

window.showToast = function(message, type = 'info', title = null) {
    const icons = {
        'success': 'fas fa-check-circle text-success',
        'error': 'fas fa-times-circle text-danger',
        'danger': 'fas fa-times-circle text-danger',
        'warning': 'fas fa-exclamation-triangle text-warning',
        'info': 'fas fa-info-circle text-info',
        'primary': 'fas fa-bell text-primary'
    };
    
    const titles = {
        'success': '{% trans "نجح" %}',
        'error': '{% trans "خطأ" %}',
        'danger': '{% trans "خطأ" %}',
        'warning': '{% trans "تنبيه" %}',
        'info': '{% trans "معلومة" %}',
        'primary': '{% trans "إشعار" %}'
    };
    
    const now = new Date();
    const timestamp = now.getHours().toString().padStart(2, '0') + ':' + 
                     now.getMinutes().toString().padStart(2, '0');
    
    let html = $('#toast-template .toast').prop('outerHTML');
    html = html.replace('{icon}', icons[type] || icons['info']);
    html = html.replace('{title}', title || titles[type] || titles['info']);
    html = html.replace('{message}', message);
    html = html.replace('{timestamp}', timestamp);
    
    const $toast = $(html);
    $toast.addClass('border-' + type);
    
    $('.toast-container').append($toast);
    
    const toast = new bootstrap.Toast($toast[0]);
    toast.show();
    
    // Remove from DOM after hide
    $toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
    
    return $toast;
};

// Message progress bar animation
function startMessageProgress($alert) {
    if (!$alert.data('auto-hide')) return;
    
    const $progressBar = $alert.find('.progress-bar-custom');
    $progressBar.css('width', '100%');
    
    setTimeout(function() {
        $progressBar.css({
            'width': '0%',
            'transition': 'width 5s linear'
        });
    }, 100);
}

// Handle AJAX messages
function handleAjaxMessage(response) {
    if (response.message) {
        const type = response.success ? 'success' : 'error';
        showAlert(response.message, type);
    }
    
    if (response.messages && Array.isArray(response.messages)) {
        response.messages.forEach(function(msg) {
            showAlert(msg.message || msg, msg.type || 'info', msg.title);
        });
    }
}

// Initialize messages
$(document).ready(function() {
    // Start progress bars for existing messages
    $('.message-alert[data-auto-hide="true"]').each(function() {
        const $alert = $(this);
        startMessageProgress($alert);
        
        // Auto-hide after 8 seconds
        setTimeout(function() {
            $alert.fadeOut('slow', function() {
                $(this).remove();
            });
        }, 8000);
    });
    
    // Handle message interactions
    $('.message-alert').on('click', function(e) {
        if (!$(e.target).hasClass('btn-close')) {
            // Mark as read or expand details
            $(this).addClass('message-read');
        }
    });
    
    // Global AJAX error handler
    $(document).ajaxError(function(event, xhr, settings) {
        if (xhr.status === 403) {
            showAlert('{% trans "ليس لديك صلاحية لتنفيذ هذا الإجراء" %}', 'error');
        } else if (xhr.status === 404) {
            showAlert('{% trans "المورد المطلوب غير موجود" %}', 'error');
        } else if (xhr.status === 500) {
            showAlert('{% trans "خطأ في الخادم، يرجى المحاولة مرة أخرى" %}', 'error');
        } else if (xhr.status === 0) {
            showAlert('{% trans "فشل في الاتصال بالخادم" %}', 'error');
        }
    });
    
    // Global AJAX success handler
    $(document).ajaxSuccess(function(event, xhr, settings) {
        try {
            const response = JSON.parse(xhr.responseText);
            handleAjaxMessage(response);
        } catch (e) {
            // Not JSON response, ignore
        }
    });
});

// Keyboard shortcuts
$(document).on('keydown', function(e) {
    // Escape to close all messages
    if (e.key === 'Escape') {
        $('.message-alert, .toast').fadeOut('fast');
    }
});
</script>

<!-- Messages Styles -->
<style>
.messages-container {
    position: relative;
    z-index: 1050;
}

.message-alert {
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
    background: white;
}

.message-alert::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 4px;
    height: 100%;
    background: currentColor;
}

.alert-success::before { background: #198754; }
.alert-danger::before { background: #dc3545; }
.alert-warning::before { background: #fd7e14; }
.alert-info::before { background: #0dcaf0; }
.alert-primary::before { background: #0d6efd; }

.message-icon {
    flex-shrink: 0;
}

.message-content {
    line-height: 1.5;
}

.alert-heading {
    color: inherit;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.message-text {
    color: inherit;
    font-size: 0.95rem;
}

.message-timestamp {
    font-size: 0.8rem;
    opacity: 0.8;
}

.message-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
}

.progress-bar-custom {
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    width: 0%;
    transition: width 0.3s ease;
}

.message-read {
    opacity: 0.9;
}

/* Toast customizations */
.toast {
    min-width: 300px;
    direction: rtl;
}

.toast-header {
    background: rgba(var(--bs-primary-rgb), 0.1);
    border-bottom: 1px solid rgba(var(--bs-primary-rgb), 0.2);
}

.toast.border-success .toast-header { background: rgba(25, 135, 84, 0.1); }
.toast.border-danger .toast-header { background: rgba(220, 53, 69, 0.1); }
.toast.border-warning .toast-header { background: rgba(255, 193, 7, 0.1); }
.toast.border-info .toast-header { background: rgba(13, 202, 240, 0.1); }

/* Animation effects */
@keyframes slideInDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideOutUp {
    from {
        transform: translateY(0);
        opacity: 1;
    }
    to {
        transform: translateY(-100%);
        opacity: 0;
    }
}

.message-alert {
    animation: slideInDown 0.3s ease-out;
}

.message-alert.fade:not(.show) {
    animation: slideOutUp 0.3s ease-in;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .message-alert {
        margin-left: -15px;
        margin-right: -15px;
        border-radius: 0;
    }
    
    .toast-container {
        left: 1rem;
        right: 1rem;
        top: 1rem !important;
    }
    
    .toast {
        min-width: 100%;
    }
    
    .alert-heading {
        font-size: 1rem;
    }
    
    .message-content {
        font-size: 0.9rem;
    }
}

/* Dark mode support (if needed) */
@media (prefers-color-scheme: dark) {
    .message-alert {
        background: #1a1a1a;
        color: #fff;
    }
    
    .message-alert .alert-heading {
        color: #fff;
    }
    
    .toast {
        background: #1a1a1a;
        color: #fff;
    }
    
    .toast-header {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border-color: rgba(255, 255, 255, 0.2);
    }
}

/* Accessibility improvements */
.message-alert:focus-within {
    outline: 2px solid var(--bs-primary);
    outline-offset: 2px;
}

.btn-close:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .message-alert {
        border: 2px solid currentColor;
    }
    
    .message-progress {
        background: currentColor;
    }
    
    .progress-bar-custom {
        background: var(--bs-body-bg);
    }
}
</style>