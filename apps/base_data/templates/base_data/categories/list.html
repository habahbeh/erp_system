<!-- File: apps/base_data/templates/base_data/categories/list.html -->
{% extends 'base_data/base/list_base.html' %}
{% load i18n %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">{% trans "التصنيفات" %}</li>
{% endblock %}

{% block list_icon %}<i class="fas fa-sitemap me-2"></i>{% endblock %}
{% block list_title %}{% trans "تصنيفات الأصناف" %}{% endblock %}
{% block total_count %}({{ total_count }} {% trans "تصنيف" %}){% endblock %}

{% block add_url %}{% url 'base_data:category_create' %}{% endblock %}
{% block import_url %}{% url 'base_data:import_errors' %}{% endblock %}
{% block export_excel_url %}{% url 'base_data:category_list' %}{% endblock %}
{% block export_csv_url %}{% url 'base_data:category_list' %}{% endblock %}

{% block filters %}
<div class="card-header bg-light border-bottom">
    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">{% trans "البحث" %}</label>
            <input type="text" class="form-control" id="search-input" placeholder="{% trans 'ابحث في التصنيفات...' %}">
        </div>
        <div class="col-md-3">
            <label class="form-label">{% trans "المستوى" %}</label>
            <select class="form-select" id="level-filter">
                <option value="">{% trans "جميع المستويات" %}</option>
                <option value="1">{% trans "المستوى الأول" %}</option>
                <option value="2">{% trans "المستوى الثاني" %}</option>
                <option value="3">{% trans "المستوى الثالث" %}</option>
                <option value="4">{% trans "المستوى الرابع" %}</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">{% trans "الحالة" %}</label>
            <select class="form-select" id="status-filter">
                <option value="">{% trans "جميع الحالات" %}</option>
                <option value="1">{% trans "نشط" %}</option>
                <option value="0">{% trans "غير نشط" %}</option>
            </select>
        </div>
        <div class="col-md-3">
            <div class="btn-group w-100">
                <button type="button" class="btn btn-outline-primary" id="apply-filters">
                    <i class="fas fa-filter me-1"></i>{% trans "تطبيق" %}
                </button>
                <button type="button" class="btn btn-outline-secondary" id="clear-filters">
                    <i class="fas fa-times me-1"></i>{% trans "إلغاء" %}
                </button>
                <a href="{% url 'base_data:category_tree' %}" class="btn btn-outline-info">
                    <i class="fas fa-sitemap me-1"></i>{% trans "عرض شجري" %}
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block list_actions %}
{{ block.super }}
<a href="{% url 'base_data:category_tree' %}" class="btn btn-info btn-sm">
    <i class="fas fa-sitemap me-1"></i>{% trans "عرض شجري" %}
</a>
<button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#quickAddModal">
    <i class="fas fa-plus-circle me-1"></i>{% trans "إضافة سريعة" %}
</button>
{% endblock %}

{% block table_headers %}
<tr>
    <th width="40">
        <input type="checkbox" class="form-check-input" id="select-all">
    </th>
    <th>{% trans "الرمز" %}</th>
    <th>{% trans "الاسم" %}</th>
    <th>{% trans "التصنيف الأب" %}</th>
    <th>{% trans "المستوى" %}</th>
    <th>{% trans "عدد الأصناف" %}</th>
    <th>{% trans "الحالة" %}</th>
    <th width="150">{% trans "الإجراءات" %}</th>
</tr>
{% endblock %}

{% block datatable_url %}{% url 'base_data:category_list' %}{% endblock %}
{% block bulk_action_url %}{% url 'base_data:category_list' %}{% endblock %}

{% block datatable_columns %}
{
    data: 'select',
    name: 'select',
    orderable: false,
    searchable: false,
    render: function(data, type, row) {
        return '<input type="checkbox" class="form-check-input row-select" value="' + row.id + '">';
    }
},
{
    data: 'code',
    name: 'code',
    render: function(data, type, row) {
        return '<code class="bg-light p-1 rounded">' + data + '</code>';
    }
},
{
    data: 'name',
    name: 'name',
    render: function(data, type, row) {
        var html = '';
        for (var i = 1; i < row.level; i++) {
            html += '<span class="text-muted me-2">└</span>';
        }
        html += '<a href="' + row.detail_url + '" class="text-decoration-none">';
        html += '<strong>' + data + '</strong></a>';
        if (row.name_en) {
            html += '<br><small class="text-muted">' + row.name_en + '</small>';
        }
        return html;
    }
},
{
    data: 'parent_name',
    name: 'parent__name',
    render: function(data, type, row) {
        if (data) {
            return '<span class="badge bg-secondary">' + data + '</span>';
        }
        return '<span class="text-muted">—</span>';
    }
},
{
    data: 'level',
    name: 'level',
    render: function(data, type, row) {
        var colors = ['', 'primary', 'success', 'warning', 'info'];
        return '<span class="badge bg-' + colors[data] + '">المستوى ' + data + '</span>';
    }
},
{
    data: 'items_count',
    name: 'items_count',
    render: function(data, type, row) {
        if (data > 0) {
            return '<span class="badge bg-primary rounded-pill">' + data + ' صنف</span>';
        }
        return '<span class="text-muted">0</span>';
    }
},
{
    data: 'is_active',
    name: 'is_active',
    render: function(data, type, row) {
        if (data) {
            return '<span class="badge bg-success"><i class="fas fa-check me-1"></i>نشط</span>';
        }
        return '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>غير نشط</span>';
    }
},
{
    data: 'actions',
    name: 'actions',
    orderable: false,
    searchable: false,
    render: function(data, type, row) {
        var html = '<div class="btn-group btn-group-sm">';
        html += '<a href="' + row.detail_url + '" class="btn btn-outline-primary btn-sm" title="التفاصيل">';
        html += '<i class="fas fa-eye"></i></a>';
        html += '<a href="' + row.edit_url + '" class="btn btn-outline-warning btn-sm" title="تعديل">';
        html += '<i class="fas fa-edit"></i></a>';
        html += '<a href="' + row.delete_url + '" class="btn btn-outline-danger btn-sm" title="حذف">';
        html += '<i class="fas fa-trash"></i></a>';
        html += '</div>';
        return html;
    }
}
{% endblock %}

{% block filter_data %}
var filters = {
    'search': $('#search-input').val(),
    'level': $('#level-filter').val(),
    'is_active': $('#status-filter').val()
};
$.extend(d, filters);
{% endblock %}

{% block clear_filters %}
$('#search-input').val('');
$('#level-filter').val('');
$('#status-filter').val('');
{% endblock %}

{% block content %}
{{ block.super }}

<!-- Quick Add Modal -->
<div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>{% trans "إضافة تصنيف سريع" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="quick-add-form">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label required-field">{% trans "اسم التصنيف" %}</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "التصنيف الأب" %}</label>
                        <select class="form-select" name="parent">
                            <option value="">{% trans "تصنيف رئيسي" %}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "إلغاء" %}
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i>{% trans "حفظ" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
// Quick add form handler
$('#quick-add-form').on('submit', function(e) {
    e.preventDefault();
    showLoading();

    $.ajax({
        url: '{% url "base_data:category_quick_add" %}',
        method: 'POST',
        data: $(this).serialize(),
        success: function(response) {
            hideLoading();
            if (response.success) {
                $('#quickAddModal').modal('hide');
                table.ajax.reload();
                // Show success message
                location.reload();
            } else {
                alert(response.message || 'حدث خطأ');
            }
        },
        error: function() {
            hideLoading();
            alert('حدث خطأ في الاتصال');
        }
    });
});

// Load parent categories for quick add
$('#quickAddModal').on('show.bs.modal', function() {
    $.get('{% url "base_data:category_select" %}', function(data) {
        var $select = $('#quickAddModal select[name="parent"]');
        $select.find('option:not(:first)').remove();
        $.each(data, function(i, category) {
            $select.append('<option value="' + category.id + '">' + category.text + '</option>');
        });
    });
});
{% endblock %}