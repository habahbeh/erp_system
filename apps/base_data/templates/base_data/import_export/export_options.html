<!-- File: apps/base_data/templates/base_data/import_export/export_options.html -->
{% extends 'base_data/base/base_data.html' %}
{% load i18n widget_tweaks %}

{% block title %}{% trans "خيارات التصدير" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'base_data:reports_index' %}">{% trans "البيانات الأساسية" %}</a>
</li>
<li class="breadcrumb-item active">{% trans "تصدير البيانات" %}</li>
{% endblock %}

{% block page_icon %}<i class="fas fa-file-export me-2"></i>{% endblock %}
{% block page_title %}{% trans "تصدير البيانات" %}{% endblock %}

{% block header_actions %}
<a href="{% url 'base_data:reports_index' %}" class="btn btn-secondary btn-sm">
    <i class="fas fa-arrow-right me-1"></i>{% trans "رجوع" %}
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Export Form -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-download me-2"></i>{% trans "اختر البيانات للتصدير" %}
                </h5>
            </div>
            <form method="post" id="export-form">
                {% csrf_token %}
                <div class="card-body">

                    <!-- Export Type Selection -->
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <label class="form-label required-field">{% trans "نوع البيانات" %}</label>
                            <div class="row">
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card export-type-card" data-export-type="items">
                                        <div class="card-body text-center">
                                            <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
                                            <h6 class="card-title">{% trans "الأصناف" %}</h6>
                                            <small class="text-muted">{{ items_count }} {% trans "صنف" %}</small>
                                            <input type="radio" name="export_type" value="items"
                                                   class="form-check-input d-none export-type-radio">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card export-type-card" data-export-type="partners">
                                        <div class="card-body text-center">
                                            <i class="fas fa-users fa-2x text-success mb-2"></i>
                                            <h6 class="card-title">{% trans "الشركاء" %}</h6>
                                            <small class="text-muted">{{ partners_count }} {% trans "شريك" %}</small>
                                            <input type="radio" name="export_type" value="partners"
                                                   class="form-check-input d-none export-type-radio">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card export-type-card" data-export-type="warehouses">
                                        <div class="card-body text-center">
                                            <i class="fas fa-warehouse fa-2x text-warning mb-2"></i>
                                            <h6 class="card-title">{% trans "المستودعات" %}</h6>
                                            <small class="text-muted">{{ warehouses_count }} {% trans "مستودع" %}</small>
                                            <input type="radio" name="export_type" value="warehouses"
                                                   class="form-check-input d-none export-type-radio">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card export-type-card" data-export-type="categories">
                                        <div class="card-body text-center">
                                            <i class="fas fa-sitemap fa-2x text-info mb-2"></i>
                                            <h6 class="card-title">{% trans "التصنيفات" %}</h6>
                                            <small class="text-muted">{{ categories_count }} {% trans "تصنيف" %}</small>
                                            <input type="radio" name="export_type" value="categories"
                                                   class="form-check-input d-none export-type-radio">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card export-type-card" data-export-type="stock">
                                        <div class="card-body text-center">
                                            <i class="fas fa-chart-bar fa-2x text-danger mb-2"></i>
                                            <h6 class="card-title">{% trans "تقرير المخزون" %}</h6>
                                            <small class="text-muted">{% trans "جميع المستودعات" %}</small>
                                            <input type="radio" name="export_type" value="stock"
                                                   class="form-check-input d-none export-type-radio">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card export-type-card" data-export-type="custom">
                                        <div class="card-body text-center">
                                            <i class="fas fa-cog fa-2x text-secondary mb-2"></i>
                                            <h6 class="card-title">{% trans "مخصص" %}</h6>
                                            <small class="text-muted">{% trans "خيارات متقدمة" %}</small>
                                            <input type="radio" name="export_type" value="custom"
                                                   class="form-check-input d-none export-type-radio">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Export Format -->
                    <div class="row" id="format-section" style="display: none;">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{% trans "صيغة الملف" %}</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="format" value="xlsx" id="format-xlsx" checked>
                                <label class="btn btn-outline-primary" for="format-xlsx">
                                    <i class="fas fa-file-excel me-1"></i>Excel
                                </label>

                                <input type="radio" class="btn-check" name="format" value="csv" id="format-csv">
                                <label class="btn btn-outline-primary" for="format-csv">
                                    <i class="fas fa-file-csv me-1"></i>CSV
                                </label>

                                <input type="radio" class="btn-check" name="format" value="pdf" id="format-pdf">
                                <label class="btn btn-outline-primary" for="format-pdf">
                                    <i class="fas fa-file-pdf me-1"></i>PDF
                                </label>

                                <input type="radio" class="btn-check" name="format" value="json" id="format-json">
                                <label class="btn btn-outline-primary" for="format-json">
                                    <i class="fas fa-code me-1"></i>JSON
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">{% trans "نطاق البيانات" %}</label>
                            <select name="date_range" class="form-select" id="date-range">
                                <option value="all">{% trans "جميع البيانات" %}</option>
                                <option value="today">{% trans "اليوم" %}</option>
                                <option value="yesterday">{% trans "أمس" %}</option>
                                <option value="week">{% trans "هذا الأسبوع" %}</option>
                                <option value="month">{% trans "هذا الشهر" %}</option>
                                <option value="quarter">{% trans "هذا الربع" %}</option>
                                <option value="year">{% trans "هذا العام" %}</option>
                                <option value="custom">{% trans "نطاق مخصص" %}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Custom Date Range -->
                    <div class="row" id="custom-dates" style="display: none;">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{% trans "من تاريخ" %}</label>
                            <input type="date" name="custom_date_from" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{% trans "إلى تاريخ" %}</label>
                            <input type="date" name="custom_date_to" class="form-control">
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="accordion" id="advanced-options" style="display: none;">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapse-advanced">
                                    <i class="fas fa-cogs me-2"></i>{% trans "خيارات متقدمة" %}
                                </button>
                            </h2>
                            <div id="collapse-advanced" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox"
                                                       name="include_inactive" id="include-inactive">
                                                <label class="form-check-label" for="include-inactive">
                                                    {% trans "تضمين البيانات غير النشطة" %}
                                                </label>
                                            </div>

                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox"
                                                       name="compress_file" id="compress-file">
                                                <label class="form-check-label" for="compress-file">
                                                    {% trans "ضغط الملف (ZIP)" %}
                                                </label>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="form-check form-switch mb-3" id="include-images-option">
                                                <input class="form-check-input" type="checkbox"
                                                       name="include_images" id="include-images">
                                                <label class="form-check-label" for="include-images">
                                                    {% trans "تضمين الصور" %}
                                                </label>
                                            </div>

                                            <div class="form-check form-switch mb-3" id="include-relations-option">
                                                <input class="form-check-input" type="checkbox"
                                                       name="include_relations" id="include-relations" checked>
                                                <label class="form-check-label" for="include-relations">
                                                    {% trans "تضمين العلاقات" %}
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Field Selection -->
                                    <div class="mt-4" id="field-selection">
                                        <h6>{% trans "اختيار الحقول" %}</h6>
                                        <div class="row" id="fields-container">
                                            <!-- Fields will be populated via JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="history.back()">
                            <i class="fas fa-times me-1"></i>{% trans "إلغاء" %}
                        </button>
                        <button type="submit" class="btn btn-primary" id="export-btn" disabled>
                            <i class="fas fa-download me-1"></i>{% trans "تصدير البيانات" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Help Card -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>{% trans "معلومات التصدير" %}
                </h6>
            </div>
            <div class="card-body">
                <div class="export-info d-none" id="items-info">
                    <h6>{% trans "تصدير الأصناف" %}</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>{% trans "معلومات الأصناف الأساسية" %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% trans "الأسعار والضرائب" %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% trans "التصنيفات ووحدات القياس" %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% trans "معدلات التحويل" %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% trans "أرصدة المخزون" %}</li>
                    </ul>
                </div>

                <div class="export-info d-none" id="partners-info">
                    <h6>{% trans "تصدير الشركاء" %}</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>{% trans "بيانات العملاء والموردين" %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% trans "معلومات الاتصال" %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% trans "البيانات الضريبية" %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% trans "حدود الائتمان" %}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{% trans "مندوبي المبيعات" %}</li>
                    </ul>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>{% trans "تنبيه:" %}</strong>
                    {% trans "تأكد من صلاحياتك قبل تصدير البيانات الحساسة" %}
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>{% trans "نصيحة:" %}</strong>
                    {% trans "استخدم صيغة Excel للحصول على أفضل النتائج" %}
                </div>
            </div>
        </div>

        <!-- Recent Exports -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>{% trans "آخر العمليات" %}
                </h6>
            </div>
            <div class="card-body">
                {% if recent_exports %}
                    <div class="list-group list-group-flush">
                        {% for export in recent_exports %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-file-{{ export.format }} me-2"></i>
                                    <small>{{ export.name }}</small>
                                </div>
                                <small class="text-muted">{{ export.created_at|date:"d/m H:i" }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center">{% trans "لا توجد عمليات تصدير سابقة" %}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progress-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-download me-2"></i>{% trans "جاري التصدير..." %}
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{% trans "جاري المعالجة..." %}</span>
                    </div>
                </div>
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                </div>
                <p class="text-muted mb-0" id="progress-message">{% trans "بدء العملية..." %}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.export-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e9ecef;
}

.export-type-card:hover {
    border-color: var(--bs-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.export-type-card.selected {
    border-color: var(--bs-primary);
    background-color: rgba(13, 110, 253, 0.1);
}

.export-type-card.selected .card-body {
    color: var(--bs-primary);
}

.export-info {
    font-size: 0.9rem;
}

.export-info h6 {
    color: var(--bs-primary);
    margin-bottom: 1rem;
}

.export-info ul li {
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.btn-check:checked + .btn {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Export type selection
    $('.export-type-card').on('click', function() {
        const exportType = $(this).data('export-type');

        // Update UI
        $('.export-type-card').removeClass('selected');
        $(this).addClass('selected');

        // Update radio button
        $('.export-type-radio').prop('checked', false);
        $(this).find('.export-type-radio').prop('checked', true);

        // Show/hide sections
        $('#format-section, #advanced-options').show();
        $('#export-btn').prop('disabled', false);

        // Show relevant info
        $('.export-info').addClass('d-none');
        $('#' + exportType + '-info').removeClass('d-none');

        // Show/hide specific options
        if (exportType === 'items') {
            $('#include-images-option').show();
        } else {
            $('#include-images-option').hide();
        }

        // Load field options
        loadFieldOptions(exportType);
    });

    // Date range change
    $('#date-range').on('change', function() {
        const value = $(this).val();
        if (value === 'custom') {
            $('#custom-dates').show();
        } else {
            $('#custom-dates').hide();
        }
    });

    // Form submission
    $('#export-form').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const exportType = $('input[name="export_type"]:checked').val();

        if (!exportType) {
            showAlert('{% trans "يرجى اختيار نوع البيانات للتصدير" %}', 'warning');
            return;
        }

        // Show progress modal
        $('#progress-modal').modal('show');
        updateProgress(10, '{% trans "جاري تحضير البيانات..." %}');

        // Start export
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        updateProgress(percentComplete, '{% trans "جاري الرفع..." %}');
                    }
                }, false);

                xhr.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        updateProgress(percentComplete, '{% trans "جاري التنزيل..." %}');
                    }
                }, false);

                return xhr;
            },
            success: function(response, status, xhr) {
                updateProgress(100, '{% trans "تم التصدير بنجاح!" %}');

                // Handle file download
                if (xhr.getResponseHeader('Content-Disposition')) {
                    const blob = new Blob([response]);
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);

                    link.href = url;
                    link.download = getFilenameFromHeader(xhr.getResponseHeader('Content-Disposition'));
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }

                setTimeout(function() {
                    $('#progress-modal').modal('hide');
                    showAlert('{% trans "تم تصدير البيانات بنجاح" %}', 'success');
                }, 1000);
            },
            error: function(xhr) {
                $('#progress-modal').modal('hide');

                if (xhr.status === 403) {
                    showAlert('{% trans "ليس لديك صلاحية لتصدير هذه البيانات" %}', 'error');
                } else {
                    showAlert('{% trans "خطأ في تصدير البيانات" %}', 'error');
                }
            }
        });
    });

    function loadFieldOptions(exportType) {
        // This would load available fields for the selected export type
        // For now, we'll use static options
        const fields = getFieldsForType(exportType);
        const container = $('#fields-container');
        container.empty();

        fields.forEach(function(field) {
            const col = $('<div class="col-md-6 mb-2">');
            const checkbox = $(`
                <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                           name="selected_fields" value="${field.name}"
                           id="field-${field.name}" checked>
                    <label class="form-check-label" for="field-${field.name}">
                        ${field.label}
                    </label>
                </div>
            `);
            col.append(checkbox);
            container.append(col);
        });
    }

    function getFieldsForType(exportType) {
        const fieldSets = {
            'items': [
                {name: 'code', label: '{% trans "الكود" %}'},
                {name: 'name', label: '{% trans "الاسم" %}'},
                {name: 'category', label: '{% trans "التصنيف" %}'},
                {name: 'unit', label: '{% trans "وحدة القياس" %}'},
                {name: 'purchase_price', label: '{% trans "سعر الشراء" %}'},
                {name: 'sale_price', label: '{% trans "سعر البيع" %}'},
                {name: 'tax_rate', label: '{% trans "نسبة الضريبة" %}'},
                {name: 'manufacturer', label: '{% trans "الشركة المصنعة" %}'}
            ],
            'partners': [
                {name: 'code', label: '{% trans "الكود" %}'},
                {name: 'name', label: '{% trans "الاسم" %}'},
                {name: 'partner_type', label: '{% trans "نوع الشريك" %}'},
                {name: 'phone', label: '{% trans "الهاتف" %}'},
                {name: 'email', label: '{% trans "البريد الإلكتروني" %}'},
                {name: 'city', label: '{% trans "المدينة" %}'},
                {name: 'tax_number', label: '{% trans "الرقم الضريبي" %}'},
                {name: 'credit_limit', label: '{% trans "حد الائتمان" %}'}
            ]
        };

        return fieldSets[exportType] || [];
    }

    function updateProgress(percentage, message) {
        $('#progress-modal .progress-bar').css('width', percentage + '%').text(Math.round(percentage) + '%');
        $('#progress-message').text(message);
    }

    function getFilenameFromHeader(disposition) {
        const regex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
        const matches = regex.exec(disposition);
        if (matches != null && matches[1]) {
            return matches[1].replace(/['"]/g, '');
        }
        return 'export.xlsx';
    }
});
</script>
{% endblock %}