<!-- File: apps/base_data/templates/base_data/import_export/import_form.html -->
{% extends 'base_data/base/base_data.html' %}
{% load i18n widget_tweaks %}

{% block title %}{% trans "استيراد البيانات" %}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'base_data:reports_index' %}">{% trans "البيانات الأساسية" %}</a>
</li>
<li class="breadcrumb-item active">{% trans "استيراد البيانات" %}</li>
{% endblock %}

{% block page_icon %}<i class="fas fa-file-import me-2"></i>{% endblock %}
{% block page_title %}{% trans "استيراد البيانات" %}{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown">
        <i class="fas fa-download me-1"></i>{% trans "تحميل عينات" %}
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
        <li>
            <a class="dropdown-item" href="{% url 'base_data:download_sample' 'items' %}">
                <i class="fas fa-boxes me-2"></i>{% trans "عينة الأصناف" %}
            </a>
        </li>
        <li>
            <a class="dropdown-item" href="{% url 'base_data:download_sample' 'partners' %}">
                <i class="fas fa-users me-2"></i>{% trans "عينة الشركاء" %}
            </a>
        </li>
        <li>
            <a class="dropdown-item" href="{% url 'base_data:download_sample' 'warehouses' %}">
                <i class="fas fa-warehouse me-2"></i>{% trans "عينة المستودعات" %}
            </a>
        </li>
        <li>
            <a class="dropdown-item" href="{% url 'base_data:download_sample' 'categories' %}">
                <i class="fas fa-sitemap me-2"></i>{% trans "عينة التصنيفات" %}
            </a>
        </li>
    </ul>
    <a href="{% url 'base_data:import_errors' %}" class="btn btn-warning btn-sm">
        <i class="fas fa-exclamation-triangle me-1"></i>{% trans "عرض الأخطاء" %}
    </a>
    <a href="{% url 'base_data:reports_index' %}" class="btn btn-secondary btn-sm">
        <i class="fas fa-arrow-right me-1"></i>{% trans "رجوع" %}
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Import Form -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>{% trans "رفع ملف البيانات" %}
                </h5>
            </div>
            <form method="post" enctype="multipart/form-data" id="import-form">
                {% csrf_token %}
                <div class="card-body">

                    <!-- Import Type Selection -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <label class="form-label required-field">{% trans "نوع البيانات" %}</label>
                            <div class="row">
                                <div class="col-md-6 col-lg-3 mb-3">
                                    <div class="card import-type-card" data-import-type="items">
                                        <div class="card-body text-center">
                                            <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
                                            <h6 class="card-title">{% trans "الأصناف" %}</h6>
                                            <small class="text-muted">{% trans "استيراد المواد والمنتجات" %}</small>
                                            <input type="radio" name="import_type" value="items"
                                                   class="form-check-input d-none import-type-radio">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3 mb-3">
                                    <div class="card import-type-card" data-import-type="partners">
                                        <div class="card-body text-center">
                                            <i class="fas fa-users fa-2x text-success mb-2"></i>
                                            <h6 class="card-title">{% trans "الشركاء" %}</h6>
                                            <small class="text-muted">{% trans "العملاء والموردين" %}</small>
                                            <input type="radio" name="import_type" value="partners"
                                                   class="form-check-input d-none import-type-radio">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3 mb-3">
                                    <div class="card import-type-card" data-import-type="warehouses">
                                        <div class="card-body text-center">
                                            <i class="fas fa-warehouse fa-2x text-warning mb-2"></i>
                                            <h6 class="card-title">{% trans "المستودعات" %}</h6>
                                            <small class="text-muted">{% trans "المخازن والمستودعات" %}</small>
                                            <input type="radio" name="import_type" value="warehouses"
                                                   class="form-check-input d-none import-type-radio">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3 mb-3">
                                    <div class="card import-type-card" data-import-type="categories">
                                        <div class="card-body text-center">
                                            <i class="fas fa-sitemap fa-2x text-info mb-2"></i>
                                            <h6 class="card-title">{% trans "التصنيفات" %}</h6>
                                            <small class="text-muted">{% trans "تصنيفات الأصناف" %}</small>
                                            <input type="radio" name="import_type" value="categories"
                                                   class="form-check-input d-none import-type-radio">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Section -->
                    <div class="import-section d-none" id="file-section">
                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <label class="form-label required-field">{% trans "ملف البيانات" %}</label>
                                <div class="file-upload-area" id="file-drop-zone">
                                    <input type="file" name="file" id="file-input" class="d-none"
                                           accept=".xlsx,.xls,.csv" required>
                                    <div class="file-upload-content text-center py-5">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <h5>{% trans "اسحب الملف هنا أو انقر للاختيار" %}</h5>
                                        <p class="text-muted">{% trans "يدعم ملفات Excel (.xlsx, .xls) و CSV" %}</p>
                                        <button type="button" class="btn btn-outline-primary" onclick="$('#file-input').click()">
                                            <i class="fas fa-folder-open me-1"></i>{% trans "اختيار ملف" %}
                                        </button>
                                    </div>
                                    <div class="file-upload-success d-none">
                                        <div class="d-flex align-items-center justify-content-between p-3">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-file-excel fa-2x text-success me-3"></i>
                                                <div>
                                                    <h6 class="mb-0" id="selected-filename"></h6>
                                                    <small class="text-muted" id="selected-filesize"></small>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearSelectedFile()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Import Options -->
                    <div class="import-section d-none" id="options-section">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox"
                                           name="update_existing" id="update-existing" checked>
                                    <label class="form-check-label" for="update-existing">
                                        <strong>{% trans "تحديث البيانات الموجودة" %}</strong>
                                        <br><small class="text-muted">{% trans "تحديث السجلات بنفس الكود" %}</small>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox"
                                           name="validate_data" id="validate-data" checked>
                                    <label class="form-check-label" for="validate-data">
                                        <strong>{% trans "التحقق من البيانات" %}</strong>
                                        <br><small class="text-muted">{% trans "فحص صحة البيانات قبل الاستيراد" %}</small>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6" id="skip-errors-option">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox"
                                           name="skip_errors" id="skip-errors">
                                    <label class="form-check-label" for="skip-errors">
                                        <strong>{% trans "تجاهل الأخطاء" %}</strong>
                                        <br><small class="text-muted">{% trans "متابعة مع وجود أخطاء" %}</small>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6" id="import-images-option" style="display: none;">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox"
                                           name="import_images" id="import-images">
                                    <label class="form-check-label" for="import-images">
                                        <strong>{% trans "استيراد الصور" %}</strong>
                                        <br><small class="text-muted">{% trans "من مجلد منفصل" %}</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Mapping Options -->
                        <div class="accordion mt-4" id="mapping-accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#mapping-collapse">
                                        <i class="fas fa-map me-2"></i>{% trans "ربط الأعمدة (متقدم)" %}
                                    </button>
                                </h2>
                                <div id="mapping-collapse" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <div id="column-mapping">
                                            <p class="text-muted">{% trans "سيتم عرض أعمدة الملف هنا بعد الرفع لربطها بحقول النظام" %}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="import-section d-none" id="preview-section">
                        <h6><i class="fas fa-eye me-2"></i>{% trans "معاينة البيانات" %}</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered" id="preview-table">
                                <thead class="table-dark">
                                    <!-- Headers will be populated -->
                                </thead>
                                <tbody>
                                    <!-- Data will be populated -->
                                </tbody>
                            </table>
                        </div>
                        <div class="text-muted small mt-2">
                            <i class="fas fa-info-circle me-1"></i>
                            {% trans "يتم عرض أول 5 صفوف فقط للمعاينة" %}
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-undo me-1"></i>{% trans "إعادة تعيين" %}
                        </button>

                        <div>
                            <button type="button" class="btn btn-info me-2" id="preview-btn" style="display: none;">
                                <i class="fas fa-eye me-1"></i>{% trans "معاينة" %}
                            </button>
                            <button type="submit" class="btn btn-success" id="import-btn" disabled>
                                <i class="fas fa-upload me-1"></i>{% trans "بدء الاستيراد" %}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Import Guidelines -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>{% trans "إرشادات الاستيراد" %}
                </h6>
            </div>
            <div class="card-body">
                <div class="import-guidelines d-none" id="items-guidelines">
                    <h6>{% trans "استيراد الأصناف" %}</h6>
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            {% trans "تأكد من وجود التصنيفات ووحدات القياس مسبقاً" %}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            {% trans "الأعمدة الإجبارية: الكود، الاسم، التصنيف، الوحدة" %}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            {% trans "يمكن ترك سعر الشراء والبيع فارغين" %}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            {% trans "لا تكرر الأكواد أو الباركودات" %}
                        </li>
                    </ul>
                </div>

                <div class="import-guidelines d-none" id="partners-guidelines">
                    <h6>{% trans "استيراد الشركاء" %}</h6>
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            {% trans "الأعمدة الإجبارية: الكود، الاسم، نوع الشريك" %}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            {% trans "نوع الشريك: customer, supplier, both" %}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            {% trans "يمكن ترك معلومات الاتصال فارغة" %}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            {% trans "تأكد من صحة عناوين البريد الإلكتروني" %}
                        </li>
                    </ul>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>{% trans "استخدم ملفات العينة كقالب لضمان التوافق" %}</small>
                </div>
            </div>
        </div>

        <!-- Supported Formats -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-file me-2"></i>{% trans "الصيغ المدعومة" %}
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <i class="fas fa-file-excel fa-2x text-success mb-2"></i>
                        <div class="small">
                            <strong>Excel</strong><br>
                            <span class="text-muted">.xlsx, .xls</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <i class="fas fa-file-csv fa-2x text-primary mb-2"></i>
                        <div class="small">
                            <strong>CSV</strong><br>
                            <span class="text-muted">.csv</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <i class="fas fa-file-archive fa-2x text-warning mb-2"></i>
                        <div class="small">
                            <strong>ZIP</strong><br>
                            <span class="text-muted">{% trans "مع الصور" %}</span>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="small text-muted">
                    <strong>{% trans "حد الحجم:" %}</strong> 10 ميجابايت<br>
                    <strong>{% trans "أقصى عدد صفوف:" %}</strong> 10,000 صف
                </div>
            </div>
        </div>

        <!-- Recent Imports -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>{% trans "آخر العمليات" %}
                </h6>
            </div>
            <div class="card-body">
                {% if recent_imports %}
                    <div class="list-group list-group-flush">
                        {% for import in recent_imports %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-{{ import.type }} me-2"></i>
                                    <div>
                                        <small class="fw-bold">{{ import.filename }}</small>
                                        <div class="text-muted small">{{ import.type_display }}</div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    {% if import.status == 'completed' %}
                                        <span class="badge bg-success">{% trans "مكتمل" %}</span>
                                    {% elif import.status == 'failed' %}
                                        <span class="badge bg-danger">{% trans "فشل" %}</span>
                                    {% else %}
                                        <span class="badge bg-warning">{% trans "معالجة" %}</span>
                                    {% endif %}
                                    <div class="text-muted small">{{ import.created_at|date:"d/m H:i" }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center mb-0">{% trans "لا توجد عمليات استيراد سابقة" %}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="import-progress-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>{% trans "جاري الاستيراد..." %}
                </h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">{% trans "جاري المعالجة..." %}</span>
                    </div>
                </div>

                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">
                        <span class="progress-text">0%</span>
                    </div>
                </div>

                <div class="row text-center">
                    <div class="col-3">
                        <div class="border-end">
                            <h5 class="text-success mb-1" id="success-count">0</h5>
                            <small class="text-muted">{% trans "نجح" %}</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border-end">
                            <h5 class="text-danger mb-1" id="error-count">0</h5>
                            <small class="text-muted">{% trans "فشل" %}</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border-end">
                            <h5 class="text-warning mb-1" id="warning-count">0</h5>
                            <small class="text-muted">{% trans "تحذير" %}</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <h5 class="text-info mb-1" id="total-count">0</h5>
                        <small class="text-muted">{% trans "إجمالي" %}</small>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <p class="text-muted mb-0" id="import-status-message">{% trans "بدء العملية..." %}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.import-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e9ecef;
    height: 100%;
}

.import-type-card:hover {
    border-color: var(--bs-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.import-type-card.selected {
    border-color: var(--bs-primary);
    background-color: rgba(13, 110, 253, 0.1);
}

.import-type-card.selected .card-body {
    color: var(--bs-primary);
}

.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: var(--bs-primary);
    background-color: rgba(13, 110, 253, 0.02);
}

.file-upload-area.dragover {
    border-color: var(--bs-success);
    background-color: rgba(25, 135, 84, 0.1);
}

.import-guidelines h6 {
    color: var(--bs-primary);
    margin-bottom: 1rem;
}

#preview-table {
    font-size: 0.8rem;
}

#preview-table th,
#preview-table td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
}

.progress-text {
    font-weight: 600;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let selectedImportType = null;
    let selectedFile = null;

    // Import type selection
    $('.import-type-card').on('click', function() {
        selectedImportType = $(this).data('import-type');

        // Update UI
        $('.import-type-card').removeClass('selected');
        $(this).addClass('selected');

        // Update radio button
        $('.import-type-radio').prop('checked', false);
        $(this).find('.import-type-radio').prop('checked', true);

        // Show relevant sections
        $('#file-section').removeClass('d-none');

        // Show relevant guidelines
        $('.import-guidelines').addClass('d-none');
        $('#' + selectedImportType + '-guidelines').removeClass('d-none');

        // Show/hide specific options
        if (selectedImportType === 'items') {
            $('#import-images-option').show();
        } else {
            $('#import-images-option').hide();
        }

        updateImportButton();
    });

    // File upload handling
    $('#file-input').on('change', handleFileSelect);

    // Drag and drop
    const dropZone = $('#file-drop-zone')[0];

    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });

    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            $('#file-input')[0].files = files;
            handleFileSelect({target: {files: files}});
        }
    });

    // Click to upload
    $('#file-drop-zone').on('click', function() {
        if (!$(this).find('.file-upload-success').is(':visible')) {
            $('#file-input').click();
        }
    });

    // Preview button
    $('#preview-btn').on('click', function() {
        if (selectedFile) {
            previewFile();
        }
    });

    // Form submission
    $('#import-form').on('submit', function(e) {
        e.preventDefault();

        if (!selectedImportType || !selectedFile) {
            showAlert('{% trans "يرجى اختيار نوع البيانات والملف" %}', 'warning');
            return;
        }

        startImport();
    });

    function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        const file = files[0];
        selectedFile = file;

        // Validate file
        if (!validateFile(file)) return;

        // Update UI
        $('#selected-filename').text(file.name);
        $('#selected-filesize').text(formatFileSize(file.size));

        $('.file-upload-content').addClass('d-none');
        $('.file-upload-success').removeClass('d-none');

        // Show options and preview
        $('#options-section').removeClass('d-none');
        $('#preview-btn').show();

        updateImportButton();
    }

    function validateFile(file) {
        const allowedTypes = [
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/vnd.ms-excel',
            'text/csv',
            'application/zip'
        ];

        if (!allowedTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv|zip)$/i)) {
            showAlert('{% trans "نوع الملف غير مدعوم. يجب أن يكون Excel أو CSV" %}', 'error');
            return false;
        }

        if (file.size > 10 * 1024 * 1024) {
            showAlert('{% trans "حجم الملف كبير جداً. يجب أن يكون أقل من 10MB" %}', 'error');
            return false;
        }

        return true;
    }

    function previewFile() {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('import_type', selectedImportType);
        formData.append('action', 'preview');
        formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());

        showLoading('{% trans "جاري تحليل الملف..." %}');

        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                hideLoading();
                if (response.success) {
                    displayPreview(response.preview_data);
                    $('#preview-section').removeClass('d-none');
                } else {
                    showAlert(response.message || '{% trans "خطأ في تحليل الملف" %}', 'error');
                }
            },
            error: function() {
                hideLoading();
                showAlert('{% trans "خطأ في تحليل الملف" %}', 'error');
            }
        });
    }

    function displayPreview(data) {
        const table = $('#preview-table');
        const thead = table.find('thead');
        const tbody = table.find('tbody');

        // Clear previous content
        thead.empty();
        tbody.empty();

        if (data.headers && data.headers.length > 0) {
            const headerRow = $('<tr>');
            data.headers.forEach(function(header) {
                headerRow.append('<th>' + header + '</th>');
            });
            thead.append(headerRow);
        }

        if (data.rows && data.rows.length > 0) {
            data.rows.forEach(function(row) {
                const dataRow = $('<tr>');
                row.forEach(function(cell) {
                    dataRow.append('<td>' + (cell || '') + '</td>');
                });
                tbody.append(dataRow);
            });
        }
    }

    function startImport() {
        const formData = new FormData($('#import-form')[0]);

        // Show progress modal
        $('#import-progress-modal').modal('show');

        // Start import
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        updateProgress(Math.min(percentComplete, 90), '{% trans "جاري الرفع..." %}');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                if (response.success) {
                    updateProgress(100, '{% trans "تم الاستيراد بنجاح!" %}');
                    updateCounts(response.summary || {});

                    setTimeout(function() {
                        $('#import-progress-modal').modal('hide');

                        if (response.has_errors) {
                            showAlert('{% trans "تم الاستيراد مع وجود بعض الأخطاء" %}', 'warning');
                            setTimeout(() => window.location.href = '{% url "base_data:import_errors" %}', 1000);
                        } else {
                            showAlert('{% trans "تم الاستيراد بنجاح" %}', 'success');
                            setTimeout(() => location.reload(), 2000);
                        }
                    }, 2000);
                } else {
                    $('#import-progress-modal').modal('hide');
                    showAlert(response.message || '{% trans "خطأ في الاستيراد" %}', 'error');
                }
            },
            error: function(xhr) {
                $('#import-progress-modal').modal('hide');

                if (xhr.status === 413) {
                    showAlert('{% trans "الملف كبير جداً" %}', 'error');
                } else if (xhr.status === 403) {
                    showAlert('{% trans "ليس لديك صلاحية للاستيراد" %}', 'error');
                } else {
                    showAlert('{% trans "خطأ في الاستيراد" %}', 'error');
                }
            }
        });
    }

    function updateProgress(percentage, message) {
        const progressBar = $('.progress-bar');
        progressBar.css('width', percentage + '%');
        progressBar.find('.progress-text').text(percentage + '%');
        $('#import-status-message').text(message);
    }

    function updateCounts(summary) {
        $('#success-count').text(summary.successful_count || 0);
        $('#error-count').text(summary.error_count || 0);
        $('#warning-count').text(summary.warning_count || 0);
        $('#total-count').text(summary.total_count || 0);
    }

    function updateImportButton() {
        const canImport = selectedImportType && selectedFile;
        $('#import-btn').prop('disabled', !canImport);
    }

    function clearSelectedFile() {
        selectedFile = null;
        $('#file-input').val('');
        $('.file-upload-content').removeClass('d-none');
        $('.file-upload-success').addClass('d-none');
        $('#options-section, #preview-section').addClass('d-none');
        $('#preview-btn').hide();
        updateImportButton();
    }

    function resetForm() {
        selectedImportType = null;
        selectedFile = null;
        $('.import-type-card').removeClass('selected');
        $('.import-type-radio').prop('checked', false);
        $('.import-section').addClass('d-none');
        clearSelectedFile();
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
});
</script>
{% endblock %}