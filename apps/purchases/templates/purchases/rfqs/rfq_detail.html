{# apps/purchases/templates/purchases/rfqs/rfq_detail.html #}
{% extends 'base/base.html' %}
{% load i18n %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                    </li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-file-alt text-primary"></i>
            {% trans "طلب عرض سعر رقم" %} {{ rfq.number }}
        </h2>
        <div>
            {% if rfq.status == 'draft' %}
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#sendToSuppliersModal">
                    <i class="fas fa-paper-plane"></i> {% trans "إرسال للموردين" %}
                </button>
                <a href="{% url 'purchases:rfq_update' rfq.pk %}" class="btn btn-warning">
                    <i class="fas fa-edit"></i> {% trans "تعديل" %}
                </a>
                <a href="{% url 'purchases:rfq_delete' rfq.pk %}" class="btn btn-danger">
                    <i class="fas fa-trash"></i> {% trans "حذف" %}
                </a>
            {% elif rfq.status == 'sent' %}
                <a href="{% url 'purchases:mark_rfq_as_evaluating' rfq.pk %}" class="btn btn-primary">
                    <i class="fas fa-clipboard-check"></i> {% trans "البدء بالتقييم" %}
                </a>
                <a href="{% url 'purchases:cancel_rfq' rfq.pk %}" class="btn btn-danger">
                    <i class="fas fa-ban"></i> {% trans "إلغاء" %}
                </a>
            {% elif rfq.status == 'evaluating' %}
                <a href="{% url 'purchases:quotation_list' %}?rfq={{ rfq.id }}" class="btn btn-info">
                    <i class="fas fa-file-invoice"></i> {% trans "عرض العروض المستلمة" %}
                </a>
            {% endif %}

            <a href="{% url 'purchases:rfq_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> {% trans "رجوع" %}
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-md-8">
            <!-- RFQ Details Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "تفاصيل طلب عرض السعر" %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>{% trans "رقم الطلب:" %}</strong> {{ rfq.number }}</p>
                            <p><strong>{% trans "الموضوع:" %}</strong> {{ rfq.subject }}</p>
                            <p><strong>{% trans "التاريخ:" %}</strong> {{ rfq.date|date:"Y-m-d" }}</p>
                            <p><strong>{% trans "الشركة:" %}</strong> {{ rfq.company.name }}</p>
                            {% if rfq.currency %}
                            <p><strong>{% trans "العملة:" %}</strong> {{ rfq.currency.name }} ({{ rfq.currency.code }})</p>
                            {% endif %}
                            {% if rfq.purchase_request %}
                            <p><strong>{% trans "طلب الشراء:" %}</strong>
                                <a href="{% url 'purchases:request_detail' rfq.purchase_request.pk %}">
                                    {{ rfq.purchase_request.number }}
                                </a>
                            </p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <p><strong>{% trans "آخر موعد للتقديم:" %}</strong>
                                {% if rfq.submission_deadline %}
                                    {{ rfq.submission_deadline|date:"Y-m-d" }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </p>
                            <p><strong>{% trans "تاريخ التسليم المطلوب:" %}</strong>
                                {% if rfq.required_delivery_date %}
                                    {{ rfq.required_delivery_date|date:"Y-m-d" }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </p>
                            {% if rfq.warranty_required %}
                            <p><strong>{% trans "الضمان مطلوب:" %}</strong>
                                <span class="badge bg-success">نعم</span>
                                {% if rfq.warranty_period_months %}
                                    ({{ rfq.warranty_period_months }} شهر)
                                {% endif %}
                            </p>
                            {% endif %}
                            <p><strong>{% trans "الحالة:" %}</strong>
                                {% if rfq.status == 'draft' %}
                                    <span class="badge bg-secondary fs-6">{% trans "مسودة" %}</span>
                                {% elif rfq.status == 'sent' %}
                                    <span class="badge bg-info fs-6">{% trans "مرسل" %}</span>
                                {% elif rfq.status == 'evaluating' %}
                                    <span class="badge bg-warning fs-6">{% trans "قيد التقييم" %}</span>
                                {% elif rfq.status == 'awarded' %}
                                    <span class="badge bg-success fs-6">{% trans "تم الترسية" %}</span>
                                {% elif rfq.status == 'cancelled' %}
                                    <span class="badge bg-danger fs-6">{% trans "ملغي" %}</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    {% if rfq.description %}
                    <hr>
                    <p><strong>{% trans "الوصف:" %}</strong></p>
                    <p>{{ rfq.description|linebreaks }}</p>
                    {% endif %}

                    {% if rfq.payment_terms or rfq.delivery_terms %}
                    <hr>
                    <div class="row">
                        {% if rfq.payment_terms %}
                        <div class="col-md-6">
                            <p><strong>{% trans "شروط الدفع:" %}</strong></p>
                            <p class="text-muted">{{ rfq.payment_terms }}</p>
                        </div>
                        {% endif %}
                        {% if rfq.delivery_terms %}
                        <div class="col-md-6">
                            <p><strong>{% trans "شروط التسليم:" %}</strong></p>
                            <p class="text-muted">{{ rfq.delivery_terms }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if rfq.notes %}
                    <hr>
                    <p><strong>{% trans "ملاحظات:" %}</strong></p>
                    <p class="mb-0">{{ rfq.notes|linebreaks }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Suppliers Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-users"></i> {% trans "الموردين المستهدفين" %}</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>{% trans "اسم المورد" %}</th>
                                    <th>{% trans "البريد الإلكتروني" %}</th>
                                    <th>{% trans "الهاتف" %}</th>
                                    <th>{% trans "المدينة" %}</th>
                                    <th class="text-center">{% trans "حالة العرض" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for quotation in rfq.quotations.all %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <strong>{{ quotation.supplier.name }}</strong>
                                        {% if quotation.supplier.tax_number %}
                                            <br><small class="text-muted">{{ quotation.supplier.tax_number }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ quotation.supplier.email|default:"-" }}</td>
                                    <td>{{ quotation.supplier.phone|default:"-" }}</td>
                                    <td>{{ quotation.supplier.city|default:"-" }}</td>
                                    <td class="text-center">
                                        {% if quotation.status == 'draft' %}
                                            <span class="badge bg-secondary">مسودة</span>
                                        {% elif quotation.status == 'submitted' %}
                                            <span class="badge bg-info">مقدم</span>
                                        {% elif quotation.status == 'accepted' %}
                                            <span class="badge bg-success">مقبول</span>
                                        {% elif quotation.status == 'rejected' %}
                                            <span class="badge bg-danger">مرفوض</span>
                                        {% else %}
                                            <span class="badge bg-warning">قيد المراجعة</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-3">{% trans "لم يتم إرسال الطلب للموردين بعد" %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Items Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> {% trans "الأصناف المطلوبة" %}</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>{% trans "الصنف" %}</th>
                                    <th>{% trans "الوصف" %}</th>
                                    <th>{% trans "المواصفات" %}</th>
                                    <th class="text-center">{% trans "الكمية" %}</th>
                                    <th class="text-center">{% trans "الوحدة" %}</th>
                                    <th class="text-end">{% trans "السعر التقديري" %}</th>
                                    <th class="text-end">{% trans "الإجمالي" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in rfq.items.all %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        {% if item.item %}
                                            <strong>{{ item.item.code }}</strong> - {{ item.item.name }}
                                        {% else %}
                                            <strong>{{ item.item_description }}</strong>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.item_description|default:"-" }}</td>
                                    <td>{{ item.specifications|default:"-" }}</td>
                                    <td class="text-center"><strong>{{ item.quantity|floatformat:3 }}</strong></td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">
                                            {% if item.unit %}
                                                {{ item.unit }}
                                            {% elif item.item %}
                                                {{ item.item.base_uom.name|default:"-" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        {% if item.estimated_price %}
                                            {{ item.estimated_price|floatformat:3 }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if item.estimated_price %}
                                            {{ item.line_total|floatformat:3 }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-3">{% trans "لا توجد أصناف" %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            {% if rfq.items.exists and rfq.items.all.0.estimated_price %}
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="7" class="text-end"><strong>{% trans "التكلفة التقديرية الإجمالية:" %}</strong></td>
                                    <td class="text-end">
                                        <strong>
                                            {% widthratio rfq.items.all.0.estimated_price 1 1 as temp %}
                                            {{ rfq.total_estimated|default:"0.000"|floatformat:3 }}
                                        </strong>
                                    </td>
                                </tr>
                            </tfoot>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>

            <!-- Received Quotations Section -->
            {% if rfq.status == 'evaluating' or rfq.status == 'awarded' %}
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-file-invoice"></i> {% trans "العروض المستلمة" %}</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>{% trans "المورد" %}</th>
                                    <th>{% trans "رقم العرض" %}</th>
                                    <th>{% trans "التاريخ" %}</th>
                                    <th class="text-end">{% trans "المبلغ" %}</th>
                                    <th class="text-center">{% trans "التقييم" %}</th>
                                    <th class="text-center">{% trans "الحالة" %}</th>
                                    <th>{% trans "الإجراء" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for quotation in rfq.quotations.all %}
                                    {% if quotation.status != 'draft' %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td><strong>{{ quotation.supplier.name }}</strong></td>
                                        <td>{{ quotation.number }}</td>
                                        <td>{{ quotation.date|date:"Y-m-d" }}</td>
                                        <td class="text-end">
                                            {% if quotation.total_amount %}
                                                {{ quotation.total_amount|floatformat:3 }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if quotation.score %}
                                                <span class="badge bg-info">{{ quotation.score }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if quotation.status == 'submitted' %}
                                                <span class="badge bg-info">مقدم</span>
                                            {% elif quotation.status == 'accepted' %}
                                                <span class="badge bg-success">مقبول</span>
                                            {% elif quotation.status == 'rejected' %}
                                                <span class="badge bg-danger">مرفوض</span>
                                            {% else %}
                                                <span class="badge bg-warning">قيد المراجعة</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'purchases:quotation_detail' quotation.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i> عرض
                                            </a>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-3">{% trans "لا توجد عروض مستلمة" %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Summary Card -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-calculator"></i> {% trans "ملخص الطلب" %}</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>{% trans "عدد الأصناف:" %}</span>
                        <strong>{{ rfq.items.count }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>{% trans "إجمالي الكمية:" %}</span>
                        <strong>
                            {% widthratio 1 1 1 as temp %}
                            {{ rfq.total_quantity|default:"0"|floatformat:3 }}
                        </strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>{% trans "عدد الموردين المستهدفين:" %}</span>
                        <strong>{{ rfq.quotations.count }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>{% trans "العروض المستلمة:" %}</span>
                        <strong class="text-success">
                            {{ rfq.quotations.exclude|default:"0" }}
                        </strong>
                    </div>
                    {% if rfq.submission_deadline %}
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>{% trans "الموعد النهائي:" %}</span>
                        <span class="text-danger"><strong>{{ rfq.submission_deadline|date:"Y-m-d" }}</strong></span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Status Card -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "معلومات الحالة" %}</h6>
                </div>
                <div class="card-body">
                    <p><strong>{% trans "الحالة:" %}</strong>
                        {% if rfq.status == 'draft' %}
                            <span class="badge bg-secondary">{% trans "مسودة" %}</span>
                        {% elif rfq.status == 'sent' %}
                            <span class="badge bg-info">{% trans "مرسل" %}</span>
                        {% elif rfq.status == 'evaluating' %}
                            <span class="badge bg-warning">{% trans "قيد التقييم" %}</span>
                        {% elif rfq.status == 'awarded' %}
                            <span class="badge bg-success">{% trans "تم الترسية" %}</span>
                        {% elif rfq.status == 'cancelled' %}
                            <span class="badge bg-danger">{% trans "ملغي" %}</span>
                        {% endif %}
                    </p>
                    {% if rfq.purchase_request %}
                    <p><strong>{% trans "طلب الشراء:" %}</strong>
                        <a href="{% url 'purchases:request_detail' rfq.purchase_request.pk %}">
                            {{ rfq.purchase_request.number }}
                        </a>
                    </p>
                    {% endif %}
                    <hr>
                    <small class="text-muted d-block">
                        <i class="fas fa-user me-1"></i>
                        أنشئ بواسطة: {{ rfq.created_by.get_full_name }}
                    </small>
                    <small class="text-muted d-block">
                        <i class="fas fa-calendar-alt me-1"></i>
                        تاريخ الإنشاء: {{ rfq.created_at|date:"Y-m-d H:i" }}
                    </small>
                    {% if rfq.updated_at != rfq.created_at %}
                    <small class="text-muted d-block">
                        <i class="fas fa-edit me-1"></i>
                        آخر تحديث: {{ rfq.updated_at|date:"Y-m-d H:i" }}
                    </small>
                    {% endif %}
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-cog"></i> {% trans "الإجراءات" %}</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                            <i class="fas fa-print me-1"></i> {% trans "طباعة" %}
                        </button>

                        {% if rfq.status == 'draft' %}
                        <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#sendToSuppliersModal">
                            <i class="fas fa-paper-plane me-1"></i> {% trans "إرسال للموردين" %}
                        </button>
                        <a href="{% url 'purchases:rfq_update' rfq.pk %}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-edit me-1"></i> {% trans "تعديل" %}
                        </a>
                        <a href="{% url 'purchases:rfq_delete' rfq.pk %}" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-trash me-1"></i> {% trans "حذف" %}
                        </a>
                        {% elif rfq.status == 'sent' %}
                        <a href="{% url 'purchases:mark_rfq_as_evaluating' rfq.pk %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-clipboard-check me-1"></i> {% trans "البدء بالتقييم" %}
                        </a>
                        <a href="{% url 'purchases:cancel_rfq' rfq.pk %}" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-ban me-1"></i> {% trans "إلغاء" %}
                        </a>
                        {% elif rfq.status == 'evaluating' %}
                        <a href="{% url 'purchases:quotation_list' %}?rfq={{ rfq.id }}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-file-invoice me-1"></i> {% trans "عرض العروض المستلمة" %}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Send to Suppliers Modal -->
<div class="modal fade" id="sendToSuppliersModal" tabindex="-1" aria-labelledby="sendToSuppliersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'purchases:send_rfq_to_suppliers' rfq.pk %}">
                {% csrf_token %}
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="sendToSuppliersModalLabel">
                        <i class="fas fa-paper-plane me-2"></i>{% trans "إرسال طلب العرض للموردين" %}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        {% trans "اختر الموردين الذين تريد إرسال طلب عرض الأسعار إليهم" %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">{% trans "الموردين المتاحين:" %}</label>
                        <div class="list-group">
                            {% for supplier in suppliers %}
                            <label class="list-group-item">
                                <input class="form-check-input me-2" type="checkbox" name="suppliers" value="{{ supplier.id }}">
                                <strong>{{ supplier.code }}</strong> - {{ supplier.name }}
                                {% if supplier.phone %}
                                    <small class="text-muted d-block ms-4">
                                        <i class="fas fa-phone me-1"></i>{{ supplier.phone }}
                                    </small>
                                {% endif %}
                            </label>
                            {% empty %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                {% trans "لا توجد موردين نشطين في النظام" %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>{% trans "إلغاء" %}
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane me-1"></i>{% trans "إرسال" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
