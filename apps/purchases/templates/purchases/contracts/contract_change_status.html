{# apps/purchases/templates/purchases/contracts/contract_change_status.html #}
{% extends 'base/base.html' %}
{% load i18n widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                    </li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>
                        {{ title }}
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Contract Information -->
                    <div class="card bg-light mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-file-contract"></i> {% trans "معلومات العقد" %}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>{% trans "رقم العقد:" %}</strong> {{ contract.number }}</p>
                                    <p><strong>{% trans "المورد:" %}</strong> {{ contract.supplier.name }}</p>
                                    <p><strong>{% trans "تاريخ العقد:" %}</strong> {{ contract.contract_date|date:"Y-m-d" }}</p>
                                    <p><strong>{% trans "تاريخ البدء:" %}</strong> {{ contract.start_date|date:"Y-m-d" }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>{% trans "تاريخ الانتهاء:" %}</strong> {{ contract.end_date|date:"Y-m-d" }}</p>
                                    <p><strong>{% trans "قيمة العقد:" %}</strong> {{ contract.contract_value|floatformat:3 }} {{ contract.currency.code }}</p>
                                    <p><strong>{% trans "الحالة الحالية:" %}</strong>
                                        {% if contract.status == 'draft' %}
                                            <span class="badge bg-secondary fs-6">{% trans "مسودة" %}</span>
                                        {% elif contract.status == 'active' %}
                                            <span class="badge bg-success fs-6">{% trans "نشط" %}</span>
                                        {% elif contract.status == 'suspended' %}
                                            <span class="badge bg-warning fs-6">{% trans "معلق" %}</span>
                                        {% elif contract.status == 'completed' %}
                                            <span class="badge bg-info fs-6">{% trans "مكتمل" %}</span>
                                        {% elif contract.status == 'terminated' %}
                                            <span class="badge bg-danger fs-6">{% trans "منهي" %}</span>
                                        {% elif contract.status == 'expired' %}
                                            <span class="badge bg-dark fs-6">{% trans "منتهي الصلاحية" %}</span>
                                        {% endif %}
                                    </p>
                                    <p><strong>{% trans "معتمد:" %}</strong>
                                        {% if contract.approved %}
                                            <span class="badge bg-success">{% trans "نعم" %}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{% trans "لا" %}</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Change Form -->
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <div class="card border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h5 class="mb-0 text-info">
                                    <i class="fas fa-tasks"></i> {% trans "تغيير حالة العقد" %}
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Action Selection -->
                                <div class="mb-4">
                                    <label class="form-label">
                                        {% trans "الإجراء المطلوب" %} <span class="text-danger">*</span>
                                    </label>
                                    <div class="row g-3">
                                        {% if contract.status == 'draft' and contract.approved %}
                                        <div class="col-md-4">
                                            <div class="card action-card border-primary border-2 h-100" style="cursor: pointer; transition: all 0.3s;">
                                                <div class="card-body text-center p-4">
                                                    <div class="form-check">
                                                        <input type="radio" name="action" value="activate" class="form-check-input d-none" id="action_activate" required>
                                                        <label class="form-check-label w-100" for="action_activate" style="cursor: pointer;">
                                                            <i class="fas fa-play-circle text-primary fa-3x d-block mb-3"></i>
                                                            <h5 class="mb-2">{% trans "تفعيل العقد" %}</h5>
                                                            <p class="text-muted small mb-0">{% trans "تحويل العقد من مسودة إلى ساري المفعول" %}</p>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        {% if contract.status == 'active' %}
                                        <div class="col-md-4">
                                            <div class="card action-card border-warning border-2 h-100" style="cursor: pointer; transition: all 0.3s;">
                                                <div class="card-body text-center p-4">
                                                    <div class="form-check">
                                                        <input type="radio" name="action" value="suspend" class="form-check-input d-none" id="action_suspend" required>
                                                        <label class="form-check-label w-100" for="action_suspend" style="cursor: pointer;">
                                                            <i class="fas fa-pause-circle text-warning fa-3x d-block mb-3"></i>
                                                            <h5 class="mb-2">{% trans "تعليق العقد" %}</h5>
                                                            <p class="text-muted small mb-0">{% trans "إيقاف العقد مؤقتاً - يمكن إعادة تفعيله لاحقاً" %}</p>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        {% if contract.status in 'active,suspended' %}
                                        <div class="col-md-4">
                                            <div class="card action-card border-danger border-2 h-100" style="cursor: pointer; transition: all 0.3s;">
                                                <div class="card-body text-center p-4">
                                                    <div class="form-check">
                                                        <input type="radio" name="action" value="terminate" class="form-check-input d-none" id="action_terminate" required>
                                                        <label class="form-check-label w-100" for="action_terminate" style="cursor: pointer;">
                                                            <i class="fas fa-stop-circle text-danger fa-3x d-block mb-3"></i>
                                                            <h5 class="mb-2">{% trans "إنهاء العقد" %}</h5>
                                                            <p class="text-danger small mb-2"><i class="fas fa-exclamation-triangle"></i> {% trans "إنهاء نهائي - لا يمكن التراجع" %}</p>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% if form.action.errors %}
                                    <div class="invalid-feedback d-block mt-2">
                                        {{ form.action.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Reason -->
                                <div class="mb-3">
                                    <label for="{{ form.reason.id_for_label }}" class="form-label">
                                        {% trans "سبب التغيير" %}
                                    </label>
                                    {{ form.reason|add_class:"form-control"|attr:"rows:4"|attr:"placeholder:أدخل سبب تغيير حالة العقد (اختياري)" }}
                                    <div class="form-text">
                                        {% trans "يُفضل توضيح سبب التعليق أو الإنهاء للرجوع إليه مستقبلاً" %}
                                    </div>
                                    {% if form.reason.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.reason.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Important Notes -->
                                <div class="alert alert-info" role="alert">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-info-circle me-2"></i>{% trans "ملاحظات هامة:" %}
                                    </h6>
                                    <ul class="mb-0">
                                        <li>{% trans "تفعيل العقد: يتطلب أن يكون العقد معتمداً وفي حالة مسودة" %}</li>
                                        <li>{% trans "تعليق العقد: يمكن تعليق العقود النشطة فقط، ويمكن إعادة تفعيلها لاحقاً" %}</li>
                                        <li>{% trans "إنهاء العقد: إجراء نهائي لإنهاء العقد قبل موعده، ولا يمكن التراجع عنه" %}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a href="{% url 'purchases:contract_detail' contract.pk %}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-times me-2"></i> {% trans "إلغاء" %}
                            </a>
                            <button type="submit" id="submitButton" class="btn btn-success btn-lg">
                                <i class="fas fa-check-circle me-2"></i> {% trans "تأكيد وتنفيذ التغيير" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Highlight selected action card
    $('input[name="action"]').on('change', function() {
        // Remove previous highlights
        $('.action-card').removeClass('border-3 shadow-lg bg-light');

        // Highlight selected card
        $(this).closest('.action-card').addClass('border-3 shadow-lg bg-light');

        // Enable submit button
        $('#submitButton').prop('disabled', false);
    });

    // Pre-select action from URL parameter if available
    var urlParams = new URLSearchParams(window.location.search);
    var actionParam = urlParams.get('action');
    if (actionParam) {
        $('input[name="action"][value="' + actionParam + '"]').prop('checked', true).trigger('change');
    }

    // Disable submit button initially if no action selected
    if (!$('input[name="action"]:checked').length) {
        $('#submitButton').prop('disabled', true);
    }
});
</script>
{% endblock %}
