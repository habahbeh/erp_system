{# apps/purchases/templates/purchases/quotations/quotation_detail.html #}
{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                    </li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-file-invoice text-primary"></i>
            {% trans "عرض سعر رقم" %} {{ quotation.number }}
        </h2>
        <div>
            {% if quotation.status == 'draft' or quotation.status == 'received' %}
                <a href="{% url 'purchases:quotation_update' quotation.pk %}" class="btn btn-warning">
                    <i class="fas fa-edit"></i> {% trans "تعديل" %}
                </a>
                {% if quotation.status == 'draft' %}
                <a href="{% url 'purchases:quotation_delete' quotation.pk %}" class="btn btn-danger">
                    <i class="fas fa-trash"></i> {% trans "حذف" %}
                </a>
                {% endif %}
            {% elif quotation.status == 'under_evaluation' or quotation.status == 'accepted' %}
                <a href="{% url 'purchases:quotation_update' quotation.pk %}" class="btn btn-warning">
                    <i class="fas fa-edit"></i> {% trans "تعديل" %}
                </a>
            {% elif quotation.status == 'awarded' %}
                <span class="badge bg-success fs-5 me-2">
                    <i class="fas fa-trophy"></i> {% trans "عرض فائز" %}
                </span>
            {% endif %}
            <a href="{% url 'purchases:quotation_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> {% trans "رجوع" %}
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-md-8">
            <!-- Quotation Details Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "معلومات عرض السعر" %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>{% trans "رقم العرض:" %}</strong> {{ quotation.number }}</p>
                            <p><strong>{% trans "المورد:" %}</strong> {{ quotation.supplier.name }}</p>
                            {% if quotation.supplier.tax_number %}
                                <p class="mb-1"><small class="text-muted">
                                    <i class="fas fa-receipt me-1"></i>{% trans "الرقم الضريبي:" %} {{ quotation.supplier.tax_number }}
                                </small></p>
                            {% endif %}
                            {% if quotation.supplier.phone %}
                                <p class="mb-1"><small class="text-muted">
                                    <i class="fas fa-phone me-1"></i>{{ quotation.supplier.phone }}
                                </small></p>
                            {% endif %}
                            {% if quotation.supplier.email %}
                                <p class="mb-3"><small class="text-muted">
                                    <i class="fas fa-envelope me-1"></i>{{ quotation.supplier.email }}
                                </small></p>
                            {% endif %}
                            <p><strong>{% trans "طلب عرض السعر:" %}</strong>
                                {% if quotation.quotation_request %}
                                    <a href="{% url 'purchases:rfq_detail' quotation.quotation_request.pk %}">
                                        {{ quotation.quotation_request.number }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>{% trans "التاريخ:" %}</strong> {{ quotation.date|date:"Y-m-d" }}</p>
                            <p><strong>{% trans "تاريخ الصلاحية:" %}</strong>
                                {% if quotation.valid_until %}
                                    {{ quotation.valid_until|date:"Y-m-d" }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </p>
                            <p><strong>{% trans "العملة:" %}</strong>
                                {% if quotation.currency %}
                                    {{ quotation.currency.name }} ({{ quotation.currency.code }})
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </p>
                            <p><strong>{% trans "الحالة:" %}</strong>
                                {% if quotation.status == 'draft' %}
                                    <span class="badge bg-secondary fs-6">{% trans "مسودة" %}</span>
                                {% elif quotation.status == 'sent' %}
                                    <span class="badge bg-primary fs-6">{% trans "مرسل" %}</span>
                                {% elif quotation.status == 'received' %}
                                    <span class="badge bg-info fs-6">{% trans "مستلم" %}</span>
                                {% elif quotation.status == 'under_evaluation' %}
                                    <span class="badge bg-warning fs-6">{% trans "تحت التقييم" %}</span>
                                {% elif quotation.status == 'accepted' %}
                                    <span class="badge bg-success fs-6">{% trans "مقبول" %}</span>
                                {% elif quotation.status == 'awarded' %}
                                    <span class="badge bg-success fs-6">{% trans "فائز" %}</span>
                                {% elif quotation.status == 'rejected' %}
                                    <span class="badge bg-danger fs-6">{% trans "مرفوض" %}</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    {% if quotation.payment_terms or quotation.delivery_terms or quotation.delivery_period_days or quotation.warranty_period_months %}
                    <hr>
                    <div class="row">
                        {% if quotation.payment_terms %}
                        <div class="col-md-6">
                            <p><strong>{% trans "شروط الدفع:" %}</strong></p>
                            <p class="text-muted">{{ quotation.payment_terms }}</p>
                        </div>
                        {% endif %}
                        {% if quotation.delivery_terms %}
                        <div class="col-md-6">
                            <p><strong>{% trans "شروط التسليم:" %}</strong></p>
                            <p class="text-muted">{{ quotation.delivery_terms }}</p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="row">
                        {% if quotation.delivery_period_days %}
                        <div class="col-md-6">
                            <p><strong>{% trans "مدة التسليم:" %}</strong>
                                <span class="badge bg-secondary">{{ quotation.delivery_period_days }} {% trans "يوم" %}</span>
                            </p>
                        </div>
                        {% endif %}
                        {% if quotation.warranty_period_months %}
                        <div class="col-md-6">
                            <p><strong>{% trans "مدة الضمان:" %}</strong>
                                <span class="badge bg-success">{{ quotation.warranty_period_months }} {% trans "شهر" %}</span>
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Items Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-boxes"></i> {% trans "تفاصيل الأصناف" %}</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>{% trans "الصنف" %}</th>
                                    <th>{% trans "العلامة التجارية" %}</th>
                                    <th>{% trans "بلد المنشأ" %}</th>
                                    <th class="text-center">{% trans "الكمية" %}</th>
                                    <th class="text-end">{% trans "سعر الوحدة" %}</th>
                                    <th class="text-end">{% trans "الخصم" %}</th>
                                    <th class="text-end">{% trans "الإجمالي" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in quotation.lines.all %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        {% if item.item %}
                                            <strong>{{ item.item.code }}</strong> - {{ item.item.name }}
                                        {% else %}
                                            <strong>{{ item.description }}</strong>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.brand|default:"-" }}</td>
                                    <td>{{ item.country_of_origin|default:"-" }}</td>
                                    <td class="text-center"><strong>{{ item.quantity|floatformat:3 }}</strong></td>
                                    <td class="text-end">{{ item.unit_price|floatformat:3 }}</td>
                                    <td class="text-end">
                                        {% if item.discount_percentage %}
                                            <span class="badge bg-danger">{{ item.discount_percentage }}%</span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-end"><strong>{{ item.total|floatformat:3 }}</strong></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-3">{% trans "لا توجد أصناف" %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Action Buttons Section (for evaluating/awarding) -->
            {% if can_evaluate or can_award or can_reject or can_convert %}
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-cogs"></i> {% trans "الإجراءات المتاحة" %}</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap justify-content-center">
                        {% if can_evaluate %}
                        <a href="{% url 'purchases:evaluate_quotation' quotation.pk %}" class="btn btn-warning btn-lg">
                            <i class="fas fa-star"></i> {% trans "تقييم العرض" %}
                        </a>
                        {% endif %}

                        {% if can_award %}
                        <a href="{% url 'purchases:award_quotation' quotation.pk %}"
                           class="btn btn-success btn-lg award-btn">
                            <i class="fas fa-trophy"></i> {% trans "ترسية العرض" %}
                        </a>
                        {% endif %}

                        {% if can_reject %}
                        <a href="{% url 'purchases:reject_quotation' quotation.pk %}" class="btn btn-danger btn-lg">
                            <i class="fas fa-times-circle"></i> {% trans "رفض العرض" %}
                        </a>
                        {% endif %}

                        {% if can_convert %}
                        <a href="{% url 'purchases:convert_quotation_to_order' quotation.pk %}"
                           class="btn btn-primary btn-lg convert-btn">
                            <i class="fas fa-exchange-alt"></i> {% trans "تحويل لأمر شراء" %}
                        </a>
                        {% endif %}
                    </div>

                    {% if quotation.is_awarded and can_convert %}
                    <div class="alert alert-success mt-3 mb-0">
                        <i class="fas fa-info-circle"></i>
                        {% trans "هذا العرض فائز ويمكن تحويله إلى أمر شراء" %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Financial Summary Card -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-calculator"></i> {% trans "الملخص المالي" %}</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <span>{% trans "المجموع الفرعي:" %}</span>
                        <strong>{{ quotation.subtotal|floatformat:3 }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <span>{% trans "الخصم:" %}</span>
                        <strong class="text-danger">{{ quotation.discount_amount|floatformat:3 }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                        <span>{% trans "الضريبة:" %}</span>
                        <strong>{{ quotation.tax_amount|floatformat:3 }}</strong>
                    </div>
                    <div class="d-flex justify-content-between pt-2">
                        <span class="text-primary fw-bold fs-5">{% trans "الإجمالي النهائي:" %}</span>
                        <strong class="text-primary fs-5">{{ quotation.total_amount|floatformat:3 }}</strong>
                    </div>
                </div>
            </div>

            <!-- Score/Evaluation Card -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-star"></i> {% trans "التقييم" %}</h6>
                </div>
                <div class="card-body text-center">
                    {% if quotation.score %}
                        <div class="mb-3">
                            <div class="display-4 text-primary fw-bold">{{ quotation.score }}<small class="fs-4 text-muted">/100</small></div>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar {% if quotation.score >= 80 %}bg-success{% elif quotation.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}"
                                 role="progressbar"
                                 style="width: {{ quotation.score }}%;"
                                 aria-valuenow="{{ quotation.score }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                {{ quotation.score }}%
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">{% trans "لم يتم التقييم بعد" %}</p>
                    {% endif %}

                    {% if quotation.evaluation_notes %}
                        <hr>
                        <div class="text-start">
                            <label class="form-label text-muted small fw-bold">{% trans "ملاحظات التقييم:" %}</label>
                            <p class="small mb-0">{{ quotation.evaluation_notes|linebreaks }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Status/Info Card -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "معلومات الحالة" %}</h6>
                </div>
                <div class="card-body">
                    <p><strong>{% trans "الحالة:" %}</strong>
                        {% if quotation.status == 'draft' %}
                            <span class="badge bg-secondary">{% trans "مسودة" %}</span>
                        {% elif quotation.status == 'sent' %}
                            <span class="badge bg-primary">{% trans "مرسل" %}</span>
                        {% elif quotation.status == 'received' %}
                            <span class="badge bg-info">{% trans "مستلم" %}</span>
                        {% elif quotation.status == 'under_evaluation' %}
                            <span class="badge bg-warning">{% trans "تحت التقييم" %}</span>
                        {% elif quotation.status == 'accepted' %}
                            <span class="badge bg-success">{% trans "مقبول" %}</span>
                        {% elif quotation.status == 'awarded' %}
                            <span class="badge bg-success">{% trans "فائز" %}</span>
                        {% elif quotation.status == 'rejected' %}
                            <span class="badge bg-danger">{% trans "مرفوض" %}</span>
                        {% endif %}
                    </p>
                    {% if quotation.quotation_request %}
                    <p><strong>{% trans "طلب العرض:" %}</strong>
                        <a href="{% url 'purchases:rfq_detail' quotation.quotation_request.pk %}">
                            {{ quotation.quotation_request.number }}
                        </a>
                    </p>
                    {% endif %}
                    <hr>
                    <small class="text-muted d-block mb-1">
                        <i class="fas fa-user me-1"></i>
                        أنشئ بواسطة: {{ quotation.created_by.get_full_name }}
                    </small>
                    <small class="text-muted d-block mb-1">
                        <i class="fas fa-calendar-alt me-1"></i>
                        تاريخ الإنشاء: {{ quotation.created_at|date:"Y-m-d H:i" }}
                    </small>
                    {% if quotation.updated_at != quotation.created_at %}
                    <small class="text-muted d-block">
                        <i class="fas fa-edit me-1"></i>
                        آخر تحديث: {{ quotation.updated_at|date:"Y-m-d H:i" }}
                    </small>
                    {% endif %}
                </div>
            </div>

            <!-- Notes Card -->
            {% if quotation.notes %}
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-sticky-note"></i> {% trans "ملاحظات" %}</h6>
                </div>
                <div class="card-body">
                    <p class="mb-0 small">{{ quotation.notes|linebreaks }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Actions Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-cog"></i> {% trans "الإجراءات" %}</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                            <i class="fas fa-print me-1"></i> {% trans "طباعة" %}
                        </button>

                        {% if quotation.status == 'draft' or quotation.status == 'received' or quotation.status == 'under_evaluation' or quotation.status == 'accepted' %}
                        <a href="{% url 'purchases:quotation_update' quotation.pk %}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-edit me-1"></i> {% trans "تعديل" %}
                        </a>
                        {% endif %}

                        {% if quotation.status == 'draft' %}
                        <a href="{% url 'purchases:quotation_delete' quotation.pk %}" class="btn btn-outline-danger btn-sm delete-btn">
                            <i class="fas fa-trash me-1"></i> {% trans "حذف" %}
                        </a>
                        {% endif %}

                        {% if can_evaluate %}
                        <a href="{% url 'purchases:evaluate_quotation' quotation.pk %}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-star me-1"></i> {% trans "تقييم العرض" %}
                        </a>
                        {% endif %}

                        {% if quotation.quotation_request %}
                        <a href="{% url 'purchases:rfq_detail' quotation.quotation_request.pk %}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-file-alt me-1"></i> {% trans "عرض طلب العرض" %}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Confirmation for delete and reject buttons
    $('.delete-btn, a[href*="reject"]').on('click', function(e) {
        if (!confirm('{% trans "هل أنت متأكد من تنفيذ هذا الإجراء؟" %}')) {
            e.preventDefault();
        }
    });

    // Confirmation for award button
    $('.award-btn').on('click', function(e) {
        if (!confirm('{% trans "هل أنت متأكد من ترسية العرض على هذا المورد؟ سيتم رفض جميع العروض الأخرى." %}')) {
            e.preventDefault();
        }
    });

    // Confirmation for convert button
    $('.convert-btn').on('click', function(e) {
        if (!confirm('{% trans "سيتم إنشاء أمر شراء جديد من هذا العرض. هل تريد المتابعة؟" %}')) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
