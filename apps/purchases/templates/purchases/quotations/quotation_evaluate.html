{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.evaluation-card {
    border-right: 4px solid #ffc107;
}

.score-input {
    font-size: 1.5rem;
    text-align: center;
    font-weight: bold;
}

.evaluation-form {
    background-color: #f8f9fa;
    padding: 2rem;
    border-radius: 0.375rem;
}

.quotation-summary {
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.score-guide {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 1rem;
    margin-bottom: 1.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                    </li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-star text-warning"></i> {{ title }}
            </h1>
            <p class="text-muted mb-0">{% trans "تقييم عرض السعر وإضافة ملاحظات" %}</p>
        </div>
        <div>
            <a href="{% url 'purchases:quotation_detail' quotation.pk %}" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> {% trans "رجوع" %}
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Quotation Summary -->
            <div class="quotation-summary">
                <h5 class="mb-3">
                    <i class="fas fa-file-invoice"></i> {% trans "ملخص عرض السعر" %}
                </h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-2">
                            <label class="text-muted small">{% trans "رقم العرض" %}</label>
                            <p class="fw-bold mb-0">{{ quotation.number }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-2">
                            <label class="text-muted small">{% trans "المورد" %}</label>
                            <p class="fw-bold mb-0">{{ quotation.supplier.name }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-2">
                            <label class="text-muted small">{% trans "الإجمالي" %}</label>
                            <p class="fw-bold mb-0 text-primary">
                                {{ quotation.total_amount|floatformat:3 }}
                                <small>{{ quotation.currency.code }}</small>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <label class="text-muted small">{% trans "مدة التسليم" %}</label>
                            <p class="mb-0">
                                {% if quotation.delivery_period_days %}
                                    {{ quotation.delivery_period_days }} {% trans "يوم" %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-2">
                            <label class="text-muted small">{% trans "مدة الضمان" %}</label>
                            <p class="mb-0">
                                {% if quotation.warranty_period_months %}
                                    {{ quotation.warranty_period_months }} {% trans "شهر" %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evaluation Form -->
            <div class="card evaluation-card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check"></i> {% trans "نموذج التقييم" %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" class="evaluation-form">
                        {% csrf_token %}

                        <!-- Score Guide -->
                        <div class="score-guide">
                            <h6 class="mb-2">
                                <i class="fas fa-info-circle"></i> {% trans "دليل التقييم" %}
                            </h6>
                            <ul class="mb-0 small">
                                <li>{% trans "90-100: ممتاز جداً - سعر منافس، جودة عالية، شروط مناسبة" %}</li>
                                <li>{% trans "80-89: جيد جداً - سعر جيد، مواصفات مطابقة" %}</li>
                                <li>{% trans "70-79: جيد - سعر مقبول، بعض التحفظات" %}</li>
                                <li>{% trans "60-69: مقبول - احتياج لمزيد من التفاوض" %}</li>
                                <li>{% trans "أقل من 60: ضعيف - غير موصى به" %}</li>
                            </ul>
                        </div>

                        <!-- Score Input -->
                        <div class="mb-4">
                            <label for="score" class="form-label fw-bold">
                                {% trans "التقييم" %} <span class="text-danger">*</span>
                            </label>
                            <div class="input-group input-group-lg">
                                <input
                                    type="number"
                                    class="form-control score-input"
                                    id="score"
                                    name="score"
                                    min="0"
                                    max="100"
                                    step="0.01"
                                    value="{{ quotation.score|default:'' }}"
                                    placeholder="0.00"
                                    required
                                >
                                <span class="input-group-text">/100</span>
                            </div>
                            <div class="form-text">{% trans "أدخل التقييم من 0 إلى 100" %}</div>
                        </div>

                        <!-- Evaluation Notes -->
                        <div class="mb-4">
                            <label for="evaluation_notes" class="form-label fw-bold">
                                {% trans "ملاحظات التقييم" %}
                            </label>
                            <textarea
                                class="form-control"
                                id="evaluation_notes"
                                name="evaluation_notes"
                                rows="6"
                                placeholder="{% trans 'أدخل ملاحظاتك التفصيلية حول العرض...' %}"
                            >{{ quotation.evaluation_notes|default:'' }}</textarea>
                            <div class="form-text">
                                {% trans "يمكنك ذكر نقاط القوة والضعف، مدى مطابقة المواصفات، جودة المنتجات، شروط الدفع والتسليم، الخ." %}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="{% url 'purchases:quotation_detail' quotation.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> {% trans "إلغاء" %}
                            </a>
                            <button type="submit" class="btn btn-warning text-dark">
                                <i class="fas fa-save"></i> {% trans "حفظ التقييم" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Side Panel - Current Evaluation -->
        <div class="col-md-4">
            {% if quotation.score %}
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line"></i> {% trans "التقييم الحالي" %}
                    </h6>
                </div>
                <div class="card-body text-center">
                    <div class="display-4 fw-bold mb-2
                        {% if quotation.score >= 90 %}text-success
                        {% elif quotation.score >= 80 %}text-primary
                        {% elif quotation.score >= 70 %}text-info
                        {% elif quotation.score >= 60 %}text-warning
                        {% else %}text-danger
                        {% endif %}
                    ">
                        {{ quotation.score|floatformat:2 }}
                    </div>
                    <p class="text-muted mb-0">{% trans "من 100" %}</p>

                    {% if quotation.evaluation_notes %}
                    <hr>
                    <div class="text-start">
                        <strong class="small">{% trans "الملاحظات السابقة" %}:</strong>
                        <p class="small text-muted mb-0 mt-2">
                            {{ quotation.evaluation_notes|linebreaksbr|truncatewords:50 }}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Tips Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb"></i> {% trans "نصائح التقييم" %}
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="small mb-0">
                        <li class="mb-2">{% trans "قارن السعر مع العروض الأخرى" %}</li>
                        <li class="mb-2">{% trans "تحقق من مطابقة المواصفات المطلوبة" %}</li>
                        <li class="mb-2">{% trans "راجع شروط الدفع والتسليم" %}</li>
                        <li class="mb-2">{% trans "ضع في الاعتبار سمعة المورد وخبرته" %}</li>
                        <li class="mb-2">{% trans "راجع مدة الضمان والخدمات المقدمة" %}</li>
                        <li>{% trans "تأكد من توفر جميع المستندات المطلوبة" %}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Score input validation
    $('#score').on('input', function() {
        let value = parseFloat($(this).val());
        if (value > 100) {
            $(this).val(100);
        } else if (value < 0) {
            $(this).val(0);
        }

        // Update score color based on value
        $(this).removeClass('text-success text-primary text-info text-warning text-danger');
        if (value >= 90) {
            $(this).addClass('text-success');
        } else if (value >= 80) {
            $(this).addClass('text-primary');
        } else if (value >= 70) {
            $(this).addClass('text-info');
        } else if (value >= 60) {
            $(this).addClass('text-warning');
        } else {
            $(this).addClass('text-danger');
        }
    });

    // Form validation
    $('form').on('submit', function(e) {
        let score = $('#score').val();
        if (!score || score === '') {
            e.preventDefault();
            alert('{% trans "يرجى إدخال التقييم" %}');
            $('#score').focus();
            return false;
        }
    });
});
</script>
{% endblock %}
