{# apps/sales/templates/sales/campaigns/campaign_form.html #}
{% extends 'base/base.html' %}
{% load i18n static widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
/* Select2 RTL Styles */
.select2-container--bootstrap-5 .select2-selection--multiple {
    direction: rtl;
    text-align: right;
}

.select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
    float: right;
    margin-right: 0;
    margin-left: 5px;
}

.select2-container--bootstrap-5 .select2-dropdown {
    direction: rtl;
    text-align: right;
}

.select2-container--bootstrap-5 .select2-results__options {
    text-align: right;
    direction: rtl;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    margin-bottom: 1.5rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    padding: 1rem 1.25rem;
}

.form-section {
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.form-section-title {
    font-size: 1rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
}

.field-help-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.required-field::after {
    content: " *";
    color: #dc3545;
}

/* Campaign Type Selection */
.campaign-type-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.campaign-type-card {
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.campaign-type-card:hover {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.campaign-type-card.selected {
    border-color: #0d6efd;
    background-color: #e7f1ff;
}

.campaign-type-card input[type="radio"] {
    display: none;
}

.campaign-type-card i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    display: block;
}

/* Dynamic Fields */
.dynamic-field {
    display: none;
}

.dynamic-field.show {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">الرئيسية</a></li>
            <li class="breadcrumb-item"><a href="{% url 'sales:campaign_list' %}">حملات الخصومات</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
        </ol>
    </nav>

    <!-- Form Card -->
    <form method="post" id="campaignForm">
        {% csrf_token %}

        <div class="row">
            <!-- Main Form Column -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            المعلومات الأساسية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label required-field">اسم الحملة</label>
                                {{ form.name|add_class:"form-control" }}
                                {% if form.name.errors %}
                                    <div class="text-danger small mt-1">{{ form.name.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label required-field">كود الحملة</label>
                                {{ form.code|add_class:"form-control" }}
                                <div class="field-help-text">سيتم تحويله للأحرف الكبيرة تلقائياً</div>
                                {% if form.code.errors %}
                                    <div class="text-danger small mt-1">{{ form.code.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-12">
                                <label class="form-label">وصف الحملة</label>
                                {{ form.description|add_class:"form-control" }}
                                {% if form.description.errors %}
                                    <div class="text-danger small mt-1">{{ form.description.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campaign Type & Discount -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-percent me-2"></i>
                            نوع الحملة والخصم
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label required-field">نوع الحملة</label>
                            {{ form.campaign_type }}
                            {% if form.campaign_type.errors %}
                                <div class="text-danger small mt-1">{{ form.campaign_type.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Percentage Discount Fields -->
                        <div class="form-section dynamic-field" id="percentage-fields">
                            <div class="form-section-title">إعدادات الخصم النسبي</div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">نسبة الخصم (%)</label>
                                    {{ form.discount_percentage|add_class:"form-control" }}
                                    {% if form.discount_percentage.errors %}
                                        <div class="text-danger small mt-1">{{ form.discount_percentage.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">الحد الأقصى لمبلغ الخصم</label>
                                    {{ form.max_discount_amount|add_class:"form-control" }}
                                    <div class="field-help-text">اختياري - لتحديد حد أقصى للخصم</div>
                                    {% if form.max_discount_amount.errors %}
                                        <div class="text-danger small mt-1">{{ form.max_discount_amount.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Fixed Discount Fields -->
                        <div class="form-section dynamic-field" id="fixed-fields">
                            <div class="form-section-title">إعدادات الخصم الثابت</div>
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label">مبلغ الخصم</label>
                                    {{ form.discount_amount|add_class:"form-control" }}
                                    {% if form.discount_amount.errors %}
                                        <div class="text-danger small mt-1">{{ form.discount_amount.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Buy X Get Y Fields -->
                        <div class="form-section dynamic-field" id="buy-x-get-y-fields">
                            <div class="form-section-title">إعدادات اشتري X واحصل على Y</div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">كمية الشراء (X)</label>
                                    {{ form.buy_quantity|add_class:"form-control" }}
                                    {% if form.buy_quantity.errors %}
                                        <div class="text-danger small mt-1">{{ form.buy_quantity.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">كمية الهدية (Y)</label>
                                    {{ form.get_quantity|add_class:"form-control" }}
                                    {% if form.get_quantity.errors %}
                                        <div class="text-danger small mt-1">{{ form.get_quantity.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date & Time Settings -->
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            فترة الحملة
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label required-field">تاريخ البداية</label>
                                {{ form.start_date|add_class:"form-control" }}
                                {% if form.start_date.errors %}
                                    <div class="text-danger small mt-1">{{ form.start_date.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label required-field">تاريخ النهاية</label>
                                {{ form.end_date|add_class:"form-control" }}
                                {% if form.end_date.errors %}
                                    <div class="text-danger small mt-1">{{ form.end_date.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">وقت البداية</label>
                                {{ form.start_time|add_class:"form-control" }}
                                <div class="field-help-text">اختياري - لتحديد وقت بداية يومي</div>
                                {% if form.start_time.errors %}
                                    <div class="text-danger small mt-1">{{ form.start_time.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">وقت النهاية</label>
                                {{ form.end_time|add_class:"form-control" }}
                                <div class="field-help-text">اختياري - لتحديد وقت نهاية يومي</div>
                                {% if form.end_time.errors %}
                                    <div class="text-danger small mt-1">{{ form.end_time.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conditions & Limits -->
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-sliders-h me-2"></i>
                            الشروط والقيود
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">الحد الأدنى للمشتريات</label>
                                {{ form.min_purchase_amount|add_class:"form-control" }}
                                <div class="field-help-text">اختياري - أقل مبلغ لتطبيق الحملة</div>
                                {% if form.min_purchase_amount.errors %}
                                    <div class="text-danger small mt-1">{{ form.min_purchase_amount.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">الحد الأقصى للمشتريات</label>
                                {{ form.max_purchase_amount|add_class:"form-control" }}
                                <div class="field-help-text">اختياري - أعلى مبلغ لتطبيق الحملة</div>
                                {% if form.max_purchase_amount.errors %}
                                    <div class="text-danger small mt-1">{{ form.max_purchase_amount.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">الحد الأقصى للاستخدامات</label>
                                {{ form.max_uses|add_class:"form-control" }}
                                <div class="field-help-text">اختياري - إجمالي عدد مرات الاستخدام</div>
                                {% if form.max_uses.errors %}
                                    <div class="text-danger small mt-1">{{ form.max_uses.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">الحد الأقصى للاستخدام لكل عميل</label>
                                {{ form.max_uses_per_customer|add_class:"form-control" }}
                                <div class="field-help-text">اختياري - عدد مرات استخدام العميل الواحد</div>
                                {% if form.max_uses_per_customer.errors %}
                                    <div class="text-danger small mt-1">{{ form.max_uses_per_customer.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Target Selection -->
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-bullseye me-2"></i>
                            تحديد الفئة المستهدفة
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            إذا لم تحدد أي خيار، سيتم تطبيق الحملة على جميع الفئات
                        </div>

                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">المواد المحددة</label>
                                {{ form.items }}
                                <div class="field-help-text">اختر مواد محددة أو اتركه فارغاً لجميع المواد</div>
                                {% if form.items.errors %}
                                    <div class="text-danger small mt-1">{{ form.items.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-12">
                                <label class="form-label">الأصناف المحددة</label>
                                {{ form.categories }}
                                <div class="field-help-text">اختر أصناف محددة أو اتركه فارغاً لجميع الأصناف</div>
                                {% if form.categories.errors %}
                                    <div class="text-danger small mt-1">{{ form.categories.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="col-12">
                                <label class="form-label">العملاء المحددون</label>
                                {{ form.customers }}
                                <div class="field-help-text">اختر عملاء محددين أو اتركه فارغاً لجميع العملاء</div>
                                {% if form.customers.errors %}
                                    <div class="text-danger small mt-1">{{ form.customers.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="col-lg-4">
                <!-- Status & Priority -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            الإعدادات
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.is_active|add_class:"form-check-input" }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                    تفعيل الحملة
                                </label>
                            </div>
                            <div class="field-help-text">قم بإلغاء التفعيل لإيقاف الحملة مؤقتاً</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">الأولوية</label>
                            {{ form.priority|add_class:"form-control" }}
                            <div class="field-help-text">الحملات ذات الأولوية الأعلى يتم تطبيقها أولاً</div>
                            {% if form.priority.errors %}
                                <div class="text-danger small mt-1">{{ form.priority.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-0">
                            <label class="form-label">ملاحظات</label>
                            {{ form.notes|add_class:"form-control" }}
                            {% if form.notes.errors %}
                                <div class="text-danger small mt-1">{{ form.notes.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                حفظ الحملة
                            </button>
                            <a href="{% url 'sales:campaign_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>
                                إلغاء
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Help Card -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-question-circle me-2"></i>
                            مساعدة
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0 small">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-1"></i>
                                <strong>خصم نسبة:</strong> يطبق نسبة خصم على الإجمالي
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-1"></i>
                                <strong>خصم ثابت:</strong> يطرح مبلغ ثابت من الإجمالي
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-1"></i>
                                <strong>اشتري X واحصل Y:</strong> عند شراء كمية معينة يحصل على كمية إضافية
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 for multiple select fields
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%',
        dir: "rtl",
        placeholder: 'اختر...',
        allowClear: true,
        language: {
            noResults: function() { return "لا توجد نتائج"; }
        }
    });

    // Show/Hide dynamic fields based on campaign type
    function updateDynamicFields() {
        const campaignType = $('#id_campaign_type').val();

        // Hide all dynamic fields
        $('.dynamic-field').removeClass('show');

        // Show relevant fields
        if (campaignType === 'percentage') {
            $('#percentage-fields').addClass('show');
        } else if (campaignType === 'fixed') {
            $('#fixed-fields').addClass('show');
        } else if (campaignType === 'buy_x_get_y') {
            $('#buy-x-get-y-fields').addClass('show');
        }
    }

    // Initialize on page load
    updateDynamicFields();

    // Update when campaign type changes
    $('#id_campaign_type').on('change', function() {
        updateDynamicFields();
    });

    // Form validation
    $('#campaignForm').on('submit', function(e) {
        const campaignType = $('#id_campaign_type').val();
        let isValid = true;
        let errorMessage = '';

        if (campaignType === 'percentage') {
            const discountPercentage = parseFloat($('#id_discount_percentage').val());
            if (!discountPercentage || discountPercentage <= 0) {
                isValid = false;
                errorMessage = 'يجب إدخال نسبة خصم صحيحة';
            }
        } else if (campaignType === 'fixed') {
            const discountAmount = parseFloat($('#id_discount_amount').val());
            if (!discountAmount || discountAmount <= 0) {
                isValid = false;
                errorMessage = 'يجب إدخال مبلغ خصم صحيح';
            }
        } else if (campaignType === 'buy_x_get_y') {
            const buyQty = parseInt($('#id_buy_quantity').val());
            const getQty = parseInt($('#id_get_quantity').val());
            if (!buyQty || buyQty <= 0 || !getQty || getQty <= 0) {
                isValid = false;
                errorMessage = 'يجب إدخال كميات الشراء والهدية';
            }
        }

        if (!isValid) {
            e.preventDefault();
            alert(errorMessage);
            return false;
        }
    });
});
</script>
{% endblock %}
