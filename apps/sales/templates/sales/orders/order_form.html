{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.rtl.min.css" rel="stylesheet" />
<style>
    .formset-row {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
        position: relative;
    }
    .delete-row {
        position: absolute;
        top: 10px;
        left: 10px;
    }
    .total-section {
        background-color: #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
    .line-total {
        font-weight: bold;
        color: #198754;
    }
    .select2-container {
        width: 100% !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- صفحة العنوان -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">
            <i class="fas fa-shopping-cart ms-2"></i>
            {{ title }}
        </h2>
        <a href="{% url 'sales:order_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-right ms-2"></i>
            رجوع للقائمة
        </a>
    </div>

    <!-- نموذج طلب البيع -->
    <form method="post" id="orderForm">
        {% csrf_token %}

        <div class="row">
            <!-- معلومات طلب البيع الأساسية -->
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle ms-2"></i>
                            معلومات طلب البيع
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="{{ form.date.id_for_label }}" class="form-label required">التاريخ</label>
                                {% render_field form.date class="form-control" %}
                                {% if form.date.errors %}
                                    <div class="text-danger small mt-1">{{ form.date.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.customer.id_for_label }}" class="form-label required">العميل</label>
                                {% render_field form.customer class="form-control select2" %}
                                {% if form.customer.errors %}
                                    <div class="text-danger small mt-1">{{ form.customer.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.warehouse.id_for_label }}" class="form-label required">المستودع</label>
                                {% render_field form.warehouse class="form-control select2" %}
                                {% if form.warehouse.errors %}
                                    <div class="text-danger small mt-1">{{ form.warehouse.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.salesperson.id_for_label }}" class="form-label required">موظف المبيعات</label>
                                {% render_field form.salesperson class="form-control select2" %}
                                {% if form.salesperson.errors %}
                                    <div class="text-danger small mt-1">{{ form.salesperson.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.quotation.id_for_label }}" class="form-label">عرض السعر</label>
                                {% render_field form.quotation class="form-control select2" %}
                                {% if form.quotation.errors %}
                                    <div class="text-danger small mt-1">{{ form.quotation.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">اختياري - إذا كان من عرض سعر</small>
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.delivery_date.id_for_label }}" class="form-label">تاريخ التسليم المتوقع</label>
                                {% render_field form.delivery_date class="form-control" %}
                                {% if form.delivery_date.errors %}
                                    <div class="text-danger small mt-1">{{ form.delivery_date.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="col-12">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">ملاحظات</label>
                                {% render_field form.notes class="form-control" rows="3" %}
                                {% if form.notes.errors %}
                                    <div class="text-danger small mt-1">{{ form.notes.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- سطور طلب البيع -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list ms-2"></i>
                            سطور طلب البيع
                        </h5>
                    </div>
                    <div class="card-body">
                        {{ formset.management_form }}
                        {% if formset.non_form_errors %}
                            <div class="alert alert-danger">
                                {{ formset.non_form_errors }}
                            </div>
                        {% endif %}

                        <div id="formset-container">
                            {% for form in formset %}
                            <div class="formset-row" data-form-idx="{{ forloop.counter0 }}">
                                {% if not forloop.first %}
                                <button type="button" class="btn btn-sm btn-danger delete-row delete-formset-row">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}

                                <div class="row g-3">
                                    <!-- Hidden fields -->
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}

                                    <div class="col-md-6">
                                        <label class="form-label required">الصنف</label>
                                        {% render_field form.item class="form-control select2 item-select" %}
                                        {% if form.item.errors %}
                                            <div class="text-danger small mt-1">{{ form.item.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-2">
                                        <label class="form-label required">الكمية</label>
                                        {% render_field form.quantity class="form-control quantity-input" %}
                                        {% if form.quantity.errors %}
                                            <div class="text-danger small mt-1">{{ form.quantity.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-2">
                                        <label class="form-label required">سعر الوحدة</label>
                                        {% render_field form.unit_price class="form-control unit-price-input" %}
                                        {% if form.unit_price.errors %}
                                            <div class="text-danger small mt-1">{{ form.unit_price.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-2">
                                        <label class="form-label">الإجمالي</label>
                                        <input type="text" class="form-control line-total" readonly value="0.00">
                                    </div>

                                    {% if form.DELETE %}
                                    <div class="col-12 d-none">
                                        {% render_field form.DELETE %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <button type="button" class="btn btn-success mt-3" id="add-formset-row">
                            <i class="fas fa-plus ms-2"></i>
                            إضافة سطر جديد
                        </button>
                    </div>
                </div>
            </div>

            <!-- ملخص المبالغ -->
            <div class="col-lg-4">
                <div class="card shadow-sm border-0 mb-4 sticky-top" style="top: 20px;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator ms-2"></i>
                            الإجمالي
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="total-section">
                            <div class="d-flex justify-content-between">
                                <span class="h5">الإجمالي:</span>
                                <span id="grand-total" class="h5 fw-bold text-success">0.00</span>
                            </div>
                        </div>

                        <!-- أزرار الإجراءات -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary w-100 mb-2">
                                <i class="fas fa-save ms-2"></i>
                                حفظ طلب البيع
                            </button>
                            <a href="{% url 'sales:order_list' %}" class="btn btn-secondary w-100">
                                <i class="fas fa-times ms-2"></i>
                                إلغاء
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Empty formset template -->
<div id="empty-formset-template" class="d-none">
    <div class="formset-row" data-form-idx="__prefix__">
        <button type="button" class="btn btn-sm btn-danger delete-row delete-formset-row">
            <i class="fas fa-times"></i>
        </button>

        <div class="row g-3">
            {{ formset.empty_form.as_p }}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ar.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2
    function initializeSelect2() {
        $('.select2').select2({
            theme: 'bootstrap-5',
            language: 'ar',
            dir: 'rtl',
            width: '100%'
        });
    }
    initializeSelect2();

    // Set today's date as default if empty
    const dateInput = $('#id_date');
    if (!dateInput.val()) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.val(today);
    }

    // Calculate line total
    function calculateLineTotal(row) {
        const quantity = parseFloat(row.find('.quantity-input').val()) || 0;
        const unitPrice = parseFloat(row.find('.unit-price-input').val()) || 0;

        const total = quantity * unitPrice;

        row.find('.line-total').val(total.toFixed(2));
        calculateGrandTotal();
    }

    // Calculate grand total
    function calculateGrandTotal() {
        let grandTotal = 0;

        $('.formset-row').each(function() {
            const row = $(this);
            const deleteCheckbox = row.find('input[name$="-DELETE"]');

            if (!deleteCheckbox.is(':checked')) {
                const quantity = parseFloat(row.find('.quantity-input').val()) || 0;
                const unitPrice = parseFloat(row.find('.unit-price-input').val()) || 0;

                grandTotal += quantity * unitPrice;
            }
        });

        $('#grand-total').text(grandTotal.toFixed(2));
    }

    // Event listeners for calculation
    $(document).on('input', '.quantity-input, .unit-price-input', function() {
        const row = $(this).closest('.formset-row');
        calculateLineTotal(row);
    });

    // Add new formset row
    $('#add-formset-row').click(function() {
        const totalForms = $('#id_form-TOTAL_FORMS');
        const currentFormCount = parseInt(totalForms.val());
        const template = $('#empty-formset-template .formset-row').clone();

        // Replace __prefix__ with actual form number
        const newFormHtml = template.html().replace(/__prefix__/g, currentFormCount);
        template.html(newFormHtml);
        template.attr('data-form-idx', currentFormCount);

        $('#formset-container').append(template);
        totalForms.val(currentFormCount + 1);

        // Reinitialize Select2 for new row
        template.find('.select2').select2({
            theme: 'bootstrap-5',
            language: 'ar',
            dir: 'rtl',
            width: '100%'
        });

        calculateGrandTotal();
    });

    // Delete formset row
    $(document).on('click', '.delete-formset-row', function() {
        const row = $(this).closest('.formset-row');
        const deleteCheckbox = row.find('input[name$="-DELETE"]');

        if (deleteCheckbox.length) {
            deleteCheckbox.prop('checked', true);
            row.hide();
        } else {
            row.remove();
        }

        calculateGrandTotal();
    });

    // Initial calculation
    $('.formset-row').each(function() {
        calculateLineTotal($(this));
    });
    calculateGrandTotal();

    // Form validation before submit
    $('#orderForm').submit(function(e) {
        let hasValidLine = false;

        $('.formset-row').each(function() {
            const row = $(this);
            const deleteCheckbox = row.find('input[name$="-DELETE"]');
            const itemSelect = row.find('.item-select');

            if (!deleteCheckbox.is(':checked') && itemSelect.val()) {
                hasValidLine = true;
            }
        });

        if (!hasValidLine) {
            e.preventDefault();
            alert('يجب إضافة سطر واحد على الأقل لطلب البيع');
            return false;
        }
    });
});
</script>
{% endblock %}
