{# apps/sales/templates/sales/pos/pos_interface.html #}
{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
body {
    overflow: hidden;
}

.pos-container {
    height: calc(100vh - 60px);
    display: flex;
    flex-direction: column;
}

.pos-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem;
    flex-shrink: 0;
}

.pos-body {
    flex: 1;
    display: flex;
    overflow: hidden;
}

.pos-items-panel {
    flex: 2;
    padding: 1rem;
    overflow-y: auto;
    background: #f8f9fa;
}

.pos-cart-panel {
    flex: 1;
    background: white;
    border-left: 2px solid #dee2e6;
    display: flex;
    flex-direction: column;
}

.cart-header {
    padding: 1rem;
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.cart-items {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
}

.cart-footer {
    padding: 1rem;
    background: #f8f9fa;
    border-top: 2px solid #dee2e6;
}

.barcode-input {
    font-size: 1.5rem;
    height: 60px;
    text-align: center;
    border: 3px solid #0d6efd;
}

.barcode-input:focus {
    border-color: #0a58ca;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.cart-item {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s;
}

.cart-item:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
}

.cart-item-name {
    font-weight: 600;
    color: #212529;
    margin-bottom: 0.25rem;
}

.cart-item-details {
    font-size: 0.875rem;
    color: #6c757d;
}

.cart-total {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

.cart-total-amount {
    font-size: 2rem;
    font-weight: 700;
}

.btn-checkout {
    font-size: 1.25rem;
    padding: 1rem;
}

.session-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.session-badge {
    background: rgba(255,255,255,0.2);
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
}

.quick-amounts {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    margin-top: 1rem;
}

.quick-amount-btn {
    padding: 0.75rem;
    font-size: 0.875rem;
}

.empty-cart {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
}

.empty-cart i {
    font-size: 4rem;
    opacity: 0.3;
    margin-bottom: 1rem;
}

.item-quantity-input {
    width: 80px;
    text-align: center;
}

.remove-item-btn {
    cursor: pointer;
    color: #dc3545;
}

.remove-item-btn:hover {
    color: #bb2d3b;
}
</style>
{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- POS Header -->
    <div class="pos-header">
        <div class="session-info">
            <div>
                <h4 class="mb-1">
                    <i class="fas fa-cash-register me-2"></i>
                    نقطة البيع
                </h4>
                <p class="mb-0 opacity-75">{{ session.cashier.get_full_name }} - {{ session.branch.name }}</p>
            </div>
            <div class="session-badge">
                <strong>جلسة: {{ session.session_number }}</strong><br>
                <small>{{ session.opening_datetime|date:"Y-m-d H:i" }}</small>
            </div>
            <div class="text-end">
                <div class="mb-1">
                    <strong>{{ session.transactions_count }}</strong> معاملة
                </div>
                <div>
                    <strong>{{ session.total_sales|floatformat:2 }}</strong> دينار
                </div>
            </div>
            <div>
                <a href="{% url 'sales:pos_session_close' session.pk %}" class="btn btn-warning">
                    <i class="fas fa-door-closed me-1"></i> إغلاق الجلسة
                </a>
                <a href="{% url 'sales:pos_session_list' %}" class="btn btn-light ms-2">
                    <i class="fas fa-arrow-right me-1"></i> الجلسات
                </a>
            </div>
        </div>
    </div>

    <!-- POS Body -->
    <div class="pos-body">
        <!-- Items Panel -->
        <div class="pos-items-panel">
            <!-- Barcode Scanner -->
            <div class="mb-4">
                <label class="form-label">
                    <i class="fas fa-barcode me-2"></i>
                    امسح الباركود أو اكتب كود المادة
                </label>
                <input type="text" id="barcodeInput" class="form-control barcode-input"
                       placeholder="امسح الباركود أو اكتب الكود..." autofocus>
            </div>

            <!-- Customer & Payment Method -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label">العميل</label>
                    <select id="customerSelect" class="form-select">
                        <option value="">عميل نقدي (افتراضي)</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">طريقة الدفع</label>
                    <select id="paymentMethodSelect" class="form-select">
                        {% for method in payment_methods %}
                        <option value="{{ method.id }}" {% if method == default_payment_method %}selected{% endif %}>
                            {{ method.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Discount -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label">نوع الخصم</label>
                    <select id="discountType" class="form-select">
                        <option value="percentage">نسبة مئوية %</option>
                        <option value="amount">مبلغ</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">قيمة الخصم</label>
                    <input type="number" id="discountValue" class="form-control" value="0" min="0" step="0.001">
                </div>
                <div class="col-md-4">
                    <label class="form-label">مبلغ الخصم</label>
                    <input type="text" id="discountAmount" class="form-control" readonly value="0.000">
                </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
                <label class="form-label">ملاحظات الفاتورة</label>
                <textarea id="invoiceNotes" class="form-control" rows="2"
                          placeholder="ملاحظات إضافية (اختياري)"></textarea>
            </div>
        </div>

        <!-- Cart Panel -->
        <div class="pos-cart-panel">
            <!-- Cart Header -->
            <div class="cart-header">
                <h5 class="mb-0">
                    <i class="fas fa-shopping-cart me-2"></i>
                    سلة المشتريات
                    <span id="cartItemCount" class="badge bg-primary">0</span>
                </h5>
            </div>

            <!-- Cart Items -->
            <div class="cart-items" id="cartItemsContainer">
                <div class="empty-cart">
                    <i class="fas fa-shopping-basket"></i>
                    <p>السلة فارغة</p>
                    <small>امسح الباركود لإضافة مواد</small>
                </div>
            </div>

            <!-- Cart Footer -->
            <div class="cart-footer">
                <!-- Subtotal -->
                <div class="d-flex justify-content-between mb-2">
                    <span>المجموع الفرعي:</span>
                    <strong id="cartSubtotal">0.000</strong>
                </div>

                <!-- Discount -->
                <div class="d-flex justify-content-between mb-2 text-danger">
                    <span>الخصم:</span>
                    <strong id="cartDiscount">0.000</strong>
                </div>

                <!-- Total -->
                <div class="cart-total">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>الإجمالي:</span>
                        <span class="cart-total-amount" id="cartTotal">0.000</span>
                    </div>
                </div>

                <!-- Checkout Buttons -->
                <div class="d-grid gap-2">
                    <button id="checkoutBtn" class="btn btn-success btn-checkout" disabled>
                        <i class="fas fa-check-circle me-2"></i>
                        إتمام البيع
                    </button>
                    <button id="clearCartBtn" class="btn btn-outline-danger">
                        <i class="fas fa-trash me-2"></i>
                        إفراغ السلة
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Cart data
    let cart = [];
    const sessionId = {{ session.id }};

    // Initialize
    updateCartDisplay();

    // Barcode input handler
    $('#barcodeInput').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            const barcode = $(this).val().trim();
            if (barcode) {
                searchAndAddItem(barcode);
                $(this).val('').focus();
            }
        }
    });

    // Search and add item
    function searchAndAddItem(barcode) {
        $.ajax({
            url: '{% url "sales:pos_search_item" %}',
            method: 'GET',
            data: { q: barcode },
            success: function(response) {
                if (response.success) {
                    addItemToCart(response.item);
                } else {
                    showError(response.message);
                }
            },
            error: function() {
                showError('حدث خطأ في البحث عن المادة');
            }
        });
    }

    // Add item to cart
    function addItemToCart(item) {
        // Check if item already in cart
        const existingItem = cart.find(i => i.id === item.id);

        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({
                id: item.id,
                code: item.code,
                name: item.name,
                unit_price: parseFloat(item.selling_price),
                quantity: 1,
                discount_percentage: 0
            });
        }

        updateCartDisplay();
        playBeep();
    }

    // Update cart display
    function updateCartDisplay() {
        const container = $('#cartItemsContainer');

        if (cart.length === 0) {
            container.html(`
                <div class="empty-cart">
                    <i class="fas fa-shopping-basket"></i>
                    <p>السلة فارغة</p>
                    <small>امسح الباركود لإضافة مواد</small>
                </div>
            `);
            $('#cartItemCount').text('0');
            $('#checkoutBtn').prop('disabled', true);
        } else {
            let html = '';
            cart.forEach((item, index) => {
                const lineTotal = item.quantity * item.unit_price;
                const discountAmount = lineTotal * item.discount_percentage / 100;
                const netAmount = lineTotal - discountAmount;

                html += `
                    <div class="cart-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="cart-item-name flex-grow-1">${item.name}</div>
                            <span class="remove-item-btn" data-index="${index}">
                                <i class="fas fa-times-circle fa-lg"></i>
                            </span>
                        </div>
                        <div class="cart-item-details">
                            <div class="row g-2 mb-2">
                                <div class="col-4">
                                    <small class="d-block text-muted">الكمية</small>
                                    <input type="number" class="form-control form-control-sm item-quantity-input"
                                           value="${item.quantity}" min="0.001" step="0.001"
                                           data-index="${index}">
                                </div>
                                <div class="col-4">
                                    <small class="d-block text-muted">السعر</small>
                                    <input type="number" class="form-control form-control-sm item-price-input"
                                           value="${item.unit_price}" min="0" step="0.001"
                                           data-index="${index}">
                                </div>
                                <div class="col-4">
                                    <small class="d-block text-muted">خصم %</small>
                                    <input type="number" class="form-control form-control-sm item-discount-input"
                                           value="${item.discount_percentage}" min="0" max="100" step="0.01"
                                           data-index="${index}">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>الإجمالي:</span>
                                <strong>${netAmount.toFixed(3)} د.أ</strong>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.html(html);
            $('#cartItemCount').text(cart.length);
            $('#checkoutBtn').prop('disabled', false);

            // Attach event handlers
            $('.item-quantity-input').on('change', function() {
                const index = $(this).data('index');
                cart[index].quantity = parseFloat($(this).val());
                updateCartTotals();
            });

            $('.item-price-input').on('change', function() {
                const index = $(this).data('index');
                cart[index].unit_price = parseFloat($(this).val());
                updateCartTotals();
            });

            $('.item-discount-input').on('change', function() {
                const index = $(this).data('index');
                cart[index].discount_percentage = parseFloat($(this).val());
                updateCartTotals();
            });

            $('.remove-item-btn').on('click', function() {
                const index = $(this).data('index');
                cart.splice(index, 1);
                updateCartDisplay();
            });
        }

        updateCartTotals();
    }

    // Update cart totals
    function updateCartTotals() {
        let subtotal = 0;

        cart.forEach(item => {
            const lineTotal = item.quantity * item.unit_price;
            const discountAmount = lineTotal * item.discount_percentage / 100;
            subtotal += (lineTotal - discountAmount);
        });

        // Invoice discount
        const discountType = $('#discountType').val();
        const discountValue = parseFloat($('#discountValue').val()) || 0;
        let invoiceDiscount = 0;

        if (discountType === 'percentage') {
            invoiceDiscount = subtotal * discountValue / 100;
        } else {
            invoiceDiscount = discountValue;
        }

        const total = subtotal - invoiceDiscount;

        $('#cartSubtotal').text(subtotal.toFixed(3));
        $('#cartDiscount').text(invoiceDiscount.toFixed(3));
        $('#discountAmount').val(invoiceDiscount.toFixed(3));
        $('#cartTotal').text(total.toFixed(3));
    }

    // Discount change handlers
    $('#discountType, #discountValue').on('change', updateCartTotals);

    // Clear cart
    $('#clearCartBtn').on('click', function() {
        if (confirm('هل أنت متأكد من إفراغ السلة؟')) {
            cart = [];
            updateCartDisplay();
        }
    });

    // Checkout
    $('#checkoutBtn').on('click', function() {
        if (cart.length === 0) {
            showError('السلة فارغة');
            return;
        }

        const customerId = $('#customerSelect').val() || null;
        const paymentMethodId = $('#paymentMethodSelect').val();
        const discountType = $('#discountType').val();
        const discountValue = parseFloat($('#discountValue').val()) || 0;
        const notes = $('#invoiceNotes').val();

        const data = {
            customer_id: customerId,
            payment_method_id: paymentMethodId,
            discount_type: discountType,
            discount_value: discountValue,
            notes: notes,
            items: cart.map(item => ({
                item_id: item.id,
                quantity: item.quantity,
                unit_price: item.unit_price,
                discount_percentage: item.discount_percentage
            }))
        };

        // Disable button
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...');

        $.ajax({
            url: `/sales/pos/${sessionId}/create-invoice/`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showSuccess('تم إنشاء الفاتورة بنجاح: ' + response.invoice_number);

                    // Clear cart
                    cart = [];
                    updateCartDisplay();
                    $('#invoiceNotes').val('');
                    $('#discountValue').val('0');
                    $('#barcodeInput').focus();

                    // Update session totals
                    location.reload();
                } else {
                    showError(response.message);
                    $('#checkoutBtn').prop('disabled', false).html('<i class="fas fa-check-circle me-2"></i>إتمام البيع');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showError(response && response.message ? response.message : 'حدث خطأ في إنشاء الفاتورة');
                $('#checkoutBtn').prop('disabled', false).html('<i class="fas fa-check-circle me-2"></i>إتمام البيع');
            }
        });
    });

    // Helper functions
    function showError(message) {
        alert('خطأ: ' + message);
        playError();
    }

    function showSuccess(message) {
        alert(message);
        playSuccess();
    }

    function playBeep() {
        // Simple beep sound (can be replaced with actual sound file)
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhB');
        audio.play();
    }

    function playSuccess() {
        // Success sound
    }

    function playError() {
        // Error sound
    }

    // Auto-focus barcode input
    setInterval(function() {
        if (!$('input:focus').length && !$('select:focus').length && !$('textarea:focus').length) {
            $('#barcodeInput').focus();
        }
    }, 1000);
});
</script>
{% endblock %}
