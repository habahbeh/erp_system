{% extends 'assets/base_asset.html' %}
{% load static i18n %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                {% else %}
                    <li class="breadcrumb-item"><a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a></li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-boxes text-primary"></i> {{ title }}
            </h1>
            <p class="text-muted mb-0">نظرة شاملة على الأصول الثابتة والصيانة</p>
        </div>
        <div class="btn-group no-print">
            <a href="{% url 'assets:asset_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> أصل جديد
            </a>
            <a href="{% url 'assets:asset_list' %}" class="btn btn-outline-primary">
                <i class="fas fa-list"></i> سجل الأصول
            </a>
        </div>
    </div>

    <!-- Stats Cards Row 1 - الأصول -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="me-auto">
                            <h6 class="text-muted mb-1">إجمالي الأصول</h6>
                            <h3 class="mb-0">{{ assets_stats.total_count }}</h3>
                            <small class="text-success">
                                <i class="fas fa-check-circle"></i>
                                {{ assets_stats.active_count }} نشط
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-success bg-opacity-10 text-success">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="me-auto">
                            <h6 class="text-muted mb-1">التكلفة الأصلية</h6>
                            <h3 class="mb-0">{{ assets_stats.total_cost|floatformat:0 }}</h3>
                            <small class="text-muted">دينار أردني</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="me-auto">
                            <h6 class="text-muted mb-1">الإهلاك المتراكم</h6>
                            <h3 class="mb-0">{{ assets_stats.total_depreciation|floatformat:0 }}</h3>
                            <small class="text-muted">دينار أردني</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-info bg-opacity-10 text-info">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="me-auto">
                            <h6 class="text-muted mb-1">القيمة الدفترية</h6>
                            <h3 class="mb-0">{{ assets_stats.total_book_value|floatformat:0 }}</h3>
                            <small class="text-muted">دينار أردني</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards Row 2 - الصيانة -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-wrench"></i>
                        </div>
                        <div class="me-auto">
                            <h6 class="text-muted mb-1">إجمالي الصيانة</h6>
                            <h3 class="mb-0">{{ maintenance_stats.total_count }}</h3>
                            <small class="text-info">
                                <i class="fas fa-calendar"></i>
                                {{ maintenance_stats.scheduled_count }} مجدولة
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-spinner"></i>
                        </div>
                        <div class="me-auto">
                            <h6 class="text-muted mb-1">صيانة جارية</h6>
                            <h3 class="mb-0">{{ maintenance_stats.in_progress_count }}</h3>
                            <small class="text-muted">تحت التنفيذ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-success bg-opacity-10 text-success">
                            <i class="fas fa-check-double"></i>
                        </div>
                        <div class="me-auto">
                            <h6 class="text-muted mb-1">صيانة مكتملة</h6>
                            <h3 class="mb-0">{{ maintenance_stats.completed_count }}</h3>
                            <small class="text-muted">منجزة</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-danger bg-opacity-10 text-danger">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="me-auto">
                            <h6 class="text-muted mb-1">تكلفة الشهر</h6>
                            <h3 class="mb-0">{{ maintenance_stats.this_month_cost|floatformat:0 }}</h3>
                            <small class="text-muted">دينار أردني</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <!-- الأصول حسب الفئة -->
        <div class="col-xl-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie text-primary"></i>
                        الأصول حسب الفئة
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="assetsByCategoryChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- الأصول حسب الحالة -->
        <div class="col-xl-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar text-success"></i>
                        الأصول حسب الحالة
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="assetsByStatusChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Row -->
    <div class="row g-4 mb-4">
        <!-- الصيانة القريبة -->
        {% if upcoming_maintenance %}
        <div class="col-xl-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock text-warning"></i>
                        الصيانة القريبة (30 يوم)
                    </h5>
                    <span class="badge bg-warning">{{ upcoming_maintenance|length }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for maintenance in upcoming_maintenance %}
                        <div class="list-group-item">
                            <div class="d-flex align-items-center">
                                <div class="alert-icon bg-warning bg-opacity-10 text-warning">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ maintenance.asset.name }}</h6>
                                    <small class="text-muted">
                                        {{ maintenance.maintenance_type.name }} - 
                                        {{ maintenance.scheduled_date }}
                                    </small>
                                </div>
                                <a href="{% url 'assets:maintenance_detail' maintenance.pk %}" 
                                   class="btn btn-sm btn-outline-primary">
                                    عرض
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-white text-center">
                    <a href="{% url 'assets:maintenance_list' %}" class="btn btn-sm btn-link">
                        عرض الكل <i class="fas fa-arrow-left"></i>
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- الصيانة المتأخرة -->
        {% if overdue_maintenance %}
        <div class="col-xl-6">
            <div class="card shadow-sm border-danger">
                <div class="card-header bg-danger bg-opacity-10 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        الصيانة المتأخرة
                    </h5>
                    <span class="badge bg-danger">{{ overdue_maintenance|length }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for maintenance in overdue_maintenance %}
                        <div class="list-group-item">
                            <div class="d-flex align-items-center">
                                <div class="alert-icon bg-danger bg-opacity-10 text-danger">
                                    <i class="fas fa-exclamation"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ maintenance.asset.name }}</h6>
                                    <small class="text-muted">
                                        {{ maintenance.maintenance_type.name }} - 
                                        <span class="text-danger">{{ maintenance.scheduled_date }}</span>
                                    </small>
                                </div>
                                <a href="{% url 'assets:maintenance_detail' maintenance.pk %}" 
                                   class="btn btn-sm btn-danger">
                                    معالجة
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- آخر العمليات -->
    {% if recent_transactions %}
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history text-info"></i>
                        آخر العمليات
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>رقم العملية</th>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>الأصل</th>
                                    <th>المبلغ</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trans in recent_transactions %}
                                <tr>
                                    <td><strong>{{ trans.transaction_number }}</strong></td>
                                    <td>{{ trans.transaction_date }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ trans.get_transaction_type_display }}</span>
                                    </td>
                                    <td>{{ trans.asset.name }}</td>
                                    <td>{{ trans.amount|floatformat:3 }}</td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block asset_extra_js %}
<script>
    // الأصول حسب الفئة - Pie Chart
    const categoryData = {{ assets_by_category|safe }};
    const categoryLabels = categoryData.map(item => item.category__name || 'غير محدد');
    const categoryValues = categoryData.map(item => item.total_book_value);
    
    new Chart(document.getElementById('assetsByCategoryChart'), {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryValues,
                backgroundColor: [
                    '#667eea', '#764ba2', '#f093fb', '#4facfe',
                    '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + formatNumber(context.parsed) + ' د.أ';
                        }
                    }
                }
            }
        }
    });
    
    // الأصول حسب الحالة - Bar Chart
    const statusData = {{ assets_by_status|safe }};
    const statusLabels = ['نشط', 'غير نشط', 'تحت الصيانة', 'مستبعد', 'مباع'];
    const statusValues = statusData.map(item => item.count);
    
    new Chart(document.getElementById('assetsByStatusChart'), {
        type: 'bar',
        data: {
            labels: statusLabels,
            datasets: [{
                label: 'عدد الأصول',
                data: statusValues,
                backgroundColor: '#667eea'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
</script>
{% endblock %}