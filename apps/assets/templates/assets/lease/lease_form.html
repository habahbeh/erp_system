{# apps/assets/templates/assets/lease/lease_form.html #}
{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
/* Select2 RTL Styles */
.select2-container--bootstrap-5 .select2-selection--single {
    background-image: none !important;
    background-color: #fff !important;
    padding: 0.375rem 0.75rem !important;
    direction: rtl;
    text-align: right;
    min-height: 38px;
    display: flex;
    align-items: center;
}

select[data-select2-id] {
    background-image: none !important;
}

.select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
    position: absolute;
    left: auto !important;
    right: 8px !important;
    top: 50% !important;
    transform: translateY(-50%);
}

.select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
    padding-left: 0 !important;
    padding-right: 35px !important;
    text-align: right;
    direction: rtl;
}

.select2-container--bootstrap-5 .select2-dropdown {
    direction: rtl;
    text-align: right;
}

.select2-container--bootstrap-5 .select2-results__options {
    text-align: right;
    direction: rtl;
}

.required:after {
    content: " *";
    color: red;
}

.form-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.form-section-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                    </li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-contract"></i>
                        {{ title }}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="leaseForm" novalidate>
                        {% csrf_token %}

                        <!-- Basic Information -->
                        <div class="form-section">
                            <h6 class="form-section-title">
                                <i class="fas fa-info-circle"></i> {% trans "المعلومات الأساسية" %}
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label required">{% trans "رقم العقد" %}</label>
                                    {{ form.lease_number }}
                                    {% if form.lease_number.errors %}
                                        <div class="text-danger small mt-1">{{ form.lease_number.errors.0 }}</div>
                                    {% endif %}
                                    <small class="text-muted">{% trans "يُنشأ تلقائياً إذا ترك فارغاً" %}</small>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label required">{% trans "الأصل" %}</label>
                                    {{ form.asset }}
                                    {% if form.asset.errors %}
                                        <div class="text-danger small mt-1">{{ form.asset.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label required">{% trans "المؤجر" %}</label>
                                    {{ form.lessor }}
                                    {% if form.lessor.errors %}
                                        <div class="text-danger small mt-1">{{ form.lessor.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">{% trans "معلومات الاتصال" %}</label>
                                    {{ form.lessor_contact }}
                                    {% if form.lessor_contact.errors %}
                                        <div class="text-danger small mt-1">{{ form.lessor_contact.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label required">{% trans "نوع الإيجار" %}</label>
                                    {{ form.lease_type }}
                                    {% if form.lease_type.errors %}
                                        <div class="text-danger small mt-1">{{ form.lease_type.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label required">{% trans "الحالة" %}</label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                        <div class="text-danger small mt-1">{{ form.status.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Dates Section -->
                        <div class="form-section">
                            <h6 class="form-section-title">
                                <i class="fas fa-calendar-alt"></i> {% trans "التواريخ" %}
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label required">{% trans "تاريخ بداية العقد" %}</label>
                                    {{ form.start_date }}
                                    {% if form.start_date.errors %}
                                        <div class="text-danger small mt-1">{{ form.start_date.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label required">{% trans "تاريخ نهاية العقد" %}</label>
                                    {{ form.end_date }}
                                    {% if form.end_date.errors %}
                                        <div class="text-danger small mt-1">{{ form.end_date.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">{% trans "دورية الدفع" %}</label>
                                    {{ form.payment_frequency }}
                                    {% if form.payment_frequency.errors %}
                                        <div class="text-danger small mt-1">{{ form.payment_frequency.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Financial Details -->
                        <div class="form-section">
                            <h6 class="form-section-title">
                                <i class="fas fa-dollar-sign"></i> {% trans "التفاصيل المالية" %}
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label required">{% trans "القيمة الشهرية" %}</label>
                                    <div class="input-group">
                                        {{ form.monthly_payment }}
                                        <span class="input-group-text">{% trans "د.ك" %}</span>
                                    </div>
                                    {% if form.monthly_payment.errors %}
                                        <div class="text-danger small mt-1">{{ form.monthly_payment.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">{% trans "مبلغ التأمين" %}</label>
                                    <div class="input-group">
                                        {{ form.security_deposit }}
                                        <span class="input-group-text">{% trans "د.ك" %}</span>
                                    </div>
                                    {% if form.security_deposit.errors %}
                                        <div class="text-danger small mt-1">{{ form.security_deposit.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label required">{% trans "يوم الدفع" %}</label>
                                    {{ form.payment_day }}
                                    {% if form.payment_day.errors %}
                                        <div class="text-danger small mt-1">{{ form.payment_day.errors.0 }}</div>
                                    {% endif %}
                                    <small class="text-muted">{% trans "من 1 إلى 28" %}</small>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Details -->
                        <div class="form-section">
                            <h6 class="form-section-title">
                                <i class="fas fa-clipboard-list"></i> {% trans "تفاصيل إضافية" %}
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">{% trans "خيار التجديد" %}</label>
                                    {{ form.renewal_option }}
                                    {% if form.renewal_option.errors %}
                                        <div class="text-danger small mt-1">{{ form.renewal_option.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">{% trans "فترة الإشعار (بالأيام)" %}</label>
                                    {{ form.notice_period_days }}
                                    {% if form.notice_period_days.errors %}
                                        <div class="text-danger small mt-1">{{ form.notice_period_days.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-12">
                                    <label class="form-label">{% trans "شروط العقد" %}</label>
                                    {{ form.terms }}
                                    {% if form.terms.errors %}
                                        <div class="text-danger small mt-1">{{ form.terms.errors.0 }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-12">
                                    <label class="form-label">{% trans "ملاحظات" %}</label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                        <div class="text-danger small mt-1">{{ form.notes.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> {{ submit_text|default:"حفظ" }}
                                </button>
                                <a href="{% url 'assets:lease_list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> {% trans "إلغاء" %}
                                </a>
                            </div>
                            {% if is_update %}
                            <div>
                                <span class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    {% trans "آخر تحديث" %}: {{ object.updated_at|date:"Y-m-d H:i" }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 for asset selection
    $('#id_asset').select2({
        theme: 'bootstrap-5',
        dir: 'rtl',
        placeholder: '{% trans "اختر الأصل" %}',
        allowClear: true,
        width: '100%'
    });

    // Initialize Select2 for other select fields
    $('select').not('#id_asset').each(function() {
        if (!$(this).hasClass('select2-hidden-accessible')) {
            $(this).select2({
                theme: 'bootstrap-5',
                dir: 'rtl',
                minimumResultsForSearch: Infinity,
                width: '100%'
            });
        }
    });

    // Date validation
    $('#id_start_date, #id_end_date').change(function() {
        const startDate = new Date($('#id_start_date').val());
        const endDate = new Date($('#id_end_date').val());

        if (startDate && endDate && endDate <= startDate) {
            Swal.fire({
                icon: 'warning',
                title: '{% trans "تحذير" %}',
                text: '{% trans "تاريخ النهاية يجب أن يكون بعد تاريخ البداية" %}',
                confirmButtonText: '{% trans "حسناً" %}'
            });
        }
    });

    // Payment day validation
    $('#id_payment_day').on('input', function() {
        let value = parseInt($(this).val());
        if (value < 1) {
            $(this).val(1);
        } else if (value > 28) {
            $(this).val(28);
        }
    });

    // Form validation
    $('#leaseForm').submit(function(e) {
        let isValid = true;
        const requiredFields = $(this).find('[required]');

        requiredFields.each(function() {
            if (!$(this).val()) {
                isValid = false;
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        if (!isValid) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: '{% trans "خطأ" %}',
                text: '{% trans "يرجى ملء جميع الحقول المطلوبة" %}',
                confirmButtonText: '{% trans "حسناً" %}'
            });
            return false;
        }
    });
});
</script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}
