<!-- Path: apps/assets/templates/assets/assets/asset_form.html -->
{% extends 'assets/base_asset.html' %}
{% load static i18n widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                {% else %}
                    <li class="breadcrumb-item"><a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a></li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-4">
        <h1 class="h3 mb-1">
            <i class="fas fa-box text-primary"></i> {{ title }}
        </h1>
        <p class="text-muted mb-0">املأ جميع الحقول المطلوبة بعناية</p>
    </div>

    <form method="post" enctype="multipart/form-data" id="assetForm">
        {% csrf_token %}

        <div class="row">
            <div class="col-xl-9">
                <!-- المعلومات الأساسية -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary bg-opacity-10">
                        <h5 class="mb-0 text-primary">
                            <i class="fas fa-info-circle"></i> المعلومات الأساسية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label required">اسم الأصل</label>
                                {{ form.name|add_class:"form-control"|attr:"required" }}
                                {% if form.name.errors %}
                                    <div class="text-danger small mt-1">{{ form.name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">الاسم الإنجليزي</label>
                                {{ form.name_en|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required">الفئة</label>
                                {{ form.category|add_class:"form-select"|attr:"required" }}
                                {% if form.category.errors %}
                                    <div class="text-danger small mt-1">{{ form.category.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">الحالة</label>
                                {{ form.condition|add_class:"form-select" }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">حالة النشاط</label>
                                {{ form.status|add_class:"form-select" }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- معلومات الشراء -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success bg-opacity-10">
                        <h5 class="mb-0 text-success">
                            <i class="fas fa-shopping-cart"></i> معلومات الشراء
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label required">تاريخ الشراء</label>
                                {{ form.purchase_date|add_class:"form-control"|attr:"required" }}
                                {% if form.purchase_date.errors %}
                                    <div class="text-danger small mt-1">{{ form.purchase_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">رقم فاتورة الشراء</label>
                                {{ form.purchase_invoice_number|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">المورد</label>
                                {{ form.supplier|add_class:"form-select" }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- المعلومات المالية -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h5 class="mb-0 text-warning">
                            <i class="fas fa-dollar-sign"></i> المعلومات المالية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label required">التكلفة الأصلية (د.أ)</label>
                                {{ form.original_cost|add_class:"form-control"|attr:"required" }}
                                {% if form.original_cost.errors %}
                                    <div class="text-danger small mt-1">{{ form.original_cost.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">القيمة المتبقية (التخريدية) (د.أ)</label>
                                {{ form.salvage_value|add_class:"form-control" }}
                                <small class="form-text text-muted">القيمة المتوقعة في نهاية العمر الافتراضي</small>
                                {% if form.salvage_value.errors %}
                                    <div class="text-danger small mt-1">{{ form.salvage_value.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- معلومات الإهلاك -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-danger bg-opacity-10">
                        <h5 class="mb-0 text-danger">
                            <i class="fas fa-chart-line"></i> معلومات الإهلاك
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label required">طريقة الإهلاك</label>
                                {{ form.depreciation_method|add_class:"form-select"|attr:"required" }}
                                {% if form.depreciation_method.errors %}
                                    <div class="text-danger small mt-1">{{ form.depreciation_method.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required">العمر الافتراضي (بالأشهر)</label>
                                {{ form.useful_life_months|add_class:"form-control"|attr:"required" }}
                                <small class="form-text text-muted">مثال: 60 شهر = 5 سنوات</small>
                                {% if form.useful_life_months.errors %}
                                    <div class="text-danger small mt-1">{{ form.useful_life_months.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required">تاريخ بدء الإهلاك</label>
                                {{ form.depreciation_start_date|add_class:"form-control"|attr:"required" }}
                                {% if form.depreciation_start_date.errors %}
                                    <div class="text-danger small mt-1">{{ form.depreciation_start_date.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- لوحدات الإنتاج فقط -->
                            <div class="col-12">
                                <div class="alert alert-info" id="unitsProductionFields" style="display: none;">
                                    <h6 class="alert-heading">وحدات الإنتاج</h6>
                                    <p class="mb-2">هذه الحقول مطلوبة لطريقة وحدات الإنتاج فقط</p>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">إجمالي الوحدات المتوقعة</label>
                                            {{ form.total_expected_units|add_class:"form-control" }}
                                            <small class="form-text">مثال: 200,000 كيلومتر</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">اسم الوحدة</label>
                                            {{ form.unit_name|add_class:"form-control" }}
                                            <small class="form-text">مثال: كيلومتر، ساعة، قطعة</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- الموقع والمسؤولية -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info bg-opacity-10">
                        <h5 class="mb-0 text-info">
                            <i class="fas fa-map-marker-alt"></i> الموقع والمسؤولية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">مركز التكلفة</label>
                                {{ form.cost_center|add_class:"form-select" }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">الموظف المسؤول</label>
                                {{ form.responsible_employee|add_class:"form-select" }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">الموقع الفعلي</label>
                                {{ form.physical_location|add_class:"form-control" }}
                                <small class="form-text">مثال: مبنى أ - طابق 3 - مكتب 305</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- معلومات إضافية -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary bg-opacity-10">
                        <h5 class="mb-0 text-secondary">
                            <i class="fas fa-info"></i> معلومات إضافية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">الرقم التسلسلي</label>
                                {{ form.serial_number|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">الموديل</label>
                                {{ form.model|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">الشركة المصنعة</label>
                                {{ form.manufacturer|add_class:"form-control" }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- الضمان -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary bg-opacity-10">
                        <h5 class="mb-0 text-primary">
                            <i class="fas fa-shield-alt"></i> معلومات الضمان
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">تاريخ بدء الضمان</label>
                                {{ form.warranty_start_date|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">تاريخ انتهاء الضمان</label>
                                {{ form.warranty_end_date|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">مزود الضمان</label>
                                {{ form.warranty_provider|add_class:"form-control" }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- الوصف والملاحظات -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-sticky-note"></i> الوصف والملاحظات
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">الوصف</label>
                                {{ form.description|add_class:"form-control" }}
                            </div>
                            <div class="col-12">
                                <label class="form-label">ملاحظات</label>
                                {{ form.notes|add_class:"form-control" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-xl-3">
                <!-- Actions -->
                <div class="card shadow-sm mb-4 sticky-top" style="top: 20px;">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-cog"></i> الإجراءات
                        </h6>
                    </div>
                    <div class="card-body">
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-save"></i> حفظ الأصل
                        </button>
                        <a href="{% url 'assets:asset_list' %}" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-times"></i> إلغاء
                        </a>
                    </div>
                </div>

                <!-- Help Card -->
                <div class="card shadow-sm bg-light">
                    <div class="card-body">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-question-circle"></i> مساعدة
                        </h6>
                        <ul class="list-unstyled small">
                            <li class="mb-2">
                                <i class="fas fa-check text-success"></i>
                                <strong>الحقول المطلوبة:</strong> اسم الأصل، الفئة، تاريخ الشراء، التكلفة، طريقة الإهلاك
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-info-circle text-info"></i>
                                <strong>رقم الأصل:</strong> يتم توليده تلقائياً عند الحفظ
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                <strong>القيمة المتبقية:</strong> يجب أن تكون أقل من التكلفة الأصلية
                            </li>
                            <li>
                                <i class="fas fa-lightbulb text-warning"></i>
                                <strong>وحدات الإنتاج:</strong> اختر هذه الطريقة للأصول التي تُهلك حسب الاستخدام
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block asset_extra_js %}
<script>
$(document).ready(function() {
    // إظهار/إخفاء حقول وحدات الإنتاج
    function toggleUnitsFields() {
        var selectedMethod = $('#id_depreciation_method option:selected').text();
        if (selectedMethod.includes('وحدات الإنتاج') || selectedMethod.includes('Units of Production')) {
            $('#unitsProductionFields').slideDown();
            $('#id_total_expected_units').attr('required', true);
            $('#id_unit_name').attr('required', true);
        } else {
            $('#unitsProductionFields').slideUp();
            $('#id_total_expected_units').removeAttr('required');
            $('#id_unit_name').removeAttr('required');
        }
    }

    // تنفيذ عند التحميل
    toggleUnitsFields();

    // تنفيذ عند التغيير
    $('#id_depreciation_method').on('change', toggleUnitsFields);

    // ملء تاريخ بدء الإهلاك بنفس تاريخ الشراء
    $('#id_purchase_date').on('change', function() {
        if (!$('#id_depreciation_start_date').val()) {
            $('#id_depreciation_start_date').val($(this).val());
        }
    });

    // التحقق من صحة النموذج
    $('#assetForm').on('submit', function(e) {
        var originalCost = parseFloat($('#id_original_cost').val()) || 0;
        var salvageValue = parseFloat($('#id_salvage_value').val()) || 0;

        if (salvageValue >= originalCost) {
            e.preventDefault();
            alert('تنبيه: القيمة المتبقية يجب أن تكون أقل من التكلفة الأصلية');
            return false;
        }
    });
});
</script>
{% endblock %}