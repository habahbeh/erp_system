{% extends 'base/base.html' %}
{% load static i18n %}

{% block extra_css %}
<style>
    #videoPreview {
        width: 100%;
        max-width: 640px;
        height: 480px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background-color: #000;
    }

    .scan-result {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .scanner-overlay {
        position: relative;
        display: inline-block;
    }

    .scanner-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #00ff00, transparent);
        top: 50%;
        animation: scanLine 2s infinite;
    }

    @keyframes scanLine {
        0%, 100% {
            top: 20%;
        }
        50% {
            top: 80%;
        }
    }

    .asset-card {
        transition: all 0.3s ease;
    }

    .asset-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .scan-history-item {
        border-left: 3px solid #28a745;
        background-color: #f8f9fa;
    }

    .camera-selector {
        max-width: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between mb-4">
        <div>
            <h2><i class="fas fa-barcode text-primary"></i> {% trans "مسح الباركود - الجرد الفعلي" %}</h2>
            {% if count_cycle %}
            <p class="text-muted mb-0">
                <i class="fas fa-calendar"></i> {% trans "دورة الجرد:" %}
                <strong>{{ count_cycle.name }}</strong>
            </p>
            {% endif %}
        </div>
        <div>
            <a href="{% url 'assets:count_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "رجوع" %}
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Scanner Section -->
        <div class="col-lg-8">
            <!-- Scanner Controls -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-camera"></i> {% trans "الماسح الضوئي" %}</h5>
                </div>
                <div class="card-body">
                    <!-- Camera Selector -->
                    <div class="mb-3">
                        <label class="form-label">{% trans "اختر الكاميرا" %}</label>
                        <select id="cameraSelector" class="form-select camera-selector">
                            <option value="">{% trans "جاري التحميل..." %}</option>
                        </select>
                    </div>

                    <!-- Scanner Mode -->
                    <div class="mb-3">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="scanMode" id="cameraScan" value="camera" checked>
                            <label class="btn btn-outline-primary" for="cameraScan">
                                <i class="fas fa-camera"></i> {% trans "مسح بالكاميرا" %}
                            </label>

                            <input type="radio" class="btn-check" name="scanMode" id="manualEntry" value="manual">
                            <label class="btn btn-outline-primary" for="manualEntry">
                                <i class="fas fa-keyboard"></i> {% trans "إدخال يدوي" %}
                            </label>
                        </div>
                    </div>

                    <!-- Camera Video Preview -->
                    <div id="cameraSection" class="text-center mb-3">
                        <div class="scanner-overlay">
                            <video id="videoPreview" playsinline></video>
                            <div class="scanner-line"></div>
                        </div>
                        <div class="mt-3">
                            <button id="startScanBtn" class="btn btn-success btn-lg">
                                <i class="fas fa-play"></i> {% trans "بدء المسح" %}
                            </button>
                            <button id="stopScanBtn" class="btn btn-danger btn-lg d-none">
                                <i class="fas fa-stop"></i> {% trans "إيقاف المسح" %}
                            </button>
                        </div>
                    </div>

                    <!-- Manual Entry Section -->
                    <div id="manualSection" class="d-none">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">
                                <i class="fas fa-barcode"></i>
                            </span>
                            <input type="text" id="manualBarcodeInput" class="form-control"
                                   placeholder="{% trans 'امسح أو أدخل رقم الباركود' %}" autofocus>
                            <button class="btn btn-primary" type="button" id="manualSearchBtn">
                                <i class="fas fa-search"></i> {% trans "بحث" %}
                            </button>
                        </div>
                    </div>

                    <!-- Scan Status -->
                    <div id="scanStatus" class="alert alert-info mt-3" role="alert">
                        <i class="fas fa-info-circle"></i>
                        <span id="statusMessage">{% trans "جاهز للمسح" %}</span>
                    </div>
                </div>
            </div>

            <!-- Scanned Asset Details -->
            <div id="assetDetailsCard" class="card shadow-sm d-none">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-check-circle"></i> {% trans "تفاصيل الأصل" %}</h5>
                </div>
                <div class="card-body">
                    <div id="assetDetailsContent"></div>

                    <!-- Count Form -->
                    <form id="countForm" class="mt-4">
                        {% csrf_token %}
                        <input type="hidden" id="assetId" name="asset_id">
                        <input type="hidden" id="cycleId" name="cycle_id" value="{{ count_cycle.id }}">

                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">{% trans "الكمية المتوقعة" %}</label>
                                <input type="number" class="form-control" id="expectedQty" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{% trans "الكمية الفعلية" %}</label>
                                <input type="number" class="form-control" id="actualQty" name="actual_quantity"
                                       value="1" min="0" step="1" required>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">{% trans "الحالة" %}</label>
                                <select class="form-select" id="assetCondition" name="condition">
                                    <option value="good">{% trans "جيدة" %}</option>
                                    <option value="fair">{% trans "متوسطة" %}</option>
                                    <option value="poor">{% trans "سيئة" %}</option>
                                    <option value="damaged">{% trans "تالفة" %}</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{% trans "الموقع الفعلي" %}</label>
                                <input type="text" class="form-control" id="actualLocation" name="actual_location">
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">{% trans "ملاحظات" %}</label>
                            <textarea class="form-control" id="countNotes" name="notes" rows="2"></textarea>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">{% trans "إرفاق صورة" %}</label>
                            <input type="file" class="form-control" id="photoUpload" name="photo" accept="image/*" capture="environment">
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> {% trans "حفظ والمتابعة" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Scan History Sidebar -->
        <div class="col-lg-4">
            <!-- Statistics -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-bar"></i> {% trans "إحصائيات المسح" %}</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <h3 class="text-success mb-0" id="scannedCount">0</h3>
                            <small class="text-muted">{% trans "تم المسح" %}</small>
                        </div>
                        <div class="col-6 mb-3">
                            <h3 class="text-primary mb-0" id="totalCount">{{ total_assets|default:0 }}</h3>
                            <small class="text-muted">{% trans "الإجمالي" %}</small>
                        </div>
                        <div class="col-12">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-success" role="progressbar" id="progressBar"
                                     style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    0%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Scans -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-history"></i> {% trans "السجل الأخير" %}</h6>
                </div>
                <div class="card-body p-0">
                    <div id="scanHistoryList" class="list-group list-group-flush" style="max-height: 500px; overflow-y: auto;">
                        <div class="list-group-item text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="mb-0">{% trans "لا توجد عمليات مسح بعد" %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
$(document).ready(function() {
    let codeReader = new ZXing.BrowserBarcodeReader();
    let selectedDeviceId;
    let scannedAssets = [];

    // Initialize Camera Selector
    codeReader.listVideoInputDevices()
        .then((videoInputDevices) => {
            const sourceSelect = $('#cameraSelector');
            sourceSelect.empty();

            if (videoInputDevices.length > 0) {
                videoInputDevices.forEach((device) => {
                    const option = $('<option>')
                        .val(device.deviceId)
                        .text(device.label || 'Camera ' + (videoInputDevices.indexOf(device) + 1));
                    sourceSelect.append(option);
                });

                selectedDeviceId = videoInputDevices[0].deviceId;
            } else {
                sourceSelect.append('<option value="">{% trans "لا توجد كاميرا" %}</option>');
            }
        })
        .catch((err) => {
            console.error(err);
            updateStatus('{% trans "خطأ في الوصول للكاميرا" %}', 'danger');
        });

    // Camera Selector Change
    $('#cameraSelector').on('change', function() {
        selectedDeviceId = $(this).val();
    });

    // Scan Mode Toggle
    $('input[name="scanMode"]').on('change', function() {
        if ($(this).val() === 'camera') {
            $('#cameraSection').removeClass('d-none');
            $('#manualSection').addClass('d-none');
        } else {
            $('#cameraSection').addClass('d-none');
            $('#manualSection').removeClass('d-none');
            $('#manualBarcodeInput').focus();
        }
    });

    // Start Scanning
    $('#startScanBtn').on('click', function() {
        codeReader.decodeFromVideoDevice(selectedDeviceId, 'videoPreview', (result, err) => {
            if (result) {
                processBarcode(result.text);
                // Play beep sound
                playBeep();
            }
        });

        $(this).addClass('d-none');
        $('#stopScanBtn').removeClass('d-none');
        updateStatus('{% trans "جاري المسح..." %}', 'info');
    });

    // Stop Scanning
    $('#stopScanBtn').on('click', function() {
        codeReader.reset();
        $(this).addClass('d-none');
        $('#startScanBtn').removeClass('d-none');
        updateStatus('{% trans "تم إيقاف المسح" %}', 'warning');
    });

    // Manual Search
    $('#manualSearchBtn, #manualBarcodeInput').on('click keypress', function(e) {
        if (e.type === 'click' || e.which === 13) {
            e.preventDefault();
            const barcode = $('#manualBarcodeInput').val().trim();
            if (barcode) {
                processBarcode(barcode);
                $('#manualBarcodeInput').val('');
            }
        }
    });

    // Process Barcode
    function processBarcode(barcode) {
        updateStatus('{% trans "جاري البحث عن الأصل..." %}', 'info');

        $.ajax({
            url: '{% url "assets:barcode_scan_ajax" %}',
            type: 'POST',
            data: {
                barcode: barcode,
                cycle_id: $('#cycleId').val(),
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    displayAssetDetails(response.asset);
                    updateStatus('{% trans "تم العثور على الأصل!" %}', 'success');
                    playBeep();
                } else {
                    updateStatus(response.message || '{% trans "الأصل غير موجود" %}', 'danger');
                    playErrorBeep();
                }
            },
            error: function() {
                updateStatus('{% trans "خطأ في الاتصال" %}', 'danger');
                playErrorBeep();
            }
        });
    }

    // Display Asset Details
    function displayAssetDetails(asset) {
        const html = `
            <div class="row">
                <div class="col-md-4 text-center mb-3">
                    ${asset.image ?
                        '<img src="' + asset.image + '" class="img-fluid rounded" alt="' + asset.name + '">' :
                        '<div class="bg-light p-5 rounded"><i class="fas fa-cube fa-4x text-muted"></i></div>'
                    }
                </div>
                <div class="col-md-8">
                    <h4>${asset.name}</h4>
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">{% trans "رقم الأصل" %}:</th>
                            <td><strong>${asset.asset_number}</strong></td>
                        </tr>
                        <tr>
                            <th>{% trans "الفئة" %}:</th>
                            <td>${asset.category}</td>
                        </tr>
                        <tr>
                            <th>{% trans "الموقع المسجل" %}:</th>
                            <td>${asset.location}</td>
                        </tr>
                        <tr>
                            <th>{% trans "القيمة الدفترية" %}:</th>
                            <td>${parseFloat(asset.book_value).toFixed(3)}</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;

        $('#assetDetailsContent').html(html);
        $('#assetId').val(asset.id);
        $('#expectedQty').val(1);
        $('#actualLocation').val(asset.location);
        $('#assetDetailsCard').removeClass('d-none');

        // Focus on actual quantity
        $('#actualQty').focus().select();
    }

    // Submit Count Form
    $('#countForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        $.ajax({
            url: '{% url "assets:upload_count_photo" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.status === 'success') {
                    addToHistory(response.asset);
                    updateProgress();
                    $('#assetDetailsCard').addClass('d-none');
                    $('#countForm')[0].reset();

                    Swal.fire({
                        icon: 'success',
                        title: '{% trans "تم الحفظ!" %}',
                        text: '{% trans "تم حفظ بيانات الجرد بنجاح" %}',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: '{% trans "خطأ!" %}',
                    text: '{% trans "حدث خطأ أثناء الحفظ" %}'
                });
            }
        });
    });

    // Add to History
    function addToHistory(asset) {
        scannedAssets.push(asset);

        const historyHtml = `
            <div class="list-group-item scan-history-item">
                <div class="d-flex justify-content-between">
                    <strong>${asset.name}</strong>
                    <span class="badge bg-success">${new Date().toLocaleTimeString('ar-EG')}</span>
                </div>
                <small class="text-muted">${asset.asset_number}</small>
            </div>
        `;

        if (scannedAssets.length === 1) {
            $('#scanHistoryList').empty();
        }

        $('#scanHistoryList').prepend(historyHtml);
    }

    // Update Progress
    function updateProgress() {
        const scanned = scannedAssets.length;
        const total = parseInt($('#totalCount').text()) || 100;
        const percentage = Math.round((scanned / total) * 100);

        $('#scannedCount').text(scanned);
        $('#progressBar').css('width', percentage + '%')
                        .attr('aria-valuenow', percentage)
                        .text(percentage + '%');
    }

    // Update Status Message
    function updateStatus(message, type) {
        const alertClass = 'alert-' + type;
        $('#scanStatus')
            .removeClass('alert-info alert-success alert-danger alert-warning')
            .addClass(alertClass);
        $('#statusMessage').text(message);
    }

    // Play Beep Sound
    function playBeep() {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSpvxfDTjTwJHGW88OShUhINQJvi8LdkHQc4jtXwyoEhBikv');
        audio.play();
    }

    // Play Error Beep
    function playErrorBeep() {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSpvxfDTjTwJHGW88OShUhINQJvi8LdkHQc4jtXwyoEhBikv');
        audio.playbackRate = 0.5;
        audio.play();
    }
});
</script>
{% endblock %}
