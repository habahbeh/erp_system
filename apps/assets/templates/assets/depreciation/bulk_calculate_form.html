{# apps/assets/templates/assets/depreciation/bulk_calculate_form.html #}
{% extends 'base/base.html' %}
{% load i18n static widget_tweaks %}

{% block title %}{% trans "حساب الإهلاك الجماعي" %}{% endblock %}

{% block extra_css %}
<style>
.page-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.page-header-icon {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.page-header-icon i {
    font-size: 2.5rem;
    color: white;
}

.page-header-content {
    flex: 1;
}

.page-header-title {
    color: white;
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.page-header-subtitle {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    margin-bottom: 0;
}

.page-header-actions {
    display: flex;
    gap: 0.75rem;
    flex-shrink: 0;
}

.page-header-actions .btn {
    white-space: nowrap;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if forloop.last %}
                    <li class="breadcrumb-item active">{{ breadcrumb.title }}</li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                    </li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="page-header">
        <div class="page-header-icon">
            <i class="fas fa-calculator"></i>
        </div>
        <div class="page-header-content">
            <h2 class="page-header-title">{% trans "حساب الإهلاك الجماعي" %}</h2>
            <p class="page-header-subtitle">{% trans "احسب الإهلاك لمجموعة من الأصول بناءً على معايير محددة" %}</p>
        </div>
        <div class="page-header-actions">
            <button type="button" class="btn btn-light" id="previewBtn">
                <i class="fas fa-eye me-1"></i> {% trans "معاينة" %}
            </button>
            <button type="submit" form="bulkDepreciationForm" class="btn btn-success" id="submitBtn" disabled>
                <i class="fas fa-play me-1"></i> {% trans "تنفيذ" %}
            </button>
            <a href="{% url 'assets:depreciation_list' %}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-1"></i> {% trans "العودة" %}
            </a>
        </div>
    </div>

    <div class="row">
        <!-- معلومات الفترة والتصفية -->
        <div class="col-lg-8">
            <!-- الفترة المحاسبية -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-calendar-alt"></i> {% trans "الفترة المحاسبية" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <h6 class="text-muted mb-1">{% trans "السنة المالية" %}</h6>
                            {{ form.period_year|add_class:"form-control" }}
                            {% if form.period_year.errors %}
                                <div class="text-danger small mt-1">{{ form.period_year.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <h6 class="text-muted mb-1">{% trans "الشهر" %}</h6>
                            {{ form.period_month|add_class:"form-select" }}
                            {% if form.period_month.errors %}
                                <div class="text-danger small mt-1">{{ form.period_month.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <h6 class="text-muted mb-1">{% trans "تاريخ الإهلاك" %}</h6>
                            {{ form.depreciation_date|add_class:"form-control" }}
                            {% if form.depreciation_date.errors %}
                                <div class="text-danger small mt-1">{{ form.depreciation_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- تصفية الأصول -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-filter"></i> {% trans "تصفية الأصول" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">{% trans "الفئة" %}</h6>
                            {{ form.category|add_class:"form-select" }}
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">{% trans "الموقع" %}</h6>
                            {{ form.location|add_class:"form-select" }}
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">{% trans "القسم" %}</h6>
                            {{ form.department|add_class:"form-select" }}
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">{% trans "طريقة الإهلاك" %}</h6>
                            {{ form.depreciation_method|add_class:"form-select" }}
                        </div>

                        <div class="col-md-6">
                            <div class="form-check mt-2">
                                {{ form.include_fully_depreciated|add_class:"form-check-input" }}
                                <label class="form-check-label" for="{{ form.include_fully_depreciated.id_for_label }}">
                                    {% trans "تضمين الأصول المهلكة بالكامل" %}
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check mt-2">
                                {{ form.skip_already_calculated|add_class:"form-check-input" }}
                                <label class="form-check-label" for="{{ form.skip_already_calculated.id_for_label }}">
                                    {% trans "تخطي الأصول المحسوبة لنفس الفترة" %}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- خيارات التنفيذ -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-cog"></i> {% trans "خيارات التنفيذ" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-check">
                                {{ form.auto_post|add_class:"form-check-input" }}
                                <label class="form-check-label" for="{{ form.auto_post.id_for_label }}">
                                    {% trans "ترحيل تلقائي للقيود المحاسبية" %}
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check">
                                {{ form.create_single_journal_entry|add_class:"form-check-input" }}
                                <label class="form-check-label" for="{{ form.create_single_journal_entry.id_for_label }}">
                                    {% trans "إنشاء قيد محاسبي واحد مجمّع" %}
                                </label>
                            </div>
                        </div>

                        <div class="col-12">
                            <h6 class="text-muted mb-1">{% trans "ملاحظات" %}</h6>
                            {{ form.notes|add_class:"form-control" }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- معاينة الأصول -->
            <div class="card shadow-sm mb-4" id="previewSection" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> {% trans "معاينة الأصول المحددة" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-primary mb-0" id="assetCount">0</h3>
                                <small class="text-muted">{% trans "عدد الأصول" %}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-success mb-0" id="totalDepreciation">0.000</h3>
                                <small class="text-muted">{% trans "إجمالي الإهلاك" %}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-info mb-0" id="totalAssetValue">0.000</h3>
                                <small class="text-muted">{% trans "قيمة الأصول" %}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-warning mb-0" id="totalBookValue">0.000</h3>
                                <small class="text-muted">{% trans "القيمة الدفترية" %}</small>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive mt-4">
                        <table class="table table-sm table-hover" id="assetPreviewTable">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "رمز الأصل" %}</th>
                                    <th>{% trans "اسم الأصل" %}</th>
                                    <th>{% trans "الفئة" %}</th>
                                    <th class="text-end">{% trans "التكلفة" %}</th>
                                    <th class="text-end">{% trans "الإهلاك المحسوب" %}</th>
                                    <th class="text-end">{% trans "القيمة الدفترية بعد" %}</th>
                                </tr>
                            </thead>
                            <tbody id="assetPreviewBody">
                            </tbody>
                        </table>
                    </div>

                    <div class="text-center mt-4">
                        <button type="submit" form="bulkDepreciationForm" class="btn btn-primary">
                            <i class="fas fa-play"></i> {% trans "تنفيذ الحساب الجماعي" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- الشريط الجانبي -->
        <div class="col-lg-4">
            <!-- معلومات النظام -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info"></i> {% trans "معلومات مهمة" %}
                    </h6>
                </div>
                <div class="card-body">
                    <small class="text-muted d-block mb-1">
                        <i class="fas fa-check text-success"></i>
                        الفترة المحاسبية مطلوبة
                    </small>
                    <small class="text-muted d-block mb-1">
                        <i class="fas fa-check text-success"></i>
                        يمكن تصفية الأصول حسب معايير مختلفة
                    </small>
                    <small class="text-muted d-block mb-1">
                        <i class="fas fa-check text-success"></i>
                        معاينة الأصول قبل التنفيذ إلزامية
                    </small>
                    <small class="text-muted d-block">
                        <i class="fas fa-info-circle text-primary"></i>
                        يمكن إنشاء قيد واحد مجمّع أو قيود منفصلة
                    </small>
                </div>
            </div>

            <!-- إجراءات سريعة -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt"></i> {% trans "إجراءات سريعة" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-info" id="previewBtn2">
                            <i class="fas fa-eye"></i> {% trans "معاينة الأصول" %}
                        </button>
                        <a href="{% url 'assets:calculate_depreciation' %}" class="btn btn-outline-primary">
                            <i class="fas fa-calculator"></i> {% trans "حساب فردي" %}
                        </a>
                        <a href="{% url 'assets:depreciation_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-list"></i> {% trans "سجل الإهلاك" %}
                        </a>
                    </div>
                </div>
            </div>

            <!-- معلومات إضافية -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-lightbulb text-warning"></i> {% trans "نصائح التصفية" %}
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success"></i>
                            اترك المعايير فارغة لتشمل جميع الأصول
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success"></i>
                            استخدم الفئة للحساب حسب نوع الأصل
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-info-circle text-primary"></i>
                            استخدم القسم للحساب حسب الإدارة
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-exclamation-triangle text-warning"></i>
                            تأكد من معاينة الأصول قبل التنفيذ
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="bulkDepreciationForm" style="display: none;">
        {% csrf_token %}
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Preview Assets
    $('#previewBtn, #previewBtn2').on('click', function() {
        const year = $('#id_period_year').val();
        const month = $('#id_period_month').val();

        if (!year || !month) {
            Swal.fire({
                icon: 'warning',
                title: 'بيانات ناقصة',
                text: 'يرجى تحديد السنة والشهر',
                confirmButtonColor: '#0d6efd'
            });
            return;
        }

        const formData = new URLSearchParams();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('period_year', year);
        formData.append('period_month', month);
        formData.append('depreciation_date', $('#id_depreciation_date').val() || '');
        formData.append('category', $('#id_category').val() || '');
        formData.append('location', $('#id_location').val() || '');
        formData.append('department', $('#id_department').val() || '');
        formData.append('depreciation_method', $('#id_depreciation_method').val() || '');
        formData.append('include_fully_depreciated', $('#id_include_fully_depreciated').is(':checked') ? 'on' : '');
        formData.append('skip_already_calculated', $('#id_skip_already_calculated').is(':checked') ? 'on' : '');
        formData.append('notes', $('#id_notes').val() || '');
        formData.append('auto_post', $('#id_auto_post').is(':checked') ? 'on' : '');
        formData.append('create_single_journal_entry', $('#id_create_single_journal_entry').is(':checked') ? 'on' : '');

        $.ajax({
            url: '{% url "assets:bulk_depreciation_preview" %}',
            method: 'POST',
            data: formData.toString(),
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            success: function(response) {
                if (response.success) {
                    // Update summary
                    $('#assetCount').text(response.asset_count);
                    $('#totalDepreciation').text(response.total_depreciation.toFixed(3));
                    $('#totalAssetValue').text(response.total_asset_value.toFixed(3));
                    $('#totalBookValue').text(response.total_book_value.toFixed(3));

                    // Update table
                    const tbody = $('#assetPreviewBody');
                    tbody.empty();

                    response.assets.forEach(function(asset) {
                        const row = `
                            <tr>
                                <td>${asset.code}</td>
                                <td>${asset.name}</td>
                                <td>${asset.category}</td>
                                <td class="text-end">${asset.purchase_cost.toFixed(3)}</td>
                                <td class="text-end">${asset.depreciation_amount.toFixed(3)}</td>
                                <td class="text-end">${asset.new_book_value.toFixed(3)}</td>
                            </tr>
                        `;
                        tbody.append(row);
                    });

                    $('#previewSection').slideDown();
                    $('#submitBtn').prop('disabled', false);

                    if (response.asset_count === 0) {
                        Swal.fire({
                            icon: 'info',
                            title: 'لا توجد أصول',
                            text: 'لا توجد أصول تطابق المعايير المحددة',
                            confirmButtonColor: '#0d6efd'
                        });
                        $('#submitBtn').prop('disabled', true);
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ',
                        text: response.message || 'حدث خطأ أثناء المعاينة',
                        confirmButtonColor: '#dc3545'
                    });
                }
            },
            error: function(xhr) {
                var message = 'حدث خطأ أثناء المعاينة';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: message,
                    confirmButtonColor: '#dc3545'
                });
            }
        });
    });

    // Form Submission
    $('#bulkDepreciationForm').on('submit', function(e) {
        e.preventDefault();
        const form = this;
        const assetCount = $('#assetCount').text();

        Swal.fire({
            title: 'تأكيد التنفيذ',
            text: `هل أنت متأكد من تنفيذ الحساب الجماعي لـ ${assetCount} أصل؟`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-play me-2"></i>تنفيذ الحساب',
            cancelButtonText: 'إلغاء',
            confirmButtonColor: '#198754',
            cancelButtonColor: '#6c757d'
        }).then((result) => {
            if (result.isConfirmed) {
                const submitBtn = $('#submitBtn');
                submitBtn.prop('disabled', true).html(
                    '<i class="fas fa-spinner fa-spin me-2"></i>جاري التنفيذ...'
                );
                form.submit();
            }
        });
    });
});
</script>
{% endblock %}
