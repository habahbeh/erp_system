# نظام إدارة الأصول الثابتة (Assets Management System)

## نظرة عامة

نظام شامل لإدارة الأصول الثابتة مبني على Django، يوفر حلاً متكاملاً لتتبع وإدارة أصول المؤسسة من لحظة الشراء حتى التخلص منها أو بيعها.

## المميزات الرئيسية

### 1. إدارة الأصول
- **تصنيف هرمي للأصول** مع دعم التصنيفات الرئيسية والفرعية
- **تتبع دقيق للأصول** مع أرقام فريدة، باركود، ورقم تسلسلي
- **إدارة حالات الأصول**: نشط، قيد الصيانة، متوقف، محول، مباع، متبرع به، مسروق، مفقود
- **تتبع موقع الأصول** حسب الفرع، المبنى، الطابق، الغرفة
- **إرفاق صور ومستندات** للأصول
- **تقييم دوري للأصول** مع تتبع تاريخ التقييمات
- **استيراد/تصدير Excel** للأصول بشكل جماعي

### 2. الإهلاك التلقائي
- **طرق إهلاك متعددة**:
  - القسط الثابت (Straight Line)
  - الرصيد المتناقص (Declining Balance)
  - الرصيد المتناقص المضاعف (Double Declining Balance)
  - مجموع أرقام السنين (Sum of Years Digits)
  - وحدات الإنتاج (Units of Production)

- **حساب إهلاك تلقائي** شهري/سنوي
- **حساب جماعي للإهلاك** لعدة أصول
- **عكس قيود الإهلاك** مع تتبع الأسباب
- **تقارير إهلاك تفصيلية** مع رسوم بيانية

### 3. الصيانة
- **أنواع صيانة مخصصة** (وقائية، تصحيحية، طارئة، دورية)
- **جدولة صيانة تلقائية** (يومية، أسبوعية، شهرية، ربع سنوية، نصف سنوية، سنوية)
- **تتبع حالة الصيانة**: مجدولة، قيد التنفيذ، مكتملة، ملغاة، مؤجلة
- **تسجيل تكاليف الصيانة** مع قطع الغيار والعمالة
- **تنبيهات صيانة تلقائية** قبل موعد الصيانة
- **تقارير صيانة شاملة** مع إحصائيات الأداء

### 4. التأمين
- **إدارة شركات التأمين** مع تفاصيل الاتصال
- **بوليصات تأمين متعددة** لكل أصل
- **تتبع حالة التأمين**: نشط، منتهي، ملغي، معلق
- **إدارة مطالبات التأمين**: قيد المراجعة، موافق، مرفوض، مدفوع، ملغي
- **معالجة دفعات التأمين** مع تتبع تواريخ الاستحقاق
- **تنبيهات انتهاء التأمين** التلقائية
- **تقارير تأمين تفصيلية**

### 5. الجرد الفعلي
- **دورات جرد منظمة** (سنوية، نصف سنوية، ربع سنوية، شهرية، طارئة)
- **مسح الباركود/QR Code** عبر الكاميرا
- **واجهة مسح متقدمة** مع دعم HTML5 Camera API
- **تسجيل الفروقات**: فائض، عجز، تالف
- **تعديلات تلقائية** بناءً على نتائج الجرد
- **تصوير الأصول** أثناء الجرد
- **تقارير جرد شاملة** مع رسوم بيانية
- **تحديث جماعي** لبيانات الجرد

### 6. المعاملات المالية
- **عمليات الشراء** مع تسجيل تفاصيل الموردين
- **عمليات البيع** مع حساب الربح/الخسارة
- **التحويلات** بين الفروع/الأقسام
- **التبرعات والتخلص** من الأصول
- **سحب وإرجاع** الأصول من الموظفين
- **قيود محاسبية تلقائية** لجميع المعاملات
- **تتبع تاريخ المعاملات** الكامل

### 7. الإيجار التمويلي
- **إدارة عقود الإيجار** (تشغيلي/تمويلي)
- **جدولة دفعات منتظمة** (شهرية، ربع سنوية، نصف سنوية، سنوية)
- **تجديد عقود الإيجار** التلقائي
- **خيارات الشراء** في نهاية العقد
- **معالجة دفعات جماعية**
- **تنبيهات استحقاق الدفعات**
- **تقارير إيجار تفصيلية**

### 8. سير العمل والموافقات
- **سيرات عمل مخصصة** لكل نوع عملية
- **موافقات متعددة المستويات** مع تسلسل هرمي
- **تصعيد تلقائي** عند انتهاء المهلة
- **موافقة سريعة** من لوحة التحكم
- **موافقة جماعية** لعدة طلبات
- **تفويض الموافقات** لمستخدمين آخرين
- **تتبع كامل للموافقات** مع السجل التاريخي

### 9. التقارير والإحصائيات
- **لوحة تحكم تفاعلية** مع Chart.js
- **تقارير Excel/PDF** قابلة للتصدير
- **إحصائيات مالية**: القيمة الإجمالية، الإهلاك، القيمة الدفترية
- **تقارير الصيانة**: التكاليف، معدلات الأعطال، الأداء
- **تقارير الجرد**: الفروقات، الدقة، التغطية
- **تقارير التأمين**: التغطية، المطالبات، التكاليف
- **رسوم بيانية تفاعلية**: دوائر، أعمدة، خطوط، شرائط
- **فلترة متقدمة** بجميع التقارير

### 10. الإشعارات
- **إشعارات الصيانة**: قبل موعد الصيانة المجدولة
- **إشعارات التأمين**: قبل انتهاء البوليصة
- **إشعارات الإيجار**: قبل استحقاق الدفعة/انتهاء العقد
- **إشعارات الموافقات**: عند طلب موافقة جديدة
- **إشعارات التقييم**: عند اقتراب موعد التقييم
- **إشعارات الإهلاك**: عند اكتمال إهلاك أصل
- **مركز إشعارات موحد** مع تصنيفات ملونة

## التثبيت

### المتطلبات الأساسية
- Python 3.10+
- Django 5.2.5
- MySQL/MariaDB (أو PostgreSQL)
- pip

### خطوات التثبيت

1. **استنساخ المشروع**
```bash
git clone <repository-url>
cd erp_system
```

2. **إنشاء بيئة افتراضية**
```bash
python -m venv venv
source venv/bin/activate  # على Linux/Mac
# أو
venv\Scripts\activate  # على Windows
```

3. **تثبيت المتطلبات**
```bash
pip install -r requirements.txt
```

4. **إعداد قاعدة البيانات**

في ملف `.env`:
```env
DB_NAME=erp_database
DB_USER=your_username
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=3306
SECRET_KEY=your-secret-key-here
DEBUG=True
```

5. **تشغيل الهجرات**
```bash
python manage.py migrate
```

6. **إنشاء مستخدم مسؤول**
```bash
python manage.py createsuperuser
```

7. **تحميل البيانات الابتدائية (اختياري)**
```bash
python manage.py load_depreciation_methods
python manage.py load_sample_assets
```

8. **تشغيل الخادم**
```bash
python manage.py runserver
```

9. **الوصول للنظام**
- الواجهة الأمامية: `http://localhost:8000/assets/`
- لوحة الإدارة: `http://localhost:8000/admin/`

## البنية التنظيمية

```
apps/assets/
├── models/              # نماذج البيانات (28 موديل)
│   ├── asset.py         # الأصول والتصنيفات
│   ├── transaction.py   # المعاملات المالية
│   ├── depreciation.py  # الإهلاك
│   ├── maintenance.py   # الصيانة
│   ├── insurance.py     # التأمين
│   ├── physical_count.py # الجرد الفعلي
│   ├── lease.py         # الإيجار
│   └── workflow.py      # سير العمل
│
├── views/               # وجهات العرض (228 دالة/صنف)
│   ├── asset_views.py
│   ├── dashboard.py
│   ├── transaction_views.py
│   ├── depreciation_views.py
│   ├── maintenance_views.py
│   ├── insurance_views.py
│   ├── physical_count_views.py
│   ├── lease_views.py
│   ├── workflow_views.py
│   ├── report_views.py
│   ├── notification_views.py
│   ├── ajax_views.py
│   ├── api_views.py
│   └── export_views.py
│
├── forms/               # النماذج (53 نموذج)
│   ├── asset_forms.py
│   ├── transaction_forms.py
│   ├── depreciation_forms.py
│   ├── maintenance_forms.py
│   ├── insurance_forms.py
│   ├── physical_count_forms.py
│   ├── lease_forms.py
│   └── workflow_forms.py
│
├── templates/           # القوالب (79 ملف HTML)
│   └── assets/
│       ├── assets/
│       ├── transactions/
│       ├── depreciation/
│       ├── maintenance/
│       ├── insurance/
│       ├── physical_count/
│       ├── lease/
│       ├── workflow/
│       ├── notifications/
│       └── reports/
│
├── utils/               # الأدوات المساعدة
│   ├── depreciation_calculator.py
│   ├── excel_exporter.py
│   └── pdf_exporter.py
│
├── management/          # أوامر إدارية
│   └── commands/
│       ├── calculate_depreciation.py
│       ├── send_maintenance_notifications.py
│       ├── check_insurance_expiry.py
│       └── check_lease_payments.py
│
├── migrations/          # هجرات قاعدة البيانات
├── admin.py            # لوحة الإدارة (28 موديل مسجل)
├── apps.py             # إعدادات التطبيق
├── signals.py          # الإشارات (8 إشارات)
├── tests.py            # الاختبارات (22 اختبار)
├── urls.py             # المسارات (170+ مسار)
└── README.md           # هذا الملف
```

## النماذج (Models)

### الأصول
- **AssetCategory**: تصنيفات الأصول (هرمية)
- **DepreciationMethod**: طرق الإهلاك
- **AssetCondition**: حالات الأصول
- **Asset**: الأصل الثابت (الموديل الرئيسي)
- **AssetAttachment**: مرفقات الأصول
- **AssetValuation**: تقييمات الأصول

### المعاملات
- **AssetTransaction**: المعاملات المالية (شراء، بيع، تحويل، إلخ)

### الإهلاك
- **AssetDepreciation**: قيود الإهلاك

### الصيانة
- **MaintenanceType**: أنواع الصيانة
- **MaintenanceSchedule**: جدولة الصيانة
- **AssetMaintenance**: سجلات الصيانة

### التأمين
- **InsuranceCompany**: شركات التأمين
- **AssetInsurance**: بوليصات التأمين
- **InsuranceClaim**: مطالبات التأمين
- **ClaimPayment**: دفعات المطالبات

### الجرد الفعلي
- **PhysicalCountCycle**: دورات الجرد
- **PhysicalCount**: الجرد الفعلي
- **PhysicalCountLine**: سطور الجرد
- **PhysicalCountAdjustment**: تعديلات الجرد

### الإيجار
- **AssetLease**: عقود الإيجار
- **LeasePayment**: دفعات الإيجار

### سير العمل
- **ApprovalWorkflow**: سيرات العمل
- **ApprovalLevel**: مستويات الموافقة
- **ApprovalRequest**: طلبات الموافقة
- **ApprovalHistory**: سجل الموافقات

### الإشعارات
- **Notification**: الإشعارات

## الأوامر الإدارية

### حساب الإهلاك الشهري
```bash
python manage.py calculate_depreciation
```

### إرسال إشعارات الصيانة
```bash
python manage.py send_maintenance_notifications --days 7
```

### فحص انتهاء التأمين
```bash
python manage.py check_insurance_expiry --days 30
```

### فحص دفعات الإيجار المستحقة
```bash
python manage.py check_lease_payments
```

## الاختبارات

تشغيل جميع الاختبارات:
```bash
python manage.py test apps.assets
```

تشغيل اختبارات معينة:
```bash
# اختبار النماذج فقط
python manage.py test apps.assets.tests.AssetModelTest

# اختبار الإهلاك
python manage.py test apps.assets.tests.DepreciationCalculatorTest

# اختبار الواجهات
python manage.py test apps.assets.tests.AssetViewsTest
```

مع التغطية:
```bash
coverage run --source='apps.assets' manage.py test apps.assets
coverage report
coverage html
```

## المكتبات المستخدمة

### المكتبات الأساسية
- **Django 5.2.5**: إطار العمل الرئيسي
- **djangorestframework 3.16.1**: REST API
- **mysqlclient 2.2.7**: محرك قاعدة البيانات

### مكتبات الواجهة
- **django-select2 8.4.1**: قوائم منسدلة محسنة
- **django-datatables-view 1.20.0**: جداول تفاعلية
- **django-widget-tweaks 1.5.0**: تخصيص الحقول

### مكتبات البيانات
- **openpyxl 3.1.5**: قراءة/كتابة Excel
- **pandas 2.3.2**: معالجة البيانات
- **numpy 2.2.6**: عمليات رياضية

### مكتبات الوسائط
- **Pillow 11.3.0**: معالجة الصور
- **python-barcode 0.15.1**: توليد الباركود
- **qrcode[pil] 7.4.2**: توليد QR Code
- **reportlab 4.0.7**: توليد PDF

### مكتبات أخرى
- **python-dateutil 2.9.0**: معالجة التواريخ
- **python-decouple 3.8**: إدارة الإعدادات
- **pytz 2025.2**: المناطق الزمنية

### مكتبات التطوير
- **django-debug-toolbar 6.0.0**: أدوات التطوير
- **django-extensions 4.1**: أوامر إضافية

## التكامل مع الأنظمة الأخرى

### المحاسبة
يتكامل نظام الأصول مع تطبيق المحاسبة (`apps.accounting`) من خلال:
- قيود محاسبية تلقائية عند الشراء/البيع/التخلص
- قيود إهلاك شهرية
- قيود دفعات الإيجار

### الموارد البشرية
يتكامل مع تطبيق الموارد البشرية (`apps.hr`) من خلال:
- تعيين الأصول للموظفين
- تتبع المسؤولية عن الأصول
- سحب الأصول عند انتهاء الخدمة

### المشتريات
يتكامل مع تطبيق المشتريات (`apps.purchases`) من خلال:
- إنشاء أصول تلقائياً من أوامر الشراء
- ربط الأصول بالموردين
- تتبع تكاليف الشراء

## الإعدادات

في `settings.py`:

```python
INSTALLED_APPS = [
    # ...
    'apps.assets',
    'django_select2',
    'django_datatables_view',
    'widget_tweaks',
    # ...
]

# إعدادات الأصول (اختياري)
ASSETS_AUTO_DEPRECIATION = True  # حساب إهلاك تلقائي
ASSETS_BARCODE_TYPE = 'code128'  # نوع الباركود
ASSETS_QR_VERSION = 1  # إصدار QR Code
ASSETS_NOTIFICATION_DAYS = 7  # أيام التنبيه المسبق
```

## الاستخدام

### إضافة أصل جديد

1. انتقل إلى "الأصول" > "إضافة أصل"
2. املأ المعلومات الأساسية (الاسم، التصنيف، القيمة)
3. حدد طريقة الإهلاك والعمر الإنتاجي
4. حدد الموقع (الفرع، المبنى، الغرفة)
5. أرفق صور ومستندات (اختياري)
6. احفظ الأصل

سيتم:
- توليد رقم أصل فريد تلقائياً
- توليد باركود و QR Code
- إنشاء قيد محاسبي (إذا كان التكامل مفعل)
- إرسال إشعار للمسؤولين

### حساب الإهلاك

**للأصل الواحد:**
1. افتح تفاصيل الأصل
2. انقر "حساب إهلاك"
3. حدد تاريخ الإهلاك
4. أكد العملية

**حساب جماعي:**
1. انتقل إلى "الإهلاك" > "حساب جماعي"
2. حدد المعايير (التصنيف، الفرع، التاريخ)
3. انقر "حساب للكل"
4. راجع النتائج وأكد

**تلقائياً:**
```bash
# أضف Cron Job لتشغيل يومياً
0 1 * * * cd /path/to/project && python manage.py calculate_depreciation
```

### جدولة الصيانة

1. انتقل إلى "الصيانة" > "الجدولة"
2. اختر الأصل ونوع الصيانة
3. حدد التكرار (شهرية، ربع سنوية، إلخ)
4. حدد تاريخ البداية
5. فعّل الإشعارات (اختياري)
6. احفظ الجدولة

سيتم:
- إنشاء سجلات صيانة تلقائياً
- إرسال إشعارات قبل الموعد بالفترة المحددة
- تحديث حالة الأصل عند بدء الصيانة

### إجراء جرد فعلي

1. انتقل إلى "الجرد" > "دورة جديدة"
2. حدد النوع والتاريخ والمسؤول
3. احفظ الدورة
4. انقر "بدء الجرد"
5. استخدم واجهة المسح:
   - امسح الباركود بالكاميرا
   - أو أدخل الرقم يدوياً
   - سجل الحالة والملاحظات
   - التقط صورة (اختياري)
6. أكمل الجرد وأغلق الدورة
7. راجع الفروقات
8. أنشئ تعديلات لمعالجة الفروقات

### إنشاء سير عمل موافقات

1. انتقل إلى "سير العمل" > "إنشاء جديد"
2. حدد النوع (شراء، بيع، تحويل، إلخ)
3. حدد نطاق المبلغ
4. أضف مستويات الموافقة:
   - المستوى 1: مدير القسم (أقل من 10,000)
   - المستوى 2: المدير المالي (10,000 - 50,000)
   - المستوى 3: المدير التنفيذي (أكثر من 50,000)
5. فعّل التصعيد التلقائي (اختياري)
6. احفظ سير العمل

عند إنشاء عملية جديدة:
- سيتم إنشاء طلب موافقة تلقائياً
- إرسال إشعارات للمعتمدين
- تتبع حالة الموافقة
- تنفيذ العملية بعد الموافقة النهائية

## التقارير المتاحة

### 1. تقرير الأصول
- عرض جميع الأصول مع الفلترة
- إحصائيات حسب التصنيف/الفرع/الحالة
- تصدير Excel/PDF

### 2. تقرير الإهلاك
- الإهلاك المتراكم والقيمة الدفترية
- مقارنة بين الطرق المختلفة
- رسوم بيانية زمنية

### 3. تقرير الصيانة
- تكاليف الصيانة الإجمالية
- معدل الأعطال لكل أصل
- أداء الصيانة الوقائية

### 4. تقرير الجرد
- نتائج آخر جرد
- الفروقات والتعديلات
- دقة الجرد حسب الفرع

### 5. تقرير التأمين
- التغطية التأمينية الإجمالية
- المطالبات والدفعات
- الأقساط المستحقة

### 6. تقرير الإيجار
- الالتزامات الإيجارية
- الدفعات المستحقة
- العقود القريبة من الانتهاء

## أمثلة AJAX API

### الحصول على تفاصيل أصل
```javascript
$.ajax({
    url: `/assets/ajax/asset-detail/${assetId}/`,
    method: 'GET',
    success: function(data) {
        console.log(data.asset);
    }
});
```

### حساب إهلاك
```javascript
$.ajax({
    url: `/assets/depreciation/calculate/${assetId}/`,
    method: 'POST',
    data: {
        date: '2025-01-31',
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    },
    success: function(data) {
        if (data.success) {
            alert('تم حساب الإهلاك بنجاح');
        }
    }
});
```

### تحديث حالة الجرد
```javascript
$.ajax({
    url: `/assets/physical-count/update-line/${lineId}/`,
    method: 'POST',
    data: {
        status: 'found',
        condition: 'good',
        notes: 'حالة ممتازة',
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    },
    success: function(data) {
        if (data.success) {
            // تحديث الواجهة
        }
    }
});
```

## الأمان

### الصلاحيات المطلوبة
- **عرض الأصول**: `assets.view_asset`
- **إضافة أصول**: `assets.add_asset`
- **تعديل أصول**: `assets.change_asset`
- **حذف أصول**: `assets.delete_asset`
- **حساب إهلاك**: `assets.calculate_depreciation`
- **الموافقة على الطلبات**: `assets.approve_requests`

### حماية CSRF
جميع نماذج POST محمية بـ CSRF tokens.

### التحقق من الصلاحيات
```python
from django.contrib.auth.decorators import permission_required

@permission_required('assets.add_asset')
def create_asset(request):
    # ...
```

## الاستكشاف والإصلاح

### الأصول لا تظهر
- تحقق من الصلاحيات
- تحقق من فلاتر البحث
- تحقق من حالة الأصل (نشط/غير نشط)

### الإهلاك غير صحيح
- تحقق من طريقة الإهلاك
- تحقق من العمر الإنتاجي
- تحقق من تاريخ البداية
- تحقق من قيمة الإنقاذ

### الباركود لا يعمل
- تحقق من تثبيت `python-barcode`
- تحقق من صلاحيات مجلد الوسائط
- تحقق من إعدادات MEDIA_URL/MEDIA_ROOT

### الإشعارات لا تصل
- تحقق من إعدادات البريد في settings.py
- تحقق من Cron jobs
- تحقق من صلاحيات المستخدمين

## الأداء

### تحسين الاستعلامات
- استخدم `select_related()` للعلاقات ForeignKey
- استخدم `prefetch_related()` للعلاقات ManyToMany
- أضف indexes على الحقول المستخدمة في البحث

### التخزين المؤقت
```python
from django.core.cache import cache

def get_dashboard_stats():
    stats = cache.get('dashboard_stats')
    if not stats:
        stats = calculate_stats()
        cache.set('dashboard_stats', stats, 300)  # 5 دقائق
    return stats
```

### المهام الخلفية
استخدم Celery للعمليات الثقيلة:
```python
from celery import shared_task

@shared_task
def calculate_bulk_depreciation():
    # حساب الإهلاك لجميع الأصول
    pass
```

## المساهمة

نرحب بالمساهمات! يرجى:
1. Fork المشروع
2. إنشاء فرع للميزة (`git checkout -b feature/AmazingFeature`)
3. Commit التغييرات (`git commit -m 'Add some AmazingFeature'`)
4. Push للفرع (`git push origin feature/AmazingFeature`)
5. فتح Pull Request

## الترخيص

هذا المشروع مرخص تحت [رخصة MIT](LICENSE)

## الدعم

للأسئلة والدعم:
- البريد الإلكتروني: support@example.com
- الوثائق: [docs.example.com](https://docs.example.com)
- المنتدى: [forum.example.com](https://forum.example.com)

## الشكر والتقدير

- **Django Team**: لإطار العمل الرائع
- **Bootstrap Team**: للواجهات الجميلة
- **Chart.js**: للرسوم البيانية التفاعلية
- **ZXing**: لمسح الباركود
- **المجتمع**: لجميع المساهمات والاقتراحات

---

**الإصدار**: 1.0.0
**تاريخ آخر تحديث**: 2025-10-23
**الحالة**: جاهز للإنتاج ✅
