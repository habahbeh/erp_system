<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØªØ­ÙˆÙŠÙ„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            direction: rtl;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .console-output {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ø§Ø®ØªØ¨Ø§Ø± Ø²Ø± "Ø¥Ø¶Ø§ÙØ© ØªØ­ÙˆÙŠÙ„"</h1>
        <p class="text-muted">Ù‡Ø°Ø§ Ù…Ù„Ù Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</p>

        <div class="test-section">
            <h3>1. Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <div class="mb-3">
                <label>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</label>
                <select id="id_base_uom" class="form-select">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>
                    <option value="1">Ù‚Ø·Ø¹Ø© (PC)</option>
                    <option value="2">ÙƒØ±ØªÙˆÙ† (CTN)</option>
                    <option value="3">ÙƒÙŠÙ„Ùˆ (KG)</option>
                </select>
            </div>
        </div>

        <div class="test-section">
            <h3>2. Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª</h3>
            <p class="small text-muted mb-2">
                <i class="fas fa-info-circle"></i>
                Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙŠØªÙ… Ø¥Ù„Ù‰ ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù…Ø§Ø¯Ø©
            </p>
            <div class="table-responsive">
                <table class="table table-sm table-bordered" id="conversionsTable">
                    <thead>
                        <tr>
                            <th width="200">Ù…Ù† ÙˆØ­Ø¯Ø©</th>
                            <th width="150">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th>
                            <th width="250">Ø§Ù„ØµÙŠØºØ©</th>
                            <th width="80">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="conversionsBody">
                        <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ù‡Ù†Ø§ -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddConversion">
                <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªØ­ÙˆÙŠÙ„
            </button>
        </div>

        <div class="test-section">
            <h3>3. Console Output</h3>
            <div id="consoleOutput" class="console-output"></div>
        </div>
    </div>

    <script>
        // Ù…Ø­Ø§ÙƒØ§Ø© console.log Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
        const originalLog = console.log;
        const originalError = console.error;
        const consoleDiv = document.getElementById('consoleOutput');

        function addToConsole(message, type = 'log') {
            const color = type === 'error' ? '#f00' : '#0f0';
            const line = document.createElement('div');
            line.style.color = color;
            line.textContent = message;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('ERROR: ' + args.join(' '), 'error');
        };

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
        const uomList = [
            {id: 1, name: "Ù‚Ø·Ø¹Ø©", symbol: "PC"},
            {id: 2, name: "ÙƒØ±ØªÙˆÙ†", symbol: "CTN"},
            {id: 3, name: "ÙƒÙŠÙ„Ùˆ", symbol: "KG"},
            {id: 4, name: "Ø¬Ø±Ø§Ù…", symbol: "GM"},
            {id: 5, name: "Ù„ØªØ±", symbol: "L"}
        ];

        let conversionIndex = 0;

        console.log('ğŸ” UOM Conversions initialized');
        console.log('ğŸ“Š uomList: ' + JSON.stringify(uomList));
        console.log('ğŸ“Š uomList length: ' + uomList.length);

        function addConversionRow() {
            console.log('â• addConversionRow called');
            console.log('ğŸ“Š Current conversionIndex: ' + conversionIndex);

            const tbody = document.getElementById('conversionsBody');
            if (!tbody) {
                console.error('âŒ conversionsBody not found!');
                alert('Ø®Ø·Ø£: Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            if (!uomList || uomList.length === 0) {
                console.error('âŒ uomList is empty!');
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù‚ÙŠØ§Ø³ Ù…ØªØ§Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø§Øª Ù‚ÙŠØ§Ø³ Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            const currentIndex = conversionIndex;
            const row = document.createElement('tr');
            row.dataset.index = currentIndex;

            // Build UOM options
            let uomOptions = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>';
            uomList.forEach(uom => {
                const symbol = uom.symbol ? `(${uom.symbol})` : '';
                uomOptions += `<option value="${uom.id}">${uom.name} ${symbol}</option>`;
            });

            // Build row HTML
            row.innerHTML = `
                <td>
                    <select name="conversion_from_uom_${currentIndex}"
                            class="form-select form-select-sm conversion-from-uom"
                            data-index="${currentIndex}">
                        ${uomOptions}
                    </select>
                </td>
                <td>
                    <input type="number"
                           name="conversion_factor_${currentIndex}"
                           class="form-control form-control-sm conversion-factor"
                           placeholder="1.0"
                           step="0.001"
                           min="0.001"
                           data-index="${currentIndex}">
                </td>
                <td>
                    <small class="text-muted conversion-formula" id="conversion_formula_${currentIndex}">
                        -
                    </small>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger btn-remove-conversion">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;

            // Append row
            tbody.appendChild(row);

            // Add event listeners
            const fromSelect = row.querySelector('.conversion-from-uom');
            const factorInput = row.querySelector('.conversion-factor');
            const deleteBtn = row.querySelector('.btn-remove-conversion');

            // Update formula when from_uom or factor changes
            function updateFormula() {
                const fromUomId = fromSelect.value;
                const factor = factorInput.value;
                const baseUom = document.getElementById('id_base_uom');
                const formulaSpan = document.getElementById(`conversion_formula_${currentIndex}`);

                if (fromUomId && factor && baseUom && baseUom.value) {
                    const fromUomText = fromSelect.options[fromSelect.selectedIndex].text;
                    const baseUomText = baseUom.options[baseUom.selectedIndex].text;
                    formulaSpan.textContent = `1 ${fromUomText} = ${factor} ${baseUomText}`;
                    console.log('âœï¸ Formula updated: 1 ' + fromUomText + ' = ' + factor + ' ' + baseUomText);
                } else {
                    formulaSpan.textContent = '-';
                }
            }

            fromSelect.addEventListener('change', updateFormula);
            factorInput.addEventListener('input', updateFormula);

            // Delete handler
            deleteBtn.addEventListener('click', function() {
                row.remove();
                console.log('ğŸ—‘ï¸ Conversion row removed');
                console.log('ğŸ“Š Total rows now: ' + tbody.children.length);
            });

            conversionIndex++;

            console.log('âœ… Conversion row added successfully');
            console.log('ğŸ“Š Total rows now: ' + tbody.children.length);
        }

        // Attach button event listener
        document.addEventListener('DOMContentLoaded', function() {
            const btnAddConversion = document.getElementById('btnAddConversion');
            if (btnAddConversion) {
                btnAddConversion.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('ğŸ–±ï¸ Add Conversion button clicked');
                    addConversionRow();
                });
                console.log('âœ… Add Conversion button event listener attached');
            } else {
                console.error('âŒ btnAddConversion not found!');
            }
        });
    </script>
</body>
</html>
