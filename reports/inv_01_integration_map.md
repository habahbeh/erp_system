# خريطة تكامل نظام المخزون
## Integration Map - Inventory System

---

## 1. التكامل مع نظام المشتريات (Purchases)

### 1.1 تدفق فاتورة المشتريات → سند الإدخال

```
┌─────────────────────────────────────────────────────────────────┐
│                    فاتورة مشتريات (PurchaseInvoice)               │
│                         ↓ post()                                 │
├─────────────────────────────────────────────────────────────────┤
│  1. التحقق من وجود محضر استلام (GoodsReceipt)                   │
│     - إذا وجد: استخدام سند الإدخال الموجود                       │
│     - إذا لم يوجد: إنشاء سند إدخال جديد                          │
│                                                                   │
│  2. نسخ سطور الفاتورة لسند الإدخال:                              │
│     - item → stock_in_line.item                                   │
│     - item_variant → stock_in_line.item_variant                   │
│     - quantity → stock_in_line.quantity                           │
│     - unit_price → stock_in_line.unit_cost                        │
│     - batch_number → stock_in_line.batch_number                   │
│     - expiry_date → stock_in_line.expiry_date                     │
│                                                                   │
│  3. ترحيل سند الإدخال (بدون قيد محاسبي منفصل)                    │
│     stock_in.post(create_journal_entry=False)                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    سند إدخال (StockIn)                          │
│                         ↓ post()                                 │
├─────────────────────────────────────────────────────────────────┤
│  لكل سطر في السند:                                               │
│                                                                   │
│  1. الحصول/إنشاء رصيد المادة (ItemStock):                        │
│     - get_or_create(item, variant, warehouse, company)           │
│                                                                   │
│  2. حساب متوسط التكلفة الجديد:                                   │
│     new_quantity = old_quantity + line.quantity                   │
│     new_value = old_value + line.total_cost                       │
│     average_cost = new_value / new_quantity                       │
│                                                                   │
│  3. تحديث الرصيد:                                                 │
│     stock.quantity = new_quantity                                 │
│     stock.total_value = new_value                                 │
│     stock.average_cost = average_cost                             │
│                                                                   │
│  4. تحديث آخر سعر شراء:                                          │
│     stock.update_last_purchase(price, total, date, supplier)      │
│                                                                   │
│  5. تحديث سعر المورد (PartnerItemPrice):                         │
│     partner_price.update_purchase_price(price, qty, date)         │
│                                                                   │
│  6. إنشاء حركة مخزون (StockMovement):                            │
│     movement_type='in'                                            │
│     balance_before=old_quantity                                   │
│     balance_quantity=new_quantity                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 المطابقة الثلاثية (3-Way Matching)

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ أمر الشراء  │ ─→ │محضر الاستلام│ ─→ │ الفاتورة   │
│ PurchaseOrder│    │GoodsReceipt │    │PurchaseInv │
└─────────────┘    └─────────────┘    └─────────────┘
      ↓                   ↓                  ↓
   الكميات            التحقق              المطابقة
   المطلوبة          الفعلي              المالية
```

---

## 2. التكامل مع نظام المحاسبة (Accounting)

### 2.1 قيد سند الإدخال

```
┌─────────────────────────────────────────────────────────────────┐
│                    القيد المحاسبي لسند الإدخال                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  مصدر: مشتريات (purchase)                                        │
│  ─────────────────────────────────────                           │
│  مدين: حساب المخزون (120000)     XXX                             │
│  دائن: حساب المورد (210000)          XXX                         │
│                                                                   │
│  مصدر: رصيد افتتاحي (opening)                                    │
│  ─────────────────────────────────────                           │
│  مدين: حساب المخزون (120000)     XXX                             │
│  دائن: الأرباح المحتجزة (320101)     XXX                         │
│                                                                   │
│  مصدر: مرتجع مبيعات (return)                                     │
│  ─────────────────────────────────────                           │
│  مدين: حساب المخزون (120000)     XXX                             │
│  دائن: حساب العملاء (1102)           XXX                         │
│                                                                   │
│  مصدر: تسوية (adjustment)                                        │
│  ─────────────────────────────────────                           │
│  مدين: حساب المخزون (120000)     XXX                             │
│  دائن: حساب فروقات الجرد (5XXX)      XXX                         │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 قيد سند الإخراج

```
┌─────────────────────────────────────────────────────────────────┐
│                    القيد المحاسبي لسند الإخراج                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  جهة: مبيعات (sales)                                             │
│  ─────────────────────────────────────                           │
│  مدين: تكلفة البضاعة المباعة      XXX                            │
│  دائن: حساب المخزون (120000)          XXX                        │
│                                                                   │
│  جهة: مرتجع مشتريات (return)                                     │
│  ─────────────────────────────────────                           │
│  مدين: حساب المورد (210000)       XXX                            │
│  دائن: حساب المخزون (120000)          XXX                        │
│                                                                   │
│  جهة: استهلاك/تالف (consumption/damage)                          │
│  ─────────────────────────────────────                           │
│  مدين: حساب المصروفات             XXX                            │
│  دائن: حساب المخزون (120000)          XXX                        │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 التحقق من السنة والفترة المالية

```python
# قبل إنشاء أي قيد محاسبي:
fiscal_year = FiscalYear.objects.get(
    company=company,
    start_date__lte=date,
    end_date__gte=date,
    is_closed=False
)

period = AccountingPeriod.objects.get(
    fiscal_year=fiscal_year,
    start_date__lte=date,
    end_date__gte=date,
    is_closed=False
)
```

---

## 3. التكامل مع نظام المبيعات (Sales)

### 3.1 تدفق فاتورة المبيعات → سند الإخراج

```
┌─────────────────────────────────────────────────────────────────┐
│                    فاتورة مبيعات (SalesInvoice)                  │
│                         ↓ post()                                 │
├─────────────────────────────────────────────────────────────────┤
│  1. إنشاء سند إخراج (StockOut):                                  │
│     - destination_type='sales'                                    │
│     - customer=invoice.customer                                   │
│     - sales_invoice=invoice                                       │
│                                                                   │
│  2. نسخ سطور الفاتورة لسند الإخراج                                │
│                                                                   │
│  3. ترحيل سند الإخراج:                                            │
│     - التحقق من الكمية المتاحة                                   │
│     - حساب التكلفة بمتوسط التكلفة                                │
│     - خصم من المخزون                                              │
│     - إنشاء حركة مخزون                                            │
│     - تحديث أسعار العميل                                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. الأحداث والـ Signals

### 4.1 أحداث الترحيل

```python
# عند ترحيل سند إدخال:
StockIn.post() triggers:
├── ItemStock.update() × n lines
├── StockMovement.create() × n lines
├── PartnerItemPrice.update() (if supplier)
└── JournalEntry.create() (if required)

# عند ترحيل سند إخراج:
StockOut.post() triggers:
├── ItemStock.update() × n lines
├── StockMovement.create() × n lines
├── PartnerItemPrice.update() (if customer)
└── JournalEntry.create()
```

### 4.2 أحداث إلغاء الترحيل

```python
# عند إلغاء ترحيل:
unpost() triggers:
├── ItemStock.reverse_update() × n lines
├── StockMovement.delete() × n lines
├── JournalEntry.unpost()
└── JournalEntry.delete()
```

---

## 5. البيانات المشتركة

### 5.1 من Core إلى Inventory

| البيان | الاستخدام |
|--------|-----------|
| Item | المادة في جميع السندات |
| ItemVariant | المتغير (اختياري) |
| Warehouse | المستودع |
| BusinessPartner | المورد/العميل |
| User | المستخدمين |
| Branch | الفرع |
| Currency | العملة |

### 5.2 من Inventory إلى الأنظمة الأخرى

| البيان | الجهة | الاستخدام |
|--------|-------|-----------|
| ItemStock.quantity | Sales | التحقق من التوفر |
| ItemStock.average_cost | Accounting | حساب التكلفة |
| ItemStock.last_purchase_price | Purchases | مقارنة الأسعار |
| StockMovement | Reports | تقارير الحركة |

---

## 6. نقاط الربط (Integration Points)

```
                    ┌──────────────────┐
                    │   نظام المخزون   │
                    │   (Inventory)    │
                    └────────┬─────────┘
                             │
       ┌─────────────────────┼─────────────────────┐
       │                     │                     │
       ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   المشتريات  │    │   المحاسبة   │    │   المبيعات   │
│  (Purchases) │    │ (Accounting) │    │   (Sales)    │
├──────────────┤    ├──────────────┤    ├──────────────┤
│ نقاط الربط:  │    │ نقاط الربط:  │    │ نقاط الربط:  │
│              │    │              │    │              │
│• PurchaseInv │    │• JournalEntry│    │• SalesInvoice│
│  .post()     │    │• FiscalYear  │    │  .post()     │
│• GoodsReceipt│    │• Period      │    │• SalesReturn │
│• Purchase    │    │• Account     │    │• Reservation │
│  Return      │    │              │    │              │
└──────────────┘    └──────────────┘    └──────────────┘
```

---

## 7. ملخص نقاط التكامل

| النظام | نوع التكامل | الاتجاه | الوصف |
|--------|-------------|---------|-------|
| Purchases | فواتير | ← | فاتورة مشتريات تُنشئ سند إدخال |
| Purchases | استلام | ← | محضر استلام يُنشئ سند إدخال |
| Purchases | مرتجعات | → | سند إخراج من مرتجع مشتريات |
| Sales | فواتير | ← | فاتورة مبيعات تُنشئ سند إخراج |
| Sales | مرتجعات | ← | مرتجع مبيعات يُنشئ سند إدخال |
| Sales | حجز | ↔ | حجز الكمية من المخزون |
| Accounting | قيود | → | سندات المخزون تُنشئ قيود |
| Accounting | تقييم | → | قيمة المخزون للميزانية |
| Accounting | تكلفة | → | تكلفة البضاعة المباعة |
